<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Barber Manager 1.0 Pro Fix</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&family=Bebas+Neue&family=Lobster&family=Orbitron:wght@500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/all.min.css">
<link rel="stylesheet" href="css/leaflet.css" />
<script src="leaflet.js"></script>
<style>
    /* --- MOTOR VISUAL PRO V2 --- */
    /* 1. Barra de desplazamiento (Solo Vertical) */
    ::-webkit-scrollbar { width: 3px; height: 0px; background: transparent; } /* Height 0 elimina la raya horizontal */
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }

    /* 2. Protección Total contra Selección y Menús (Anti-Navegador) */
    * {
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none !important; /* Bloquea menú nativo */
        user-select: none !important;           /* Bloquea selección azul */
        -webkit-user-select: none !important;
        -webkit-user-drag: none !important;     /* Bloquea arrastre de imgs */
    }
    /* Solo permitir selección en campos de escritura real */
    input:not([readonly]), textarea { 
        user-select: text !important; 
        -webkit-user-select: text !important; 
        -webkit-touch-callout: default !important; /* Permitir menú en escritura */
    }
    /* Los inputs de fecha/hora (readonly) actúan como botones */
    input[readonly] {
        cursor: pointer;
        caret-color: transparent; /* Oculta el cursor de texto */
    }

    /* 3. Inputs Vivos */
    input:focus, select:focus {
        border-color: var(--primary) !important;
        background: rgba(255,255,255,0.05) !important;
        transform: translateY(-2px);
        transition: 0.3s ease;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    
    /* 4. Cristal */
    .glass-effect {
        background: rgba(18, 18, 18, 0.75) !important;
        backdrop-filter: blur(16px) !important;
        -webkit-backdrop-filter: blur(16px) !important;
        border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
        box-shadow: 0 -10px 40px rgba(0,0,0,0.8) !important;
    }

    /* --- MODO RENDIMIENTO (LITE) --- */
    /* 1. Base: Mantiene colores originales pero mata el consumo de CPU */
    body.lite-mode * {
        box-shadow: none !important; /* Adiós Neón */
        text-shadow: none !important;
        transition: none !important; /* Cero movimientos suaves */
        animation: none !important;  /* Cero movimientos constantes */
        
        /* IMPORTANTE: Quitamos el BLUR (borroso) para velocidad, 
           pero mantenemos la transparencia del color original */
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }

    /* 2. Optimización de Listas (Invisible fuera de pantalla) */
    body.lite-mode .client-item, 
    body.lite-mode .appt-item {
        content-visibility: auto;
        contain-intrinsic-size: 60px;
    }

    /* 3. EXCEPCIÓN: EL FAB (PLUMA) MANTIENE SU MAGIA */
    body.lite-mode #quickFab {
        box-shadow: 0 15px 35px rgba(0,0,0,0.9), 0 0 20px var(--primary) !important; /* Neón activo */
        animation: swing-razor 4s ease-in-out infinite !important; /* Movimiento activo */
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
    }
    /* ------------------------ */

    @font-face {font-family:'Montserrat';src:local('Montserrat'),local('sans-serif');}
    @font-face {font-family:'Bebas Neue';src:local('Bebas Neue'),local('Impact'),local('sans-serif-condensed');}
    @font-face {font-family:'Lobster';src:local('Lobster'),local('Brush Script MT'),local('cursive');}
    @font-face {font-family:'Orbitron';src:local('Orbitron'),local('monospace');}
.profile-hero-section {display:flex;align-items:center;justify-content:space-between;padding:40px 20px 20px 20px;position:relative;gap:15px;}
.profile-avatar-container {width:90px;height:90px;position:relative;flex-shrink:0;}
.profile-avatar-img {width:100%;height:100%;border-radius:50%;object-fit:cover;border:3px solid var(--primary);box-shadow:0 0 20px rgba(46,204,113,0.3);display:none;}
.profile-avatar-img.visible {display:block;}
.profile-avatar-default {width:100%;height:100%;background:linear-gradient(135deg,rgba(255,255,255,0.05),rgba(255,255,255,0.02));border:3px solid var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--primary);font-size:2.5rem;}
.profile-camera-btn {background:var(--primary);color:#000;width:30px;height:30px;border-radius:50%;position:absolute;bottom:0;right:0;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.5);border:2px solid #000;transition:transform 0.2s;}
.profile-camera-btn:active {transform:scale(0.9);}
.profile-info-col {flex:1;display:flex;flex-direction:column;gap:4px;overflow:hidden;transform:translateY(-43px);}
.profile-status-badge {display:inline-flex;align-self:flex-start;background:rgba(30,30,30,0.95);padding:4px 10px;border-radius:24px;align-items:center;gap:8px;font-size:0.6rem;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;border:1px solid rgba(255,255,255,0.1);margin-bottom:2px;}
.profile-status-badge.online {border-color:#2ecc71;color:#2ecc71;}
.profile-status-badge.offline {border-color:#e74c3c;color:#e74c3c;}
.status-dot-animated {width:6px;height:6px;border-radius:50%;background:currentColor;animation:pulse-dot 1.5s infinite;}
@keyframes pulse-dot {0%,100% {opacity:1;transform:scale(1);}50% {opacity:0.5;transform:scale(1.2);}}
.profile-brand-name {font-size:1.3rem;font-weight:800;color:#fff;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.profile-id-row {display:flex;align-items:center;justify-content:flex-start;gap:10px;font-size:0.65rem;color:#666;}
/* Ajuste de Iconos para Diseño Horizontal */
.profile-id-row i {
    color: var(--primary);
    cursor: pointer;
    padding: 8px;
    background: rgba(46, 204, 113, 0.1);
    border-radius: 6px;
    font-size: 0.8rem;
    transition: 0.2s;
}
.profile-id-row i:active {
    background: var(--primary);
    color: #000;
}
/* --- TARJETA DE ESTADO (OSCURA) --- */
.profile-status-toggle-card {margin:10px 20px 20px 20px;background:#0a0a0a;border:1px solid rgba(255,255,255,0.1);border-radius:24px;padding:25px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 10px 40px -10px rgba(0,0,0,0.8);}
.status-toggle-left {display:flex;flex-direction:column;align-items:center;text-align:center;gap:5px;flex:1;}
.status-toggle-left i {font-size:1.4rem;color:var(--primary);margin-bottom:2px;}
.status-toggle-title {font-weight:800;color:#fff;font-size:0.9rem;}
.status-toggle-subtitle {font-size:0.65rem;color:#666;}

/* Switch iOS Style */
.switch-large {position:relative;width:55px;height:30px;}
.switch-large input {opacity:0;width:0;height:0;}
.slider-large {position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#333;transition:0.3s;border-radius:30px;}
.slider-large:before {position:absolute;content:"";height:24px;width:24px;left:3px;bottom:3px;background-color:#fff;transition:0.3s;border-radius:50%;}
.switch-large input:checked + .slider-large {background:var(--primary);box-shadow:0 0 15px var(--primary);}
.switch-large input:checked + .slider-large:before {transform:translateX(25px);}

/* --- GRID ESTADÍSTICAS (3 CUADRADOS) --- */
.profile-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin: 0 20px 10px 20px;
}
.stat-card {
    background: #0a0a0a;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    aspect-ratio: 1/1; /* Cuadrado perfecto */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: transform 0.2s;
    padding: 10px;
}
.stat-card:active {transform:scale(0.95);border-color:var(--primary);}
.stat-card i {font-size:1.3rem;color:var(--primary);margin-bottom:8px;}
.stat-value {font-size:1.2rem;font-weight:800;color:#fff;}
.stat-label {font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;margin-top:3px;}
/* Tarjetas de Información (Dark Mode) */
.profile-section-card {
    margin: 0 20px 15px 20px;
    background: #0a0a0a;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 24px;
    padding: 25px;
    position: relative;
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
}
.profile-section-card.highlight-card {border-color:rgba(241,196,15,0.4);background:rgba(241,196,15,0.05);cursor:pointer;}
.section-header {display:flex;align-items:center;gap:14px;margin-bottom:12px;font-weight:700;color:#fff;font-size:0.9rem;}
.section-header i {color:var(--primary);font-size:1rem;}
.btn-edit-mini {margin-left:auto;background:rgba(255,255,255,0.1);border:none;color:var(--primary);width:30px;height:30px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.75rem;}
.btn-edit-mini:active {background:var(--primary);color:#000;}
.section-subtitle {font-size:0.75rem;color:var(--text-muted);}
.section-arrow {position:absolute;right:18px;top:50%;transform:translateY(-50%);color:#666;}
.notification-badge {background:#e74c3c;color:#fff;padding:3px 10px;border-radius:15px;font-size:0.75rem;font-weight:700;margin-left:auto;}
.info-row {display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05);}
.info-row:last-child {border-bottom:none;}
.info-label {font-size:0.8rem;color:var(--text-muted);}
.info-value {font-size:0.95rem;color:#fff;font-weight:600;}
.info-link {color:#25d366;text-decoration:none;font-size:0.85rem;font-weight:600;display:flex;align-items:center;gap:14px;cursor:pointer;}
.quick-services-list {margin-bottom:12px;}
.service-item-mini {display:flex;justify-content:space-between;padding:14px 0;border-bottom:1px solid rgba(255,255,255,0.05);font-size:0.85rem;color:#ddd;}
.service-price {color:var(--primary);font-weight:700;}
.btn-action-secondary {width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--primary);padding:14px;border-radius:16px;font-weight:700;font-size:0.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:16px;}
.btn-action-secondary:active {background:var(--primary);color:#000;}
/* --- CORRECCIÓN HORARIO DESLIZANTE --- */
.availability-grid {
    display: flex;              /* Fila en vez de cuadrícula */
    gap: 12px;                  /* Espacio entre días */
    overflow-x: auto;           /* Permite deslizar a los lados */
    padding-bottom: 5px;        /* Espacio para que no corte la sombra */
    
    /* Ocultar barra de scroll (Estética limpia) */
    -ms-overflow-style: none;   
    scrollbar-width: none;      
}
.availability-grid::-webkit-scrollbar {
    display: none;              /* Ocultar barra en Chrome/Android */
}

.day-slot {
    min-width: 68px;            /* Ancho mínimo para que no se aplasten */
    flex-shrink: 0;             /* Evita que se encojan */
    text-align: center;
    padding: 14px 5px;
    border-radius: 16px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
}
/* ------------------------------------- */
.day-slot.active {border-color:var(--primary);background:rgba(46,204,113,0.1);}
.day-slot.inactive {opacity:0.4;}
.day-name {display:block;font-size:0.65rem;font-weight:700;color:#fff;text-transform:uppercase;margin-bottom:3px;}
.day-hours {display:block;font-size:0.5rem;color:var(--text-muted);}
.profile-actions-container {margin:28px 20px 15px 20px;display:flex;flex-direction:column;gap:14px;}
.btn-publish {background:var(--primary);color:#000;border:none;padding:24px;border-radius:16px;font-weight:800;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:14px;box-shadow:0 5px 20px rgba(46,204,113,0.3);text-transform:uppercase;letter-spacing:1.2px;}
.btn-publish:active {transform:scale(0.97);filter:brightness(0.9);}
.btn-preview {background:transparent;border:2px solid var(--primary);color:#fff;padding:14px;border-radius:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:16px;width:100%;}
.btn-preview:active {background:var(--primary);color:#000;}
.sync-status-bar {margin:0 20px;padding:14px;background:rgba(0,0,0,0.3);border-radius:16px;display:flex;align-items:center;justify-content:center;gap:16px;font-size:0.75rem;color:#888;}
.sync-status-bar i {color:var(--primary);}
.profile-advanced-toggle {margin:24px 20px 10px 20px;padding:24px;background:rgba(255,255,255,0.02);border-radius:15px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;color:#888;font-size:0.85rem;font-weight:600;}
.advanced-options-panel {display:none;margin:0 20px;padding:24px;background:rgba(0,0,0,0.3);border-radius:15px;flex-direction:column;gap:14px;}
.advanced-options-panel.show {display:flex;}
.btn-advanced-option {background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#ddd;padding:14px;border-radius:16px;font-weight:600;font-size:0.8rem;cursor:pointer;display:flex;align-items:center;gap:14px;}
.btn-advanced-option i {color:var(--primary);width:20px;text-align:center;}
.btn-advanced-option.danger {border-color:rgba(231,76,60,0.3);color:#e74c3c;}
.btn-advanced-option.danger i {color:#e74c3c;}
#mapPickerContainer { 
    width: 100%; 
    height: 300px; 
    border-radius: 18px; 
    overflow: hidden; 
    margin-bottom: 20px; 
    border: 1px solid rgba(255,255,255,0.1); 
    position: relative; 
    display: none; 
    background: #121212; 
    z-index: 1;
}
#mapPickerContainer.active { display: block; }
.leaflet-control-zoom { display: none !important; }

.btn-geo-auto { background:linear-gradient(135deg, rgba(46,204,113,0.15), rgba(46,204,113,0.05)); color:#2ecc71; border:1px solid #2ecc71; padding:14px; border-radius:16px; width:100%; font-weight:800; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:20px; transition:0.2s; font-size: 0.9rem; }
.btn-geo-auto:active { background:#2ecc71; color:#000; transform: scale(0.95); }
</style>

<style>
.schedule-row {
    display: flex; align-items: center; justify-content: space-between;
    background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px;
    margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05);
}
.schedule-day { font-weight: 800; width: 40px; font-size: 0.9rem; color: #fff; }
.schedule-inputs { display: flex; align-items: center; gap: 8px; opacity: 0.3; pointer-events: none; transition: 0.3s; }
.schedule-inputs.active { opacity: 1; pointer-events: auto; }
.time-input-mini {
    background: #000; border: 1px solid #444; color: #fff;
    border-radius: 8px; padding: 8px 5px; font-family: monospace;
    width: 65px; text-align: center; font-size: 0.85rem;
}
.schedule-switch input:checked + .slider { background-color: var(--primary); }

.appt-started {
    background:rgba(255,0,0,0.4) !important;
    border:1px solid rgba(255,0,0,0.6) !important;
    box-shadow:0 0 10px rgba(255,0,0,0.2);
}

.chart-container {
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    height:120px;
    padding:24px 10px;
    background:rgba(0,0,0,0.2);
    border-radius:15px;
    margin-bottom:24px;
    border:1px solid rgba(255,255,255,0.05);
}
.chart-col {
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-end;
    height:100%;
    flex:1;
}
.chart-bar {
    width:6px;
    background:rgba(255,255,255,0.1);
    border-radius:16px;
    min-height:6px;
    position:relative;
}
.chart-bar.today {
    background:var(--primary);
    box-shadow:0 0 12px var(--primary);
}
.chart-label {
    font-size:0.6rem;
    color:#666;
    margin-top:8px;
    font-weight:700;
}
#toast-container {
    position:fixed;bottom:100px;left:50%;transform:translateX(-50%);
    display:flex;flex-direction:column;gap:10px;z-index:2000000;pointer-events:none;
    align-items:center; width: 90%; max-width: 320px;
}
.toast-neon {
    position:relative;pointer-events:auto;overflow:hidden;
    display:flex;align-items:center;gap:14px;
    padding:10px 20px;border-radius:50px;width:100%;
    /* Efecto Glass más transparente como pediste */
    background:rgba(0,0,0,0.7);
    backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
    border:1px solid rgba(255,255,255,0.15);
    /* Sombras adaptadas al tema */
    box-shadow:0 5px 20px -5px rgba(0,0,0,0.5), 0 0 15px -5px var(--primary);
    opacity:0;transform:translateY(40px) scale(0.9);
    transition:all 0.5s cubic-bezier(0.175,0.885,0.32,1.275);
}
.toast-neon::after {
    content:'';position:absolute;bottom:0;left:0;height:3px;
    background:var(--primary);width:100%;
    box-shadow:0 -2px 10px var(--primary);
}
.toast-neon.show {opacity:1;transform:translateY(0) scale(1);}
.toast-neon.show::after {animation:timerShrink 3s linear forwards;}
.toast-neon.hide {opacity:0;transform:translateY(-20px) scale(0.95);transition:0.4s ease-out;}
@keyframes timerShrink {from{width:100%;}to{width:0%;}}
.t-emoji {
    font-size:22px;display:block;
    text-shadow:0 0 10px var(--primary);
    animation:floatEmoji 3s ease-in-out infinite;
}
.t-content {display:flex;flex-direction:column;justify-content:center;text-align:left;flex:1;}
.t-title {color:var(--primary);font-weight:800;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;line-height:1.2;margin-bottom:2px;}
.t-msg {font-size:11px;color:rgba(255,255,255,0.95);font-weight:500;line-height:1.2;}
@keyframes floatEmoji {0%,100%{transform:translateY(0);}50%{transform:translateY(-3px);}}

.virtual-wrapper {position:relative;width:100%;}
.virtual-item {
    position:absolute;
    top:0;left:0;
    width:100%;
    padding-right: 25px; /* Ajustado: Contactos llegan casi hasta las letras */
    height:65px;
    contain:strict;
    will-change:transform;
    transform:translateZ(0);
    backface-visibility:hidden;
}
/* INDICE ALFABETICO PRO */
.alphabet-nav {
    /* Ajustado: Empieza bajo el botón verde (160px) y termina antes del menú (90px) */
    position: fixed; top: 160px; right: 0; bottom: 90px;
    width: 35px; display: flex; flex-direction: column;
    z-index: 200; touch-action: none; 
    background: rgba(0,0,0,0.1); border-radius: 20px 0 0 20px;
}
.alpha-char {
    flex: 1; display: flex; align-items: center; justify-content: center;
    font-size: 0.55rem; color: #aaa; font-weight: 600; /* Ajustado para mas espacio visual */
}
.letter-bubble {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
    width: 80px; height: 80px; background: var(--primary); color: #000;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 3rem; font-weight: 900; z-index: 5000;
    box-shadow: 0 0 30px var(--primary); pointer-events: none;
    transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.letter-bubble.show { transform: translate(-50%, -50%) scale(1); }

:root {--primary:#2ecc71;--bg-body:#000;--glass-card:rgba(18,18,18,0.92);--border-glass:rgba(255,255,255,0.08);--text:#ffffff;--text-muted:#88aa88;--radius:20px;--font-main:'Montserrat',sans-serif;--shadow:0 10px 30px -5px rgba(0,0,0,0.8);--overlay-opacity:0.85;}

.font-modern {font-family:'Montserrat',sans-serif;letter-spacing:1.2px;text-transform:uppercase;font-weight:800;}
.font-elegant {font-family:'Lobster',cursive;letter-spacing:1.2px;font-weight:400;}
.font-urban {font-family:'Bebas Neue',sans-serif;letter-spacing:2.5px;font-weight:400;font-size:1.4em;}
.font-cyber {font-family:'Orbitron',sans-serif;letter-spacing:2.5px;font-weight:600;}

[data-theme="urbano"] {--primary:#00ffea;--glass-card:rgba(5,15,20,0.92);--bg-body:#020a0c;--text-muted:#8ab;}
[data-theme="clasico"] {--primary:#ffffff;--glass-card:rgba(20,20,20,0.92);--bg-body:#111;--text-muted:#999;}
[data-theme="rojo"] {--primary:#ff4757;--glass-card:rgba(25,5,5,0.92);--bg-body:#1a0505;--text-muted:#daa;}
[data-theme="oro"] {--primary:#d4af37;--glass-card:rgba(20,18,10,0.92);--bg-body:#050505;--text-muted:#cba;}
[data-theme="cyber"] {--primary:#ff00ff;--glass-card:rgba(25,0,25,0.92);--bg-body:#0d001a;--text-muted:#d0d;}
[data-theme="ocean"] {--primary:#00a8ff;--glass-card:rgba(5,15,30,0.92);--bg-body:#00101f;--text-muted:#8ab;}
[data-theme="matrix"] {--primary:#2ecc71;--glass-card:rgba(10,15,10,0.92);--bg-body:#000;--text-muted:#88aa88;}

/* Rendimiento Global: touch-action elimina el delay de 300ms en clicks */
* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    touch-action: manipulation; 
}
input,textarea {user-select:text;}
body {font-family:var(--font-main);margin:0;padding:0;color:var(--text);background-color:var(--bg-body);height:100vh;overflow:hidden;}
.bg-image {position:fixed;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;z-index:-2;}
.bg-overlay {position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg-body);opacity:var(--overlay-opacity);backdrop-filter:blur(5px);z-index:-1;}
.app-container {height:100%;width:100%;position:relative;overflow:hidden;}

.view-content {
    position:absolute;top:0;left:0;width:100%;bottom:85px;
    overflow-y:auto;overscroll-behavior-y:none;padding:0;
    display:none;
    contain:content;
}
.view-content.active {display:flex;flex-direction:column;}

.sticky-container {flex-shrink:0;z-index:50;background:transparent !important;padding:25px 20px 10px 20px;text-shadow:0 2px 10px rgba(0,0,0,0.8);}
.content-body {flex:1;overflow-y:auto;padding:0 20px 20px 20px;}

.card {background:var(--glass-card);border:1px solid var(--border-glass);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);border-radius:var(--radius);padding:24px;margin-bottom:18px;box-shadow:var(--shadow);}

.photo-box img {width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;display:none;}
.gallery-item img {width:80px;height:100%;object-fit:cover;border-right:1px solid rgba(255,255,255,0.1);cursor:pointer;}

/* Listas Aceleradas (GPU 3D) */
.client-item, .appt-item {
    display: flex; flex-direction: row; align-items: center; justify-content: space-between;
    background: rgba(30, 30, 30, 0.4); 
    backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); 
    padding: 12px 15px; 
    border-radius: 18px;
    margin-bottom: 8px; 
    border: 1px solid rgba(255, 255, 255, 0.08); 
    box-shadow: 0 4px 6px rgba(0,0,0,0.2); 
    min-height: 60px;
    transition: transform 0.2s, background 0.2s;
    /* Motor Gráfico Activado */
    transform: translate3d(0,0,0);
    will-change: transform;
    backface-visibility: hidden;
}
.client-item:active, .appt-item:active {
    transform: scale(0.97);
    background: rgba(255,255,255,0.1); /* Destello al tocar */
    border-color: var(--primary);
}
.client-info {display:flex;align-items:center;gap:14px;flex:1;overflow:hidden;cursor:pointer;}
.client-actions {display:flex;gap:16px;}
.client-avatar {width:34px;height:34px;background:rgba(255,255,255,0.05);border:1px solid var(--primary);color:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.8rem;flex-shrink:0;box-shadow:0 3px 8px rgba(0,0,0,0.2);}

.action-btn {width:30px;height:30px;border-radius:8px;border:none;display:flex;align-items:center;justify-content:center;font-size:0.8rem;transition:transform 0.2s,box-shadow 0.2s;cursor:pointer;color:#fff;text-decoration:none;}
.action-btn:active {transform:scale(0.9);filter:brightness(1.2);}

.btn-call {background:rgba(46,204,113,0.2);color:#2ecc71;border:1px solid rgba(46,204,113,0.3);}
.btn-msg {background:rgba(52,152,219,0.2);color:#3498db;border:1px solid rgba(52,152,219,0.3);}
        .btn-wa {background:rgba(37,211,102,0.2);color:#25d366;border:1px solid rgba(37,211,102,0.3);}
        .btn-edit {background:rgba(241,196,15,0.2);color:#f1c40f;border:1px solid rgba(241,196,15,0.3);}
        .btn-del {background:rgba(231,76,60,0.2);color:#e74c3c;border:1px solid rgba(231,76,60,0.3);}
        
        .clickable-card {cursor:pointer;}.clickable-card:active {transform:scale(0.97);}
        .card-transparent {background:rgba(0,0,0,0.3) !important;backdrop-filter:none !important;box-shadow:none !important;border:1px solid rgba(255,255,255,0.05);}
        .btn {background:var(--primary);color:#000;border:none;padding:24px;border-radius:16px;font-weight:700;width:100%;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:16px;box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:transform 0.2s,filter 0.2s;}.btn:active {transform:scale(0.95);filter:brightness(0.9);}
        .btn-outline {background:transparent;border:2px solid var(--primary);color:var(--text);}
        .btn-import {background:linear-gradient(135deg,rgba(255,255,255,0.1),rgba(255,255,255,0.05));border:1px solid var(--primary);color:var(--primary);padding:0 15px;border-radius:15px;font-size:0.75rem;font-weight:800;cursor:pointer;display:flex;align-items:center;gap:16px;height:52px;letter-spacing:0.8px;transition:0.35s ease;box-shadow:0 8px 20px rgba(0,0,0,0.2);width:100%;justify-content:center;}.btn-import:active {background:var(--primary);color:#000;transform:scale(0.95);}
        
        select {background-color:rgba(20,20,20,0.8);border:1px solid var(--border-glass);color:#fff;font-weight:500;border-radius:15px;padding:14px;width:100%;-webkit-appearance:none;}
        .btn-color-picker {width:100%;background:rgba(255,255,255,0.05);border:1px solid var(--border-glass);padding:14px 15px;border-radius:16px;display:flex;align-items:center;justify-content:center;gap:14px;color:#fff;cursor:pointer;margin-top:10px;font-weight:600;}
        .search-row {display:flex;gap:16px;align-items:center;width:100%;margin-top:10px;}.search-wrapper {position:relative;flex:1;}
        .btn-search-action {width:50px;height:50px;border-radius:15px;border:1px solid var(--border-glass);background:rgba(255,255,255,0.1);color:var(--primary);display:flex;align-items:center;justify-content:center;font-size:1.1rem;cursor:pointer;transition:0.25s ease;}.btn-search-action:active {background:var(--primary);color:#000;}
        input {
            width:100%; padding:16px;
            background:rgba(255,255,255,0.03); /* Casi transparente */
            border:1px solid rgba(255,255,255,0.1);
            border-radius:16px;
            color:#fff; font-size:1rem; margin-bottom:0;
            transition:all 0.3s ease;
        }
        .input-with-clear {position:relative;display:flex;align-items:center;}.btn-clear-input {position:absolute;right:12px;background:transparent;border:none;color:#e74c3c;font-size:1.2rem;cursor:pointer;display:none;padding:5px;}
        .modal-row {display:flex;gap:14px;align-items:flex-start;margin-bottom:12px;}.modal-col {flex:1;}.modal-label {display:block;font-size:0.8rem;color:var(--text-muted);margin-bottom:5px;font-weight:600;}
        @keyframes slideIn {from {opacity:0;transform:translateY(20px);}to {opacity:1;transform:translateY(0);}}
        .theme-collapse {display:none;overflow:hidden;margin-top:10px;}.theme-collapse.show {display:block;}
        .theme-grid {display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px;}
        .theme-option {height:60px;border-radius:15px;border:2px solid transparent;cursor:pointer;position:relative;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.7rem;text-transform:uppercase;text-shadow:0 1px 3px rgba(0,0,0,0.8);box-shadow:0 6px 16px rgba(0,0,0,0.3);transition:transform 0.2s;}.theme-option.selected {border-color:#fff;transform:scale(1.05);box-shadow:0 0 15px var(--primary);}
        /* BARRA FLOTANTE PRO (GPU Acelerada) */
        .bottom-nav {
            position: fixed; bottom: 15px; left: 15px; right: 15px; width: auto;
            background: rgba(15, 15, 15, 0.85) !important;
            /* Desenfoque mantenido, pero renderizado por GPU */
            backdrop-filter: blur(20px) !important; 
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            border-radius: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6) !important;
            display: flex; justify-content: space-around; align-items: center;
            padding: 12px 0; z-index: 100; pointer-events: auto;
            /* Motor Gráfico Activado */
            transform: translate3d(0,0,0);
            will-change: transform;
            backface-visibility: hidden;
        }
        /* Botones Turbo (Sin saltos) */
        .nav-btn {
            background: none; border: none; color: #666;
            display: flex; flex-direction: column; align-items: center;
            font-size: 0.65rem; flex: 1; 
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.3s ease;
            font-weight: 600;
            will-change: transform, color; /* Prepara al navegador */
            transform: translateZ(0);
        }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 2px; transition: 0.3s; }
        
        .nav-btn.active { 
            color: var(--primary); 
            /* Movimiento 3D forzado */
            transform: translate3d(0, -6px, 0) scale(1.1); 
        }
        .nav-btn.active i { 
            text-shadow: none; 
            filter: none;
        }
        
        @keyframes swing-razor {
            0% {transform:rotate(0deg);}
            20% {transform:rotate(15deg);}
            40% {transform:rotate(-10deg);}
            60% {transform:rotate(5deg);}
            80% {transform:rotate(-5deg);}
            100% {transform:rotate(0deg);}
        }

        #quickFab {
            position:fixed;
            bottom:95px;
            right:25px;
            width:55px;
            height:55px;
            background: radial-gradient(circle at 30% 30%, #333, #000);
            border: 2px solid var(--primary);
            border-radius:50%;
            color:var(--primary);
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:1.5rem;
            box-shadow: inset 4px 4px 8px rgba(255,255,255,0.15), 0 15px 35px rgba(0,0,0,0.9), 0 0 20px var(--primary);
            z-index:1999;
            cursor:pointer;
            transition:transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 0 4px 8px rgba(0,0,0,1);
            animation:swing-razor 4s ease-in-out infinite;
        }
        /* CORRECCION: Desactivar animación al ocultar para que funcione el scale(0) */
        #quickFab.fab-hidden { transform: scale(0) !important; animation: none !important; pointer-events: none; }
        #quickFab:active {transform:scale(0.9);animation:none;}

        /* --- MICROFONO IA --- */
        #fabVoice {
            position:fixed; bottom:165px; right:25px;
            width:55px; height:55px;
            background: linear-gradient(135deg, #000, #333);
            border: 2px solid #3498db;
            border-radius:50%; color:#3498db;
            display:flex; align-items:center; justify-content:center;
            font-size:1.4rem; z-index:1999; cursor:pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #fabVoice.fab-hidden { transform: scale(0) !important; pointer-events: none; }
        #fabVoice:active { transform: scale(0.9); }
        
        /* Animación cuando está escuchando */
        #fabVoice.listening {
            border-color: #e74c3c; color: #e74c3c;
            animation: pulse-mic 1s infinite;
        }
        @keyframes pulse-mic {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        #customNumKeyboard {
            display:none;
            position:fixed;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            width:280px;
            background:#000;
            border:1px solid var(--border-glass);
            border-radius:24px;
            padding:24px;
            grid-template-columns:repeat(3,1fr);
            gap:14px;
            z-index:8000;
            box-shadow:0 20px 60px rgba(0,0,0,1);
            
}
        .num-key {
            background:rgba(255,255,255,0.12);
            border:none;
            color:#fff;
            border-radius:15px;
            height:60px;
            font-weight:800;
            font-size:1.5rem;
            display:flex;align-items:center;justify-content:center;
            cursor:pointer;
            transition:0.1s;
}

        .num-key:active {background:var(--primary);color:#000;}
        .num-key.del {background:rgba(231,76,60,0.2);color:#e74c3c;font-size:0.9rem;}
        .num-key.confirm {grid-column:span 3;background:var(--primary);color:#000;text-transform:uppercase;font-size:0.8rem;letter-spacing:1.2px;}



        .btn-big-action {
            width:100%;
            height:60px;
            border-radius:15px;
            font-weight:800;
            font-size:0.9rem;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:14px;
            cursor:pointer;
            transition:0.25s ease;
            text-transform:uppercase;
            letter-spacing:0.8px;
}
        .btn-big-import {
            background:rgba(255,255,255,0.05);
            border:1px solid var(--primary);
            color:var(--primary);
}
        .btn-big-manual {
            background:var(--primary);
            color:#000;
            border:none;
            box-shadow:0 8px 20px rgba(0,0,0,0.3);
}
        .time-picker-btn {
            background:var(--primary);color:#000;border:none;
            width:45px;height:45px;border-radius:15px;
            font-size:1.2rem;cursor:pointer;margin-left:8px;
            display:flex;align-items:center;justify-content:center;
            box-shadow:0 6px 16px rgba(0,0,0,0.3);
}
        .time-slots-grid {
            display:none;
            grid-template-columns:repeat(4,1fr);
            gap:16px;
            margin-top:10px;
            max-height:180px;
            overflow-y:auto;
            background:rgba(0,0,0,0.3);
            padding:14px;
            border-radius:15px;
            border:1px solid rgba(255,255,255,0.1);
}
        .time-slot {
            background:rgba(46,204,113,0.15);color:#2ecc71;
            border:1px solid #2ecc71;padding:8px 4px;border-radius:8px;
            font-size:0.8rem;cursor:pointer;text-align:center;font-weight:600;
            transition:0.25s ease;
}
        .time-slot:active {background:#2ecc71;color:#000;}
        .time-slot.taken {
            background:rgba(255,255,255,0.05);color:#555;
            border-color:transparent;pointer-events:none;
            text-decoration:line-through;opacity:0.5;
}
        
        .modal {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:3000;display:none;justify-content:center;align-items:flex-end;backdrop-filter:blur(8px);transition:all 0.3s;}.modal.open {display:flex;}
        /* Modales Turbo (GPU Activa) */
        .modal-card {
            background: rgba(10, 10, 10, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            width: 100%;
            border-radius: 30px 30px 0 0;
            padding: 35px 25px 45px 25px;
            border-top: 1px solid rgba(255,255,255,0.15);
            /* Inicio fuera de pantalla (3D) */
            transform: translate3d(0, 100%, 0);
            max-height: 100vh;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 0 -15px 50px rgba(0,0,0,0.9);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform;
        }
        /* MODO MITAD (Reprogramación) */
        .modal-card.half-mode {
            height: auto !important;
            max-height: 55vh !important; /* Solo media pantalla */
            border-radius: 40px 40px 0 0;
        }
        .modal-card.half-mode input:read-only { opacity: 0.7; border-color: transparent; background: transparent; font-weight: 800; font-size: 1.2rem; text-align: center; }
    /* Posición final 3D (GPU) */
    .modal.open .modal-card {transform:translate3d(0, 0, 0);}
        .modal-close-x {position:absolute;top:20px;right:20px;color:var(--primary);background:none;border:none;font-size:1.8rem;cursor:pointer;transition:transform 0.2s;}
        
        @keyframes popIn {0% {transform:scale(0.8);opacity:0;}100% {transform:scale(1);opacity:1;}}
        
        #quickClientList::-webkit-scrollbar,#quickTimeGrid::-webkit-scrollbar {display:none;}
        #quickClientList,#quickTimeGrid {-ms-overflow-style:none;scrollbar-width:none;}

        @keyframes shatter-effect {0% {transform:scale(1);opacity:1;filter:blur(0);}40% {transform:scale(1.05) rotate(2deg);opacity:0.9;}100% {transform:scale(1.4) rotate(-5deg);opacity:0;filter:blur(10px);}}.shatter-out {pointer-events:none;}
        .toggle-row {display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;padding:14px 0;border-bottom:1px solid rgba(255,255,255,0.05);}
        .switch {position:relative;display:inline-block;width:50px;height:26px;}.switch input {opacity:0;width:0;height:0;}.slider {position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#333;transition:.4s;border-radius:34px;}.slider:before {position:absolute;content:"";height:20px;width:20px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%;}input:checked + .slider {background-color:var(--primary);}input:checked + .slider:before {transform:translateX(24px);}
        #modalManualEntry {z-index:3500 !important;}
        .custom-alert-overlay {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);z-index:26000;display:none;align-items:center;justify-content:center;}
        .custom-alert-box {background:#121212;border:1px solid rgba(255,255,255,0.08);padding:40px 25px;border-radius:32px;width:85%;max-width:320px;text-align:center;box-shadow:0 25px 80px rgba(0,0,0,0.9);animation:popAlert 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.27);position:relative;overflow:hidden;}
        .custom-alert-box::before {content:'';position:absolute;top:0;left:0;width:100%;height:4px;background:var(--primary);box-shadow:0 0 15px var(--primary);}
        @keyframes popAlert {0%{transform:scale(0.8);opacity:0;}100%{transform:scale(1);opacity:1;}}
        #brandDisplay {text-align:left;margin:5px 0 2px 0;font-size:1.2rem;transition:color 0.3s;}#realClock {font-size:1.1rem;font-weight:600;color:var(--primary);letter-spacing:2.5px;font-family:'Courier New',monospace;opacity:0.9;}
        .finance-tabs,.tutorial-tabs {display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;background:rgba(0,0,0,0.3);padding:5px;border-radius:15px;}.tutorial-tabs {grid-template-columns:1fr 1fr;}
        .f-tab {background:transparent;border:none;color:#777;padding:14px 0;font-size:0.8rem;font-weight:700;border-radius:8px;cursor:pointer;transition:0.35s ease;}.f-tab.active {background:var(--primary);color:#000;box-shadow:0 6px 16px rgba(0,0,0,0.3);}
        .finance-list {max-height:400px;overflow-y:auto;}
        .search-clear {position:absolute;right:15px;top:50%;transform:translateY(-50%);color:var(--text-muted);cursor:pointer;display:none;font-size:1.1rem;}
        #view-tutorial .card,#view-ajustes .card {background:transparent !important;border:none !important;box-shadow:none !important;backdrop-filter:none !important;padding:14px 0;}
        .faq-question {background:rgba(255,255,255,0.03);border-radius:15px;padding:24px;font-weight:400;margin-bottom:5px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}.faq-question:hover {background:rgba(255,255,255,0.08);}.faq-question.active {border:1px solid var(--primary);color:var(--primary);}.faq-answer {display:none;padding:24px;background:rgba(0,0,0,0.2);border-radius:0 0 12px 12px;line-height:1.5;font-size:0.9rem;color:#ddd;margin-bottom:12px;}
        .photo-grid {display:flex;gap:14px;margin-bottom:24px;}.photo-col {flex:1;display:flex;flex-direction:column;gap:16px;}
        .photo-box {width:100%;aspect-ratio:3/4;background:rgba(255,255,255,0.05);border:2px dashed var(--border-glass);border-radius:15px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;}
        .btn-camera {display:none;}
        #clientSuggestions {max-height:150px;overflow-y:auto;background:rgba(30,30,30,0.95);border-radius:15px;margin-top:5px;display:none;border:1px solid var(--border-glass);}.suggestion-item {padding:14px;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;color:#fff;font-size:0.9rem;display:flex;justify-content:space-between;align-items:center;}.suggestion-item:active {background:var(--primary);color:#000;}
        .photo-edit-label {position:absolute;bottom:10px;background:rgba(0,0,0,0.6);color:#fff;padding:4px 10px;border-radius:24px;font-size:0.7rem;font-weight:600;display:none;pointer-events:none;}
        
        #view-result-placeholder {
            display:none;
            position:fixed;
            top:0;left:0;
            width:100%;height:100%;
            background:#000;
            z-index:9999;
            flex-direction:column;
            align-items:center;
            justify-content:center;
}

        .generated-container {
            width:100%;
            height:100%;
            display:flex;
            align-items:center;
            justify-content:center;
            touch-action:none;
}

        .generated-container img {
            width:100%;
            height:100%;
            object-fit:contain;
}

        .fab-row {
            position:absolute;
            bottom:40px;
            left:0;
            width:100%;
            display:flex;
            justify-content:center;
            gap:24px;
            z-index:10000;
            transform:translateY(0); /* VISIBLE SIEMPRE */
            opacity:1; /* VISIBLE SIEMPRE */
            transition:transform 0.4s cubic-bezier(0.175,0.885,0.32,1.27),opacity 0.4s ease;
}

        .fab-row.show-buttons {
            transform:translateY(0);
            opacity:1;
}

        .fab-mini {
            width:60px;height:60px;
            border-radius:50%;
            border:none;
            display:flex;align-items:center;justify-content:center;
            font-size:1.5rem;
            cursor:pointer;
            box-shadow:0 5px 20px rgba(0,0,0,0.5);
            color:#fff;
            transition:transform 0.2s;
}
        .fab-mini:active {transform:scale(0.9);}
        .font-selector {display:flex;gap:14px;margin-top:10px;}.font-opt {flex:1;padding:14px;text-align:center;background:rgba(255,255,255,0.05);border:1px solid transparent;border-radius:16px;cursor:pointer;font-size:0.8rem;}.font-opt.selected {border-color:var(--primary);background:rgba(255,255,255,0.1);color:var(--primary);}
        .profile-tabs {display:flex;gap:14px;margin-bottom:24px;}.p-tab {flex:1;padding:14px;border-radius:15px;background:rgba(255,255,255,0.05);color:#fff;border:none;cursor:pointer;transition:0.35s ease;display:flex;align-items:center;justify-content:center;gap:16px;font-weight:600;}.p-tab.active {background:var(--primary);color:#000;box-shadow:0 0 15px rgba(46,204,113,0.4);}
        .tab-content {display:none;}.tab-content.active {display:block;}
        .update-item {margin-bottom:18px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.05);}.update-ver {font-size:0.8rem;color:var(--primary);font-weight:800;letter-spacing:1.2px;}.update-txt {font-size:0.85rem;color:#ccc;margin-top:5px;line-height:1.4;}
        .goal-container {width:100%;margin:18px 0 10px 0;display:none;}.goal-container.show {display:block;}.progress-track {width:100%;height:8px;background:rgba(255,255,255,0.1);border-radius:16px;margin-top:5px;overflow:hidden;}.progress-fill {height:100%;background:var(--primary);width:0%;transition:width 1s ease-out;box-shadow:0 0 10px var(--primary);}.privacy-btn {margin-left:8px;color:var(--text-muted);cursor:pointer;font-size:0.9rem;transition:0.25s ease;}.privacy-btn:hover {color:var(--primary);}
        
        .tag-badge {padding:3px 8px;border-radius:6px;font-size:0.6rem;font-weight:800;text-transform:uppercase;margin-left:8px;display:inline-block;vertical-align:middle;box-shadow:0 3px 8px rgba(0,0,0,0.3);}
        .tag-vip {background:#f1c40f;color:#000;border:1px solid #d4ac0d;}.tag-good {background:#3498db;color:#fff;border:1px solid #2980b9;}.tag-alert {background:#e74c3c;color:#fff;border:1px solid #c0392b;}
        .trash-item {background:rgba(255,255,255,0.03);border:1px solid rgba(255,71,87,0.3);padding:14px;border-radius:15px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;}.trash-info {font-size:0.9rem;}.trash-meta {font-size:0.7rem;color:#aaa;margin-top:3px;display:flex;gap:14px;}.btn-restore {background:rgba(46,204,113,0.2);color:#2ecc71;border:1px solid #2ecc71;border-radius:8px;padding:5px 10px;font-size:0.8rem;cursor:pointer;}
        
        .comparison-container {position:relative;width:100%;aspect-ratio:1/1;overflow:hidden;border-radius:15px;margin-bottom:24px;border:2px solid var(--border-glass);display:none;}
        .img-comp-container {position:absolute;width:100%;height:100%;overflow:hidden;}
        .img-comp-img {display:block;width:100%;height:100%;object-fit:cover;}
        .img-comp-overlay {position:absolute;top:0;left:0;width:50%;height:100%;overflow:hidden;border-right:3px solid var(--primary);box-shadow:5px 0 15px rgba(0,0,0,0.5);z-index:2;transition:width 0.1s;}
        .comp-slider {position:absolute;z-index:9;-webkit-appearance:none;appearance:none;width:100%;height:100%;background:transparent;outline:none;margin:0;top:0;left:0;cursor:pointer;}
        .comp-slider::-webkit-slider-thumb {-webkit-appearance:none;appearance:none;width:40px;height:100vh;background:transparent;cursor:pointer;}
        .slider-handle-vis {position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:40px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#000;box-shadow:0 0 15px rgba(0,0,0,0.8);pointer-events:none;z-index:3;}

        .tag-selector-row {display:flex;gap:16px;margin-bottom:12px;flex-wrap:wrap;}
        .tag-pill {flex:1;padding:8px;border-radius:16px;text-align:center;font-size:0.75rem;font-weight:700;cursor:pointer;transition:0.25s ease;opacity:0.5;border:1px solid transparent;text-transform:uppercase;}
        .tag-pill.active {opacity:1;transform:scale(1.05);box-shadow:0 0 15px currentColor;}
        
        .confetti {position:absolute;width:10px;height:10px;background-color:#f00;animation:fall linear forwards;z-index:5000;}
        @keyframes fall {to {transform:translateY(100vh) rotate(720deg);}}
        .trophy-popup {position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);z-index:5001;font-size:5rem;color:#f1c40f;text-shadow:0 10px 30px rgba(0,0,0,0.8);animation:popTrophy 2s forwards;display:none;flex-direction:column;align-items:center;text-align:center;}
        @keyframes popTrophy {0% {transform:translate(-50%,-50%) scale(0);}50% {transform:translate(-50%,-50%) scale(1.2);}80% {transform:translate(-50%,-50%) scale(0.9);}100% {transform:translate(-50%,-50%) scale(1);opacity:0;pointer-events:none;}}
        
        .qr-container-grid {display:grid;grid-template-columns:repeat(2,1fr);gap:18px;margin-top:15px;}
        .qr-card {background:rgba(255,255,255,0.05);border-radius:15px;padding:14px;border:1px solid rgba(255,255,255,0.1);text-align:center;position:relative;transition:0.35s ease;cursor:pointer;}
        .qr-card:active {transform:scale(0.95);border-color:var(--primary);}
        .qr-card img {width:100%;border-radius:16px;aspect-ratio:1/1;object-fit:cover;}
        .qr-label {margin-top:8px;font-weight:700;color:#fff;font-size:0.8rem;text-transform:uppercase;letter-spacing:1.2px;}

        .gallery-search-row {display:flex;gap:14px;margin-bottom:18px;}
        .gallery-filter-chips {display:flex;gap:16px;overflow-x:auto;padding-bottom:10px;margin-bottom:12px;}
        .chip-client {background:rgba(255,255,255,0.1);padding:5px 12px;border-radius:24px;font-size:0.75rem;white-space:nowrap;cursor:pointer;border:1px solid transparent;transition:0.25s ease;color:#fff;}
        .chip-client.active {background:var(--primary);color:#000;font-weight:800;box-shadow:0 0 10px var(--primary);}

        .gallery-grid {display:flex;flex-direction:column;gap:14px;padding:14px;}
        /* Galería Turbo (GPU 3D) */
        .gallery-item {
            display:flex; align-items:center; justify-content:space-between;
            height:80px; background:rgba(255,255,255,0.05);
            padding:0; border:1px solid rgba(255,255,255,0.1);
            border-radius:15px; overflow:hidden;
            /* Motor Gráfico Activado */
            transform: translate3d(0,0,0);
            will-change: transform;
            backface-visibility: hidden;
        }
        .gallery-info {flex:1;padding:0 15px;display:flex;flex-direction:column;justify-content:center;cursor:pointer;}
        .gallery-actions {padding-right:15px;display:flex;gap:16px;}
        .btn-gallery-del {background:rgba(231,76,60,0.2);color:#e74c3c;border:1px solid #e74c3c;width:35px;height:35px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;}

        .fullscreen-viewer {position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:5000;display:none;flex-direction:column;justify-content:center;align-items:center;}
        .fullscreen-viewer img {max-width:100%;max-height:85vh;object-fit:contain;}
        .fullscreen-close {position:absolute;top:20px;right:20px;color:#fff;background:rgba(255,255,255,0.2);width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer;backdrop-filter:blur(5px);}

        #customPromptOverlay {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:6000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(5px);}
        .prompt-box {background:#1a1a1a;padding:25px;border-radius:24px;width:85%;max-width:320px;border:1px solid var(--primary);text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.8);}
        .prompt-box input {width:100%;padding:14px;margin:14px 0;background:#333;border:1px solid #555;color:white;border-radius:8px;}
.btn-camera-direct {
    margin-top:8px;
    padding:6px;
    font-size:0.8rem;
    background:rgba(255,255,255,0.05) !important;
    border:1px solid rgba(255,255,255,0.2);
    color:#ccc;
    width:100%;
    border-radius:16px;
}
.btn-camera-direct:active {
    background:var(--primary) !important;
    color:#000 !important;
}
/* Finanzas Turbo (GPU 3D) */
.swipe-item {
    position:relative;
    overflow:hidden;
    margin-bottom:0; 
    border-radius:0; 
    border-bottom: 1px solid rgba(255,255,255,0.08); 
    background:transparent;
    height: 55px;
    min-height: 55px;
    content-visibility:auto;
    contain-intrinsic-size:55px;
    transform: translate3d(0,0,0);
    will-change: transform;
    backface-visibility: hidden;
}

/* Capas ocultas */
.swipe-bg-layer { display:none; }
.bg-edit { display:none; }
.bg-delete { display:none; }

.swipe-front {
    position:relative;
    background:transparent; 
    padding:0 20px; 
    height: 100%;
    z-index:2;
    transition:transform 0.2s ease-out;
    display:flex;justify-content:space-between;align-items:center;
    border:none; 
    border-radius:0;
}

/* Scroll sin rebote */
.finance-list { overscroll-behavior-y: contain; } 

/* NUEVO: Grid para Resumen (Semana/Mes/Global) */
.finance-grid-view {
    display: grid;
    grid-template-columns: 1fr 1fr; /* 2 Columnas */
    gap: 12px;
    padding: 15px;
}
.fin-summary-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    min-height: 100px;
}
.fin-card-icon { font-size: 1.2rem; margin-bottom: 8px; opacity: 0.8; }
.fin-card-title { font-size: 0.7rem; font-weight: 700; color: #aaa; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
.fin-card-value { font-size: 1.2rem; color: #fff; font-weight: 800; }
.fin-card-sub { font-size: 0.6rem; color: #666; margin-top: 4px; }


    .finance-sticky-header {
        position:sticky;
        top:-35px;
        z-index:10;
        background:rgba(15,15,15,0.95);
        backdrop-filter:blur(15px);
        padding-bottom:10px;
        margin-bottom:12px;
        border-bottom:1px solid rgba(255,255,255,0.05);
}

    #modalTimeDrum {z-index:27000 !important;align-items:flex-end;}
    #modalTimeDrum .modal-card {height:auto;padding:0;background:#111;border-radius:25px 25px 0 0;width:100%;max-width:100%;padding-bottom:20px;}
    
    .drum-header {display:flex;justify-content:space-between;padding:24px 25px;background:transparent;}
    .drum-btn {background:none;border:none;font-size:0.9rem;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:1.2px;}
    .drum-cancel {color:#e74c3c;}
    .drum-done {color:var(--primary);}
    .drum-title {color:#fff;font-weight:700;font-size:1rem;}

    .drum-body {
        position:relative;
        height:250px;
        display:flex;
        justify-content:center;
        gap:0;
        background:#000;
        overflow:hidden;
        mask-image:linear-gradient(to bottom,transparent 0%,black 20%,black 80%,transparent 100%);
        -webkit-mask-image:linear-gradient(to bottom,transparent 0%,black 20%,black 80%,transparent 100%);
}
    
    .drum-highlight {
        position:absolute;
        top:50%;
        left:0;
        width:100%;
        height:50px;
        transform:translateY(-50%);
        background:var(--primary);
        opacity:0.15;
        pointer-events:none;
        z-index:5;
}
    
    .drum-col {
        width:80px;
        height:100%;
        overflow-y:scroll;
        scroll-behavior:auto;
        -ms-overflow-style:none;
        scrollbar-width:none;
        z-index:10;
        text-align:center;
        padding:100px 0;
}
    .drum-col::-webkit-scrollbar {display:none;}
    
    .drum-item {
        height:50px;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:1.2rem;
        color:#555;
        font-weight:600;
        transition:opacity 0.2s,transform 0.2s;
        opacity:0.3;
        line-height:1;
        padding:0;
        margin:0;
}
    .drum-item.active {
        color:#fff;
        font-size:1.5rem;
        opacity:1;
        font-weight:800;
        transform:scale(1.1);
}

    #modalDateSmart {z-index:27000 !important;align-items:flex-end;}
    #modalDateSmart .modal-card {height:auto;padding:0;background:#111;border-radius:25px 25px 0 0;width:100%;max-width:100%;padding-bottom:30px;}
    
    .cal-nav-bar {display:flex;justify-content:space-between;align-items:center;padding:5px 20px 15px 20px;}
    .cal-nav-btn {background:rgba(255,255,255,0.1);border:none;color:#fff;width:35px;height:35px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .cal-title-btn {background:none;border:none;color:#fff;font-size:1.1rem;font-weight:800;cursor:pointer;display:flex;align-items:center;gap:16px;}
    
    .cal-grid {display:grid;grid-template-columns:repeat(7,1fr);gap:16px;padding:0 15px;text-align:center;}
    .cal-day-label {color:#666;font-size:0.75rem;font-weight:700;padding-bottom:10px;text-transform:uppercase;}
    .cal-day {height:45px;display:flex;align-items:center;justify-content:center;border-radius:50%;color:#fff;font-weight:500;cursor:pointer;transition:0.25s ease;font-size:1rem;}
    .cal-day.empty {pointer-events:none;}
    .cal-day:active {background:rgba(255,255,255,0.1);}
    .cal-day.today {border:1px solid var(--primary);color:var(--primary);font-weight:700;}
    .cal-day.selected {background:var(--primary);color:#000 !important;font-weight:800;box-shadow:0 0 15px var(--primary);transform:scale(1.1);border:none;}

    .cal-view {display:none;}
    .cal-view.active {display:block;}
    .manual-wrapper {padding:5px;color:#ddd;line-height:1.6;}
    .manual-wrapper h2 {color:var(--primary);border-left:4px solid var(--primary);padding-left:15px;font-size:1.4rem;margin-top:30px;margin-bottom:18px;text-transform:uppercase;letter-spacing:1.2px;}
    .manual-wrapper h3 {color:#fff;font-size:1.1rem;margin-top:20px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:8px;font-weight:600;}
    .manual-wrapper p {font-size:0.9rem;margin-bottom:18px;color:#ccc;}

    .toc-mini {background:rgba(255,255,255,0.03);padding:24px;border-radius:15px;margin-bottom:25px;border:1px solid rgba(255,255,255,0.05);}
    .toc-mini ul {list-style:none;padding:0;display:flex;flex-wrap:wrap;gap:16px;justify-content:center;}
    .toc-mini a {color:var(--primary);text-decoration:none;font-weight:700;font-size:0.75rem;background:rgba(0,0,0,0.4);padding:8px 12px;border-radius:24px;border:1px solid rgba(255,255,255,0.1);transition:0.25s ease;}
    .toc-mini a:active {background:var(--primary);color:#000;}

    .step-list {list-style:none;padding:0;}
    .step-list li {margin-bottom:12px;padding-left:35px;position:relative;font-size:0.9rem;}
    .step-list li::before {content:"\f00c";font-family:"Font Awesome 6 Free";font-weight:900;position:absolute;left:0;top:2px;color:var(--primary);background:rgba(46,204,113,0.1);width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.7rem;border:1px solid rgba(46,204,113,0.3);}

    .tip-box {background:rgba(52,152,219,0.1);border-left:4px solid #3498db;padding:14px;margin:18px 0;font-size:0.85rem;border-radius:0 8px 8px 0;}
    .alert-box {background:rgba(231,76,60,0.1);border-left:4px solid #e74c3c;padding:14px;margin:18px 0;font-size:0.85rem;border-radius:0 8px 8px 0;color:#ffcccc;}

    .img-placeholder-mini {width:100%;height:180px;background:rgba(0,0,0,0.3);border:2px dashed rgba(255,255,255,0.2);border-radius:15px;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:18px 0;color:#666;text-align:center;padding:14px;}
    .img-placeholder-mini i {font-size:2rem;color:var(--primary);margin-bottom:12px;opacity:0.85;}
    
    #splashOverlay {
        position:fixed;top:0;left:0;width:100%;height:100%;
        background-color:#000;z-index:30000;
        display:flex;flex-direction:column;align-items:center;justify-content:center;
        transition:opacity 0.5s ease-out;
    }
    #splashIcon {
        font-size: 5rem; color: #f1c40f;
        filter: drop-shadow(0 0 20px rgba(241,196,15,0.4));
        animation: pulse-gold 1s infinite;
    }
    #splashText {
        margin-top: 20px; color: #fff; font-size: 0.9rem;
        font-weight: 800; letter-spacing: 3px; text-transform: uppercase;
        animation: fadeText 1s infinite alternate;
    }
    @keyframes pulse-gold { 0% {transform:scale(1);} 50% {transform:scale(1.1);} 100% {transform:scale(1);} }
    @keyframes fadeText { from {opacity:0.6;} to {opacity:1;} }
    .profile-header-wrapper {
        display:flex;
        flex-direction:column;
        align-items:center;
        cursor:pointer;
        margin-top:5px;
        z-index:50;
        margin-right:auto;
        margin-left:5px;
}
    .profile-header-circle {
        width:55px;height:55px;
        border-radius:50%;
        border:2px solid var(--primary);
        background:rgba(255,255,255,0.1);
        display:flex;align-items:center;justify-content:center;
        overflow:visible;
        box-shadow:0 0 15px rgba(0,0,0,0.5);
        transition:transform 0.2s;
        position:relative;
}
    .status-dot {
        position:absolute;
        bottom:-2px;
        right:-2px;
        width:16px;
        height:16px;
        border-radius:50%;
        border:2px solid #000;
        z-index:10;
        transition:background 0.3s;
}
    .status-dot.online {background-color:#2ecc71;box-shadow:0 0 8px #2ecc71;}
    .status-dot.offline {background-color:#e74c3c;box-shadow:0 0 8px #e74c3c;}

    .profile-header-circle:active {transform:scale(0.9);border-color:#fff;}
    .profile-header-circle img {width:100%;height:100%;object-fit:cover;border-radius:50%;}
    .profile-header-circle i {font-size:1.5rem;color:var(--primary);}
    .profile-header-text {font-size:0.6rem;font-weight:800;color:var(--primary);margin-top:3px;letter-spacing:1.2px;text-transform:uppercase;text-shadow:0 2px 5px #000;}

    .profile-dashboard-grid {display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:20px;}
    .profile-dash-card {
        background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,255,255,0.1);
        border-radius:24px;
        padding:24px 15px;
        display:flex;flex-direction:column;align-items:center;justify-content:center;
        text-align:center;
        gap:14px;transition:0.25s ease;
}
    .profile-dash-card:active {background:var(--primary);color:#000;transform:scale(0.95);}
    .profile-dash-card i {font-size:1.8rem;margin-bottom:5px;color:var(--primary);}
    .profile-dash-card:active i {color:#000;}
    .profile-dash-label {font-size:0.8rem;font-weight:700;text-transform:uppercase;}
.btn-google {background:#fff;color:#333;border:none;padding:14px;border-radius:16px;font-weight:700;width:100%;display:flex;align-items:center;justify-content:center;gap:14px;margin-top:10px;box-shadow:0 6px 16px rgba(255,255,255,0.1);transition:transform 0.2s;}
.btn-google:active {transform:scale(0.95);}

#fabRequests {
    position:fixed; bottom:95px; left:25px;
    width:55px; height:55px;
    background:#e74c3c; border-radius:50%; color:#fff;
    display:none; align-items:center; justify-content:center;
    font-size:1.2rem; box-shadow:0 5px 20px rgba(231,76,60,0.6);
    z-index:1998; cursor:pointer;
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    animation:bounceIn 0.5s cubic-bezier(0.175,0.885,0.32,1.27);
}
#fabRequests.fab-hidden { transform: scale(0) !important; pointer-events: none; }
#fabRequests:active {transform:scale(0.9);}
.req-counter {position:absolute;top:-5px;right:-5px;background:#fff;color:#e74c3c;width:25px;height:25px;border-radius:50%;font-size:0.8rem;font-weight:900;display:flex;align-items:center;justify-content:center;border:2px solid #e74c3c;}
@keyframes bounceIn {0% {transform:scale(0);opacity:0;}60% {transform:scale(1.1);}100% {transform:scale(1);opacity:1;}}

.inbox-header-actions {display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.1);padding:14px 15px;border-radius:15px;margin-bottom:18px;}
.inbox-card {transition:0.25s ease;border:2px solid transparent;}
.inbox-card {transition:0.25s ease;border:1px solid rgba(255,255,255,0.1);}
.inbox-card.selected {
    background:rgba(46,204,113,0.15) !important;
    border:1px solid #2ecc71 !important;
    transform:scale(0.98);
}
.mini-contact-btn {
    width:35px;height:35px;border-radius:50%;border:none;
    display:flex;align-items:center;justify-content:center;
    font-size:0.9rem;color:#fff;cursor:pointer;
}


#gameOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 26000; pointer-events: none; display: none;
    overflow: hidden;
}
.spotlight-box {
    position: absolute;
    box-shadow: 0 0 0 9999px rgba(0,0,0,0.7);
    border-radius: 50%;
    transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
    pointer-events: auto;
    cursor: pointer;
    border: 2px solid var(--primary);
    background: rgba(46, 204, 113, 0.1);
    animation: pulse-border 2s infinite;
    z-index: 25001;
    display: none;
}
@keyframes pulse-border {
    0% { transform: scale(1); box-shadow: 0 0 0 9999px rgba(0,0,0,0.7), 0 0 15px rgba(46, 204, 113, 0.5); }
    50% { transform: scale(1.02); box-shadow: 0 0 0 9999px rgba(0,0,0,0.7), 0 0 25px rgba(46, 204, 113, 0.8); }
    100% { transform: scale(1); box-shadow: 0 0 0 9999px rgba(0,0,0,0.7), 0 0 15px rgba(46, 204, 113, 0.5); }
}
.tut-tooltip {
    position: absolute;
    background: #000;
    border: 2px solid #fff;
    color: #fff;
    padding: 25px;
    border-radius: 24px;
    width: 280px;
    text-align: center;
    pointer-events: none; 
    z-index: 25010 !important;
    font-size: 1.1rem;
    font-weight: 600;
    box-shadow: 0 0 30px rgba(255,255,255,0.3);
    transition: all 0.3s ease;
}

.tut-tooltip h4 { margin: 0 0 8px 0; color: #f1c40f; text-transform: uppercase; font-weight: 900; letter-spacing: 1.2px; font-size: 1.4rem; text-shadow: 0 0 10px #f1c40f; }
.tut-tooltip p { margin: 0; color: #fff; line-height: 1.5; font-weight: 500; }
.tap-hint { font-size: 0.8rem; color: #fff; margin-top: 12px; font-weight: 700; opacity: 1; animation: blinkHint 1.5s infinite; text-transform: uppercase; letter-spacing: 1px; border: 1px solid #fff; border-radius: 20px; padding: 5px; display: inline-block; }
@keyframes blinkHint { 0%,100% {opacity:0.6; transform: scale(1);} 50% {opacity:1; transform: scale(1.05);} }

.tut-hand {
    position: absolute;
    font-size: 4.5rem;
    color: #fff;
    text-shadow: 0 0 20px rgba(255,255,255,0.8);
    z-index: 25005;
    pointer-events: none;
    transition: all 0.5s ease;
    display: none;
    filter: drop-shadow(0 0 10px rgba(0,0,0,1));
}
.tut-hand.point { animation: point-move 1.5s infinite; }
.tut-hand.swipe-right { animation: swipe-r 1.5s infinite; }
.tut-hand.swipe-left { animation: swipe-l 1.5s infinite; }

@keyframes point-move { 0% {transform:translateY(0);} 50% {transform:translateY(-20px);} 100% {transform:translateY(0);} }
@keyframes swipe-r { 0% {transform:translateX(0) rotate(0deg);opacity:1;} 60% {transform:translateX(100px) rotate(10deg);opacity:0;} 100% {transform:translateX(0);opacity:0;} }
@keyframes swipe-l { 0% {transform:translateX(0) rotate(0deg);opacity:1;} 60% {transform:translateX(-100px) rotate(-10deg);opacity:0;} 100% {transform:translateX(0);opacity:0;} }

.hard-lock-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 24000;
    display: none;
}
.element-highlight-lock {
    position: relative; /* Por defecto para elementos normales */
    z-index: 24001 !important;
    pointer-events: auto !important;
    background: rgba(30,30,30,0.95);
    box-shadow: 0 0 0 5px var(--primary), 0 0 50px rgba(0,0,0,0.8);
    border-radius: 12px;
}
/* CORRECCIÓN: Si el elemento ya era fixed (como el FAB), forzamos que siga siéndolo */
#quickFab.element-highlight-lock {
    position: fixed !important;
}
    /* NUEVO: Animación y Estilo Exclusivo para el Tutorial de la Pluma */
@keyframes tap-strong {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(0.8) translateY(10px); }
}
.tut-hand.heavy-tap {
    font-size: 4rem;
    color: #f1c40f; /* Mano Dorada */
    text-shadow: 0 0 20px rgba(0,0,0,1);
    animation: tap-strong 1s infinite;
    z-index: 25006 !important;
}
.fab-super-lock {
    z-index: 25005 !important;
    pointer-events: auto !important;
    /* Esta sombra gigante simula la capa oscura sin tapar el botón */
    box-shadow: 0 0 0 9999px rgba(0,0,0,0.9) !important; 
}

/* Animación de entrada triunfal desde abajo */
@keyframes superSlideUp {
    0% { transform: translate(-50%, 100vh) scale(0.5); opacity: 0; }
    60% { transform: translate(-50%, -20px) scale(1.1); opacity: 1; }
    80% { transform: translate(-50%, 10px) scale(0.95); }
    100% { transform: translate(-50%, 0) scale(1); }
}

.tut-special-entry {
    animation: superSlideUp 1.2s cubic-bezier(0.22, 1, 0.36, 1) forwards !important;
    border-color: var(--primary) !important;
    box-shadow: 0 0 50px rgba(46, 204, 113, 0.6) !important;
    bottom: 20% !important; 
    top: auto !important;
}

/* ANIMACIÓN FLECHA INTELIGENTE */
@keyframes arrow-fly {
    0% {
        opacity: 0;
        /* Empieza 300px más abajo de su destino */
        transform: translate(-50%, 300px) scale(0.5) rotate(-45deg);
    }
    50% {
        opacity: 1;
        /* Llega al destino */
        transform: translate(-50%, 0) scale(1.2) rotate(-45deg);
    }
    100% {
        opacity: 1;
        /* Se mantiene en el destino palpitando */
        transform: translate(-50%, 0) scale(1) rotate(-45deg);
    }
}

.tut-arrow-anim {
    position: fixed !important;
    z-index: 25006 !important;
    color: #f1c40f !important;
    text-shadow: 0 0 15px rgba(0,0,0,1);
    pointer-events: none;
    /* Animación infinita para que no desaparezca */
    animation: arrow-fly 1.5s infinite ease-in-out;
}
.btn-skip-tut {
    position: absolute;
    top: 40px; right: 20px;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255,255,255,0.3);
    color: #fff;
    padding: 8px 16px;
    border-radius: 30px;
    font-weight: 700;
    font-size: 0.8rem;
    z-index: 26005; /* Encima de todo */
    backdrop-filter: blur(5px);
    cursor: pointer;
    pointer-events: auto;
    transition: top 0.4s ease, bottom 0.4s ease;
}
.btn-skip-tut:active { background: rgba(255,255,255,0.3); }
.btn-skip-tut.moved {
    top: auto;
    bottom: 40px; /* Se mueve abajo si estorba arriba */
}
    /* --- ESTILOS HISTORIA (WHATSAPP STYLE) --- */
    .story-add-btn {
        width: 50px; height: 50px; border-radius: 50%;
        background: linear-gradient(45deg, #f09433, #e6683c, #dc2743);
        border: 3px solid #1a1a1a;
        display: flex; align-items: center; justify-content: center;
        color: #fff; font-size: 1.2rem; cursor: pointer;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        position: relative; z-index: 10;
        transition: transform 0.2s;
    }
    .story-add-btn:active { transform: scale(0.9); }
    
    .story-preview-mini {
        width: 50px; height: 50px; border-radius: 50%;
        border: 2px solid #f09433; padding: 2px;
        object-fit: cover; background: #000;
    }

    /* --- ESTILOS CATALOGO (NUEVO) --- */
    .catalog-btn {
        width: 50px; height: 50px; border-radius: 50%;
        background: linear-gradient(135deg, #3498db, #2980b9);
        border: 3px solid #1a1a1a;
        display: flex; align-items: center; justify-content: center;
        color: #fff; font-size: 1.1rem; cursor: pointer;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        transition: transform 0.2s;
    }
    .catalog-btn:active { transform: scale(0.9); }

    .catalog-grid {
        display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;
        padding: 10px; max-height: 60vh; overflow-y: auto;
    }
    .catalog-item {
        position: relative; aspect-ratio: 1/1;
        border-radius: 12px; overflow: hidden;
        border: 1px solid rgba(255,255,255,0.1);
        background: #000;
        cursor: pointer;
    }
    .catalog-img { width: 100%; height: 100%; object-fit: cover; }
    .catalog-add {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2);
        color: #aaa; cursor: pointer; aspect-ratio: 1/1; border-radius: 12px;
    }
    .catalog-add:active { background: rgba(255,255,255,0.1); color: #fff; }

    /* VISOR GESTIÓN (TIPO WHATSAPP) */
    #storyManagerModal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 30000; display: none;
        flex-direction: column;
    }
    #storyManagerImg {
        width: 100%; flex: 1; object-fit: contain;
        background: #000; transition: transform 0.3s;
    }
    
    .story-stats-sheet {
        position: absolute; bottom: 0; left: 0; width: 100%;
        height: 75vh; background: rgba(20,20,20,0.98);
        border-radius: 25px 25px 0 0;
        transform: translateY(calc(100% - 60px));
        /* Velocidad aumentada a 0.2s para efecto WhatsApp */
        transition: transform 0.2s cubic-bezier(0.1, 0.9, 0.2, 1); 
        backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1);
        display: flex; flex-direction: column;
    }
    .story-timer-badge {
        position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px;
        color: #fff; font-size: 0.8rem; font-weight: 600;
        border: 1px solid rgba(255,255,255,0.2); z-index: 40; pointer-events: none;
    }
    /* FIX ALERTAS: Subir z-index para que tape el modal de historia */
    .custom-alert-overlay { z-index: 40000 !important; }
    .story-stats-sheet.expanded { transform: translateY(0); }
    
    .sheet-handle {
        width: 40px; height: 5px; background: rgba(255,255,255,0.3);
        border-radius: 5px; margin: 15px auto;
    }
    .sheet-header {
        text-align: center; color: #fff; padding-bottom: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        display: flex; justify-content: center; align-items: center; gap: 10px;
        font-weight: 700; cursor: pointer;
    }
    .stats-list { flex: 1; overflow-y: auto; padding: 0 20px; }
    
    .stat-item {
        display: flex; align-items: center; padding: 12px 0;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .stat-avatar {
        width: 45px; height: 45px; border-radius: 50%;
        background: #333; color: #fff;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; margin-right: 15px; font-size: 1rem;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .stat-info { flex: 1; overflow: hidden; }
    .stat-name { color: #fff; font-weight: 800; font-size: 0.95rem; margin-bottom: 2px; }
    .stat-action { font-size: 0.85rem; color: #bbb; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .stat-icon-container { display: flex; gap: 10px; align-items: center; margin-left: 10px; }
    .stat-heart { color: #e74c3c; font-size: 1.4rem; animation: popIn 0.3s; }

    /* --- MOTOR DE ESCALADO AUTOMÁTICO (FIX GLOBAL) --- */
    
    /* 1. Ajuste base de la fuente: Esto hace que todos los 'rem' se achiquen en pantallas pequeñas */
    @media screen and (max-width: 380px) {
        html { font-size: 13px !important; } /* Reduce todo un 20% */
        .profile-hero-section { padding-top: 30px !important; } /* Sube el perfil */
        .modal-card { padding: 15px !important; } /* Gana espacio en bordes */
    }

    /* 2. Forzar que NINGÚN texto se salga de la pantalla */
    * {
        overflow-wrap: break-word;
        word-wrap: break-word;
    }

    /* 3. Reparación Global de Botones y Textos Largos */
    button, .btn, .nav-btn, .f-tab, .font-opt, .drum-btn {
        white-space: normal !important; /* Permite que el texto baje de línea */
        line-height: 1.1 !important;    /* Junta las líneas para que quepan */
        text-align: center !important;
        flex-shrink: 1 !important;      /* Permite que el botón se encoja */
    }

    /* 4. Ajuste de las filas de iconos/texto para que no se desborden */
    .profile-id-row, .info-row, .status-toggle-left {
        flex-wrap: wrap !important;
        justify-content: center !important;
        text-align: center !important;
    }
    
    /* 5. Forzar que los inputs no rompan el ancho */
    input, select {
        max-width: 100% !important;
        min-width: 0 !important; /* Vital para flexbox */
    }

    /* 6. Corrección específica para la fila de pestañas de Auth (Login/Crear) */
    #authTabsRow {
        display: grid !important;
        grid-template-columns: 1fr 1fr 1fr 1fr !important; /* 4 columnas exactas */
        gap: 2px !important;
        width: 100% !important;
    }
    #authTabsRow button {
        font-size: 0.6rem !important; /* Letra más pequeña automática */
        padding: 8px 2px !important;
        height: auto !important;
        min-height: 40px !important;
    }

    /* 7. Ajuste del Modal para pantallas cortas */
    .modal-card {
        max-height: 95vh !important;
        height: auto !important;
        padding-bottom: 80px !important; /* Espacio para scroll */
    }

</style>



</head>
<body>
    <div id="splashOverlay">
        <i class="fas fa-scissors" id="splashIcon"></i>
        <div id="splashText">BARBER MANAGER</div>
    </div>

    <div id="hardLockLayer" class="hard-lock-overlay"></div>
    <div id="gameOverlay">
        <button id="btnSkipTut" class="btn-skip-tut" onclick="skipTutorial()">OMITIR ✕</button>
        <div id="tutSpotlight" class="spotlight-box"></div>
        <i id="tutHand" class="fas fa-hand-pointer tut-hand"></i>
        <div id="tutTooltip" class="tut-tooltip">
            <h4 id="tutTitle">Título</h4>
            <p id="tutDesc">Descripción</p>
            <div id="tutHint" class="tap-hint"><i class="fas fa-fingerprint"></i> Toca para continuar</div>
        </div>
    </div>

    <div class="bg-image" id="appBackground"></div>
    <div class="bg-overlay"></div>
    <div id="trophyAnim" class="trophy-popup"><i class="fas fa-trophy"></i><div style="font-size:1.5rem;color:#fff;font-family:var(--font-main);margin-top:10px;">🎖️NUEVO RECORD!</div></div>

    <div class="app-container">
        
        <div id="fabRequests" onclick="abrirBandejaSolicitudes()">
            <i class="fas fa-bell"></i>
            <div class="req-counter" id="reqCounterBadge">0</div>
        </div>

        <div id="fabVoice" onclick="activarMicrofono()" style="display:none;">
            <i class="fas fa-microphone"></i>
        </div>

        <div id="quickFab" onclick="openQuickMode()"><i class="fas fa-calendar-plus"></i></div>

        <div id="view-agenda" class="view-content active">
            <div class="sticky-container">
                <header style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;">
                    <div style="flex:1;">
                        <h2 style="margin:0;font-size:1.8rem;cursor:pointer;" id="agendaTitle" onclick="openQRModal()"><i class="fas fa-qrcode"></i> Agenda</h2>
                        <div style="font-size:0.9rem;color:var(--text-muted);margin-top:5px;" id="todayDate">--/--/----</div>
                        <div id="brandDisplay">BARBERIA CON ESTILO</div>
                        <div id="realClock">--:--:--</div>
                    </div>

                    <div class="profile-header-wrapper" onclick="openMyProfileModal()">
                        <div class="profile-header-circle">
                            <img id="headerProfileImg" style="display:none;">
                            <div id="headerProfileIcon"><i class="fas fa-user"></i></div>
                            <div id="statusDot" class="status-dot offline"></div>
                        </div>
                        <div class="profile-header-text">PERFIL</div>
                    </div>

                    <div class="card clickable-card card-transparent" style="padding:14px 10px;margin-left:20px;min-width:120px;text-align:right;border:none;" onclick="openFinanceModal()">
                        <small style="font-size:0.7rem;text-transform:uppercase;letter-spacing:1.2px;" id="headerLabel">Ganancia</small>
                        <div style="font-weight:800;color:var(--primary);font-size:1.4rem;margin:5px 0;display:flex;align-items:center;justify-content:flex-end;">
                            <span id="currencySign">$</span><span id="dailyTotal">0</span>
                            <i class="fas fa-eye privacy-btn" id="btnPrivacy" onclick="event.stopPropagation();togglePrivacy()"></i>
                        </div>
                        <small style="font-size:0.6rem;color:var(--text-muted);">Historial <i class="fas fa-arrow-right"></i></small>
                    </div>
                </header>

                <div id="monthlyGoalContainer" class="goal-container">
                    <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--text-muted);font-weight:600;">
                        <span>META MENSUAL <span id="percentText">0%</span></span>
                        <span id="goalText">$0 / $80000</span>
                    </div>
                    <div class="progress-track">
                        <div id="goalBar" class="progress-fill"></div>
                    </div>
                </div>

                <div style="display:flex;gap:16px;">
                    <input type="text" id="agendaDateDisplay" style="margin:0;text-align:center;font-weight:700;cursor:pointer;flex:1;" readonly onclick="openDateSmart('agenda')">
                    <input type="hidden" id="dateSelector">
                    <button onclick="toggleAllPending()" id="btnToggleAll" class="btn btn-outline" style="width:auto;padding:0 18px;" title="Ver todos"><i class="fas fa-list-ul"></i></button>
                    <button onclick="verAgendaManana()" class="btn btn-outline" style="width:auto;padding:0 15px;" title="Historia Mañana"><i class="fas fa-mountain-sun"></i></button>
                </div>
            </div>

            <div class="content-body">
                <div id="agendaList" style="min-height:200px;"></div>
            </div>
        </div>

       <div id="view-clientes" class="view-content">
            <div class="sticky-container">
                <h2 style="margin:0;"> <i class="fas fa-id-card"></i> PERFILES</h2>
                <div class="search-row">
                    <div class="search-wrapper">
                        <input type="text" id="clientSearch" placeholder="🔍 Buscar perfil..." oninput="renderClients()">
                        <i class="fas fa-times search-clear" id="btnClearSearch" onclick="clearClientSearch()"></i>
                    </div>
                    <button class="btn-search-action" onclick="openGalleryModal()" title="Ver Estéticas" style="border-color:var(--primary);color:var(--primary);"><i class="fas fa-images"></i></button>
                </div>
            </div>

            <div class="content-body">
                <div id="clientsListContainer"></div>
            </div>
        </div> 
        <div id="view-contactos" class="view-content">
            <div id="alphaBubble" class="letter-bubble">A</div>
            <div id="alphaNav" class="alphabet-nav"></div>

            <div class="sticky-container">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h2 style="margin:0;font-size:1.4rem;">🧾 Contactos <span id="contactsCount" style="font-size:1rem;color:var(--text-muted);font-weight:400;">(0)</span></h2>
                </div>
                <div class="search-row" style="margin-top:10px;">
                     <div class="search-wrapper">
                        <input type="text" id="contactSearch" placeholder="🔍 Buscar contacto..." oninput="renderContactsList()">
                    </div>
                    <button class="btn-search-action" onclick="openCustomAdd()" title="Agregar Contacto" style="background:#2ecc71;color:#000;"><i class="fas fa-user-plus"></i></button>
                </div>
            </div>
            
            <div class="content-body" style="padding-bottom:100px;">
                <div id="contactsListContainer"></div>
            </div>
            
        </div>

        <div id="view-tutorial" class="view-content">
            <div class="sticky-container">
                <h2 style="margin-bottom:24px;">📖 Centro de Ayuda</h2>
                <div class="tutorial-tabs">
                    <button class="f-tab" onclick="switchTutorialTab('faq',this)">Tutorial Completo</button>
                    <button class="f-tab active" onclick="switchTutorialTab('new',this)">Lo Mas Nuevo</button>
                </div>
            </div>
            
            <div class="content-body">
                               <div id="tut-faq" class="tab-content manual-wrapper" style="padding-bottom:50px;">
                    
                    <div style="text-align:center;margin-bottom:20px;">
                        <h2 style="border:none;padding:0;margin:0;font-size:1.6rem;color:var(--primary);text-transform:uppercase;letter-spacing:2px;">Manual PRO 12.0</h2>
                        <small style="color:var(--text-muted);">Guía definitiva del sistema</small>
                    </div>

                    <div class="card" style="text-align:center;border:1px solid var(--primary);background:rgba(46,204,113,0.1);">
                        <i class="fas fa-hand-pointer" style="font-size:2rem;color:var(--primary);margin-bottom:10px;"></i>
                        <h3 style="margin:0 0 10px 0;">¿Eres nuevo?</h3>
                        <p style="font-size:0.8rem;margin-bottom:15px;">Inicia el recorrido interactivo que te enseña a usar la app paso a paso tocando la pantalla.</p>
                        <button class="btn" onclick="iniciarTutorialMaestro()" style="background:var(--primary);color:#000;font-weight:800;text-transform:uppercase;box-shadow:0 0 15px var(--primary);">
                            ▶ INICIAR TUTORIAL
                        </button>
                    </div>

                    <section>
                        <h2>1. Agenda y Gestos</h2>
                        <div class="card">
                            <ul class="step-list">
                                <li><strong>Deslizar Derecha ➡️:</strong> Abre el Perfil del Cliente, sus fotos y su historial.</li>
                                <li><strong>Deslizar Izquierda ⬅️:</strong> Elimina el turno (va a la Papelera por 24h).</li>
                                <li><strong>Tocar Turno:</strong> Muestra opciones de contacto (Llamar 📞, WhatsApp 💬, SMS).</li>
                                <li><strong>Ojo 👁️ (Privacidad):</strong> Toca el icono junto al dinero total para ocultar los montos ($****) frente a clientes.</li>
                            </ul>
                        </div>
                    </section>

                    <section>
                        <h2>2. Modo Rápido (La Pluma)</h2>
                        <div class="card">
                            <p>El botón flotante <i class="fas fa-feather-pointed"></i> es para velocidad extrema:</p>
                            <ul class="step-list">
                                <li><strong>Teclado Gigante:</strong> Escribe el precio rápido.</li>
                                <li><strong>Buscador Inteligente:</strong> Escribe el nombre. Si no existe, se crea al instante.</li>
                                <li><strong>Botón Sol ☀️:</strong> Cambia la fecha a "Mañana" con un solo toque.</li>
                            </ul>
                        </div>
                    </section>

                    <section>
                        <h2>3. Perfil Online y Ubicación</h2>
                        <div class="card">
                            <p>Toca tu <strong>FOTO DE PERFIL</strong> (arriba a la derecha) para entrar al Panel de Control:</p>
                            <ul class="step-list">
                                <li><strong>Switch Online:</strong> Activa o desactiva tu visibilidad en la app de clientes.</li>
                                <li><strong>Ubicación GPS:</strong> En "Editar Datos", usa el mapa para fijar la posición exacta de tu barbería.</li>
                                <li><strong>Horarios:</strong> Define qué días y horas trabajas en "Disponibilidad Horaria".</li>
                            </ul>
                        </div>
                    </section>

                    <section>
                        <h2>4. Estudio y Marketing</h2>
                        <div class="card">
                            <p>Ve al perfil de un cliente y entra en la pestaña <strong>Fotos</strong>:</p>
                            <ul class="step-list">
                                <li><strong>Antes y Después:</strong> Toma dos fotos y pulsa "Generar Estética".</li>
                                <li><strong>Marca de Agua:</strong> La app crea un collage automático con TU LOGO listo para Instagram.</li>
                                <li><strong>Ahorro Memoria:</strong> Las fotos se comprimen automáticamente para no llenar tu celular.</li>
                            </ul>
                        </div>
                    </section>

                    <section>
                        <h2>5. Finanzas y QR</h2>
                        <div class="card">
                            <ul class="step-list">
                                <li><strong>Gráficas:</strong> Toca el dinero total para ver ganancias diarias, semanales y mensuales.</li>
                                <li><strong>Ingresos Extra:</strong> Usa el botón (+) en Finanzas para sumar propinas o ventas de productos.</li>
                                <li><strong>Billetera QR:</strong> Toca el título "Agenda" (arriba izquierda) para mostrar tus códigos de pago al cliente.</li>
                            </ul>
                        </div>
                    </section>

                    <section>
                        <h2>Preguntas Frecuentes (FAQ)</h2>
                        
                        <div class="faq-question" onclick="toggleFaq(this)">1. ¿Cómo recupero mi contraseña? <i class="fas fa-chevron-down"></i></div>
                        <div class="faq-answer">Ve a tu Perfil (toca tu foto) > Editar Datos. Escribe tu teléfono y clave, y toca el icono de la LLAVE 🔑 para restaurar tu cuenta.</div>

                        <div class="faq-question" onclick="toggleFaq(this)">2. ¿Si borro la app pierdo todo? <i class="fas fa-chevron-down"></i></div>
                        <div class="faq-answer">Si haces copias de seguridad NO. Ve a Ajustes > Datos Locales > Backup y guarda el archivo. Luego usa "Restaurar" para volver a cargarlo.</div>

                        <div class="faq-question" onclick="toggleFaq(this)">3. ¿Cómo cambio los precios de mis cortes? <i class="fas fa-chevron-down"></i></div>
                        <div class="faq-answer">Ve a Ajustes > Mis Servicios. Ahí puedes agregar, editar o borrar los cortes y precios que ven tus clientes.</div>

                        <div class="faq-question" onclick="toggleFaq(this)">4. ¿Cómo veo las solicitudes online? <i class="fas fa-chevron-down"></i></div>
                        <div class="faq-answer">Aparecerá un botón rojo con una campana 🔔 abajo a la derecha cuando tengas clientes esperando confirmación.</div>

                        <div class="faq-question" onclick="toggleFaq(this)">5. ¿Cómo cambio el nombre de mi barbería? <i class="fas fa-chevron-down"></i></div>
                        <div class="faq-answer">Ve a Ajustes > Marca & Editor. Escribe el nombre y pulsa "Guardar". También puedes cambiar el color y la fuente del recibo.</div>

                        <div class="faq-question" onclick="toggleFaq(this)">6. ¿Borré un turno por error, qué hago? <i class="fas fa-chevron-down"></i></div>
                        <div class="faq-answer">Tranquilo. Ve a Ajustes > Papelera. Todo lo que borras se queda ahí por 24 horas antes de eliminarse para siempre.</div>

                        <div class="faq-question" onclick="toggleFaq(this)">7. ¿Cómo importo mis contactos del teléfono? <i class="fas fa-chevron-down"></i></div>
                        <div class="faq-answer">Ve a la sección "Contactos" y pulsa el botón (+) verde. Si estás en Android, te pedirá permiso para leer tu agenda.</div>

                        <div class="faq-question" onclick="toggleFaq(this)">8. ¿Cómo pongo el modo oscuro/color? <i class="fas fa-chevron-down"></i></div>
                        <div class="faq-answer">Ve a Ajustes > Apariencia > Temas Visuales. Tienes opciones como Matrix, Oro, Neón, Rojo, etc.</div>

                        <div class="faq-question" onclick="toggleFaq(this)">9. ¿Para qué sirven las etiquetas (VIP)? <i class="fas fa-chevron-down"></i></div>
                        <div class="faq-answer">Al crear un cliente, asígnale una etiqueta (VIP, Paga Bien, Poco Frecuente). Verás un distintivo de color junto a su nombre en la agenda.</div>

                        <div class="faq-question" onclick="toggleFaq(this)">10. ¿La app funciona sin internet? <i class="fas fa-chevron-down"></i></div>
                        <div class="faq-answer">SÍ. Toda la gestión local (agenda, caja, fotos) es offline. Solo necesitas internet para publicar tu perfil y recibir solicitudes online.</div>
                    </section>

                </div>


                <div id="tut-new" class="tab-content active">
                    <div class="card">
                        <h3 style="color:var(--primary);margin-bottom:24px;font-weight:400;">Destacados del Manual</h3>
                        
                        <div class="update-item">
                            <div class="update-ver">MARKETING</div>
                            <div class="update-txt">📸 <b>Estudio Antes/Después:</b> Aprende a crear collages automáticos con tu logo listos para subir a Instagram. (Ver Manual Sec. 3)</div>
                        </div>

                        <div class="update-item">
                            <div class="update-ver">VELOCIDAD</div>
                            <div class="update-txt">⚡ <b>Turno Rápido:</b> Usa el botón flotante para agendar citas en 5 segundos con la interfaz oscura. (Ver Manual Sec. 2)</div>
                        </div>

                        <div class="update-item">
                            <div class="update-ver">TRUCO PRO</div>
                            <div class="update-txt">👆 <b>Gestos de Agenda:</b> Desliza un turno a la derecha ➡️ para ver su Perfil,o a la izquierda ⬅️ para Borrarlo. (Ver Manual Sec. 1)</div>
                        </div>

                    </div>
                </div>

            </div>
        </div>
         <div id="view-ajustes" class="view-content">
            <div class="sticky-container">
                <h2 style="margin-bottom:0;">⚙️  Ajustes</h2>
            </div>
            <div class="content-body">
                

                <div class="card" style="display:flex;gap:14px;align-items:center;justify-content:space-between;border-color:rgba(231,76,60,0.4);cursor:pointer;" onclick="openTrashModal()">
                    <div><h3 style="margin:0;font-weight:400;color:#e74c3c;"><i class="fas fa-trash-alt"></i> Papelera de Reciclaje</h3><small style="color:var(--text-muted);">Restaurar eliminados (24h)</small></div><i class="fas fa-chevron-right" style="color:#e74c3c;"></i>
                </div>

                <div class="card" style="border:1px solid var(--primary); background:rgba(46,204,113,0.05);">
                    <h3 style="margin-bottom:12px;font-weight:400;color:var(--primary);"><i class="fas fa-microphone"></i> Barber Voice IA</h3>
                    <div class="toggle-row" style="margin-bottom:5px;">
                        <span>Activar Comandos de Voz</span>
                        <label class="switch"><input type="checkbox" id="toggleVoice" onchange="toggleVoiceSettings()"><span class="slider"></span></label>
                    </div>
                    <small style="color:#88aa88;font-size:0.75rem;">Habilita el micrófono para dictar turnos o consultar ganancias.</small>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:18px;font-weight:400;">🏷 Marca & Editor</h3>
                    <div class="toggle-row"><span>Mostrar Marca</span><label class="switch"><input type="checkbox" id="toggleBrand" onchange="saveBrandSettings()" checked><span class="slider"></span></label></div>
                    <input type="text" id="brandTextInput" value="BARBERIA CON ESTILO" oninput="saveBrandSettings()" placeholder="Tu nombre...">
                    <button class="btn-color-picker" onclick="document.getElementById('brandColorInput').click()"><span>🌈Seleccionar Color</span></button>
                    <input type="color" id="brandColorInput" value="#ffffff" onchange="saveBrandSettings()" style="visibility:hidden;position:absolute;">
                    <div class="font-selector" style="margin-top:10px;">
                        <div class="font-opt font-modern selected" onclick="selectFont('font-modern',this)">Moderna</div>
                        <div class="font-opt font-elegant" onclick="selectFont('font-elegant',this)">Elegante</div>
                        <div class="font-opt font-urban" onclick="selectFont('font-urban',this)">Urbana</div>
                        <div class="font-opt font-cyber" onclick="selectFont('font-cyber',this)">Cyber</div>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom:18px;font-weight:400;">🎯 Meta Mensual</h3>
                    <div class="toggle-row"><span>Mostrar Barra</span><label class="switch"><input type="checkbox" id="toggleGoal" onchange="saveGoalSettings()"><span class="slider"></span></label></div>
                    <input type="number" id="inputGoalAmount" value="80000" onchange="saveGoalSettings()">
                </div>
                <div class="card">
                    <h3 style="margin-bottom:18px;font-weight:400;">🎨 Apariencia</h3>
                    <button class="btn btn-outline" onclick="Android.cambiarFondo()" style="margin-bottom:24px;"><i class="fas fa-image"></i> Cambiar Fondo</button>
                    <button class="btn btn-outline" onclick="toggleThemePanel()" style="width:100%;display:flex;justify-content:space-between;align-items:center;"><span>🎨 Temas Visuales</span><i class="fas fa-chevron-down" id="themeArrow"></i></button>
                    <div id="themeContainer" class="theme-collapse"><div class="theme-grid">
                        <div class="theme-option" style="background:#2ecc71;color:#000;border:1px solid #0f0;" onclick="previewTheme('matrix')">Matrix</div>
                        <div class="theme-option" style="background:#d4af37;color:#000;" onclick="previewTheme('oro')">Oro</div>
                        <div class="theme-option" style="background:#00ffea;color:#000;" onclick="previewTheme('urbano')">Neon</div>
                        <div class="theme-option" style="background:#ffffff;color:#000;" onclick="previewTheme('clasico')">White</div>
                        <div class="theme-option" style="background:#ff4757;color:#fff;" onclick="previewTheme('rojo')">Red</div>
                        <div class="theme-option" style="background:#ff00ff;color:#fff;" onclick="previewTheme('cyber')">Cyber</div>
                        <div class="theme-option" style="background:#00a8ff;color:#fff;" onclick="previewTheme('ocean')">Ocean</div>
                    </div></div>
                </div>
                

                <div class="card">
                    <h3 style="margin-bottom:18px;font-weight:400;">💾 Datos Locales</h3>
                    
                    <div style="display:flex;gap:14px;margin-top:5px;">

                        <button class="btn btn-outline" onclick="descargarBackup()"><i class="fas fa-download"></i> Backup</button>
                        <button class="btn btn-outline" onclick="Android.buscarBackup()"><i class="fas fa-upload"></i> Restaurar</button>
                    </div>
                </div>
        </div>
    </div>
    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="navTo('agenda')"><i class="fas fa-calendar-alt"></i> Agenda</button>
        <button class="nav-btn" onclick="navTo('clientes')"><i class="fas fa-users"></i> Clientes</button>
        <button class="nav-btn" onclick="navTo('contactos')"><i class="fas fa-address-book"></i> Contactos</button>
        <button class="nav-btn" onclick="navTo('tutorial')"><i class="fas fa-book-open"></i> Tutorial</button>
        <button class="nav-btn" onclick="navTo('ajustes')"><i class="fas fa-sliders-h"></i> Ajustes</button>
    </nav>
    <div id="modalAdd" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-card" style="position:relative;">
            <button class="modal-close-x" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div style="text-align:center;margin-bottom:24px;"><h3 style="color:var(--primary);margin:0;font-size:1.5rem;" id="modalTitle">Nuevo Turno</h3></div>
            <input type="hidden" id="editId">
            <input type="hidden" id="inputTag"> <div id="searchContainer" style="margin-bottom:18px;">
                <label class="modal-label">Buscar Cliente</label>
                <div class="input-with-clear">
                    <input type="text" id="apptSearch" placeholder="🔍 Buscar nombre..." oninput="handleSearchInput()" autocomplete="off" style="border:1px solid var(--primary);background:rgba(46,204,113,0.1);">
                    <button class="btn-clear-input" id="btnXSearch" onclick="clearSearchInput()" style="display:none;color:var(--primary);"><i class="fas fa-times"></i></button>
                </div>
                <div id="clientSuggestions"></div>
            </div>

            <div id="manualInputContainer" style="display:none;padding:14px;background:rgba(255,255,255,0.02);border-radius:15px;margin-bottom:18px;border:1px solid rgba(255,255,255,0.05);">
                <label class="modal-label" style="color:var(--primary);">Datos Manuales</label>
                <div class="modal-row" style="margin-bottom:12px;">
                    <div class="modal-col"><input type="text" id="inputClient" placeholder="Nombre..." autocomplete="off"></div>
                </div>
                <div class="modal-row" style="margin-bottom:0;">
                    <div class="modal-col"><input type="tel" id="inputPhone" placeholder="Telefono (Opcional)" style="flex:1;"></div>
                </div>
            </div>

            <div class="modal-row" id="actionButtonsRow" style="margin-bottom:18px;">
                <div class="modal-col">
                    <button class="btn-big-action btn-big-import" onclick="importContact()">
                        <i class="fas fa-address-book"></i> IMPORTAR
                    </button>
                </div>
                <div class="modal-col">
                    <button class="btn-big-action btn-big-manual" onclick="toggleManualInput()">
                        <i class="fas fa-user-plus"></i> NUEVO
                    </button>
                </div>
            </div>

            <div class="modal-row">
                <div class="modal-col">
                    <label class="modal-label">Fecha</label>
                    <input type="text" id="inputDateDisplay" style="font-weight:700;text-align:center;cursor:pointer;" readonly onclick="openDateSmart()" placeholder="--/--/----">
                    <input type="hidden" id="inputDate"> 
                </div>
                <div class="modal-col">
                    <label class="modal-label">Hora</label>
                    <div style="display:flex;align-items:center;">
                        <input type="text" id="inputTime" style="flex:1;cursor:pointer;text-align:center;font-weight:700;" readonly onclick="openTimeDrum()" placeholder="--:-- --">
                        <button type="button" class="time-picker-btn" onclick="toggleSmartGrid()">🕒</button>
                    </div>
                    <div id="timeSlotsContainer" class="time-slots-grid"></div>
                </div>
            </div>
            <div class="modal-row" id="containerPrice">
                <div class="modal-col"><label class="modal-label">Precio ($)</label><input type="number" id="inputPrice" value="500"></div>
            </div>
            <button class="btn" onclick="attemptSaveAppointment()" style="margin-top:20px;box-shadow:0 5px 20px var(--primary);" id="btnSaveAppt">Confirmar Turno</button>
        </div>
    </div>

    <div id="modalQuickClient" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-card">
            <button class="modal-close-x" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div style="text-align:center;margin-bottom:24px;"><h3 style="color:var(--primary);">Agregar Cliente</h3></div>
            <label class="modal-label">Nombre</label><input type="text" id="quickName" placeholder="Escribe...">
            <label class="modal-label">Telefono</label><input type="tel" id="quickPhone" placeholder="Escribe...">
            <input type="hidden" id="quickTagInput">
            <label class="modal-label" style="margin-top:10px;">Etiqueta</label>
            <div class="tag-selector-row" id="quickTagsRow">
                <div class="tag-pill tag-vip" style="color:#000;" onclick="selectTagInQuick(this,'vip')">VIP</div>
                <div class="tag-pill tag-good" style="color:#fff;" onclick="selectTagInQuick(this,'good')">PAGA BIEN</div>
                <div class="tag-pill tag-alert" style="color:#fff;" onclick="selectTagInQuick(this,'alert')">POCO FREC.</div>
            </div>
            <button class="btn" onclick="saveQuickClient()" style="margin-top:25px;">Guardar Cliente</button>
        </div>
    </div>

    <div id="modalManualEntry" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-card">
            <button class="modal-close-x" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div style="text-align:center;margin-bottom:24px;"><h3 style="color:var(--primary);">Agregar Extra</h3></div>
            <label class="modal-label">Motivo</label><input type="text" id="manualReason" placeholder="Ej:Propina..." autocomplete="off">
            <label class="modal-label">Monto ($)</label><input type="number" id="manualAmount" placeholder="0">
            <button class="btn" onclick="saveManualEntry()">Guardar</button>
        </div>
    </div>

    <div id="modalClientProfile" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-card" style="height:85vh;padding-top:25px;">
            <button class="modal-close-x" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div style="text-align:center;margin-bottom:18px;">
                <div style="width:60px;height:60px;background:var(--primary);color:#000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:800;margin:0 auto 10px auto;" id="profileAvatar">A</div>
                <h3 style="color:var(--text);margin:0;" id="profileName">Nombre Cliente</h3>
                <div style="font-size:0.8rem;color:var(--text-muted);" id="profileVisits">0 Visitas</div>
            </div>
            <div class="profile-tabs">
    <button class="p-tab active" onclick="switchTab('history')">
        <i class="fas fa-history"></i> Historial
    </button>
    
    <button class="p-tab" onclick="switchTab('studio')">
        <i class="fas fa-camera"></i> Fotos
    </button>
    
    <button class="p-tab" style="background:rgba(52,152,219,0.2);color:#3498db;border:1px solid #3498db;" onclick="triggerQuickPhoto()">
        <i class="fas fa-camera-retro"></i> Rápida
    </button>
</div>
            <div id="tab-history" class="tab-content active" style="overflow-y:auto;max-height:50vh;"><div id="profileHistoryList" style="padding-bottom:50px;"></div></div>
            <div id="tab-studio" class="tab-content">
                <div id="comparisonViewer" class="comparison-container">
                    <div class="img-comp-container"><img id="compImg1" class="img-comp-img"></div>
                    <div id="compOverlay" class="img-comp-overlay"><img id="compImg2" class="img-comp-img"></div>
                    <div id="sliderHandle" class="slider-handle-vis"><i class="fas fa-arrows-alt-h"></i></div>
                    <input type="range" min="0" max="100" value="50" class="comp-slider" oninput="moveSlider(this.value)">
                </div>
                <div class="photo-grid">
                    <div class="photo-col">
                        <div class="photo-box" onclick="triggerPhotoSelect(1)">
                            <i class="fas fa-images"></i><span style="font-size:0.7rem;color:var(--text-muted);margin-top:5px;">ANTES</span>
                            <img id="previewImg1"><div class="photo-edit-label" id="editLabel1">Cambiar</div>
                        </div>
                        <button class="btn btn-outline btn-camera-direct" onclick="triggerCameraDirect(1)"><i class="fas fa-camera"></i> Cámara</button>
                    </div>
                    <div class="photo-col">
                         <div class="photo-box" onclick="triggerPhotoSelect(2)">
                            <i class="fas fa-images"></i><span style="font-size:0.7rem;color:var(--text-muted);margin-top:5px;">DESPUES</span> 
                            <img id="previewImg2"><div class="photo-edit-label" id="editLabel2">Cambiar</div>
                        </div>
                        <button class="btn btn-outline btn-camera-direct" onclick="triggerCameraDirect(2)"><i class="fas fa-camera"></i> Cámara</button>
                    </div>
                </div>
                <div style="margin-top:20px;width:100%;">
                        <button class="btn" onclick="generateCollage()"> 
                            📸 Generar Estética
                        </button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <div id="modalQR" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-card">
            <button class="modal-close-x" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div style="text-align:center;margin-bottom:24px;">
                <h3 style="color:var(--primary);margin:0;"><i class="fas fa-qrcode"></i> QR de Cobro</h3>
                <small style="color:var(--text-muted);">Tus medios de pago</small>
            </div>
            <div id="qrContainer" class="qr-container-grid"></div>
        </div>
    </div>

    <div id="modalGallery" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-card" style="height:85vh;">
            <button class="modal-close-x" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div style="text-align:center;margin-bottom:18px;">
                <h3 style="color:var(--primary);margin:0;"><i class="fas fa-camera-retro"></i> Antes y Despues</h3>
                <small style="color:var(--text-muted);">Tus trabajos guardados</small>
            </div>
            <div class="gallery-search-row">
                <div class="search-wrapper" style="width:100%">
                    <input type="text" id="gallerySearch" placeholder="🔍 Buscar cliente..." oninput="renderGalleryList()">
                </div>
            </div>
            <div id="galleryChips" class="gallery-filter-chips"></div>
            <div id="galleryList" class="gallery-grid" style="padding-bottom:50px;"></div>
        </div>
    </div>

    <div id="modalEditClient" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-card">
            <button class="modal-close-x" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div style="text-align:center;margin-bottom:24px;"><h3 style="color:var(--primary);">Editar Contacto</h3></div>
            <input type="hidden" id="editClientOldName">
            <label class="modal-label">Nombre</label><input type="text" id="editClientName">
            <label class="modal-label">Telefono</label><input type="tel" id="editClientPhone">
            <input type="hidden" id="editClientTagInput">
            <label class="modal-label" style="margin-top:10px;">Etiqueta</label>
            <div class="tag-selector-row" id="editTagsRow">
                <div class="tag-pill tag-vip" style="color:#000;" onclick="selectTagInEdit(this,'vip')">VIP</div>
                <div class="tag-pill tag-good" style="color:#fff;" onclick="selectTagInEdit(this,'good')">PAGA BIEN</div>
                <div class="tag-pill tag-alert" style="color:#fff;" onclick="selectTagInEdit(this,'alert')">POCO FREC.</div>
            </div>
            <button class="btn" onclick="saveClientEdit()" style="margin-top:15px;">Guardar Cambios</button>
        </div>
    </div>

    <div id="modalTrash" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-card">
            <button class="modal-close-x" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div style="text-align:center;margin-bottom:24px;">
                <h3 style="color:#e74c3c;margin:0;"><i class="fas fa-trash-alt"></i> Papelera</h3>
                <small style="color:var(--text-muted);">Los elementos se eliminan en 24h</small>
            </div>
            <div id="trashListContainer" style="min-height:200px;"></div>
        </div>
    </div>

       <div id="modalFinance" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-card" style="height:100% !important;max-height:100% !important;border-radius:25px 25px 0 0;padding:0 !important;display:flex;flex-direction:column;background:#000;">
            
            <div class="finance-sticky-header" style="margin:0;padding:25px 20px 10px 20px;background:#000;border-bottom:1px solid rgba(255,255,255,0.1);">
                <div style="text-align:center;margin-bottom:24px;position:relative;">
                    <button onclick="closeModal()" style="position:absolute;left:0;top:0;background:none;border:none;color:#fff;font-size:1.2rem;"><i class="fas fa-arrow-left"></i></button>
                    <h3 style="color:var(--primary);margin:0;">Finanzas</h3>
                </div>
                
                <div class="finance-tabs">
                    <button class="f-tab active" onclick="renderFinance('day',this)">Dia</button>
                    <button class="f-tab" onclick="renderFinance('week',this)">Sem</button>
                    <button class="f-tab" onclick="renderFinance('month',this)">Mes</button>
                    <button class="f-tab" onclick="renderFinance('global',this)">Global</button>
                </div>
                
                <div id="weeklyChart" class="chart-container" style="height:100px;margin-bottom:18px;"></div>
                
                <div style="text-align:center;padding:8px;background:rgba(255,255,255,0.05);border-radius:15px;position:relative;border:1px solid rgba(255,255,255,0.05);">
                    <small style="color:var(--text-muted);text-transform:uppercase;letter-spacing:1.2px;">Recaudado</small>
                    <div style="font-size:2.2rem;font-weight:800;color:var(--primary);margin-top:2px;">$<span id="financeTotal">0</span></div>
                    <button onclick="openManualEntryModal()" style="position:absolute;right:15px;top:50%;transform:translateY(-50%);background:var(--primary);color:#000;border:none;width:40px;height:40px;border-radius:50%;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(0,0,0,0.5);"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div id="financeList" class="finance-list" style="flex:1;overflow-y:auto;padding:0 !important;margin:0 !important;max-height:none;"></div>
        </div>
    </div>

        <div id="modalBackupSelector" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-card">
            <button class="modal-close-x" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div style="text-align:center;margin-bottom:24px;">
                <h3 style="color:var(--primary);margin:0;">💾 Guardar Datos</h3>
                <small style="color:var(--text-muted);">Elige qué quieres incluir</small>
            </div>
            
            <div style="background:rgba(255,255,255,0.05);padding:24px;border-radius:15px;margin-bottom:18px;border:1px solid rgba(255,255,255,0.1);">
                <div class="toggle-row"><span>👥 Clientes</span><label class="switch"><input type="checkbox" id="bkClients" checked><span class="slider"></span></label></div>
                <div class="toggle-row"><span>📅 Turnos y Finanzas</span><label class="switch"><input type="checkbox" id="bkAppts" checked><span class="slider"></span></label></div>
                <div class="toggle-row"><span>📷 Estéticas (Fotos)</span><label class="switch"><input type="checkbox" id="bkPhotos" checked><span class="slider"></span></label></div>
                <div class="toggle-row"><span>💳 QR de Pago</span><label class="switch"><input type="checkbox" id="bkQRs" checked><span class="slider"></span></label></div>
                <div class="toggle-row"><span>🖼️ Fondo de Pantalla</span><label class="switch"><input type="checkbox" id="bkBg" checked><span class="slider"></span></label></div>
            </div>

            <div style="display:flex;gap:14px;">
                <button class="btn btn-outline" onclick="toggleAllBackupChecks()">Todos</button>
                <button class="btn" onclick="ejecutarBackupFinal()">💾 Descargar Ahora</button>
            </div>
        </div>
    </div>
    <div id="modalAddContact" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-card">
            <button class="modal-close-x" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div style="text-align:center;margin-bottom:24px;">
                <h3 style="color:var(--primary);margin:0;">Nuevo Contacto</h3>
            </div>
            
            <label class="modal-label">Nombre</label>
            <input type="text" id="newContactName" placeholder="Nombre completo..." autocomplete="off">
            
            <label class="modal-label">Teléfono</label>
            <input type="tel" id="newContactPhone" placeholder="Número..." autocomplete="off">

            <div style="background:rgba(255,255,255,0.05);padding:24px;border-radius:15px;margin-top:15px;border:1px solid rgba(255,255,255,0.1);">
                <div class="toggle-row" style="margin-bottom:12px;border:none;padding:0;">
                    <span>📲 Sincronizar en Móvil</span>
                    <label class="switch"><input type="checkbox" id="syncNewContact" checked><span class="slider"></span></label>
                </div>
                
                <label class="modal-label" style="margin-top:10px;">Guardar en cuenta:</label>
                <select id="accountSelectorNew" style="background:#000;">
                    <option value="Phone">Teléfono / Local</option>
                </select>
            </div>

            <button class="btn" onclick="submitNewContact()" style="margin-top:20px;">Guardar Contacto</button>
        </div>
    </div>

    <div id="modalCustomEditContact" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-card">
            <button class="modal-close-x" onclick="closeModal()"><i class="fas fa-times"></i></button>
            <div style="text-align:center;margin-bottom:24px;">
                <h3 style="color:var(--primary);margin:0;">Editar Contacto</h3>
            </div>
            
            <input type="hidden" id="editContactOriginalName">
            <label class="modal-label">Nombre</label>
            <input type="text" id="editContactName">
            
            <label class="modal-label">Teléfono</label>
            <input type="tel" id="editContactPhone">

            <div style="background:rgba(255,255,255,0.05);padding:24px;border-radius:15px;margin-top:15px;border:1px solid rgba(255,255,255,0.1);">
                 <div class="toggle-row" style="margin-bottom:0;border:none;padding:0;">
                    <span>📲 Actualizar en Móvil</span>
                    <label class="switch"><input type="checkbox" id="syncEditContact" checked><span class="slider"></span></label>
                </div>
            </div>

            <button class="btn" onclick="submitEditContact()" style="margin-top:20px;">Guardar Cambios</button>
        </div>
    </div>

    <div id="modalTimeDrum" class="modal" onclick="if(event.target === this) closeTimeDrum()">
        <div class="modal-card">
            <div class="drum-header">

                <button class="drum-btn drum-cancel" onclick="closeTimeDrum()">Cancelar</button>
                <div style="color:#fff;font-weight:bold;">Definir hora</div>
                <button class="drum-btn drum-done" onclick="confirmTimeDrum()">Realiz.</button>
            </div>
            <div class="drum-body">
                <div class="drum-highlight"></div>
                <div class="drum-col" id="drumHours"></div>
                <div class="drum-col" id="drumMinutes"></div> <div class="drum-col" id="drumAmPm"></div>
            </div>
        </div>
    </div>

    <div id="modalDateSmart" class="modal" onclick="if(event.target === this) closeDateSmart()">
        <div class="modal-card">
            <div class="drum-header">
                <button class="drum-btn drum-cancel" onclick="closeDateSmart()">Cancelar</button>
                <div class="drum-title">Definir fecha</div>
                <button class="drum-btn drum-done" onclick="confirmDateSmart()">Confirmar</button>
            </div>

            <div id="calViewDays" class="cal-view active">
                <div class="cal-nav-bar">
                    <button class="cal-nav-btn" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                    <button class="cal-title-btn" onclick="toggleCalView()">
                        <span id="calDisplayMonth">--</span> <span id="calDisplayYear">----</span> <i class="fas fa-caret-down"></i>
                    </button>
                    <button class="cal-nav-btn" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="cal-grid" style="margin-bottom:5px;">
                    <div class="cal-day-label">D</div><div class="cal-day-label">L</div><div class="cal-day-label">M</div>
                    <div class="cal-day-label">M</div><div class="cal-day-label">J</div><div class="cal-day-label">V</div><div class="cal-day-label">S</div>
                </div>
                <div id="calDaysContainer" class="cal-grid"></div>
            </div>

            <div id="calViewDrum" class="cal-view">
                <div style="text-align:center;padding:14px;color:#888;font-size:0.8rem;">Desliza para cambiar año</div>
                <div class="drum-body" style="height:200px;">
                    <div class="drum-highlight"></div>
                    <div class="drum-col" id="drumCalMonth" style="flex:1.5;"></div>
                    <div class="drum-col" id="drumCalYear" style="flex:1;"></div>
                </div>
            </div>
        </div>
    </div>

            <div id="modalInbox" class="modal" style="z-index:3500 !important;" onclick="if(event.target === this) document.getElementById('modalInbox').classList.remove('open')">

        <div class="modal-card">
            <button class="modal-close-x" onclick="document.getElementById('modalInbox').classList.remove('open')"><i class="fas fa-times"></i></button>
            <div style="text-align:center;margin-bottom:24px;">
                <h3 style="color:#f1c40f;margin:0;"><i class="fas fa-inbox"></i> Solicitudes</h3>
                <small style="color:var(--text-muted);">Clientes esperando confirmación</small>
            </div>
            <div id="inboxList" style="min-height:200px;padding-bottom:50px;"></div>
        </div>
    </div>

    <div id="customPromptOverlay">
        <div class="prompt-box">

            <h3 style="color:var(--primary);margin-bottom:18px;">💳 Nombre del QR</h3>
            <input type="text" id="promptInput" placeholder="Ej:Bancolombia,Nequi..." autocomplete="off">
            <div style="display:flex;gap:14px;margin-top:20px;justify-content:center;">
                <button class="btn btn-outline" onclick="closeCustomPrompt()">Cancelar</button>
                <button class="btn" onclick="confirmCustomPrompt()">Guardar</button>
            </div>
        </div>
    </div>

    <div id="fullscreenViewer" class="fullscreen-viewer">
        <div class="fullscreen-close" onclick="closeFullscreenViewer()"><i class="fas fa-times"></i></div>
        <img id="fullscreenImg">
    </div>

    <div id="storyManagerModal">
        <div id="storyTimeLeft" class="story-timer-badge">⏳ Calculando...</div>

        <div style="flex:1; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;" id="storyManagerTouchZone">
            <img id="storyManagerImg" src="">
            
            <button onclick="document.getElementById('inputStoryUpload').click()" style="position:absolute; top:40px; right:80px; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.2); color:#fff; width:45px; height:45px; border-radius:50%; font-size:1.1rem; cursor:pointer; z-index:50;">
                <i class="fas fa-pen"></i>
            </button>

            <button onclick="borrarMiHistoria()" style="position:absolute; top:40px; right:20px; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.2); color:#e74c3c; width:45px; height:45px; border-radius:50%; font-size:1.1rem; cursor:pointer; z-index:50;">
                <i class="fas fa-trash-alt"></i>
            </button>
            
            <button onclick="cerrarStoryManager()" style="position:absolute; top:40px; left:20px; background:rgba(0,0,0,0.5); border:none; color:#fff; width:45px; height:45px; border-radius:50%; font-size:1.5rem; cursor:pointer; z-index:50;">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div id="storyStatsSheet" class="story-stats-sheet">
            <div class="sheet-handle" onclick="toggleStatsSheet()"></div>
            <div class="sheet-header" onclick="toggleStatsSheet()">
                <i class="fas fa-eye"></i> 
                <span id="storyViewsCount">0 Interacciones</span>
                <i class="fas fa-chevron-up" id="sheetArrow" style="font-size:0.8rem; margin-left:5px; transition:transform 0.3s;"></i>
            </div>
            
            <div id="storyStatsList" class="stats-list">
                <div style="text-align:center; padding:30px; color:#666;">Cargando...</div>
            </div>
        </div>
    </div>
    
    <div id="view-result-placeholder" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:6000;background:rgba(0,0,0,0.9);flex-direction:column;align-items:center;justify-content:center;">
        
        <div id="resultContainer" class="generated-container" style="width:100%;flex:1;display:flex;align-items:center;justify-content:center;padding-bottom:120px;">
            <img id="finalImage" style="width:100%;height:100%;object-fit:contain;">
        </div>

        <div id="fabRow" class="fab-row" style="position:absolute;bottom:40px;left:0;width:100%;display:flex;justify-content:center;gap:18px;z-index:6001;">
            
            <button class="fab-mini" style="background:#2ecc71;" onclick="saveImageToGallery(); showToast('Guardando...', '💾', 'GALERÍA')">
                <i class="fas fa-save"></i>
            </button>

                       <button id="btnPrivacyResult" class="fab-mini" style="background:#34495e;" onclick="toggleAgendaPrivacy(); showToast('Cambiando Modo', '🕵️', 'PRIVACIDAD')">
                <i class="fas fa-user-secret"></i>
            </button>


            <button class="fab-mini" style="background:#3498db;" onclick="shareImage(); showToast('Abriendo...', '🚀', 'COMPARTIR')">
                <i class="fas fa-share-alt"></i>
            </button>
            
            <button class="fab-mini" style="background:#e74c3c;" onclick="document.getElementById('view-result-placeholder').style.display='none'">
                <i class="fas fa-times"></i>
            </button>

        </div>
</div>
    </div>

    <div id="quickModeOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);z-index:24500;flex-direction:column;padding:24px;">
        
        <div style="text-align:center;margin-bottom:18px;position:relative;">
            <i class="fas fa-chevron-left" onclick="closeQuickMode()" style="position:absolute;left:0;top:50%;transform:translateY(-50%);font-size:1.5rem;color:#fff;padding:14px;cursor:pointer;"></i>
            <h2 class="font-elegant" style="color:var(--primary);font-size:2.5rem;margin:0;">Turno Rápido</h2>
        </div>

                <div style="display:flex;gap:14px;margin-bottom:18px;height:70px;">
            <div style="flex:1;background:rgba(255,255,255,0.05);border-radius:15px;border:1px solid rgba(255,255,255,0.1);display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative;" id="priceContainer" onclick="event.stopPropagation()">
                <small style="color:#aaa;font-size:0.6rem;text-transform:uppercase;">Precio ($)</small>
                <div id="quickPriceDisplay" onclick="openNumKeyboard()" style="color:var(--primary);font-weight:800;font-size:1.4rem;">500</div>
                <input type="hidden" id="quickPriceInput" value="500">
                
                <div id="customNumKeyboard">
                    <div class="num-key" onclick="pressNum('1')">1</div><div class="num-key" onclick="pressNum('2')">2</div><div class="num-key" onclick="pressNum('3')">3</div>
                    <div class="num-key" onclick="pressNum('4')">4</div><div class="num-key" onclick="pressNum('5')">5</div><div class="num-key" onclick="pressNum('6')">6</div>
                    <div class="num-key" onclick="pressNum('7')">7</div><div class="num-key" onclick="pressNum('8')">8</div><div class="num-key" onclick="pressNum('9')">9</div>
                    <div class="num-key del" onclick="pressNum('del')"><i class="fas fa-backspace"></i></div>
                    <div class="num-key" onclick="pressNum('0')">0</div>
                    <div class="num-key confirm" onclick="closeNumKeyboard()"><i class="fas fa-check"></i></div>
                </div>
            </div>

            <div style="flex:2;background:rgba(255,255,255,0.05);border-radius:15px;border:1px solid rgba(255,255,255,0.1);display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;" onclick="openDateSmart('quick')">

                <small style="color:#aaa;font-size:0.6rem;text-transform:uppercase;">Fecha</small>
                <div id="quickDateDisplay" style="font-size:1.4rem;font-weight:800;color:#fff;">--/--</div>
                <input type="hidden" id="quickDateValue">
            </div>

            <div style="flex:1;background:rgba(255,255,255,0.05);border-radius:15px;border:1px solid rgba(255,255,255,0.1);display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;" onclick="setQuickTomorrow()">
                <i class="fas fa-sun" style="color:#f1c40f;font-size:1.2rem;margin-bottom:2px;"></i>
                <small style="color:#fff;font-size:0.6rem;font-weight:bold;">Mañana</small>
            </div>
        </div>

        <div style="display:flex;flex:1;gap:18px;overflow:hidden;">
            <div style="flex:1;display:flex;flex-direction:column;position:relative;">
                
                                                <div style="position:relative;margin-bottom:12px;">
                    <input type="text" id="quickClientInput" placeholder="🔍 Buscar nombre..." style="width:100%;font-size:1.1rem;padding:24px 50px 15px 15px;border:1px solid #444;border-radius:15px;background:rgba(0,0,0,0.5);color:#fff;" oninput="handleQuickClientSearch()" autocomplete="off">
                    
                    <input type="hidden" id="quickClientPhone">
                    
                    <i class="fas fa-times" id="btnQuickClear" onclick="clearQuickInput()" style="position:absolute;right:15px;top:50%;transform:translateY(-50%);color:#e74c3c;font-size:1.4rem;cursor:pointer;display:none;padding:14px;z-index:10;"></i>
                </div>


                
                <div id="quickClientList" style="flex:1;overflow-y:auto;background:rgba(255,255,255,0.02);border-radius:15px;border:1px solid rgba(255,255,255,0.05);padding:5px;margin-bottom:12px;"></div>

                <button id="btnQuickConfirm" class="btn" style="height:60px;font-size:1.2rem;display:none;background:var(--primary);color:#000;box-shadow:0 0 20px var(--primary);text-transform:uppercase;" onclick="saveQuickModeAppointment()">
                    CONFIRMAR
                </button>
            </div>

            <div style="width:85px;display:flex;flex-direction:column;background:rgba(255,255,255,0.05);border-radius:15px;border:1px solid rgba(255,255,255,0.1);overflow:hidden;">
                <div id="btnManualTime" onclick="openTimeDrumFromQuick()" style="text-align:center;padding:14px 2px;font-weight:800;background:rgba(46,204,113,0.15);font-size:0.6rem;color:var(--primary);cursor:pointer;border-bottom:1px solid var(--border-glass);text-transform:uppercase;letter-spacing:0.8px;">
                    🕒 MANUAL
                </div>
                <div id="quickTimeGrid" style="flex:1;overflow-y:auto;padding:5px;display:flex;flex-direction:column;gap:14px;"></div>
                <input type="hidden" id="quickTimeInput">
            </div>
        </div>
    </div>

    <div id="customAlert" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <i id="alertIcon" class="fas fa-exclamation-triangle fa-3x" style="color:#ff9800;margin-bottom:18px;"></i>
            <h3 id="alertTitle" style="margin-bottom:12px;">T铆tulo</h3>
            <p id="alertMessage" style="color:var(--text-muted);margin-bottom:25px;line-height:1.5;">Mensaje</p>
            <div id="alertButtons" style="display:flex;gap:14px;justify-content:center;"></div>
        </div>
    </div>
    <div id="toast-container"></div>
   <div id="modalMyProfile" class="modal" onclick="if(event.target === this) closeModal()">
    <div class="modal-card" style="height:100vh;padding-top:15px;border-radius:30px 30px 0 0;background:rgba(10,10,10,0.98);position:relative;overflow-y:auto;">
            <div style="position:absolute;top:20px;left:20px;z-index:25;display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.05);padding:4px 10px;border-radius:20px;border:1px solid rgba(255,255,255,0.1);">
            <span style="font-family:monospace;font-size:0.65rem;color:#888;">ID: <span id="displayMyID" style="color:#fff;font-weight:bold;">...</span></span>
            <i class="fas fa-copy" onclick="copiarIDPortapapeles()" style="font-size:0.7rem;color:var(--primary);cursor:pointer;padding:5px;"></i>
        </div>

        <button class="modal-close-x" onclick="closeModal()" style="z-index:20;"><i class="fas fa-times"></i></button>

        <div class="profile-hero-section">
            <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
                <div class="profile-avatar-container">
                    <img id="profileImagePreview" src="" class="profile-avatar-img">
                    <div id="profileAvatarDefault" class="profile-avatar-default"><i class="fas fa-user"></i></div>
                    <label for="uploadProfilePic" class="profile-camera-btn"><i class="fas fa-camera"></i></label>
                    <input type="file" id="uploadProfilePic" accept="image/*" style="display:none" onchange="subirFotoPerfil(this)">
                </div>
                <div id="profileStatusBadge" class="profile-status-badge offline" style="margin:0;align-self:center;font-size:0.55rem;padding:3px 8px;">
                    <span class="status-dot-animated"></span>
                    <span id="statusTextBadge">Desconectado</span>
                </div>
            </div>


            <div id="catalogBtnContainer" style="display:flex; flex-direction:column; align-items:center; gap:3px;" onclick="abrirCatalogoModal()">
                <div class="catalog-btn" style="width:45px; height:45px; font-size:1rem;"><i class="fas fa-images"></i></div>
                <div style="font-size:0.55rem; color:#3498db; font-weight:800; letter-spacing:0.5px; text-transform:uppercase;">CATÁLOGO</div>
            </div>

            <div id="storyBtnContainer" style="display:flex; flex-direction:column; align-items:center; gap:3px;" onclick="triggerStoryAction()">
                <div id="btnStoryAdd" class="story-add-btn" style="width:45px; height:45px; font-size:1rem;"><i class="fas fa-plus"></i></div>
                <img id="myActiveStoryThumb" class="story-preview-mini" style="display:none; width:45px; height:45px;">
                <div style="font-size:0.55rem; color:#f09433; font-weight:800; letter-spacing:0.5px; text-transform:uppercase;">HISTORIA</div>
            </div>

            <input type="file" id="inputStoryUpload" accept="image/*" style="display:none;" onchange="handleStoryFile(this)">
        </div>
                <div style="text-align:center; width:100%; margin-top:-10px; margin-bottom:15px; z-index:10; position:relative;">
            <div id="displayBrandName" class="profile-brand-name" style="font-size:2rem; text-shadow:0 5px 15px rgba(0,0,0,0.5); letter-spacing:1px;">Tu Negocio</div>
        </div>


        <div class="profile-status-toggle-card">
            <div class="status-toggle-left">
                <i class="fas fa-broadcast-tower" id="iconOnlineStatus" style="font-size:1.5rem; margin-bottom:5px;"></i>
                <div class="status-toggle-title" id="toggleStatusTitle">Online - Recibiendo Clientes</div>
                <div class="status-toggle-subtitle" id="toggleStatusSubtitle">Disponible para citas</div>
            </div>
            <label class="switch-large">
                <input type="checkbox" id="toggleOnlineSwitch" onchange="alternarDisponibilidadPro(this.checked)">
                <span class="slider-large"></span>
            </label>
        </div>

        <div class="profile-stats-grid">
            <div class="stat-card" onclick="openFinanceModal()">
                <i class="fas fa-users" style="color:#2ecc71;"></i>
                <div class="stat-value" id="statClientesToday">0</div>
                <div class="stat-label">CLIENTES HOY</div>
            </div>
            <div class="stat-card" onclick="openFinanceModal()">
                <i class="fas fa-chart-line" style="color:#2ecc71;"></i>
                <div class="stat-value" id="statGananciaSemana">$0</div>
                <div class="stat-label">ESTA SEMANA</div>
            </div>
            <div class="stat-card" onclick="verMisResenasPro()" style="border:1px solid #f1c40f;">
                <i class="fas fa-star" style="color:#f1c40f;"></i>
                <div class="stat-value" id="statValoracion">5.0</div>
                <div class="stat-label">VALORACIÓN</div>
            </div>
        </div>

        <div class="profile-section-card">
            <div class="section-header">
                <i class="fas fa-phone-alt"></i>
                <span>Información de Contacto</span>
                <button class="btn-edit-mini" onclick="openEditDataModal()"><i class="fas fa-pencil-alt"></i></button>
            </div>
            <div class="info-row">
                <span class="info-label">Teléfono:</span>
                <span class="info-value" id="displayBrandPhone">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">WhatsApp:</span>
                <a href="#" id="linkWhatsApp" class="info-link" onclick="abrirWhatsAppPropio();return false;">
                    <i class="fab fa-whatsapp"></i> Enviar mensaje
                </a>
            </div>
        </div>

        <div class="profile-section-card">
            <div class="section-header">
                <i class="fas fa-calendar-check"></i>
                <span>Disponibilidad Horaria</span>
                <button class="btn-edit-mini" onclick="abrirConfigHorarios()"><i class="fas fa-cog"></i></button>
            </div>
            <div class="availability-grid" id="availabilityGrid">
                <div class="day-slot active" data-day="lun"><span class="day-name">Lun</span><span class="day-hours">8:00 - 18:00</span></div>
                <div class="day-slot active" data-day="mar"><span class="day-name">Mar</span><span class="day-hours">8:00 - 18:00</span></div>
                <div class="day-slot active" data-day="mie"><span class="day-name">Mié</span><span class="day-hours">8:00 - 18:00</span></div>
                <div class="day-slot active" data-day="jue"><span class="day-name">Jue</span><span class="day-hours">8:00 - 18:00</span></div>
                <div class="day-slot active" data-day="vie"><span class="day-name">Vie</span><span class="day-hours">8:00 - 18:00</span></div>
                <div class="day-slot active" data-day="sab"><span class="day-name">Sáb</span><span class="day-hours">9:00 - 15:00</span></div>
                <div class="day-slot inactive" data-day="dom"><span class="day-name">Dom</span><span class="day-hours">Cerrado</span></div>
            </div>
        </div>

        <div style="padding: 0 20px; margin-top: 20px;">
            <p style="text-align:center; font-size:0.7rem; color:var(--text-muted); opacity:0.5;">
                <i class="fas fa-shield-halved"></i> Tu perfil se sincroniza automáticamente al estar conectado.
            </p>
        </div>

        <div style="height:100px;"></div>
    </div>
</div>

    <div id="modalCatalog" class="modal" onclick="if(event.target === this) document.getElementById('modalCatalog').classList.remove('open')">
        <div class="modal-card">
            <button class="modal-close-x" onclick="document.getElementById('modalCatalog').classList.remove('open')"><i class="fas fa-times"></i></button>
            <div style="text-align:center;margin-bottom:20px;">
                <h3 style="color:#3498db;margin:0;">📸 Mi Catálogo</h3>
                <small style="color:var(--text-muted);">Tus mejores trabajos (Máx 10)</small>
            </div>
            
            <div id="catalogGrid" class="catalog-grid">
                </div>
            
            <input type="file" id="inputCatalogUpload" accept="image/*" style="display:none;" onchange="handleCatalogUpload(this)">
        </div>
    </div>

        <div id="modalEditData" class="modal" onclick="if(event.target === this) document.getElementById('modalEditData').classList.remove('open')">
        <div class="modal-card" style="padding-top:20px;">
            <button class="modal-close-x" style="left:20px; right:auto;" onclick="document.getElementById('modalEditData').classList.remove('open')"><i class="fas fa-arrow-left"></i></button>
            
            <div style="text-align:center; margin-bottom:20px;">
                <h3 style="color:var(--primary); margin:0 0 15px 0;">PANEL DE ACCESO</h3>
                
                <div id="authTabsRow" style="display:flex; gap:5px; background:rgba(255,255,255,0.05); padding:5px; border-radius:12px; overflow-x:auto;">
                    <button id="tabAuthCreate" onclick="setAuthMode('create')" style="flex:1; padding:12px; border:none; border-radius:10px; font-weight:800; font-size:0.55rem; background:var(--primary); color:#000; transition:0.3s; white-space:nowrap;">
                        CREAR CUENTA
                    </button>
                    <button id="tabAuthLogin" onclick="setAuthMode('login')" style="flex:1; padding:12px; border:none; border-radius:10px; font-weight:800; font-size:0.55rem; background:transparent; color:#fff; transition:0.3s; white-space:nowrap;">
                        INICIAR SESIÓN
                    </button>
                    <button id="tabAuthPhone" onclick="setAuthMode('phone')" style="flex:1; padding:12px; border:none; border-radius:10px; font-weight:800; font-size:0.55rem; background:transparent; color:#fff; transition:0.3s; white-space:nowrap;">
                        CAMBIAR NÚMERO
                    </button>
                    <button id="tabAuthPass" onclick="setAuthMode('pass')" style="flex:1; padding:12px; border:none; border-radius:10px; font-weight:800; font-size:0.55rem; background:transparent; color:#fff; transition:0.3s; white-space:nowrap;">
                        CAMBIAR CLAVE
                    </button>
                </div>
            </div>

            <div id="authFormContainer">
                
                <div id="groupNameField">
                    <label class="modal-label" style="color:#f1c40f;">Nombre del Negocio *</label>
                    <input type="text" id="editProfileName" placeholder="Ej: Barbería El Rey..." autocomplete="off">
                </div>

                <label id="lblPhone" class="modal-label" style="color:#fff;">Número de Teléfono *</label>
                <input type="tel" id="editProfilePhone" placeholder="5xxxxxxx" autocomplete="off">

                <div id="groupOldPass" style="display:none;">
                    <label class="modal-label" style="color:#e74c3c;">Contraseña ACTUAL (Seguridad) *</label>
                    <input type="text" id="inputOldPass" placeholder="Confirma que eres tú..." autocomplete="off">
                </div>

                <label id="lblPass" class="modal-label" style="color:#3498db;">Contraseña *</label>
                <input type="text" id="editProfilePassword" placeholder="Tu clave secreta..." autocomplete="off">

                <div id="groupExtraSettings">
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin:20px 0; padding:15px; background:rgba(52,152,219,0.1); border-radius:12px; border:1px solid rgba(52,152,219,0.3); cursor:pointer;" onclick="abrirGestorServicios()">
                        <span style="color:#3498db; font-weight:700;"><i class="fas fa-list-alt"></i> Lista de Precios</span>
                        <i class="fas fa-chevron-right" style="color:#3498db;"></i>
                    </div>

                    <label class="modal-label" style="color:#2ecc71;">Ubicación GPS</label>
                    <button class="btn-geo-auto" onclick="detectarUbicacionBarbero()" style="margin-bottom:10px;">
                        <i class="fas fa-map-marker-alt"></i> <span id="btnGeoText">DETECTAR GPS</span>
                    </button>

                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="text" id="manualMapSearch" placeholder="Buscar zona..." style="flex:1; background:rgba(255,255,255,0.1); border:1px solid #444; color:#fff; padding:12px; border-radius:12px; font-size:0.9rem;">
                        <button onclick="buscarLugarManual()" style="background:#3498db; color:#fff; border:none; border-radius:12px; width:50px; font-size:1.2rem;"><i class="fas fa-search"></i></button>
                    </div>

                    <div style="position:relative;">
                        <div id="mapPickerContainer"></div>
                        <button id="btnConfirmMap" onclick="confirmarPuntoMapa()" style="display:none; position:absolute; bottom:20px; left:50%; transform:translateX(-50%); z-index:1000; background:#2ecc71; color:#000; font-weight:800; border:2px solid #fff; padding:12px 24px; border-radius:30px; box-shadow:0 5px 15px rgba(0,0,0,0.5); width:auto; white-space:nowrap;">
                            <i class="fas fa-map-pin"></i> FIJAR UBICACIÓN
                        </button>
                    </div>
                </div>

                <input type="hidden" id="editProfileProvincia">
                <input type="hidden" id="editProfileZona">
                <input type="hidden" id="inputLat">
                <input type="hidden" id="inputLng">

                <button id="btnAuthAction" class="btn" onclick="saveProfileData()" style="margin-top:25px; height:60px; font-size:1rem; text-transform:uppercase; letter-spacing:1px; box-shadow:0 5px 20px var(--primary);">
                    <i class="fas fa-save"></i> GUARDAR CAMBIOS
                </button>

            </div>
        </div>
    </div>


    <div id="modalServices" class="modal" onclick="if(event.target === this) document.getElementById('modalServices').classList.remove('open')">
    <div class="modal-card">
        <button class="modal-close-x" onclick="document.getElementById('modalServices').classList.remove('open')">
            <i class="fas fa-times"></i>
        </button>

        <div style="text-align:center;margin-bottom:24px;">
            <h3 style="color:#3498db;margin:0;"><i class="fas fa-list-alt"></i> Mi Menú</h3>
                <small style="color:var(--text-muted);">Lo que verán tus clientes</small>
            </div>

            <div style="background:rgba(255,255,255,0.05);padding:24px;border-radius:15px;margin-bottom:24px;border:1px solid rgba(255,255,255,0.1);">
                <label class="modal-label" style="margin-top:0;">Nombre del Servicio</label>
                <input type="text" id="newServiceName" placeholder="Ej:Corte Degradado" autocomplete="off" style="margin-bottom:12px;">
                
                <div style="display:flex;gap:14px;">
                    <div style="flex:1;">
                        <label class="modal-label" style="margin-top:0;">Precio ($)</label>
                        <input type="number" id="newServicePrice" placeholder="500">
                    </div>
                    <button class="btn" style="width:auto;background:#3498db;color:#fff;height:52px;margin-top:23px;" onclick="crearServicio()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
                <small style="color:#888;">TUS SERVICIOS ACTIVOS</small>
            </div>
            <div id="myServicesList" style="min-height:150px;padding-bottom:50px;">
                </div>
        </div>
    </div>

    
    <input type="file" id="inputQRFile" accept="image/*" style="display:none;" onchange="handleQRFile(this)">
        <div id="modalScheduleConfig" class="modal" onclick="if(event.target === this) document.getElementById('modalScheduleConfig').classList.remove('open')">
        <div class="modal-card">
            <button class="modal-close-x" style="left:20px; right:auto;" onclick="document.getElementById('modalScheduleConfig').classList.remove('open')"><i class="fas fa-arrow-left"></i></button>
            <div style="text-align:center; margin-bottom:20px;">
                <h3 style="color:var(--primary); margin:0;">⏰ Mi Jornada</h3>
                <small style="color:var(--text-muted);">Define tus días y horas de trabajo</small>
            </div>
            
            <div id="scheduleList" style="max-height:60vh; overflow-y:auto; padding-bottom:20px;">
                </div>

            <button class="btn" onclick="guardarHorarioSemanal()" style="margin-top:10px;">
                <i class="fas fa-save"></i> GUARDAR HORARIO
            </button>
        </div>
    </div>

    <input type="file" accept="image/*" capture="environment" id="cameraInput1" hidden onchange="handleCamera(this,1)">
    <input type="file" accept="image/*" capture="environment" id="cameraInput2" hidden onchange="handleCamera(this,2)">
        <div id="modalReviewsPro" class="modal" onclick="if(event.target === this) document.getElementById('modalReviewsPro').classList.remove('open')">
        <div class="modal-card" style="height:80vh;">
            <button class="modal-close-x" onclick="document.getElementById('modalReviewsPro').classList.remove('open')"><i class="fas fa-times"></i></button>
            <div style="text-align:center; margin-bottom:20px;">
                <h3 style="color:var(--gold); margin:0;">⭐ Opiniones Recibidas</h3>
                <small style="color:var(--text-muted);">Lo que dicen tus clientes</small>
            </div>
            <div id="lista-resenas-pro" style="overflow-y:auto; padding-bottom:50px;"></div>
        </div>
    </div>

    <input type="file" accept="image/*" capture="environment" id="cameraInputQuick" hidden onchange="handleQuickPhotoInput(this)">
    
    <div id="modalUpdate" class="modal" style="z-index:50000;background:rgba(0,0,0,0.95);">
        <div class="modal-card" style="text-align:center;border:1px solid var(--primary);max-width:320px;">
            <button id="btnCloseUpdate" class="modal-close-x" onclick="document.getElementById('modalUpdate').classList.remove('open')">
                <i class="fas fa-times"></i>
            </button>
            <div style="width:70px;height:70px;background:rgba(46,204,113,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 15px auto;box-shadow:0 0 20px rgba(46,204,113,0.2);">
                <i class="fas fa-rocket fa-2x" style="color:var(--primary);"></i>
            </div>
            <h3 style="color:#fff;margin:0;text-transform:uppercase;letter-spacing:1px;">Nueva Versión</h3>
            <p id="updVerTxt" style="color:var(--primary);font-weight:800;font-size:1.5rem;margin:5px 0;">v12.0</p>
            
            <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:12px;margin:20px 0;text-align:left;border:1px solid rgba(255,255,255,0.1);">
                <small style="color:#aaa;text-transform:uppercase;font-weight:700;">Novedades:</small>
                <div id="updNotes" style="color:#fff;font-size:0.9rem;margin-top:5px;line-height:1.4;">...</div>
            </div>

            <button id="btnDoUpdate" class="btn" style="box-shadow:0 0 20px var(--primary);animation:pulse 2s infinite;">
                <i class="fas fa-download"></i> ACTUALIZAR AHORA
            </button>
        </div>
    </div>

    <div id="secureLockOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:99999;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:30px;">
    <i class="fas fa-lock" style="font-size:4rem;color:#c0392b;margin-bottom:18px;"></i>
    <h1 style="color:#e74c3c;font-family:'Montserrat';text-transform:uppercase;letter-spacing:2.5px;font-size:1.5rem;">Acceso Denegado</h1>
    <p style="color:#aaa;font-size:0.9rem;margin-top:5px;">Terminal inhabilitada por el administrador.</p>
    
    <div style="margin-top:20px;padding:14px;background:rgba(255,255,255,0.1);border-radius:16px;font-family:monospace;color:#fff;font-size:0.8rem;display:flex;align-items:center;gap:14px;">
        <span>ID:<span id="lockIDDisplay">...</span></span>
        <button onclick="copiarIDBloqueado()" style="background:transparent;border:1px solid #555;color:#fff;border-radius:5px;padding:2px 8px;cursor:pointer;">
            <i class="fas fa-copy"></i>
        </button>
    </div>

    <div style="display:flex; gap:10px; margin-top:20px; width:100%; max-width:280px;">
        <button onclick="window.open('https://wa.me/+5351881471', '_blank')" style="flex:1; background:#25D366; color:#fff; border:none; padding:12px; border-radius:12px; font-weight:bold; cursor:pointer; font-size:0.9rem;">
            <i class="fab fa-whatsapp"></i> Soporte
        </button>
        <a href="tel:+5351881471" style="flex:1; background:#3498db; color:#fff; border:none; padding:12px; border-radius:12px; font-weight:bold; display:flex; align-items:center; justify-content:center; text-decoration:none; font-size:0.9rem;">
            <i class="fas fa-phone"></i> Llamar
        </a>
    </div>
    
    <button onclick="location.reload()" style="margin-top:15px;background:transparent;border:1px solid #555;color:#aaa;padding:10px;border-radius:8px;width:100%;max-width:200px;font-size:0.8rem;">
        <i class="fas fa-sync"></i> Recargar Sistema
    </button>

</div>
<div id="globalSystemLock" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:999999;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:30px;">
        <i class="fas fa-user-slash" style="font-size:4rem;color:#c0392b;margin-bottom:18px;"></i>
        <h1 style="color:#e74c3c;font-family:'Montserrat';text-transform:uppercase;letter-spacing:2.5px;font-size:1.5rem;">Acceso Denegado</h1>
        
        <div id="globalLockMessage" style="color:#fff;font-size:1rem;margin:24px 0;line-height:1.4;word-break:break-word;"></div>

        <button onclick="verificarEstadoGlobal(true)" style="margin-top:10px;background:#3498db;color:#fff;border:none;padding:24px 30px;border-radius:30px;font-weight:800;font-size:1rem;box-shadow:0 0 20px rgba(52,152,219,0.4);cursor:pointer;display:flex;align-items:center;gap:14px;transition:transform 0.2s;">
            <i class="fas fa-sync-alt"></i> RECARGAR SISTEMA
        </button>

    </div>
    <div id="subscriptionLockOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#0a0a0a;z-index:9999999;flex-direction:column;align-items:center;justify-content:center;padding:30px;text-align:center;">
        <i class="fas fa-crown" style="font-size:4rem;color:#f1c40f;margin-bottom:20px;animation:pulse 2s infinite;"></i>
        <h2 style="color:#fff;text-transform:uppercase;letter-spacing:2px;margin:0 0 10px 0;">Suscripción Vencida</h2>
        <p style="color:#aaa;font-size:0.9rem;margin-bottom:25px;max-width:300px;">El tiempo de uso ha finalizado. Realiza el pago para reactivar tu cuenta.</p>
        
        <div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:16px;border:1px solid rgba(255,255,255,0.1);width:100%;max-width:320px;margin-bottom:20px;">
            <div id="uiPrecioSuscripcion" style="color:#f1c40f;font-weight:800;font-size:1.4rem;margin-bottom:5px;">250 CUP / Mes</div>
            
            <div style="background:#000;padding:10px;border-radius:8px;border:1px dashed #444;margin:15px 0;">
                <div style="color:#888;font-size:0.7rem;margin-bottom:5px;">NÚMERO DE TARJETA</div>
                <div style="color:#fff;font-family:monospace;font-size:1.1rem;letter-spacing:1px;font-weight:bold;" id="cardNumberDisplay">9204 0699 9752 4327</div>
                <button onclick="copiarTarjetaPago()" style="margin-top:8px;background:rgba(255,255,255,0.1);border:none;color:#fff;padding:6px 12px;border-radius:20px;font-size:0.7rem;cursor:pointer;">
                    <i class="fas fa-copy"></i> COPIAR NÚMERO
                </button>
            </div>

            <div style="background:#000;padding:10px;border-radius:8px;border:1px dashed #444;margin-bottom:15px;">
                <div style="color:#888;font-size:0.7rem;margin-bottom:5px;">CONFIRMAR TRANSFERENCIA AL:</div>
                <div style="color:#fff;font-family:monospace;font-size:1.1rem;letter-spacing:1px;font-weight:bold;" id="confirmNumberDisplay">5351881471</div>
                <button onclick="copiarConfirmacionPago()" style="margin-top:8px;background:rgba(255,255,255,0.1);border:none;color:#fff;padding:6px 12px;border-radius:20px;font-size:0.7rem;cursor:pointer;">
                    <i class="fas fa-copy"></i> COPIAR TELÉFONO
                </button>
            </div>

            <p style="color:#aaa;font-size:0.75rem;margin-bottom:15px;line-height:1.4;">
                <i class="fas fa-info-circle"></i> <b>OBLIGATORIO:</b> Al realizar la transferencia, toca el botón verde para enviar la <b>CAPTURA DE PANTALLA</b> por WhatsApp.
            </p>
            
            <button onclick="reportarPagoSuscripcion()" id="btnPagarSuscripcion" class="btn" style="width:100%;background:#2ecc71;color:#000;font-weight:800;box-shadow:0 0 15px rgba(46,204,113,0.4);font-size:0.9rem;">
                <i class="fab fa-whatsapp"></i> ENVIAR CAPTURA Y ACTIVAR
            </button>
        </div>
        
        <button onclick="location.reload()" style="background:transparent;border:none;color:#555;font-size:0.8rem;cursor:pointer;">
            <i class="fas fa-sync"></i> Verificar Estado
        </button>
    </div>

    <style>@keyframes pulse {0% {transform:scale(1);}50% {transform:scale(1.1);}100% {transform:scale(1);}}</style>
    
        <script src="supabase.js"></script>

    <script>
        // --- CREDENCIALES PROTEGIDAS (Vienen desde Java) ---
        let SUPABASE_URL = "";
        let SUPABASE_KEY = "";
        let CAT_URL = "";
        let CAT_KEY = "";

        if(typeof Android !== 'undefined' && Android.getSupabaseUrl) {
            // Estamos en la App: Pedir claves a Java
            SUPABASE_URL = Android.getSupabaseUrl();
            SUPABASE_KEY = Android.getSupabaseKey();
            CAT_URL = Android.getCatUrl();
            CAT_KEY = Android.getCatKey();
        } else {
            console.warn("Modo Navegador: Sin claves seguras");
        }
        // -------------------------------------

            const APP_CURRENT_VERSION = 1.0;

    // --- SISTEMA DE SUSCRIPCIÓN SAAS (BLINDAJE TOTAL + ANTI-HORA) ---
    async function verificarSuscripcion() {
        const MAX_DIAS_OFFLINE = 5; 
        const MARGEN_ERROR_MS = 3600000; // 1 Hora de tolerancia máxima (Más estricto)

        // A. VERIFICACIÓN ONLINE (Sincronización de Anclas)
        if (navigator.onLine && typeof supabase !== 'undefined' && MY_DEVICE_ID) {
            try {
                const p1 = supabase.from('barberos').select('vencimiento_suscripcion').eq('id', MY_DEVICE_ID).maybeSingle();
                const p2 = supabase.rpc('get_server_time');

                const [resBarbero, resTime] = await Promise.all([p1, p2]);

                if (resBarbero.data && resTime.data) {
                    const serverTime = new Date(resTime.data).getTime();
                    const deviceTime = new Date().getTime(); 
                    const vencimientoISO = resBarbero.data.vencimiento_suscripcion;

                    // REGLA DE ORO ONLINE: Si tu reloj difiere más de 1 hora -> BLOQUEO AZUL
                    if (Math.abs(serverTime - deviceTime) > MARGEN_ERROR_MS) { 
                        bloqueoSeguridad("Tu reloj no coincide con la hora mundial.", true);
                        return;
                    }

                    localStorage.setItem('bm_cached_vencimiento', vencimientoISO);
                    localStorage.setItem('bm_last_server_time', serverTime); 
                    
                    if(typeof Android !== 'undefined' && Android.getBootTime) {
                        localStorage.setItem('bm_last_boot_time', Android.getBootTime());
                    } else {
                        localStorage.setItem('bm_last_boot_time', 'browser_mode');
                    }

                    aplicarBloqueoSiVencido(vencimientoISO, serverTime);
                    return; 
                }
            } catch (e) { console.warn("Error check online:", e); }
        }

        // B. MODO OFFLINE (DETECTAR SI EL USUARIO CAMBIÓ LA HORA)
        const fechaVencimiento = localStorage.getItem('bm_cached_vencimiento');
        const lastServerTime = parseInt(localStorage.getItem('bm_last_server_time'));
        const lastBootTime = localStorage.getItem('bm_last_boot_time');

        if (fechaVencimiento && lastServerTime && lastBootTime) {
            let trustedNow = 0;

            if (typeof Android !== 'undefined' && Android.getBootTime && lastBootTime !== 'browser_mode') {
                const currentBoot = Android.getBootTime();
                const savedBoot = parseInt(lastBootTime);

                // Si reinició el teléfono, el bootTime cambia (se reinicia a ~0)
                // Si currentBoot es menor que savedBoot, hubo reinicio.
                // En este caso, obligamos a conectar para resincronizar el reloj seguro.
                if (currentBoot < savedBoot) {
                    bloqueoSeguridad("Reiniciaste el dispositivo. Conéctate para verificar.");
                    return;
                }
                
                // Calculamos la hora REAL matemática basada en el uso de CPU
                const elapsedSinceCheck = currentBoot - savedBoot;
                trustedNow = lastServerTime + elapsedSinceCheck;

                // REGLA DE ORO OFFLINE: Comparamos Hora Calculada vs Hora del Teléfono
                const deviceNow = new Date().getTime();
                const diferencia = Math.abs(trustedNow - deviceNow);

                // Si hay más de 1 hora de diferencia, es que cambió la hora -> BLOQUEO AZUL
                if (diferencia > MARGEN_ERROR_MS) { 
                     bloqueoSeguridad("Tu fecha/hora no es correcta.", true);
                     return;
                }
                
                if (elapsedSinceCheck > (MAX_DIAS_OFFLINE * 86400000)) {
                    bloqueoSeguridad("Seguridad: Requiere conexión obligatoria.");
                    return;
                }

            } else {
                // Fallback navegador (Menos seguro pero funcional)
                trustedNow = new Date().getTime();
                if (trustedNow < lastServerTime) {
                    bloqueoSeguridad("Error de Reloj. Ajusta la fecha correctamente.", true);
                    return;
                }
            }

            aplicarBloqueoSiVencido(fechaVencimiento, trustedNow);

        } else if (!fechaVencimiento && !navigator.onLine) {
            bloqueoSeguridad("Primer uso requiere internet.");
        }
    }

    function bloqueoSeguridad(motivo, esErrorReloj = false) {
        const lock = document.getElementById('subscriptionLockOverlay');
        const splash = document.getElementById('splashOverlay');
        
        if(lock) {
            lock.style.display = 'flex';
            if(splash) splash.style.display = 'none'; // Quitar carga para ver el error
            
            const h2 = lock.querySelector('h2');
            h2.innerText = esErrorReloj ? "HORA INCORRECTA" : "ACCESO RESTRINGIDO";
            h2.style.color = esErrorReloj ? "#3498db" : "#e74c3c"; // Azul si es reloj, Rojo si es hack

            lock.querySelector('p').innerText = motivo;
            
            // Ocultar panel de pago
            const divPago = lock.querySelector('div');
            if(divPago) divPago.style.display = 'none';

            // Limpiar botón anterior si existe
            const oldBtn = document.getElementById('btnFixClock');
            if(oldBtn) oldBtn.remove();

            if (esErrorReloj) {
                // Crear botón MÁGICO que lleva a Ajustes
                const btn = document.createElement('button');
                btn.id = 'btnFixClock';
                btn.className = 'btn';
                // CORREGIDO: margin-bottom:30px para separar del botón de abajo
                btn.style.cssText = "margin-top:20px;margin-bottom:30px;background:#3498db;color:#fff;width:100%;max-width:280px;box-shadow:0 0 20px rgba(52,152,219,0.4);font-weight:800;";
                btn.innerHTML = '<i class="fas fa-cog"></i> AJUSTAR FECHA Y HORA';
                btn.onclick = () => {
                    if(typeof Android !== 'undefined' && Android.abrirAjustesFecha) {
                        Android.abrirAjustesFecha();
                    } else {
                        alert("Ve a los Ajustes de tu teléfono > Fecha y Hora.");
                    }
                };
                
                // Insertar antes del botón de recargar
                const refreshBtn = lock.querySelector('button[onclick="location.reload()"]');
                if(refreshBtn) lock.insertBefore(btn, refreshBtn);
            }
            
            document.body.style.overflow = 'hidden';
        }
    }

    function aplicarBloqueoSiVencido(fechaISO, referenceTime = null) {
    const fechaVencimiento = new Date(fechaISO);
    const ahora = referenceTime ? new Date(referenceTime) : new Date();
    const lockScreen = document.getElementById('subscriptionLockOverlay');
    const splash = document.getElementById('splashOverlay');

    // Calcular diferencia en días
    const diffMs = fechaVencimiento - ahora;
    const diffDias = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

    if (diffDias <= 0) {
        // --- CASO VENCIDO: BLOQUEAR ---
        if (lockScreen && lockScreen.style.display !== 'flex') {
            lockScreen.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            if(navigator.vibrate) navigator.vibrate([200,100,200]);
        }
        // Quitamos el splash para que se vea el candado rojo inmediatamente
        if(splash) splash.style.display = 'none';
    } else {
        // --- CASO ACTIVO: PERMITIR ---
        if (lockScreen && lockScreen.style.display === 'flex') {
            lockScreen.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // CRÍTICO: Solo quitamos la pantalla de carga AQUÍ, si pasó la seguridad
        if(splash && splash.style.opacity !== '0') {
            splash.style.opacity = '0';
            setTimeout(() => splash.style.display = 'none', 500);
        }

        // 1. Mensaje de Bienvenida (Solo 1 vez si quedan +25 días, asumiendo mes nuevo)

            const yaSaludo = localStorage.getItem('bm_welcome_shown');
            if (!yaSaludo && diffDias > 25) {
                setTimeout(() => {
                    showCustomAlert('success', '¡30 DÍAS GRATIS!', 'Bienvenido a Barber Manager Pro. Tienes un mes de prueba cortesía de la casa.');
                    localStorage.setItem('bm_welcome_shown', 'true');
                    fireConfetti(); // Celebración
                }, 1500);
            }
            
            // 2. Notificación Diaria de Estado (Toast)
            // Usamos sessionStorage para que salga solo una vez por sesión (al abrir la app)
            if (!sessionStorage.getItem('bm_status_toast')) {
                let icono = "📅";
                let titulo = "SUSCRIPCIÓN";
                
                if (diffDias === 1) {
                    // ALERTA CRÍTICA 1 DÍA
                    setTimeout(() => {
                        showCustomAlert('warning', '¡Vence Mañana!', 'Tu suscripción expira en 24 horas. Realiza el pago para evitar el bloqueo.');
                    }, 2000);
                } else if (diffDias <= 3) {
                    showToast(`Te quedan ${diffDias} días`, "⚠️", "AVISO PAGO");
                } else {
                    showToast(`Te quedan ${diffDias} días`, "✅", "ESTADO");
                }
                sessionStorage.setItem('bm_status_toast', 'true');
            }
        }
    }

    // --- FUNCIONES DE PAGO DINÁMICAS ---

    function copiarTarjetaPago() {
        const num = TARJETA_ACTUAL_SISTEMA.replace(/\s/g, '');
        navigator.clipboard.writeText(num).then(() => {
            showToast("Tarjeta Copiada", "💳", "SISTEMA");
            if(navigator.vibrate) navigator.vibrate(50);
        });
    }

    function copiarConfirmacionPago() {
        const num = TELEFONO_CONFIRM_ACTUAL.replace(/\s/g, '');
        navigator.clipboard.writeText(num).then(() => {
            showToast("Teléfono Copiado", "📱", "SISTEMA");
            if(navigator.vibrate) navigator.vibrate(50);
        });
    }

    async function reportarPagoSuscripcion() {
        const btn = document.getElementById('btnPagarSuscripcion');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PROCESANDO...';

        // 1. ENVIAR SEÑAL A LA BASE DE DATOS (IMPORTANTE)
        if(navigator.onLine && typeof supabase !== 'undefined') {
            // Borramos intentos previos pendientes de este mismo usuario para no llenar la lista
            await supabase.from('pagos_pendientes').delete().eq('barbero_id', MY_DEVICE_ID);

            // Insertamos la nueva solicitud
            const { error } = await supabase.from('pagos_pendientes').insert([{
                barbero_id: MY_DEVICE_ID,
                transaccion_id: "FOTO_WA", // Etiqueta para que el Admin sepa que es por foto
                monto: PRECIO_ACTUAL_SISTEMA + ' CUP',
                estado: 'pendiente'
            }]);
            
            if(error) console.error("Error enviando aviso al admin:", error);
        }

        // 2. ABRIR WHATSAPP (Después de enviar la señal)
        const miNombre = (DB.settings.brand && DB.settings.brand.text) ? DB.settings.brand.text : "Usuario";
        const mensaje = `Hola, soy *${miNombre}* (ID: ${MY_DEVICE_ID}).%0A%0AAquí envío la captura de pantalla del pago de mi suscripción 👇`;
        
        // Usamos el teléfono dinámico, o el tuyo por defecto si falla la carga
        const targetPhone = (typeof TELEFONO_ADMIN_ACTUAL !== 'undefined') ? TELEFONO_ADMIN_ACTUAL : "5351881471";
        const link = `https://wa.me/${targetPhone}?text=${mensaje}`;
        
        // Pequeña pausa para asegurar que la base de datos recibió la señal
        setTimeout(() => {
            window.location.href = link;
            btn.innerHTML = '<i class="fas fa-check"></i> CAPTURA ENVIADA';
            showToast("Solicitud enviada al Admin", "✅", "SISTEMA");
        }, 800);
    }

    // --- VARIABLES GLOBALES CORREGIDAS ---
    // NOTA: No declaramos 'supabase' aquí para no borrar la librería original
    var supabaseCatalogo = null; 
    // -------------------------------------

    try {
        // 1. Guardamos la "Fábrica" de conexiones en una variable segura
        var _FabricaSupabase = window.supabase;

        if(_FabricaSupabase && _FabricaSupabase.createClient) {
            
            // 2. Usamos la fábrica guardada para crear las conexiones
            
            // Conexión 1: Agenda y Perfil (Esta es la principal)
            supabase = _FabricaSupabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            // Conexión 2: Catálogo de Fotos
            supabaseCatalogo = _FabricaSupabase.createClient(CAT_URL, CAT_KEY);
            
            console.log("✅ Conexiones iniciadas correctamente");
        } else {
            console.warn("⚠️ Librería Supabase no encontrada");
        }
    } catch(e) {
        console.error("Error iniciando Supabase:", e);
    }

        let MY_DEVICE_ID = localStorage.getItem('bm_secure_id_v1');

        // --- SISTEMA DE RESTAURACIÓN AUTOMÁTICA (ID DE HARDWARE) ---
        if (typeof Android !== 'undefined' && Android.getUniqueID) {
            const hardwareID = Android.getUniqueID();
            if (hardwareID && hardwareID.length > 5) {
                const finalSecureID = "hw_barber_" + hardwareID;
                // Si el ID guardado no coincide con el hardware, restauramos el ID real
                if (MY_DEVICE_ID !== finalSecureID) {
                    MY_DEVICE_ID = finalSecureID;
                    localStorage.setItem('bm_secure_id_v1', MY_DEVICE_ID);
                }
            }
        }
        // -----------------------------------------------------------

        if (!MY_DEVICE_ID) {
            MY_DEVICE_ID = 'barber_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
            localStorage.setItem('bm_secure_id_v1',MY_DEVICE_ID);
        }

        // SEGURIDAD: Guardar copia del ID Original de Fábrica
        // Esto permite "soltar" la cuenta y dejar el teléfono limpio al cerrar sesión
        if (!localStorage.getItem('backup_original_id')) {
            localStorage.setItem('backup_original_id', MY_DEVICE_ID);
        }



        let audioCtx = null;

        function playClickSound() {
            // Vibración eliminada

            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}catch (e) {
                    console.error("Audio no soportado");
                    return;
}
}

            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            
            if(audioCtx) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800,audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(300,audioCtx.currentTime + 0.05);
                gain.gain.setValueAtTime(0.05,audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime + 0.05);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.05);
}
}
        document.addEventListener('click',(e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
            if (e.target.closest('button') || e.target.closest('.clickable-card') || e.target.closest('#mainFab') || e.target.closest('.theme-option') || e.target.closest('.photo-box') || e.target.closest('.font-opt') || e.target.closest('.f-tab') || e.target.closest('.faq-question') || e.target.closest('.btn-search-action') || e.target.closest('.client-item') || e.target.closest('.appt-item') || e.target.closest('.action-btn')) playClickSound();
});

        const safeLoad = (k,d) => {
            try {
                const res = JSON.parse(localStorage.getItem(k));
                return res === null ? d :res;
}catch(e) {return d;}
};

        const DB = {
            appointments:safeLoad('bm_appointments_v3',[]),
            extras:safeLoad('bm_extras_v1',[]),
            clients:safeLoad('bm_clients_v3',{}),
            trash:safeLoad('bm_trash_v1',[]),
            qrs:safeLoad('bm_qrs_v1',[]),
            settings:safeLoad('bm_settings_v3',{
                goal:80000,theme:'matrix',bgImage:'',
                brand:{text:"BARBERIA CON ESTILO",color:"#ffffff",font:"font-modern",enabled:true}
})
};

        if (!Array.isArray(DB.appointments)) DB.appointments = [];
        if (!Array.isArray(DB.extras)) DB.extras = [];
        if (!Array.isArray(DB.trash)) DB.trash = [];
        if (!Array.isArray(DB.qrs)) DB.qrs = [];
        if (typeof DB.clients !== 'object' || DB.clients === null) DB.clients = {};
        if (typeof DB.settings !== 'object' || DB.settings === null) DB.settings = {};

        if(!DB.settings.brand) DB.settings.brand = {text:"BARBERIA CON ESTILO",color:"#ffffff",font:"font-modern",enabled:true};
        if(!DB.settings.theme) DB.settings.theme = 'matrix';
        if(typeof DB.settings.monthlyGoal === 'undefined') DB.settings.monthlyGoal = 80000;
        if(typeof DB.settings.showGoal === 'undefined') DB.settings.showGoal = true;
        if(typeof DB.settings.privacyMode === 'undefined') DB.settings.privacyMode = false;
        if(typeof DB.settings.bestDayRevenue === 'undefined') DB.settings.bestDayRevenue = 0;

        let trackedNotifs = safeLoad('bm_tracked_notifs_v6',{});
        let isImportingForClientList = false;
        let tempQRData = null;
        let promptCallback = null;

        let tempTheme = DB.settings.theme || 'matrix';
        let tipoImagenActual = '';
        let showingAll = false;
        let isSelectionMode = false;
        let currentDayTracker = new Date().getDate();
        let financeLimit = 50;
        let clientLimit = 50;
        let galleryLimit = 50;
        let trashLimit = 50;
        let currentFinanceMode = 'day';


        function getLocalISOString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2,'0');
            const day = String(now.getDate()).padStart(2,'0');
            return `${year}-${month}-${day}`;
}

        document.addEventListener('DOMContentLoaded',() => {
            // --- MOTOR DE SEGURIDAD SAAS ---
            verificarSuscripcion(); // 1. Al iniciar
            
            // 2. Al volver de "Recientes" o segundo plano
            document.addEventListener("visibilitychange", () => {
                if (!document.hidden) verificarSuscripcion();
            });

            // 3. Revisión constante cada 60 segundos (por si vence con la app abierta)
            setInterval(verificarSuscripcion, 60000); 
            // -------------------------------

            // FIX: Aplicar Modo Lite antes de mostrar nada
            if(localStorage.getItem('bm_lite_mode') === 'true') {
                document.body.classList.add('lite-mode');
                const badge = document.getElementById('liteStatusBadge');
                if(badge) { badge.innerText = "ON"; badge.style.background = "#2ecc71"; badge.style.color = "#000"; }
            }

            
            // BUSCAR ACTUALIZACION AL INICIAR
            setTimeout(verificarActualizaciones, 3000);

            try {
                applyTheme(tempTheme);
                const savedBg = localStorage.getItem('fondoPersonalizado');
                if(savedBg) applyBg(savedBg);
                else if(DB.settings.bgImage) applyBg(DB.settings.bgImage);

                loadBrandSettingsUI();
                
                setTimeout(() => applyBrandSettings(),100);
                
                loadGoalSettingsUI();
                goToToday();
                renderClients();
                startClock();

                setTimeout(() => {
                    try { cleanTrash(); } catch(e) { console.warn("Error Trash",e); }
                    try { ejecutarCierreDiario(); } catch(e) { console.warn("Error Cierre",e); }
                    try { programarAlarmas(); } catch(e) { console.warn("Error Alarmas",e); }
                },1500);


}catch (err) {
                console.error("CRASH INICIO:",err);
                document.getElementById('splashOverlay').style.display = 'none';
}

            const hideKbd = () => {
                if(document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) {
                    document.activeElement.blur();
}
};
            const scrollAreas = [
                '#view-agenda .content-body',
                '#view-clientes .content-body',
                '#view-contactos .content-body',
                '#view-ajustes .content-body',
                '#quickClientList'
            ];

            // LOGICA SCROLL INTELIGENTE (Ocultar botones)
            const agendaContainer = document.querySelector('#view-agenda .content-body');
            let isScrollingTimer;
            const fab1 = document.getElementById('quickFab');
            const fab2 = document.getElementById('fabRequests');

            if(agendaContainer) {
                agendaContainer.addEventListener('scroll', () => {
                    // 1. Al detectar movimiento, ocultamos
                    if(fab1) fab1.classList.add('fab-hidden');
                    if(fab2) fab2.classList.add('fab-hidden');

                    // 2. Reiniciamos el temporizador
                    clearTimeout(isScrollingTimer);

                    // 3. Si deja de moverse por 150ms, mostramos de nuevo
                    isScrollingTimer = setTimeout(() => {
                        if(fab1) fab1.classList.remove('fab-hidden');
                        if(fab2) fab2.classList.remove('fab-hidden');
                    }, 150);
                }, {passive: true});
            }

            scrollAreas.forEach(selector => {
                const el = document.querySelector(selector);
                if(el) el.addEventListener('touchmove',hideKbd,{passive:true});
            });
});

                function saveData() {
            try {
                localStorage.setItem('bm_appointments_v3',JSON.stringify(DB.appointments));
                localStorage.setItem('bm_clients_v3',JSON.stringify(DB.clients));
                localStorage.setItem('bm_settings_v3',JSON.stringify(DB.settings));
                localStorage.setItem('bm_extras_v1',JSON.stringify(DB.extras));
                localStorage.setItem('bm_trash_v1',JSON.stringify(DB.trash));
                localStorage.setItem('bm_qrs_v1',JSON.stringify(DB.qrs));

                if (typeof supabase !== 'undefined' && window.MY_DEVICE_ID && DB.settings && DB.settings.brand) {
                    supabase.from('barberos')
                        .update({nombre:DB.settings.brand.text})
                        .eq('id',MY_DEVICE_ID)
                        .then(() => console.log("☁️ Nombre sincronizado"));
}

}catch (e) {
                console.error("Error al guardar datos:",e);
                if(e.name === 'QuotaExceededError') {
                    alert("⚠️ Memoria llena. Borra datos de la papelera.");
}
}
}

                async function publicarPerfilOnline() {
            const btn = document.getElementById('btnPublish');
            const status = document.getElementById('lastSyncText');
            
            const nombreVisible = document.getElementById('profileBrandName').value.trim();

            if(!nombreVisible) return;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> VERIFICANDO...';
            btn.style.opacity = "0.7";

            const canalUnico = MY_DEVICE_ID;

            if(typeof Android !== 'undefined' && Android.iniciarServicioNotificaciones) {
                Android.iniciarServicioNotificaciones(canalUnico);
}

            const perfilData = {
                id:canalUnico,
                nombre:nombreVisible,
                telefono:"55555555",
                descripcion:"Barbería Activa"
                
};
            const {data,error}= await supabase
                .from('barberos')
                .upsert(perfilData)
                .select();

            if (error) {
                console.error("Error:",error);
                btn.innerHTML = '<i class="fas fa-wifi"></i> FALLO DE RED';
                btn.style.background = "#e74c3c";
                setTimeout(() => {btn.innerHTML = 'REINTENTAR';btn.style.background = "var(--primary)";},3000);
}else {
                const perfil = data[0];

                if (perfil.bloqueado) {
                    btn.innerHTML = '<i class="fas fa-ban"></i> CUENTA BLOQUEADA';
                    btn.style.background = "#c0392b";
                    btn.style.color = "#fff";
                    
                    status.innerText = "⛔ Acceso denegado por el administrador.";
                    status.style.color = "#e74c3c";
                    
                    if(navigator.vibrate) navigator.vibrate([100,100,100,500]);
                    
}else {
                    await supabase.from('barberos').update({disponible:true}).eq('id',canalUnico);

                    btn.innerHTML = '<i class="fas fa-check"></i> EN LÍNEA';
                    btn.style.background = "#2ecc71";
                    btn.style.color = "#000";
                    
                    status.innerText = "✅ Perfil activo:" + nombreVisible;
                    status.style.color = "#88aa88";
                    
                    DB.settings.brand.text = nombreVisible;
                    saveData();

                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> PUBLICAR PERFIL';
                        btn.style.background = "var(--primary)";
                        btn.style.color = "#000";
                        btn.style.opacity = "1";
},3000);
}
}
}



        function closeModal() {
        document.querySelectorAll('.modal.open').forEach(m => m.classList.remove('open'));
        document.getElementById('timeSlotsContainer').style.display = 'none';
}
async function alternarDisponibilidadPro(checked) {
    // NUEVA VALIDACIÓN: SI NO TIENE CUENTA REAL, LO MANDAMOS A REGISTRO
    const myPhone = localStorage.getItem('barber_phone_real');
    
    if (checked && (!myPhone || myPhone === "55555555" || myPhone.length < 5)) {
        // 1. Apagar visualmente el switch
        document.getElementById('toggleOnlineSwitch').checked = false;
        
        // 2. Mensaje único y directo
        showToast("Verifícate primero", "📝", "REGISTRO");
        
        // 3. Redirigir al formulario
        setTimeout(() => {
            openEditDataModal();
        }, 500);
        
        return; // DETENEMOS TODO AQUÍ
    }

    // ACTIVAMOS SILENCIADOR PARA EVITAR ECO DE SEGURIDAD
    window.isSelfUpdate = true;
    setTimeout(() => { window.isSelfUpdate = false; }, 5000);

    // 1. REGLA DE ORO: SI HAY BLOQUEO ESTRICTO, TE FRENA
    if (checked && !DB.settings.verified && DB.settings.strictMode === true) {
        document.getElementById('toggleOnlineSwitch').checked = false;
        showToast("Esperando aprobación del Admin", "👮‍♂️", "ACCESO DENEGADO");
        return;
    }

    // 2. SI PASASTE EL FILTRO, ERES VERIFICADO AUTOMÁTICAMENTE
    if (checked) {
        DB.settings.verified = true;
        saveData();
    }

    // 3. ACTUALIZACIÓN VISUAL INMEDIATA
    actualizarBotonEstado(checked);

    // 4. ENVÍO "BULLDOZER" AL SERVIDOR (Upsert + Verificado Forzoso)
    if(MY_DEVICE_ID) {
        if(navigator.vibrate) navigator.vibrate(20);
        
        // Obtenemos datos para asegurar el upsert
        const myName = DB.settings.brand.text || "Barberia";
        // Ya leímos myPhone arriba
        
        const paqueteDatos = {
            id: MY_DEVICE_ID,
            nombre: myName, // Asegura que el nombre vaya
            telefono: myPhone,
            disponible: checked,
            verificado: true // SIEMPRE TRUE SI ESTAMOS ENCENDIENDO
        };
        
        // Usamos UPSERT para que si o si cree/actualice la fila y aparezcas
        const { error } = await supabase
            .from('barberos')
            .upsert(paqueteDatos) 
            .select();

        if(error) {
            console.error("Error crítico online:", error);
            // Solo revertimos si falla la red
            actualizarBotonEstado(!checked);
            showToast("Error de conexión", "📡", "OFFLINE");
        }
    }
}

function toggleAdvancedOptions() {
    const panel = document.getElementById('advancedOptionsPanel');
    const arrow = document.getElementById('advancedArrow');
    panel.classList.toggle('show');
    arrow.style.transform = panel.classList.contains('show') ? 'rotate(180deg)' :'rotate(0deg)';
}

async function cargarEstadisticasPerfil() {
    if(!supabase || !MY_DEVICE_ID) return;

    // 1. Clientes Hoy (Agenda Local)
    const hoyISO = getLocalISOString();
    const clientesHoy = DB.appointments.filter(a => a.date === hoyISO).length;
    document.getElementById('statClientesToday').innerText = clientesHoy;

    // 2. Ganancia Semana (Local)
    // Calculamos simple: lo que hay en historial de los ultimos 7 dias
    const now = new Date();
    let totalSemana = 0;
    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    [...DB.appointments, ...DB.extras].forEach(item => {
        const d = new Date(item.date);
        if(d >= sevenDaysAgo) totalSemana += parseInt(item.price || 0);
    });
    document.getElementById('statGananciaSemana').innerText = '$' + totalSemana;

    // 3. VALORACIÓN REAL (Desde Nube)
    const { data: resenas, error } = await supabase
        .from('resenas')
        .select('calificacion')
        .eq('barbero_id', MY_DEVICE_ID);

    const valEl = document.getElementById('statValoracion');
    
    if (error || !resenas || resenas.length === 0) {
        valEl.innerText = '--'; 
        valEl.style.color = 'var(--text-muted)';
    } else {
        const suma = resenas.reduce((acc, r) => acc + (r.calificacion || 0), 0);
        const promedio = (suma / resenas.length).toFixed(1);
        
        valEl.innerText = promedio;
        
        // Color según nota
        if(promedio >= 4.5) valEl.style.color = '#f1c40f'; // Oro
        else if(promedio >= 3.0) valEl.style.color = '#fff'; // Normal
        else valEl.style.color = '#e74c3c'; // Rojo (Alerta)
    }
}

function abrirWhatsAppPropio() {
    const phone = (localStorage.getItem('barber_phone_real') || '').replace(/\D/g,'');
    if(phone) window.open(`https://wa.me/${phone}`,'_blank');
}

const DIAS_SEM = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
const DIAS_KEY = ['lun', 'mar', 'mie', 'jue', 'vie', 'sab', 'dom'];

function abrirConfigHorarios() {
    const list = document.getElementById('scheduleList');
    list.innerHTML = '';
    
    let config = DB.settings.schedule || {};
    
    DIAS_KEY.forEach((key, index) => {
        const diaNombre = DIAS_SEM[index];
        const saved = config[key] || { active: (key !== 'dom'), start: "09:00", end: "18:00" };
        
        const row = document.createElement('div');
        row.className = 'schedule-row';
        row.innerHTML = `
            <div style="display:flex; align-items:center; gap:10px;">
                <label class="switch schedule-switch">
                    <input type="checkbox" id="chk_${key}" ${saved.active ? 'checked' : ''} onchange="toggleScheduleRow('${key}')">
                    <span class="slider"></span>
                </label>
                <div class="schedule-day">${diaNombre.substring(0,3)}</div>
            </div>
            <div class="schedule-inputs ${saved.active ? 'active' : ''}" id="inputs_${key}">
                <input type="time" class="time-input-mini" id="start_${key}" value="${saved.start}">
                <span style="color:#666;">-</span>
                <input type="time" class="time-input-mini" id="end_${key}" value="${saved.end}">
            </div>
        `;
        list.appendChild(row);
    });

    document.getElementById('modalScheduleConfig').classList.add('open');
}

function toggleScheduleRow(key) {
    const chk = document.getElementById(`chk_${key}`);
    const inputs = document.getElementById(`inputs_${key}`);
    if (chk.checked) inputs.classList.add('active');
    else inputs.classList.remove('active');
}

async function guardarHorarioSemanal() {
    // ACTIVAMOS SILENCIADOR
    window.isSelfUpdate = true;
    setTimeout(() => { window.isSelfUpdate = false; }, 3000);

    const newConfig = {};
    
    DIAS_KEY.forEach(key => {
        newConfig[key] = {
            active: document.getElementById(`chk_${key}`).checked,
            start: document.getElementById(`start_${key}`).value,
            end: document.getElementById(`end_${key}`).value
        };
    });

    DB.settings.schedule = newConfig;
    saveData();
    
    actualizarGridPerfil(newConfig);

    if (typeof supabase !== 'undefined' && MY_DEVICE_ID) {
        
        const { error } = await supabase
            .from('barberos')
            .update({ horario: newConfig }) 
            .eq('id', MY_DEVICE_ID);
            
        if (error) {
            console.error("Error horario:", error);
            showToast("Error al guardar", "❌", "ERROR");
        } else {
            showToast("Horarios Actualizados", "📅", "ÉXITO");
        }
    }
    
    closeModal();
}

// --- FUNCIÓN DE TOQUE RÁPIDO (CERRAR/ABRIR DÍA) ---
async function toggleDiaRapido(key) {
    // Vibración para feedback táctil
    if(navigator.vibrate) navigator.vibrate(20);

    if(!DB.settings.schedule) DB.settings.schedule = {};
    
    // Si no existe configuración previa, creamos una por defecto
    const current = DB.settings.schedule[key] || { active: false, start: '09:00', end: '18:00' };
    
    // Invertimos el estado (Abierto <-> Cerrado)
    current.active = !current.active;
    DB.settings.schedule[key] = current;
    saveData();
    
    // Actualizar visualmente al instante
    actualizarGridPerfil(DB.settings.schedule);
    
    // Feedback visual
    if(current.active) showToast("Día Abierto", "🟢", "HORARIO");
    else showToast("Día Cerrado", "⚫", "HORARIO");
    
    // Guardar silenciosamente en la Nube
    if(typeof supabase !== 'undefined' && MY_DEVICE_ID) {
        supabase.from('barberos').update({ horario: DB.settings.schedule }).eq('id', MY_DEVICE_ID).then(() => {
            console.log("Horario rápido sincronizado");
        });
    }
}

function actualizarGridPerfil(config) {
    const container = document.getElementById('availabilityGrid');
    if(!container) return;
    
    container.innerHTML = '';
    
    DIAS_KEY.forEach(key => {
        const dia = config[key];
        // Determinar si está activo
        const isActive = dia && dia.active;
        
        const div = document.createElement('div');
        div.className = `day-slot ${isActive ? 'active' : 'inactive'}`;
        div.style.cursor = "pointer"; // Manita de click
        
        // Al tocar, ejecutamos el toggle rápido
        div.onclick = () => toggleDiaRapido(key);
        
        let textoHora = "Cerrado";
        if (isActive) {
            textoHora = `${dia.start} - ${dia.end}`;
        } else {
            // Si está cerrado, mostramos 'Toca para abrir'
            textoHora = "CERRADO"; 
        }
        
        div.innerHTML = `
            <span class="day-name">${key.charAt(0).toUpperCase() + key.slice(1,3)}</span>
            <span class="day-hours" style="${!isActive ? 'color:#e74c3c;font-weight:bold;' : ''}">${textoHora}</span>
        `;
        container.appendChild(div);
    });
}
  
        function openAddModal() {
            const modal = document.getElementById('modalAdd');
            const card = modal.querySelector('.modal-card');
            
            // RESETEAR MODO NORMAL (Full Pantalla)
            card.classList.remove('half-mode');
            const inpName = document.getElementById('inputClient');
            inpName.readOnly = false;
            inpName.style.textAlign = 'left';
            inpName.style.border = ''; // Restaurar borde original
            inpName.style.fontSize = ''; 
            
            // Restaurar visibilidad de telefono
            document.getElementById('inputPhone').style.display = 'block';

            document.getElementById('editId').value = "";
            document.getElementById('modalTitle').innerText = "Nuevo Turno";
            document.getElementById('btnSaveAppt').innerText = "Confirmar Turno";
            document.getElementById('inputClient').value = "";
            document.getElementById('inputPhone').value = "";
            document.getElementById('inputPrice').value = "500";
            
            const isoDate = getLocalISOString();
            document.getElementById('inputDate').value = isoDate;
            const [y,m,d] = isoDate.split('-');
            document.getElementById('inputDateDisplay').value = `${d}/${m}/${y}`;
            
            const now = new Date();
            const hour = String(now.getHours()).padStart(2,'0');
            document.getElementById('inputTime').value = hour + ":00";

            document.getElementById('apptSearch').value = "";
            document.getElementById('searchContainer').style.display = "block";
            document.getElementById('manualInputContainer').style.display = "none";
            document.getElementById('containerPrice').style.display = "flex";
            document.getElementById('actionButtonsRow').style.display = "flex";
            document.querySelectorAll('#modalAdd .tag-pill').forEach(t => t.classList.remove('active'));
            
            toggleTimePicker(false);
            
            modal.classList.add('open');
            isSelectionMode = false;
            
            if(typeof activarSaltoTeclado === 'function') {
                activarSaltoTeclado();
            }
        }

        function navTo(viewId) {
            // BLINDAJE: Asegurar que la burbuja se apague al cambiar de pantalla
            const bubble = document.getElementById('alphaBubble');
            if(bubble) bubble.classList.remove('show');

            if (viewId === 'agenda') {goToToday();}
            
            if (viewId === 'contactos') {
                document.getElementById('contactSearch').value = '';
                
                const scrollBox = document.querySelector('#view-contactos .content-body');
                if(scrollBox) scrollBox.scrollTop = 0;

                renderContactsList();

                if(typeof Android !== 'undefined' && Android.sincronizarAgenda) {
                    Android.sincronizarAgenda();
                }

                requestAnimationFrame(() => {
                    if(document.getElementById('view-contactos').classList.contains('active')) drawVirtualContacts();
});
}


            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            const viewEl = document.getElementById('view-' + viewId);
            if(viewEl) viewEl.classList.add('active');
            
            const viewsOrder = ['agenda','clientes','contactos','tutorial','ajustes'];
            const idx = viewsOrder.indexOf(viewId);
            
            if(idx !== -1 && document.querySelectorAll('.nav-btn')[idx]) {
                document.querySelectorAll('.nav-btn')[idx].classList.add('active');
}
            
            if(viewId === 'agenda') {
                document.getElementById('quickFab').style.display = 'flex';
                const pend = parseInt(document.getElementById('reqCounterBadge').innerText) || 0;
                if(pend > 0) document.getElementById('fabRequests').style.display = 'flex';
            }else {
                document.getElementById('quickFab').style.display = 'none';
                document.getElementById('fabRequests').style.display = 'none';
            }
            
            if(viewId === 'tutorial') {const btnNew = document.querySelectorAll('#view-tutorial .f-tab')[1];switchTutorialTab('new',btnNew);}
            saveData();
}

        function moveSlider(val) {
            document.getElementById('compOverlay').style.width = val + "%";
            const handle = document.getElementById('sliderHandle');
            handle.style.left = val + "%";
}
        
        function openQRModal() {renderQRGrid();document.getElementById('modalQR').classList.add('open');}
        function renderQRGrid() {
            const container = document.getElementById('qrContainer');
            container.innerHTML = '';
            
            DB.qrs.forEach((qr,index) => {
                const card = document.createElement('div');
                card.className = 'qr-card';
                card.onclick = () => openFullscreenViewer(qr.data);
                
                const delBtn = `<div onclick="event.stopPropagation();deleteQR(${index})" style="position:absolute;top:-5px;right:-5px;background:#e74c3c;width:25px;height:25px;border-radius:50%;color:white;font-size:0.8rem;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 8px rgba(0,0,0,0.5);z-index:5;"><i class="fas fa-times"></i></div>`;
                
                card.innerHTML = `${delBtn}<img src="${qr.data}"><div class="qr-label">${qr.name}</div>`;
                container.appendChild(card);
});

            if(DB.qrs.length < 5) {
                const addBtn = document.createElement('div');
                addBtn.className = 'qr-card';
                addBtn.style.border = "2px dashed var(--primary)";
                addBtn.style.display = "flex";
                addBtn.style.flexDirection = "row";
                addBtn.style.alignItems = "center";
                addBtn.style.justifyContent = "center";
                addBtn.style.gap = "15px";

                const btnGallery = `<div onclick="if(typeof Android !== 'undefined') Android.seleccionarQRGaleria()" style="text-align:center;color:var(--primary);cursor:pointer;"><i class="fas fa-image fa-2x"></i><div style="font-size:0.6rem;margin-top:5px;">GALERÍA</div></div>`;
                
                const btnCamera = `<div onclick="triggerQRCamera()" style="text-align:center;color:var(--primary);cursor:pointer;"><i class="fas fa-camera fa-2x"></i><div style="font-size:0.6rem;margin-top:5px;">CÁMARA</div></div>`;
                
                addBtn.innerHTML = btnGallery + btnCamera;
                container.appendChild(addBtn);
}
}

        function triggerQRCamera() {
            if(typeof Android !== 'undefined' && Android.tomarFotoQR) {
                Android.tomarFotoQR();
}else {
}
}


        function deleteQR(index) {
            showCustomAlert(
                'warning',
                'Eliminar QR',
                '¿Mover este código a la papelera?',
                function() {
                    const item = DB.qrs[index];
                    if(item) {
                        moveToTrash('qr',item,item.name,'Códigos QR');
                        DB.qrs.splice(index,1);
                        saveData();
                        renderQRGrid();
}
},
                null 
            );
}
        function showCustomPrompt(callback) {document.getElementById('promptInput').value = '';document.getElementById('customPromptOverlay').style.display = 'flex';document.getElementById('promptInput').focus();promptCallback = callback;}
        function confirmCustomPrompt() {const val = document.getElementById('promptInput').value.trim();if(val && promptCallback) {promptCallback(val);closeCustomPrompt();}else {}}
        function closeCustomPrompt() {document.getElementById('customPromptOverlay').style.display = 'none';promptCallback = null;}

    let agendaPrivacyMode = false;

    function toggleAgendaPrivacy() {
        agendaPrivacyMode = !agendaPrivacyMode;
        verAgendaManana(false);
        vibratePhone(20);

        if(agendaPrivacyMode) {
            setTimeout(() => {
                shareImage();
},500);
}
}

    function verAgendaManana(resetPrivacy = true) {
        // EN AGENDA: MOSTRAR BOTÓN PRIVACIDAD
        const btnPriv = document.getElementById('btnPrivacyResult');
        if(btnPriv) btnPriv.style.display = 'flex';

        if(resetPrivacy) {
            agendaPrivacyMode = false;
            document.getElementById('view-result-placeholder').style.display = 'flex';
}

        tipoImagenActual = 'agenda';
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        const w = 3000;

        const rowHeight = 195;
        const rowGap = 45;
        const rowStep = rowHeight + rowGap;
        const sideMargin = 0;
        
        const startHour = 9;
        const endHour = 18;
        const totalSlots = (endHour - startHour) * 2 + 1;
        const headerHeight = 690;
        const h = headerHeight + (totalSlots * rowStep) + 250;

        canvas.width = w;
        canvas.height = h;

        ctx.fillStyle = "#111";
        ctx.fillRect(0,0,w,h);
        
        const b = DB.settings.brand || {enabled:false};
        if(b.enabled) {
            ctx.fillStyle = b.color || '#fff';
            ctx.font = "900 110px Montserrat,sans-serif";
            ctx.textAlign = "center";
            ctx.fillText((b.text || "MI BARBERÍA").toUpperCase(),w/2,200);
}

        const tmrw = new Date();
        tmrw.setDate(tmrw.getDate() + 1);
        const dateStr = tmrw.toLocaleDateString('es-ES',{weekday:'long',day:'numeric',month:'long'});
        
        ctx.fillStyle = "#fff";
        ctx.font = "bold 90px Montserrat,sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("AGENDA MAÑANA",w/2,380);
        
        ctx.font = "70px Montserrat,sans-serif";
        ctx.fillStyle = '#2ecc71';
        ctx.fillText(dateStr.toUpperCase(),w/2,480);
        
        ctx.fillStyle = "#888";
        ctx.font = "50px Montserrat,sans-serif";
        ctx.fillText("Reserva tu turno por DM 📩",w/2,580);

        const tmrwISO = `${tmrw.getFullYear()}-${String(tmrw.getMonth()+1).padStart(2,'0')}-${String(tmrw.getDate()).padStart(2,'0')}`;
        const appointments = DB.appointments.filter(a => a.date === tmrwISO);
        
        let y = headerHeight;
        window.agendaCoords = [];

        for(let hour=startHour;hour<=endHour;hour++) {
            for(let min=0;min<60;min+=30) {
                if(hour === endHour && min === 30) continue;
                
                const timeStr = `${String(hour).padStart(2,'0')}:${String(min).padStart(2,'0')}`;
                const slotStart = hour * 60 + min;
                const slotEnd = slotStart + 30;

                const taken = appointments.find(a => {
                    const aMin = getMinutes(a.time);
                    return aMin >= slotStart && aMin < slotEnd;
});

                ctx.fillStyle = (min === 0) ? "rgba(255,255,255,0.08)" :"rgba(255,255,255,0.05)";
                ctx.fillRect(0,y,w,rowHeight);
                
                ctx.fillStyle = "#fff";
                ctx.font = "800 110px Montserrat,sans-serif"; /* AUMENTADO DE 80 A 110 */
                ctx.textAlign = "left";
                ctx.fillText(formatTime(timeStr),50,y + 110);
                
                ctx.textAlign = "right";
                
                if(taken) {
                    ctx.fillStyle = "#e74c3c";
                    let textoMostrar = "";
                    if(agendaPrivacyMode) {
                        textoMostrar = "⛔ OCUPADO";
}else {
                        textoMostrar = taken.name.length > 14 ? taken.name.substring(0,14) + ".." :taken.name;
                        textoMostrar = textoMostrar.toUpperCase();
}
                    ctx.fillText(textoMostrar,w - 50,y + 110);
                    
                    if(!agendaPrivacyMode) {
                        window.agendaCoords.push({
                            yMin:y,yMax:y + rowHeight,phone:taken.phone,name:taken.name
});
}
}
                else {
                    ctx.fillStyle = "#2ecc71";
                    ctx.font = "800 80px Montserrat,sans-serif";
                    ctx.fillText("DISPONIBLE ✅",w - 50,y + 110);
}
                y += rowStep;
}
}
        
        const imgData = canvas.toDataURL('image/jpeg',0.85);
        const finalImg = document.getElementById('finalImage');
        finalImg.src = imgData;

        const fabRow = document.getElementById('fabRow');
        const viewContainer = document.getElementById('view-result-placeholder');
        fabRow.classList.remove('show-buttons');

        let touchStartY = 0;
        viewContainer.ontouchstart = (e) => {touchStartY = e.touches[0].clientY;};
        viewContainer.ontouchend = (e) => {
            const diff = touchStartY - e.changedTouches[0].clientY;
            if(diff > 50) {fabRow.classList.add('show-buttons');if(navigator.vibrate) navigator.vibrate(20);}
};
        
        finalImg.onclick = function(e) {
            if (!window.agendaCoords || agendaPrivacyMode) return;
            const rect = finalImg.getBoundingClientRect();
            const scaleY = h / rect.height;
            const clickY = (e.clientY - rect.top) * scaleY;
            const row = window.agendaCoords.find(r => clickY >= r.yMin && clickY <= r.yMax);
            
            if (row && row.phone) {
                const scaleX = w / rect.width;
                const clickX = (e.clientX - rect.left) * scaleX;
                if (clickX > w/2) {makeCall(row.phone);}
                else {window.location.href = "sms:" + row.phone;}
}
};
}

        
        function openGalleryModal() {document.getElementById('gallerySearch').value = '';renderGalleryList();document.getElementById('modalGallery').classList.add('open');}
        
function renderGalleryList(resetPagination = true) {
            if(resetPagination) galleryLimit = 20;

            const searchVal = document.getElementById('gallerySearch').value.toLowerCase();
            const grid = document.getElementById('galleryList');
            const chipsContainer = document.getElementById('galleryChips');
            
            grid.onscroll = function() {
                if(grid.scrollTop + grid.clientHeight >= grid.scrollHeight - 50) {
                    galleryLimit += 20;
                    renderGalleryList(false);
}
};

            grid.innerHTML = '';
            chipsContainer.innerHTML = '';

            const now = Date.now();
            const thirtyDaysMs = 30 * 24 * 60 * 60 * 1000;

            let allWorks = [];
            const clientsWithPhotos = Object.keys(DB.clients).filter(k => {
                const c = DB.clients[k];
                return c.savedPhotos && c.savedPhotos.length > 0 && k.toLowerCase().includes(searchVal);
});

            clientsWithPhotos.forEach(name => {
                const chip = document.createElement('div');
                chip.className = 'chip-client';
                chip.innerText = name;
                chip.onclick = () => {document.getElementById('gallerySearch').value = name;renderGalleryList();};
                chipsContainer.appendChild(chip);
});

            clientsWithPhotos.forEach(name => {
                const c = DB.clients[name];
                const photo = c.savedPhotos[0];
                if ((now - photo.date) < thirtyDaysMs) {
                    allWorks.push({clientName:name,clientData:c,photoData:photo});
}
});

            allWorks.sort((a,b) => b.photoData.date - a.photoData.date);

            if(allWorks.length === 0) {
                grid.innerHTML = '<p style="text-align:center;color:#555;margin-top:20px;">No hay trabajos recientes.</p>';
                return;
}

            const displayed = allWorks.slice(0,galleryLimit);

            displayed.forEach(work => {
                const {clientName,clientData,photoData}= work;
                const dateObj = new Date(photoData.date);
                const dateStr = `${dateObj.getDate()}/${dateObj.getMonth()+1}`;
                
                const expirationTime = photoData.date + thirtyDaysMs;
                const timeLeft = expirationTime - now;
                const daysLeft = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hoursLeft = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                let expiryColor = '#88aa88';
                if(daysLeft < 3) expiryColor = '#e74c3c';
                else if(daysLeft < 7) expiryColor = '#f1c40f';

                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.style.height = 'auto';
                item.style.minHeight = '80px';
                item.style.padding = '5px 0';

                item.innerHTML = ` 
                <img src="${photoData.data}" onclick="openFullscreenViewer('${photoData.data}')" style="height:80px;width:80px;object-fit:cover;"> 
                <div class="gallery-info" onclick="openFullscreenViewer('${photoData.data}')"> 
                    <div style="font-weight:bold;color:#fff;">${clientName}</div> 
                    <div style="font-size:0.7rem;color:var(--text-muted);">📅 Creado:${dateStr}</div> 
                    <div style="font-size:0.65rem;font-weight:600;color:${expiryColor};margin-top:2px;">
                        ⏳ Expira en:${daysLeft}d ${hoursLeft}h
                    </div>
                </div> 
                <div class="gallery-actions">
                    <button class="action-btn btn-msg" onclick="shareGalleryImage('${photoData.data}')">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button class="action-btn btn-call" onclick="saveGalleryImageFromList('${photoData.data}')">
                        <i class="fas fa-download"></i>
                    </button>
                </div>`;
                grid.appendChild(item);
});
}
        function makeCall(phone) {window.location.href = `tel:${phone}`;}
        function sendWhatsApp(phone) {
             let p = phone.replace(/\D/g,'');
             window.location.href = `https://wa.me/${p}`;
}

        function deleteGalleryItem(name,photoId) {
            if(confirm('驴Borrar esta foto de la galer铆a?')) {
                const client = DB.clients[name];
                if(client && client.savedPhotos) {
                    client.savedPhotos = client.savedPhotos.filter(p => p.id !== photoId);
                    saveData();renderGalleryList();showCustomAlert('success','Borrada','Foto eliminada.');
}
}
}
        function openFullscreenViewer(src) {document.getElementById('fullscreenImg').src = src;document.getElementById('fullscreenViewer').style.display = 'flex';}
        function closeFullscreenViewer() {document.getElementById('fullscreenViewer').style.display = 'none';}
        
function saveImageToGallery() {
    const imgElement = document.getElementById('finalImage');
    
    if (!imgElement || !imgElement.src) return;

    const imgData = imgElement.src;
    const cleanBase64 = imgData.split(',')[1];

    if (tipoImagenActual === 'estetica') {
        if(currentProfileName && DB.clients[currentProfileName]) {
            const newPhoto = {id:Date.now(),date:Date.now(),data:imgData};
            DB.clients[currentProfileName].savedPhotos = [newPhoto];
            
            saveData();
            
}
}
    else if (tipoImagenActual === 'agenda') {
}

    if(typeof Android !== 'undefined' && Android.guardarFotoGaleria) {
        Android.guardarFotoGaleria(cleanBase64);
}
    else {
        const a = document.createElement('a');a.href = imgData;a.download = 'barber-'+Date.now()+'.jpg';
        document.body.appendChild(a);a.click();document.body.removeChild(a);
}
}
        
        async function shareImage() {const imgData = document.getElementById('finalImage').src;if(typeof Android !== 'undefined') Android.compartirImagenBase64(imgData);else {}}

        function selectTagInModal(el,tag) {document.querySelectorAll('#modalAdd .tag-pill').forEach(t => t.classList.remove('active'));if(document.getElementById('inputTag').value === tag) {document.getElementById('inputTag').value = "";}else {el.classList.add('active');document.getElementById('inputTag').value = tag;}}
        function selectTagInQuick(el,tag) {document.querySelectorAll('#quickTagsRow .tag-pill').forEach(t => t.classList.remove('active'));if(document.getElementById('quickTagInput').value === tag) {document.getElementById('quickTagInput').value = "";}else {el.classList.add('active');document.getElementById('quickTagInput').value = tag;}}
        function selectTagInEdit(el,tag) {document.querySelectorAll('#editTagsRow .tag-pill').forEach(t => t.classList.remove('active'));if(document.getElementById('editClientTagInput').value === tag) {document.getElementById('editClientTagInput').value = "";}else {el.classList.add('active');document.getElementById('editClientTagInput').value = tag;}}
        function checkAutoTag(phone) {return null;}
        function getTagBadge(tag) {if(!tag) return '';let text = '';let cls = '';if(tag === 'vip') {text = 'VIP';cls = 'tag-vip';}if(tag === 'good') {text = '$$$';cls = 'tag-good';}if(tag === 'alert') {text = '!!!';cls = 'tag-alert';}return `<span class="tag-badge ${cls}">${text}</span>`;}
        function checkRecordBreaker(dailyTotal) {const currentBest = DB.settings.bestDayRevenue || 0;if (dailyTotal > currentBest && dailyTotal > 0) {DB.settings.bestDayRevenue = dailyTotal;saveData();fireConfetti();const popup = document.getElementById('trophyAnim');popup.style.display = 'flex';setTimeout(() => {popup.style.display = 'none';},4000);}}
        function fireConfetti() {for(let i=0;i<50;i++) {const conf = document.createElement('div');conf.className = 'confetti';conf.style.left = Math.random() * 100 + 'vw';conf.style.backgroundColor = ['#f1c40f','#e74c3c','#2ecc71','#3498db'][Math.floor(Math.random()*4)];conf.style.animationDuration = (Math.random() * 2 + 2) + 's';document.body.appendChild(conf);setTimeout(() => conf.remove(),4000);}}
        
        function programarAlarmas() {
            if (typeof Android === 'undefined' || !Android.programarAgendaDiaria) return;
            if (!DB || !DB.appointments || !Array.isArray(DB.appointments)) return;

            try {
                const now = new Date();
                const futureAppointments = DB.appointments
                    .filter(a => {
                        // FILTRO ANTI-TUTORIAL: Ignorar IDs falsos
                        if ([9991, 9992, 9993].includes(a.id)) return false;

                        if(!a.date || !a.time) return false;
                        try {
                            const apptTime = new Date(a.date + 'T' + a.time);
                            return apptTime.getTime() > now.getTime();
}catch(err) {return false;}
})
                    .map(a => {
                        const clientData = (DB.clients && DB.clients[a.name]) ? DB.clients[a.name] :{};
                        return {
                            id:a.id,
                            name:a.name,
                            date:a.date,
                            time:a.time,
                            phone:clientData.phone || '' 
};
});

                Android.programarAgendaDiaria(JSON.stringify(futureAppointments));
}catch (e) {
                console.warn("Error silenciado en alarmas:",e);
}
}

        function revisarAgendaDiaria() {
            if (typeof Android === 'undefined' || !Android.mostrarNotificacionTurnos) return;

            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(now.getDate() + 1);

            const tomorrowISO = `${tomorrow.getFullYear()}-${String(tomorrow.getMonth()+1).padStart(2,'0')}-${String(tomorrow.getDate()).padStart(2,'0')}`;

            const tomorrowApps = DB.appointments
                .filter(a => a.date === tomorrowISO)
                .sort((a,b) => a.time.localeCompare(b.time));

            let title,message;
            if (tomorrowApps.length === 0) {
                title = "🎉 ¡Mañana libre!";
                message = "Parece que no hay turnos agendados. ¡Día de descanso o de promoción!";
}else {
                title = `📅 ${tomorrowApps.length}Turnos para Mañana`;
                const list = tomorrowApps.map(a => {
                    return `${formatTime(a.time)}- ${a.name}`;
}).join('\n');
                message = `Tus citas:\n${list}`;
}

            Android.mostrarNotificacionTurnos(title,message);
}

        function triggerPhotoSelect(num) {if(typeof Android !== 'undefined' && Android.seleccionarFoto1 && num === 1) {Android.seleccionarFoto1();}else if(typeof Android !== 'undefined' && Android.seleccionarFoto2 && num === 2) {Android.seleccionarFoto2();}else {document.getElementById('cameraInput' + num).click();}}
        function handleCamera(input,num) {if (input.files && input.files[0]) {const reader = new FileReader();reader.onload = function(e) {const imgId = 'previewImg' + num;const img = document.getElementById(imgId);img.src = e.target.result;img.style.display = 'block';document.getElementById('editLabel' + num).style.display = 'block';if(num === 1) document.getElementById('compImg1').src = e.target.result;if(num === 2) document.getElementById('compImg2').src = e.target.result;checkSliderVisibility();};reader.readAsDataURL(input.files[0]);}}
function generateCollage() {
    tipoImagenActual = 'estetica';
    const i1 = document.getElementById('previewImg1');
    const i2 = document.getElementById('previewImg2');
    
    if(i1.style.display === 'none' || i2.style.display === 'none' || !i1.src || !i2.src) {
        return showCustomAlert('warning','Faltan Fotos','Debes cargar las dos fotos.');
    }
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // REDUCIMOS TAMAÑO PARA AHORRAR MEMORIA (Antes 1080x1350)
    const w = 640; 
    const h = 800; 
    canvas.width = w;
    canvas.height = h;
    
    ctx.fillStyle = "#111";
    ctx.fillRect(0,0,w,h);
    
    const img1 = new Image();img1.src = i1.src;
    const img2 = new Image();img2.src = i2.src;

    const drawCover = (img,x,y,width,height) => {
        let imgRatio = img.width / img.height;
        let targetRatio = width / height;
        let sx,sy,sWidth,sHeight;

        if (imgRatio > targetRatio) {
            sHeight = img.height;
            sWidth = img.height * targetRatio;
            sy = 0;
            sx = (img.width - sWidth) / 2;
        }else {
            sWidth = img.width;
            sHeight = img.width / targetRatio;
            sx = 0;
            sy = (img.height - sHeight) / 2;
        }
        ctx.drawImage(img,sx,sy,sWidth,sHeight,x,y,width,height);
    };
    
    img1.onload = () => {
        drawCover(img1,0,0,w/2,h);
        
        img2.onload = () => {
            drawCover(img2,w/2,0,w/2,h);
            
            ctx.beginPath();
            ctx.moveTo(w/2,0);
            ctx.lineTo(w/2,h);
            ctx.lineWidth = 3; 
            ctx.strokeStyle = "rgba(255,255,255,0.8)";
            ctx.stroke();

            // Fondo semitransparente abajo (más pequeño)
            const footerH = 80;
            ctx.fillStyle = "rgba(0,0,0,0.6)";
            ctx.fillRect(0, h - footerH, w, footerH);

            // Texto ANTES / DESPUES (más pequeño)
            ctx.font = "bold 26px Montserrat,sans-serif";
            ctx.fillStyle = "white";
            ctx.textAlign = "center";
            ctx.fillText("ANTES", w/4, h - 30);
            ctx.fillText("DESPUÉS", (w/4)*3, h - 30);
            
            const b = DB.settings.brand;
            if(b.enabled) {
                ctx.save();
                ctx.shadowColor = "rgba(0,0,0,1)";
                ctx.shadowBlur = 5;
                ctx.fillStyle = b.color;
                ctx.textAlign = "center";
                // Fuentes ajustadas al nuevo tamaño
                let fontStr = "bold 35px sans-serif";
                if(b.font.includes('modern')) fontStr = "900 40px Montserrat";
                else if(b.font.includes('elegant')) fontStr = "50px Lobster";
                else if(b.font.includes('urban')) fontStr = "50px 'Bebas Neue'";
                else if(b.font.includes('cyber')) fontStr = "35px Orbitron";
                ctx.font = fontStr;
                ctx.fillText(b.text, w/2, 80);
                ctx.restore();
            }
    
            // COMPRESIÓN AL 60% (0.6) PARA AHORRAR ESPACIO
            const finalImgData = canvas.toDataURL('image/jpeg', 0.6);
            
            // OCULTAR BOTON PRIVACIDAD (Solo para fotos)
            const btnPriv = document.getElementById('btnPrivacyResult');
            if(btnPriv) btnPriv.style.display = 'none';

            document.getElementById('finalImage').src = finalImgData;
            
            if(typeof currentProfileName !== 'undefined' && currentProfileName && DB.clients[currentProfileName]) {
                if(!DB.clients[currentProfileName].savedPhotos) DB.clients[currentProfileName].savedPhotos = [];
                const newPhoto = {id:Date.now(),date:Date.now(),data:finalImgData};
                DB.clients[currentProfileName].savedPhotos.unshift(newPhoto);
                
                // Límite de seguridad: Solo guardar las últimas 10 fotos por cliente para no explotar memoria
                if(DB.clients[currentProfileName].savedPhotos.length > 10) {
                     DB.clients[currentProfileName].savedPhotos.pop(); 
                }
                saveData();
                showToast("Estética Generada", "✨", "FOTOS");
            }

            document.getElementById('fabRow').classList.add('show-buttons');
            document.getElementById('view-result-placeholder').ontouchstart = null;
            document.getElementById('view-result-placeholder').ontouchend = null;
            document.getElementById('view-result-placeholder').style.display = 'flex';
        }
    };
        
    if(img1.complete) img1.onload();
}
        
        function resetStudio() {document.getElementById('previewImg1').src='';document.getElementById('previewImg1').style.display='none';document.getElementById('editLabel1').style.display='none';document.getElementById('previewImg2').src='';document.getElementById('previewImg2').style.display='none';document.getElementById('editLabel2').style.display='none';document.getElementById('view-result-placeholder').style.display='none';document.getElementById('comparisonViewer').style.display = 'none';}
        function checkSliderVisibility() {if(document.getElementById('previewImg1').style.display === 'block' && document.getElementById('previewImg2').style.display === 'block') {document.getElementById('comparisonViewer').style.display = 'block';}}

        function cleanTrash() {const now = Date.now();const oneDay = 24 * 60 * 60 * 1000;DB.trash = DB.trash.filter(item => (now - item.deletedAt) < oneDay);saveData();}

        function ejecutarCierreDiario() {
            const hoy = getLocalISOString();
            
            // 1. Identificar turnos viejos (ayer o antes)
            const viejos = DB.appointments.filter(a => a.date < hoy);
            if(viejos.length === 0) return;

            // 2. Agrupar dinero por fecha
            const mapDinero = {};
            viejos.forEach(t => {
                if(!mapDinero[t.date]) mapDinero[t.date] = 0;
                mapDinero[t.date] += parseInt(t.price || 0);
            });

            // 3. Convertir a "Cierres" en Extras y Subir a Nube
            let cambios = false;
            Object.keys(mapDinero).forEach(fecha => {
                const total = mapDinero[fecha];
                // Verificar si ya existe un cierre para esa fecha para no duplicar
                const existe = DB.extras.find(e => e.date === fecha && (e.reason && e.reason.includes("CIERRE")));
                
                if(!existe && total > 0) {
                    const [y, m, d] = fecha.split('-');
                    const razonCierre = `📁 CIERRE ${d}/${m}`;
                    // Generar ID numérico único para que sea compatible con el servidor
                    const idCierre = Date.now() + Math.floor(Math.random() * 10000);

                    DB.extras.push({
                        id: idCierre,
                        type: 'manual',
                        reason: razonCierre,
                        price: total,
                        date: fecha,
                        time: "23:59"
                    });
                    cambios = true;

                    // NUEVO: Subir Cierre y LIMPIAR Detalle en Nube (Ahorro Espacio)
                    if(MY_DEVICE_ID && typeof supabase !== 'undefined') {
                        // 1. Subimos la Carpeta Amarilla (El Resumen)
                        supabase.from('ingresos_extra').insert([{
                            id: idCierre,
                            barbero_id: MY_DEVICE_ID,
                            tipo: 'manual',
                            razon: razonCierre,
                            precio: total,
                            fecha: fecha,
                            hora: "23:59"
                        }]).then(res => {
                            if(!res.error) {
                                // 2. ÉXITO: AHORA BORRAMOS LOS CORTES SUELTOS DE ESE DÍA EN EL SERVIDOR
                                supabase.from('turnos')
                                    .delete()
                                    .eq('barbero_id', MY_DEVICE_ID)
                                    .eq('fecha', fecha)
                                    .then(() => console.log("🗑️ Espacio liberado en nube: " + fecha));
                            }
                        });
                    }
                }
            });

            // 4. Borrar los turnos individuales viejos
            if(viejos.length > 0) {
                DB.appointments = DB.appointments.filter(a => a.date >= hoy);
                cambios = true;
            }

            if(cambios) {
                saveData();
                console.log("🧹 Limpieza de historial completada.");
            }
        }
        function openTrashModal() {cleanTrash();renderTrashList();document.getElementById('modalTrash').classList.add('open');}
        function renderTrashList(resetPagination = true) {
            if(resetPagination) trashLimit = 20;

            const container = document.getElementById('trashListContainer');
            
            container.onscroll = function() {
                if(container.scrollTop + container.clientHeight >= container.scrollHeight - 50) {
                    trashLimit += 20;
                    renderTrashList(false);
}
};

            container.innerHTML = '';
            
            if(DB.trash.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#555;margin-top:30px;">La papelera esta vacia.</p>';
                return;
}
            
            const now = Date.now();
            DB.trash.sort((a,b) => b.deletedAt - a.deletedAt);
            
            const displayed = DB.trash.slice(0,trashLimit);

            displayed.forEach((item,index) => {
                const div = document.createElement('div');
                div.className = 'trash-item';
                let icon = item.type === 'client' ? '<i class="fas fa-user"></i>' :'<i class="fas fa-calendar-check"></i>';
                let timeLeft = 24 - ((now - item.deletedAt) / (1000 * 60 * 60));
                let timeStr = timeLeft < 1 ? Math.floor(timeLeft * 60) + ' min' :Math.floor(timeLeft) + ' horas';
                
                div.innerHTML = `<div class="trash-info"><div style="font-weight:bold;color:#fff;">${icon}${item.originalName}</div><div class="trash-meta"><span>Origen:${item.origin}</span><span style="color:var(--primary);">Expira en:${timeStr}</span></div></div><button class="btn-restore" onclick="restoreFromTrash(${index})"><i class="fas fa-undo"></i> Restaurar</button>`;
                container.appendChild(div);
});
}
        function restoreFromTrash(index) {
    const item = DB.trash[index]; if(!item) return;
    
    if(item.type === 'client') {
        if(DB.clients[item.originalName]) { 
            showCustomAlert('warning', 'Error', 'El cliente ya existe activo.'); 
            return; 
        }
        DB.clients[item.originalName] = item.data;
    } 
    else if (item.type === 'appointment') {
        DB.appointments.push(item.data);
        
        // REACTIVAR EN NUBE (BLINDAJE TOTAL)
        // Insertamos como nuevo registro para garantizar bloqueo de horario
        if (navigator.onLine && typeof supabase !== 'undefined') {
            const turnoRestaurado = {
                barbero_id: MY_DEVICE_ID,
                cliente: item.data.name,
                telefono: item.data.phone || "",
                fecha: item.data.date,
                hora: item.data.time,
                precio: item.data.price,
                estado: 'aceptado',
                servicio: 'Restaurado'
            };

            supabase.from('turnos').insert([turnoRestaurado]).then(() => {
                console.log("Turno restaurado y bloqueado en servidor");
            });
        }
    } 
    else if (item.type === 'qr') {
        DB.qrs.push(item.data);
    }
    
    DB.trash.splice(index,1);
    saveData();
    renderTrashList();
    renderAgenda();
    renderClients();
    if(document.getElementById('modalQR').classList.contains('open')) renderQRGrid();
    
    showToast("Elemento Restaurado", "♻️", "ÉXITO");
}
        function moveToTrash(type,data,name,origin) {DB.trash.push({type:type,data:data,originalName:name,origin:origin,deletedAt:Date.now()});saveData();}
        function loadGoalSettingsUI() {document.getElementById('toggleGoal').checked = DB.settings.showGoal;document.getElementById('inputGoalAmount').value = DB.settings.monthlyGoal;}
        function saveGoalSettings() {DB.settings.showGoal = document.getElementById('toggleGoal').checked;DB.settings.monthlyGoal = parseInt(document.getElementById('inputGoalAmount').value) || 80000;saveData();renderAgenda();}
            // --- CEREBRO IA (VOICE CONTROL) ---
    function toggleVoiceSettings() {
        if(!DB.settings.voice) DB.settings.voice = { enabled: false };
        DB.settings.voice.enabled = document.getElementById('toggleVoice').checked;
        saveData();
        updateVoiceFabVisibility();
    }

    function updateVoiceFabVisibility() {
        const fab = document.getElementById('fabVoice');
        const enabled = DB.settings.voice && DB.settings.voice.enabled;
        if(fab) {
            fab.style.display = enabled ? 'flex' : 'none';
            const toggle = document.getElementById('toggleVoice');
            if(toggle) toggle.checked = enabled;
        }
    }

    function activarMicrofono() {
        const fab = document.getElementById('fabVoice');
        fab.classList.add('listening');
        if(navigator.vibrate) navigator.vibrate(50);
        
        // Llamada al Puente Java que creamos
        if(typeof Android !== 'undefined' && Android.escucharOrden) {
            Android.escucharOrden();
        } else {
            // Solo para pruebas en PC
            setTimeout(() => procesarComandoVoz("Cuanto hice hoy"), 1500); 
        }
    }

            // --- BARBER ALEXA ENGINE: MODELO DE INTERACCIÓN NLU ---
    class AlexaBrain {
        constructor() {
            this.intents = [];
            this.dialogState = null; // Para manejar conversaciones (Slots faltantes)
            this.initIntents();
        }

        // 1. CONFIGURACIÓN DE INTENCIONES (UTTERANCES + SLOTS)
        initIntents() {
            // INTENCIÓN: NAVEGACIÓN
            this.addIntent('NavegacionIntent', [
                "ir a {pantalla}",
                "abre {pantalla}",
                "muéstrame {pantalla}",
                "ver {pantalla}"
            ], (slots) => {
                const destino = slots.pantalla.toLowerCase();
                if (destino.includes('agenda') || destino.includes('calendario')) navTo('agenda');
                else if (destino.includes('cliente') || destino.includes('perfil')) navTo('clientes');
                else if (destino.includes('contacto')) navTo('contactos');
                else if (destino.includes('ajuste') || destino.includes('config')) navTo('ajustes');
                else if (destino.includes('dinero') || destino.includes('caja')) openFinanceModal();
                else return "No sé cómo llegar ahí.";
                return `Abriendo ${slots.pantalla}`;
            });

            // INTENCIÓN: AGENDAR CITA
            this.addIntent('AgendarCitaIntent', [
                "anota a {cliente} a las {hora} por {precio}",
                "agendar a {cliente} a las {hora}",
                "nuevo turno para {cliente}",
                "pon a {cliente}"
            ], (slots) => {
                // DIALOG MANAGEMENT: Si falta el cliente, preguntar
                if (!slots.cliente) return { ask: "¿A quién quieres agendar?" };
                
                // Lógica de búsqueda y guardado
                const nombre = this.resolverCliente(slots.cliente);
                if (!nombre) return `No encontré a ${slots.cliente} en tus contactos.`;

                // Valores por defecto si faltan slots opcionales
                const hora = this.normalizarHora(slots.hora); 
                const precio = this.limpiarPrecio(slots.precio);

                this.ejecutarAgendamiento(nombre, hora, precio);
                return `Listo. ${nombre} agendado a las ${hora}.`;
            });

            // INTENCIÓN: CONSULTAR DINERO
            this.addIntent('ConsultarCajaIntent', [
                "cuánto hice hoy",
                "cuánto he ganado",
                "ver ganancia",
                "cómo va la caja"
            ], () => {
                const total = document.getElementById('dailyTotal').innerText;
                const valor = (total === "****") ? "oculto" : total;
                return `Llevas ${valor} pesos hoy.`;
            });
            
            // INTENCIÓN: BORRAR TURNO
            this.addIntent('BorrarTurnoIntent', [
                "borra a {cliente}",
                "elimina el turno de {cliente}",
                "cancela a {cliente}"
            ], (slots) => {
                if(!slots.cliente) return { ask: "¿A quién elimino?" };
                
                // Buscar en agenda
                const turno = DB.appointments.find(a => a.name.toLowerCase().includes(slots.cliente.toLowerCase()));
                
                if(turno) {
                    deleteAppointment(turno.id);
                    return `Turno de ${turno.name} eliminado.`;
                } else {
                    return "No encontré ese turno hoy.";
                }
            });
        }

        // --- NÚCLEO DE PROCESAMIENTO (EL CEREBRO) ---
        addIntent(name, utterances, handler) {
            this.intents.push({ 
                name, 
                patterns: utterances.map(u => this.compileUtterance(u)), 
                handler 
            });
        }

        compileUtterance(str) {
            // Convierte "anota a {cliente}" en Regex: /^anota a (.+)$/
            let regexStr = str.replace(/\{(\w+)\}/g, "(?<$1>.+)"); 
            return new RegExp("^" + regexStr + "$", "i"); // "i" = ignora mayúsculas
        }

        process(textRaw) {
            document.getElementById('fabVoice')?.classList.remove('listening');
            if(!textRaw) return;
            
            showToast("🗣️ " + textRaw, "🧠", "ALEXA MODE");
            const text = textRaw.toLowerCase().trim()
                .replace(/^(oye|ok|hola) (barber|alexa|siri|google),? /i, "") // Limpiar "Hola Alexa"
                .replace(/[¿?¡!]/g, ""); // Limpiar signos

            // 1. DIALOG MANAGEMENT (Si el asistente hizo una pregunta antes)
            if (this.dialogState) {
                // Aquí iría la lógica para rellenar el slot faltante con la respuesta
                // Por simplicidad en este archivo único, reseteamos si es un comando nuevo
                this.dialogState = null; 
            }

            // 2. BUSCAR INTENCIÓN (INTENT MATCHING)
            for (const intent of this.intents) {
                for (const regex of intent.patterns) {
                    const match = text.match(regex);
                    if (match) {
                        const slots = match.groups || {};
                        const response = intent.handler(slots);
                        
                        if (typeof response === 'object' && response.ask) {
                            this.speak(response.ask);
                            // Activar micro de nuevo para responder (Dialog Flow)
                            setTimeout(() => activarMicrofono(), 2500); 
                        } else {
                            this.speak(response);
                        }
                        return;
                    }
                }
            }

            // FALLBACK (Si no coincide exacto, usamos búsqueda difusa simple)
            this.fallbackFuzzy(text);
        }

        fallbackFuzzy(text) {
            // Si la estructura estricta falla, buscamos palabras clave
            if (text.includes("agenda")) { navTo('agenda'); this.speak("Abriendo agenda."); }
            else if (text.includes("cliente")) { navTo('clientes'); this.speak("Clientes."); }
            else { this.speak("No entendí ese comando."); }
        }

        // --- UTILIDADES ---
        speak(text) {
            if(typeof Android !== 'undefined' && Android.hablar) Android.hablar(text);
            else {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'es-ES';
                window.speechSynthesis.speak(u);
            }
        }

        resolverCliente(nombreVoz) {
            // Lógica Difusa para encontrar "Juan" si dije "Juan Perez"
            const query = nombreVoz.toLowerCase();
            const keys = Object.keys(DB.clients);
            const match = keys.find(k => k.toLowerCase().includes(query));
            return match || null; // Retorna el nombre exacto de la DB o null
        }

        normalizarHora(txt) {
            if(!txt) {
                const d = new Date();
                return `${String(d.getHours()).padStart(2,'0')}:00`;
            }
            // Lógica simple para demo: Extraer solo números
            const nums = txt.match(/\d+/g);
            if(nums) {
                let h = parseInt(nums[0]);
                if(txt.includes("tarde") || txt.includes("noche") || txt.includes("pm")) h += 12;
                return `${h}:00`;
            }
            return "12:00";
        }
        
        limpiarPrecio(txt) {
            if(!txt) return "500";
            return txt.replace(/\D/g, "") || "500";
        }

        ejecutarAgendamiento(nombre, hora, precio) {
            const nuevoTurno = {
                id: Date.now(),
                name: nombre,
                phone: DB.clients[nombre]?.phone || "",
                date: getLocalISOString(),
                time: hora,
                price: precio
            };
            DB.appointments.push(nuevoTurno);
            saveData();
            renderAgenda();
        }
    }

    const alexa = new AlexaBrain();
    function procesarComandoVoz(texto) { alexa.process(texto); }
    function hablarIA(texto) { alexa.speak(texto); }


        function togglePrivacy() {DB.settings.privacyMode = !DB.settings.privacyMode;saveData();renderAgenda();if(document.getElementById('modalFinance').classList.contains('open')) {const activeTab = document.querySelector('.finance-tabs .f-tab.active');renderFinance(currentFinanceMode,activeTab,false);}}
        function handleSearchInput() {
            const input = document.getElementById('apptSearch');
            const val = input.value.toLowerCase();
            const list = document.getElementById('clientSuggestions');
            const btnX = document.getElementById('btnXSearch');
            
            if(val.length > 0) btnX.style.display = 'block';
            else btnX.style.display = 'none';

            list.innerHTML = '';
            if (!val) {list.style.display = 'none';return;}

            const matches = Object.keys(DB.clients).filter(name => {
                const c = DB.clients[name];
                return name.toLowerCase().includes(val) || (c.phone && c.phone.includes(val));
});
            
                        if (matches.length > 0) {
                list.style.display = 'block';
                list.scrollTop = 0;
                matches.forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = `<div style="font-weight:bold;">${name}</div><small>${DB.clients[name].phone || ''}</small>`;
                    item.onclick = () => {
                        selectClientFromSearch(name);
                        toggleTimePicker(true);
};
                    list.appendChild(item);
});
}else {
                list.style.display = 'none';
}

}
        function clearSearchInput() {document.getElementById('apptSearch').value = '';handleSearchInput();document.getElementById('apptSearch').focus();}
                function selectClientFromSearch(name) {
            document.getElementById('apptSearch').value = name;
            document.getElementById('inputClient').value = name;
            if(DB.clients[name]) {
                if(DB.clients[name].phone) document.getElementById('inputPhone').value = DB.clients[name].phone;
                if(DB.clients[name].tag) {
                    document.getElementById('inputTag').value = DB.clients[name].tag;
                    document.querySelectorAll('#modalAdd .tag-pill').forEach(t => {
                        if(t.classList.contains('tag-'+DB.clients[name].tag)) t.classList.add('active');
                        else t.classList.remove('active');
});
}
}
            document.getElementById('clientSuggestions').style.display = 'none';
            isSelectionMode = true;
            
            toggleSmartGrid();
}
        toggleTimePicker(false);

                function toggleManualInput() {
            const div = document.getElementById('manualInputContainer');
            if(div.style.display === 'none') {
                div.style.display = 'block';
                if(!document.getElementById('inputClient').value && document.getElementById('apptSearch').value) {
                    document.getElementById('inputClient').value = document.getElementById('apptSearch').value;
}
                toggleSmartGrid();
}else {
                div.style.display = 'none';
}
}

        function toggleThemePanel() {document.getElementById('themeContainer').classList.toggle('show');}
        function switchTutorialTab(tabId,btn) {document.querySelectorAll('#view-tutorial .f-tab').forEach(t => t.classList.remove('active'));btn.classList.add('active');document.querySelectorAll('#view-tutorial .tab-content').forEach(c => c.classList.remove('active'));document.getElementById('tut-' + tabId).classList.add('active');}
        function toggleFaq(el) {el.classList.toggle('active');const answer = el.nextElementSibling;if (answer.style.display === "block") {answer.style.display = "none";}else {answer.style.display = "block";}}
        function importContact() {
            toggleTimePicker(true);
            
            isImportingForClientList = false;
            if(typeof Android !== 'undefined') Android.abrirContactos();
            else {}
}

        function importContactForClientList() {
            isImportingForClientList = true;
            if(typeof Android !== 'undefined') Android.abrirContactos();
            else {}
}

        function descargarBackup() {
            document.getElementById('modalBackupSelector').classList.add('open');
}

        function toggleAllBackupChecks() {
            const inputs = document.querySelectorAll('#modalBackupSelector input');
            const algunApagado = Array.from(inputs).some(i => !i.checked);
            inputs.forEach(i => i.checked = algunApagado);
}

                function ejecutarBackupFinal() {
            try {
                // 1. Recopilar datos visuales (Checkboxes)
                const saveCli = document.getElementById('bkClients').checked;
                const saveApp = document.getElementById('bkAppts').checked;
                const savePic = document.getElementById('bkPhotos').checked;
                const saveQr = document.getElementById('bkQRs').checked;
                const saveBg = document.getElementById('bkBg').checked;

                // 2. Preparar Datos Locales (Para restaurar la App del Barbero)
                let clientesFinal = {};
                if(saveCli) {
                    if(savePic) {
                        clientesFinal = DB.clients;
                    } else {
                        clientesFinal = JSON.parse(JSON.stringify(DB.clients));
                        Object.keys(clientesFinal).forEach(k => { delete clientesFinal[k].savedPhotos; });
                    }
                }

                // 3. DATOS SERVIDOR (Para que el ADMIN lo entienda) - TRADUCCIÓN AUTOMÁTICA
                const serverBarbero = {
                    id: MY_DEVICE_ID || localStorage.getItem('bm_secure_id_v1'),
                    nombre: DB.settings.brand.text || "Usuario",
                    telefono: localStorage.getItem('barber_phone_real') || "",
                    disponible: localStorage.getItem('barber_online_status') === 'true',
                    verificado: DB.settings.verified,
                    horario: DB.settings.schedule
                };

                let serverTurnos = [];
                if (saveApp) {
                    serverTurnos = DB.appointments.map(a => ({
                        id: a.id, 
                        barbero_id: MY_DEVICE_ID,
                        cliente: a.name,
                        telefono: a.phone || "",
                        fecha: a.date,   
                        hora: a.time,    
                        precio: a.price,
                        estado: 'aceptado', 
                        servicio: 'Importado Backup'
                    }));
                }

                let serverServicios = [];
                const cachedServ = localStorage.getItem('bm_cached_services');
                if (cachedServ) serverServicios = JSON.parse(cachedServ);

                // 4. PAQUETE MAESTRO (Híbrido)
                var json = JSON.stringify({
                    // --- PARTE LOCAL ---
                    appointments: saveApp ? DB.appointments : [],
                    extras: saveApp ? DB.extras : [],
                    profiles: clientesFinal,
                    settings: DB.settings,
                    trash: DB.trash,
                    qrs: saveQr ? DB.qrs : [],
                    customBg: saveBg ? localStorage.getItem('fondoPersonalizado') : null,
                    secureId: localStorage.getItem('bm_secure_id_v1'),
                    myPhone: localStorage.getItem('barber_phone_real'),

                    // --- PARTE ADMIN (Etiquetas para subir al servidor) ---
                    tipo: 'INDIVIDUAL',  
                    fecha: new Date().toISOString(),
                    barbero: serverBarbero,
                    turnos: serverTurnos,
                    servicios: serverServicios
                });

                // 5. GUARDAR
                const nombreLimpio = (DB.settings.brand.text || 'Backup').replace(/[^a-zA-Z0-9]/g, '');
                const fileName = "BARBER_" + nombreLimpio + "_" + Date.now() + ".json";

                if (typeof Android !== 'undefined' && Android.guardarBackup) {
                    // Enviamos el JSON. Si tu Java soporta nombre, perfecto. Si no, usará default.
                    // Lo importante es que el contenido tiene la etiqueta 'INDIVIDUAL'.
                    Android.guardarBackup(json); 
                } else {
                    // Modo PC
                    var base64 = window.btoa(unescape(encodeURIComponent(json)));
                    var href = "data:application/json;base64," + base64;
                    var a = document.createElement('a');
                    a.href = href;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
                showToast("Copia lista para enviar", "💾", "SISTEMA");
                closeModal();
            } catch(e) {
                console.error(e);
                showToast("Error creando backup", "❌", "ERROR");
            }
        }


                function recibirContacto(nombre,numero) {
            if(isQuickImport) {
                if(!DB.clients[nombre]) {
                    DB.clients[nombre] = {visits:0,phone:numero,tag:checkAutoTag(numero)};
                    saveData();
                    renderClients();
}else {
                    DB.clients[nombre].phone = numero;
                    saveData();
}

                document.getElementById('quickClientInput').value = nombre;
                document.getElementById('quickClientPhone').value = numero;
                
                handleQuickClientSearch();
                
                isQuickImport = false;
                return;
}

            navTo('agenda');
            if(isImportingForClientList) {
                document.getElementById('quickName').value = nombre;
                document.getElementById('quickPhone').value = numero;
                document.getElementById('modalQuickClient').classList.add('open');
}
            else {
                openAddModal();
                document.getElementById('inputClient').value = nombre;
                document.getElementById('inputPhone').value = numero;
                document.getElementById('manualInputContainer').style.display = 'block';
                document.getElementById('searchContainer').style.display = 'none';
                isSelectionMode = true;
                toggleSmartGrid();
}
}
function recibirBackupBase64(b64) {
    try {
        var json = decodeURIComponent(escape(window.atob(b64)));
        var d = JSON.parse(json);

        if (d.appointments) {
            DB.appointments = d.appointments;
            if (d.secureId) {
                localStorage.setItem('bm_secure_id_v1', d.secureId);
                MY_DEVICE_ID = d.secureId;
            }

            DB.clients = d.profiles || d.clients || {};
            DB.settings = d.settings || DB.settings;
            DB.extras = d.extras || [];
            DB.trash = d.trash || [];
            DB.qrs = d.qrs || [];

            if (d.customBg) localStorage.setItem('fondoPersonalizado', d.customBg);
            if (d.myPhone) localStorage.setItem('barber_phone_real', d.myPhone);

            saveData();
            
            // --- NUEVO: FORZAR SUBIDA A LA NUBE TRAS RESTAURAR ---
            if(MY_DEVICE_ID && typeof supabase !== 'undefined') {
                showToast("Sincronizando con Nube...", "☁️", "BACKUP");
                
                // 1. Subir Turnos (Upsert masivo)
                const turnosNube = DB.appointments.map(a => ({
                    id: a.id, barbero_id: MY_DEVICE_ID, cliente: a.name, telefono: a.phone||"", fecha: a.date, hora: a.time, precio: a.price, estado: 'aceptado', servicio: 'Restaurado'
                }));
                // Subir en lotes pequeños para no saturar
                if(turnosNube.length > 0) supabase.from('turnos').upsert(turnosNube).then(res => console.log("Agenda Sincronizada"));

                // 2. Subir Extras (Upsert masivo)
                const extrasNube = DB.extras.map(e => ({
                    id: e.id, barbero_id: MY_DEVICE_ID, tipo: 'manual', razon: e.reason, precio: e.price, fecha: e.date, hora: e.time
                }));
                if(extrasNube.length > 0) supabase.from('ingresos_extra').upsert(extrasNube).then(res => console.log("Finanzas Sincronizadas"));
                
                // 3. Subir Perfil Básico
                const myPhone = localStorage.getItem('barber_phone_real');
                const myName = DB.settings.brand.text;
                if(myPhone) {
                    supabase.from('barberos').upsert({ id: MY_DEVICE_ID, nombre: myName, telefono: myPhone, verificado: DB.settings.verified }).then(() => console.log("Perfil Sincronizado"));
                }
            }
            // -----------------------------------------------------

            setTimeout(() => location.reload(), 2000);
        }
    } catch (e) {
        showToast("Error al restaurar", "❌", "ERROR");
    }
}

function recibirFondoDesdeApp(b64) {
    applyBg(b64);
    localStorage.setItem('fondoPersonalizado', b64);
}

function recibirFotoAntes(b64) {
    document.getElementById('previewImg1').src = b64;
    document.getElementById('previewImg1').style.display = 'block';
    document.getElementById('editLabel1').style.display = 'block';
    document.getElementById('compImg1').src = b64;
    checkSliderVisibility();
}

function recibirFotoDespues(b64) {
    document.getElementById('previewImg2').src = b64;
    document.getElementById('previewImg2').style.display = 'block';
    document.getElementById('editLabel2').style.display = 'block';
    document.getElementById('compImg2').src = b64;
    checkSliderVisibility();
}

function startClock() {
    setInterval(() => {
        const now = new Date();
        let h = now.getHours();
        const m = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        document.getElementById('realClock').innerText = `${h}:${m}:${s}${ampm}`;

        if (now.getDate() !== currentDayTracker) {
            currentDayTracker = now.getDate();
            goToToday();
        }

        if (s === "00") {
            renderAgenda();
            if (document.getElementById('view-clientes').classList.contains('active')) {
                renderClients(false);
            }
        }
    }, 1000);
}

function loadBrandSettingsUI() {
    const b = DB.settings.brand;
    document.getElementById('toggleBrand').checked = b.enabled;
    document.getElementById('brandTextInput').value = b.text;
    document.getElementById('brandColorInput').value = b.color;
    document.querySelectorAll('.font-opt').forEach(opt => opt.classList.remove('selected'));
    const activeFont = document.querySelector(`.font-opt.${b.font}`);
    if (activeFont) activeFont.classList.add('selected');
}

function saveBrandSettings() {
    DB.settings.brand.enabled = document.getElementById('toggleBrand').checked;
    DB.settings.brand.text = document.getElementById('brandTextInput').value;
    DB.settings.brand.color = document.getElementById('brandColorInput').value;
    saveData();
    applyBrandSettings();
}

function selectFont(fontClass, el) {
    DB.settings.brand.font = fontClass;
    document.querySelectorAll('.font-opt').forEach(opt => opt.classList.remove('selected'));
    el.classList.add('selected');
    saveBrandSettings();
}

function applyBrandSettings() {
    const b = DB.settings.brand;
    const el = document.getElementById('brandDisplay');
    el.style.display = b.enabled ? 'block' : 'none';
    el.innerText = b.text;
    el.style.color = b.color;
    el.className = b.font;

}

function showCustomAlert(type, title, message, onConfirm, onCancel) {
    const overlay = document.getElementById('customAlert');
    const icon = document.getElementById('alertIcon');
    const btnContainer = document.getElementById('alertButtons');
    document.getElementById('alertTitle').innerText = title;
    document.getElementById('alertMessage').innerHTML = message;
    btnContainer.innerHTML = '';
    if (type === 'success') {
        icon.className = 'fas fa-check-circle fa-3x';
        icon.style.color = '#2ecc71';
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.innerText = 'Genial';
        btn.onclick = () => {
            overlay.style.display = 'none';
            if (onConfirm) onConfirm();
        };
        btnContainer.appendChild(btn);
    } else if (type === 'warning') {
        icon.className = 'fas fa-exclamation-circle fa-3x';
        icon.style.color = '#ff9800';
        const btnCancel = document.createElement('button');
        btnCancel.className = 'btn btn-outline';
        btnCancel.innerText = 'Cancelar';
        btnCancel.onclick = () => {
            overlay.style.display = 'none';
            if (onCancel) onCancel();
        };
        const btnOk = document.createElement('button');
        btnOk.className = 'btn';
        btnOk.innerText = 'Confirmar';
        btnOk.onclick = () => {
            overlay.style.display = 'none';
            if (onConfirm) onConfirm();
        };
        btnContainer.appendChild(btnCancel);
        btnContainer.appendChild(btnOk);
    } else if (type === 'force-edit') {
        icon.className = 'fas fa-user-edit fa-3x';
        icon.style.color = '#3498db';
        const btnOk = document.createElement('button');
        btnOk.className = 'btn';
        btnOk.innerText = 'Editar';
        btnOk.onclick = () => {
            overlay.style.display = 'none';
            if (onConfirm) onConfirm();
        };
        btnContainer.appendChild(btnOk);
    }
    overlay.style.display = 'flex';
}

let hasShownBatteryAlert = false;

function showBatteryOptimizationAlert() {
    if (hasShownBatteryAlert) return;
    hasShownBatteryAlert = true;

    showCustomAlert(
        'warning',
        '🔋 Desactivar Ahorro',
        'Para que las notificaciones funcionen SIEMPRE (incluso con la app cerrada),pulsa **Confirmar** y selecciona **"Sin restricciones"** o **"No optimizar"** para Barber Manager.',
        function() {
            if (typeof Android !== 'undefined' && Android.requestIgnoreBatteryOptimizations) {
                Android.requestIgnoreBatteryOptimizations();
            }
            // Esperamos 10 segundos antes de permitir que salga de nuevo
            setTimeout(() => { hasShownBatteryAlert = false; }, 10000);
        },
        function() {
            // Si cancela, permitimos que salga de nuevo inmediatamente si el sistema lo pide
            hasShownBatteryAlert = false;
        }
    );
}

function attemptSaveAppointment() {
    const editId = document.getElementById('editId').value;
    if (!document.getElementById('inputClient').value && document.getElementById('apptSearch').value) {
        document.getElementById('inputClient').value = document.getElementById('apptSearch').value;
    }
    const name = document.getElementById('inputClient').value.trim();
    const phone = document.getElementById('inputPhone').value.trim();
    const date = document.getElementById('inputDate').value;
    const time = document.getElementById('inputTime').value;
    const price = document.getElementById('inputPrice').value;
    if (!name || !date || !time) return showCustomAlert('warning', 'Faltan Datos', 'Pon nombre,fecha y hora.', null, null);
    if (date.endsWith('-12-25')) showCustomAlert('success', '🥳🥳HAPPY BRITHDAY TO MY🥳🥳', 'Es tu cumpleaños🎂🎂!');
    checkTimeAndProceed(name, phone, date, time, price, editId);
}

function checkTimeAndProceed(name, phone, date, time, price, editId) {
    proceed(name, phone, date, time, price, editId);
}

function addSwipeLogic(element, onRightSwipe, onLeftSwipe) {
    let startX = 0;
    let currentX = 0;
    let isDragging = false;

    element.addEventListener('touchstart', e => {
        startX = e.touches[0].clientX;
        isDragging = true;
        element.style.transition = 'none';
    }, {
        passive: true
    });

    element.addEventListener('touchmove', e => {
        if (!isDragging) return;
        currentX = e.touches[0].clientX;
        const diff = currentX - startX;
        if (Math.abs(diff) > 10) element.style.transform = `translateX(${diff}px)`;
    }, {
        passive: true
    });

    element.addEventListener('touchend', e => {
        isDragging = false;
        const endX = e.changedTouches[0].clientX;
        const diff = endX - startX;
        element.style.transition = 'transform 0.3s ease';

        if (diff > 100) {
            element.style.transform = `translateX(100%)`;
            setTimeout(() => {
                onRightSwipe();
                element.style.transform = `translateX(0)`;
            }, 300);
        } else if (diff < -100) {
            element.style.transform = `translateX(-100%)`;
            setTimeout(() => {
                onLeftSwipe();
                element.style.transform = `translateX(0)`;
            }, 300);
        } else {
            element.style.transform = `translateX(0)`;
        }
    });
}

function proceed(name, phone, date, time, price, editId) {
    const conflict = findConflict(date, time, editId);
    if (conflict) {
        showCustomAlert('warning', '🔀 Cruce de Horario 🕜', `Tienes a <strong>${conflict.name}</strong> a las <strong>${formatTime(conflict.time)}</strong>.`, () => finalize(name, phone, date, time, price, editId), null);
    } else finalize(name, phone, date, time, price, editId);
}

function findConflict(date, time, excludeId) {
    const nm = getMinutes(time);
    return DB.appointments.find(a => {
        if (excludeId && a.id == excludeId) return false;
        if (a.date !== date) return false;
        return Math.abs(getMinutes(a.time) - nm) < 30;
    });
}

function finalize(name, phone, date, time, price, editId) {
    saveFinalData(name, phone, date, time, price, editId);
}

function saveFinalData(name, phone, date, time, price, editId) {
    if (editId) {
        const idx = DB.appointments.findIndex(a => a.id == editId);
        if (idx !== -1) DB.appointments[idx] = {
            id: parseInt(editId),
            name,
            phone,
            time,
            price,
            date
        };
    } else {
        DB.appointments.push({
            id: Date.now(),
            name,
            phone,
            time,
            price,
            date
        });
    }

    const tagInput = document.getElementById('inputTag').value;
    let finalTag = tagInput;

    if (!DB.clients[name]) {
        if (!finalTag) finalTag = checkAutoTag(phone);
        DB.clients[name] = {
            visits: 0,
            lastDate: date,
            phone: phone,
            tag: finalTag
        };
    } else {
        if (phone) DB.clients[name].phone = phone;
        if (tagInput) DB.clients[name].tag = tagInput;
        else if (!DB.clients[name].tag) DB.clients[name].tag = checkAutoTag(phone);
    }

    if (!editId) DB.clients[name].visits = (DB.clients[name].visits || 0) + 1;
    DB.clients[name].lastDate = date;

    saveData();
    closeModal();
    renderAgenda();
    renderClients();

    if (document.getElementById('modalFinance').classList.contains('open')) {
        renderFinance(currentFinanceMode, null, false);
    }

    if (!date.endsWith('-12-25')) {
        if (editId) {}
    }

    programarAlarmas();

    if (!editId) {
        const turnoParaNube = {
            barbero_id: MY_DEVICE_ID,
            cliente: name,
            telefono: phone || "",
            fecha: date,
            hora: time,
            precio: price,
            servicio: "Manual/Local",
            estado: "aceptado"
        };

        if (navigator.onLine && typeof supabase !== 'undefined') {
            supabase.from('turnos').insert([turnoParaNube]).then(({
                error
            }) => {
                if (error) {
                    console.warn("Fallo subida, guardando para luego...");
                    agregarAColaPendientes(turnoParaNube);
                } else {
                    console.log("☁️ Turno subido y bloqueado en tiempo real");
                }
            });
        } else {
            agregarAColaPendientes(turnoParaNube);
        }
    }
}

function openManualEntryModal() {
    document.getElementById('manualReason').value = "";
    document.getElementById('manualAmount').value = "";
    document.getElementById('modalManualEntry').classList.add('open');
    document.getElementById('manualReason').focus();
}

async function saveManualEntry() {
    const reason = document.getElementById('manualReason').value.trim() || "Ingreso Extra";
    const amount = document.getElementById('manualAmount').value;
    const dateStr = getLocalISOString();
    const now = new Date();
    const timeStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    
    if (!amount || amount <= 0) return;
    
    const nuevoId = Date.now();
    const nuevoExtra = {
        id: nuevoId,
        type: 'manual',
        reason: reason,
        price: amount,
        date: dateStr,
        time: timeStr
    };

    // 1. Guardar Local
    DB.extras.push(nuevoExtra);
    saveData();

    // 2. Subir a la Nube (Supabase)
    if(MY_DEVICE_ID && typeof supabase !== 'undefined') {
        const { error } = await supabase.from('ingresos_extra').insert([{
            id: nuevoId,
            barbero_id: MY_DEVICE_ID,
            tipo: 'manual',
            razon: reason,
            precio: amount,
            fecha: dateStr,
            hora: timeStr
        }]);
        if(error) console.error("Error subiendo extra:", error);
    }

    showToast("Ingreso agregado", "💰", "CAJA");
    closeModal();
    
    if (document.getElementById('modalFinance').classList.contains('open')) {
        const activeTab = document.querySelector('.finance-tabs .f-tab.active');
        renderFinance(currentFinanceMode, activeTab, false);
    }
    renderAgenda();
}

function editAppointment(id) {
    const app = DB.appointments.find(a => a.id === id);
    if (!app) return;
    
    const modal = document.getElementById('modalAdd');
    const card = modal.querySelector('.modal-card');

    // ACTIVAR MODO MITAD (Solo Fecha/Hora)
    card.classList.add('half-mode');

    document.getElementById('modalTitle').innerText = "Reprogramar";
    document.getElementById('btnSaveAppt').innerText = "Guardar Cambios";
    document.getElementById('editId').value = app.id;
    
    // Configurar Nombre (Solo lectura y centrado)
    const inpName = document.getElementById('inputClient');
    inpName.value = app.name;
    inpName.readOnly = true; 
    inpName.style.textAlign = 'center';
    inpName.style.border = 'none';
    inpName.style.fontSize = '1.2rem';
    inpName.style.background = 'transparent';

    document.getElementById('inputPhone').value = app.phone || '';
    document.getElementById('inputPrice').value = app.price;

    document.getElementById('inputDate').value = app.date;
    const [y, m, d] = app.date.split('-');
    document.getElementById('inputDateDisplay').value = `${d}/${m}/${y}`;

    document.getElementById('inputTime').value = app.time;

    // OCULTAR ELEMENTOS SOBRANTES
    document.getElementById('searchContainer').style.display = 'none';
    document.getElementById('actionButtonsRow').style.display = 'none';
    
    // Mostramos el contenedor manual para ver el nombre, pero ocultamos el teléfono
    document.getElementById('manualInputContainer').style.display = 'block';
    document.getElementById('inputPhone').style.display = 'none';
    
    document.getElementById('containerPrice').style.display = 'none';

    isSelectionMode = true;
    modal.classList.add('open');
}

function deleteAppointment(id) {
    showCustomAlert('warning', 'Papelera', 'Se moverá a la papelera y se liberará el horario online.',
        async () => {
            const app = DB.appointments.find(a => a.id === id);
            if (app) {
                // 1. Sincronizar con Nube (BORRADO BLINDADO POR FECHA/HORA)
                // Usamos fecha y hora para garantizar que se borre aunque el ID local sea diferente al del servidor
                if (navigator.onLine && typeof supabase !== 'undefined') {
                    supabase.from('turnos').delete()
                        .eq('barbero_id', MY_DEVICE_ID)
                        .eq('fecha', app.date)
                        .eq('hora', app.time)
                        .then(() => console.log("Turno liberado en nube (Match Fecha/Hora)"));
                }

                // 2. Lógica Local
                if (DB.clients[app.name]) {
                    DB.clients[app.name].visits--;
                    if (DB.clients[app.name].visits < 0) DB.clients[app.name].visits = 0;
                }
                moveToTrash('appointment', app, app.name + " (" + app.date + ")", 'Agenda');
                DB.appointments = DB.appointments.filter(a => a.id !== id);
                saveData();
                renderAgenda();
                renderClients();
                if (showingAll) showAllPending();
                showToast("Turno eliminado", "🗑️", "PAPELERA");

                programarAlarmas();
            }
        },
        () => {
            renderAgenda();
        }
    );
}

function getMinutes(t) {
    const [h, m] = t.split(':').map(Number);
    return h * 60 + m;
}

function openFinanceModal() {
    setTimeout(renderWeeklyChart, 100);
    document.getElementById('modalFinance').classList.add('open');
    financeLimit = 10;
    document.querySelectorAll('.f-tab').forEach(t => t.classList.remove('active'));
    document.querySelector('.finance-tabs .f-tab:first-child').classList.add('active');
    renderFinance('day', null);
}

function loadMoreFinance() {
    financeLimit += 10;
    renderFinance(currentFinanceMode, null, false);
}
let financeViewDate = new Date();

function setFinanceMonth(isoMonth) {
    if(!isoMonth) return;
    const [y, m] = isoMonth.split('-');
    financeViewDate = new Date(parseInt(y), parseInt(m)-1, 1);
    renderFinance('month', null, true);
    if(navigator.vibrate) navigator.vibrate(20);
}

function renderFinance(mode, tab, resetPagination = true) {
    if (resetPagination) financeLimit = 20;
    currentFinanceMode = mode;
    
    if (tab) {
        document.querySelectorAll('.f-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        if(mode !== 'month') financeViewDate = new Date();
    }

    const list = document.getElementById('financeList');
    
    // Solo usamos paginación scroll en modo día (lista larga)
    list.onscroll = function() {
        if (mode === 'day' && list.scrollTop + list.clientHeight >= list.scrollHeight - 50) {
            financeLimit += 20;
            renderFinance(currentFinanceMode, null, false);
        }
    };

    list.innerHTML = '';

    const allTransactions = [...DB.appointments, ...DB.extras];
    const now = new Date();
    const todayDateStr = getLocalISOString();
    
    // --- 1. SELECTOR DE MES (Solo en pestaña MES) ---
    if (mode === 'month') {
        const uniqueMonths = new Set();
        uniqueMonths.add(`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`);
        allTransactions.forEach(t => { if(t.date) uniqueMonths.add(t.date.substring(0, 7)); });
        const sortedMonths = Array.from(uniqueMonths).sort().reverse();
        const currentSelection = `${financeViewDate.getFullYear()}-${String(financeViewDate.getMonth()+1).padStart(2,'0')}`;
        const mesesNombres = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
        
        const options = sortedMonths.map(mStr => {
            const [y, m] = mStr.split('-');
            const label = `${mesesNombres[parseInt(m)-1]} ${y}`;
            return `<option value="${mStr}" ${(mStr === currentSelection) ? "selected" : ""}>${label}</option>`;
        }).join('');

        const monthSelector = document.createElement('div');
        monthSelector.style.cssText = "padding:0 5px 15px 5px; position:sticky; top:0; z-index:5; background:#000;";
        monthSelector.innerHTML = `<select onchange="setFinanceMonth(this.value)" style="width:100%; padding:12px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:#fff; border-radius:12px; font-weight:bold; font-size:1rem; text-align:center;">${options}</select>`;
        list.appendChild(monthSelector);
    }

    // --- 2. CÁLCULO DE DATOS ---
    let itemsToShow = [];
    let totalPeriodo = 0;

    // A. MODO DÍA (Lista detallada)
    if (mode === 'day') {
        itemsToShow = allTransactions.filter(t => t.date === todayDateStr && (t.type === 'manual' || new Date(t.date+'T'+t.time) <= now));
        itemsToShow.sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
        itemsToShow.forEach(t => totalPeriodo += parseInt(t.price || 0));
    }
    // B. MODO SEMANA/MES/GLOBAL (Agrupados)
    else {
        const groupedTotals = {};
        let minDate = new Date(0);
        let maxDate = new Date(8640000000000000);

        if (mode === 'week') {
            minDate = new Date();
            minDate.setDate(now.getDate() - 6); 
            minDate.setHours(0,0,0,0);
            maxDate = new Date();
            maxDate.setHours(23,59,59,999);
        } else if (mode === 'month') {
            minDate = new Date(financeViewDate.getFullYear(), financeViewDate.getMonth(), 1);
            maxDate = new Date(financeViewDate.getFullYear(), financeViewDate.getMonth() + 1, 0, 23, 59, 59);
        }

        allTransactions.forEach(t => {
            const tDate = new Date(t.date + 'T00:00:00');
            // Validar rango fecha
            if ((mode === 'global') || (tDate >= minDate && tDate <= maxDate)) {
                
                // CORRECCIÓN: Ocultar dinero de días futuros (ej: día 10 si hoy es 7)
                if (t.date > todayDateStr) return;
                // Ignorar horas futuras de hoy
                if (t.date === todayDateStr && new Date(t.date+'T'+t.time) > now) return;
                
                let key, label, sub, icon;
                
                if (mode === 'global') {
                    const [y, m, d] = t.date.split('-');
                    key = `${y}-${m}`; // Agrupar por Mes
                    const monthNames = ["ENE","FEB","MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC"];
                    label = `${monthNames[parseInt(m)-1]} ${y}`;
                    sub = "Balance Mensual";
                    icon = '<i class="fas fa-calendar" style="color:#3498db;"></i>';
                } else {
                    key = t.date; // Agrupar por Día
                    const [y, m, d] = t.date.split('-');
                    label = `DÍA ${d}`;
                    sub = `${d}/${m}`;
                    icon = '<i class="fas fa-calendar-day" style="color:#2ecc71;"></i>';
                }

                if (!groupedTotals[key]) groupedTotals[key] = { key: key, title: label, subtitle: sub, price: 0, count: 0, icon: icon };
                
                groupedTotals[key].price += parseInt(t.price || 0);
                groupedTotals[key].count += 1;
                totalPeriodo += parseInt(t.price || 0);
            }
        });
        
        itemsToShow = Object.values(groupedTotals).sort((a,b) => b.key.localeCompare(a.key));
    }

    // --- 3. ACTUALIZAR TOTAL ---
    const totalDisplay = document.getElementById('financeTotal');
    if(totalDisplay) totalDisplay.innerText = DB.settings.privacyMode ? '****' : totalPeriodo;

    // --- 4. RENDERIZADO ---
    if (itemsToShow.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.cssText = "text-align:center;color:#555;margin-top:20px;";
        emptyMsg.innerText = "Sin registros en este periodo.";
        list.appendChild(emptyMsg);
        return;
    }

    // -> RENDER GRID (Semana, Mes, Global)
    if (mode !== 'day') {
        const gridContainer = document.createElement('div');
        gridContainer.className = 'finance-grid-view';
        
        itemsToShow.forEach(item => {
            const priceTxt = DB.settings.privacyMode ? '$****' : `$${item.price}`;
            const card = document.createElement('div');
            card.className = 'fin-summary-card';
            card.innerHTML = `
                <div class="fin-card-icon">${item.icon}</div>
                <div class="fin-card-title">${item.title}</div>
                <div class="fin-card-value">${priceTxt}</div>
                <div class="fin-card-sub">${item.count} Movimientos</div>
            `;
            gridContainer.appendChild(card);
        });
        list.appendChild(gridContainer);
    } 
    // -> RENDER LISTA (Día)
    else {
        const displayed = itemsToShow.slice(0, financeLimit);
        displayed.forEach(item => {
            const wrapper = document.createElement('div');
            wrapper.className = 'swipe-item';
            
            const precioSeguro = item.price || 0;
            const priceTxt = DB.settings.privacyMode ? '$****' : `$${precioSeguro}`;
            
            const dateParts = item.date ? item.date.split('-') : ['00','00','00'];
            const d = dateParts[2]; const m = dateParts[1];
            
            const isManual = item.type === 'manual';
            const title = isManual ? (item.reason || "Extra") : item.name;
            const icon = isManual ? '<i class="fas fa-hand-holding-usd" style="color:#3498db;"></i>' : '<i class="fas fa-user"></i>';
            const timeStr = item.time ? formatTime(item.time) : '--:--';
            
            wrapper.innerHTML = `
            <div class="swipe-front">
                <div style="display:flex;flex-direction:column;justify-content:center;line-height:1.2;overflow:hidden;flex:1;">
                    <div style="font-weight:700;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#fff;">${icon} ${title}</div>
                    <div style="font-size:0.65rem;color:#666;">${d}/${m} • ${timeStr}</div>
                </div>
                <div style="display:flex;align-items:center;gap:15px;">
                    <div style="color:var(--primary);font-weight:800;font-size:0.95rem;">${priceTxt}</div>
                    <button onclick="borrarFinanza(${item.id}, '${isManual?'manual':'cita'}'); event.stopPropagation();" style="background:none;border:none;color:#444;font-size:0.9rem;padding:5px;"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
            
            list.appendChild(wrapper);
        });
    }
}


const ROW_HEIGHT = 65;
let globalContactKeys = [];
let alphaMap = {}; 

function renderContactsList(reset = true) {
    const listContainer = document.getElementById('contactsListContainer');
    const search = document.getElementById('contactSearch').value.toLowerCase();
    const countSpan = document.getElementById('contactsCount');

    globalContactKeys = Object.keys(DB.clients)
        .filter(name => name.toLowerCase().includes(search))
        .sort((a, b) => {
            const isCharA = /^[a-zA-Z\u00C0-\u017F]/.test(a);
            const isCharB = /^[a-zA-Z\u00C0-\u017F]/.test(b);
            if (isCharA && !isCharB) return -1;
            if (!isCharA && isCharB) return 1;
            return a.localeCompare(b, 'es', { sensitivity: 'base' });
        });

    if (countSpan) countSpan.innerText = `(${globalContactKeys.length})`;

    let virtualBox = document.getElementById('virtualBox');
    if (!virtualBox) {
        listContainer.innerHTML = '';
        listContainer.parentElement.scrollTop = 0;

        virtualBox = document.createElement('div');
        virtualBox.id = 'virtualBox';
        virtualBox.className = 'virtual-wrapper';
        listContainer.appendChild(virtualBox);

        listContainer.parentElement.onscroll = () => {
            requestAnimationFrame(drawVirtualContacts);
        };
    }

    virtualBox.style.height = (globalContactKeys.length * ROW_HEIGHT) + "px";
    
    generateAlphaNav(); // GENERAR BARRA LATERAL A-Z
    drawVirtualContacts();
}

function generateAlphaNav() {
    const nav = document.getElementById('alphaNav');
    if(!nav) return;
    nav.innerHTML = '';
    alphaMap = {};

    // Mapear posiciones
    globalContactKeys.forEach((name, index) => {
        const char = name.charAt(0).toUpperCase();
        if (!alphaMap[char]) alphaMap[char] = index * ROW_HEIGHT;
    });

    // Llenar A-Z
    const fullAlpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
    fullAlpha.forEach(char => {
        const el = document.createElement('div');
        el.className = 'alpha-char';
        el.innerText = char;
        el.style.opacity = alphaMap[char] ? '1' : '0.2'; 
        nav.appendChild(el);
    });

    const handleTouch = (e) => {
        if(e.cancelable) e.preventDefault();
        const touch = e.touches[0] || e.changedTouches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        
        if (target && target.classList.contains('alpha-char')) {
            const char = target.innerText;
            const bubble = document.getElementById('alphaBubble');
            bubble.innerText = char;
            bubble.classList.add('show');
            
            if (alphaMap[char] !== undefined) {
                document.querySelector('#view-contactos .content-body').scrollTop = alphaMap[char];
            }
        }
    };

    nav.ontouchstart = handleTouch;
    nav.ontouchmove = handleTouch;
    // BLINDAJE: Apagar burbuja en cualquier caso (soltar, cancelar o salir)
    const hideBubble = () => document.getElementById('alphaBubble').classList.remove('show');
    nav.ontouchend = hideBubble;
    nav.ontouchcancel = hideBubble;
    nav.onmouseleave = hideBubble;
    
    // Limpieza preventiva al cargar
    hideBubble();
}

function drawVirtualContacts() {
    const listContainer = document.getElementById('contactsListContainer');
    const virtualBox = document.getElementById('virtualBox');
    if (!virtualBox) return;

    const scrollTop = listContainer.parentElement.scrollTop;
    const viewportHeight = listContainer.parentElement.clientHeight;

    const startIndex = Math.floor(scrollTop / ROW_HEIGHT);
    const endIndex = Math.min(globalContactKeys.length, Math.ceil((scrollTop + viewportHeight) / ROW_HEIGHT));

    const start = Math.max(0, startIndex - 20);
    const end = Math.min(globalContactKeys.length, endIndex + 20);

    virtualBox.innerHTML = '';

    if (globalContactKeys.length === 0) {
        virtualBox.innerHTML = '<div style="text-align:center;padding:30px;color:#555;position:absolute;width:100%;">Sin resultados.</div>';
        return;
    }

    for (let i = start; i < end; i++) {
        const name = globalContactKeys[i];
        const c = DB.clients[name];
        const hasPhone = c.phone && c.phone.length > 5;
        const topPos = i * ROW_HEIGHT;

        const wrapper = document.createElement('div');
        wrapper.className = 'virtual-item';
        wrapper.style.transform = `translateY(${topPos}px)`;
        wrapper.style.background = 'transparent';
        wrapper.style.borderRadius = '12px';
        wrapper.style.overflow = 'hidden';

        if (hasPhone) {
            const bgCall = document.createElement('div');
            bgCall.style.cssText = "position:absolute;top:0;bottom:0;left:0;width:100%;background:#2ecc71;display:flex;align-items:center;padding-left:25px;color:#fff;font-weight:bold;z-index:1;opacity:0;";
            bgCall.innerHTML = '<i class="fas fa-phone"></i>&nbsp;&nbsp;Llamar';

            const bgMsg = document.createElement('div');
            bgMsg.style.cssText = "position:absolute;top:0;bottom:0;right:0;width:100%;background:#3498db;display:flex;justify-content:flex-end;align-items:center;padding-right:45px;color:#fff;font-weight:bold;z-index:1;opacity:0;";
            bgMsg.innerHTML = 'Mensaje&nbsp;&nbsp;<i class="fas fa-comment"></i>';

            wrapper.appendChild(bgCall);
            wrapper.appendChild(bgMsg);
        }

        const content = document.createElement('div');
        content.className = 'client-item';
        content.style.height = '60px';
        content.style.top = '2px';
        content.style.position = 'relative';
        content.style.zIndex = '2';
        content.style.background = 'rgba(0,0,0,0.6)';
        content.style.border = '1px solid rgba(255,255,255,0.08)';
        content.style.transition = 'transform 0.1s ease-out';
        content.style.display = 'flex';
        content.style.alignItems = 'center';
        content.style.justifyContent = 'space-between';

        const phoneDisplay = hasPhone ? `<div style="font-size:0.8rem;color:#888;">${c.phone}</div>` : '';
        const safeName = name.replace(/'/g, "\\'");
        content.innerHTML = `<div style="flex:1;"><div style="font-weight:bold;font-size:1rem;color:#fff;">${name}</div>${phoneDisplay}</div><div style="color:#555;padding:14px;" onclick="openCustomEdit('${safeName}')"><i class="fas fa-pen"></i></div>`;

        if (hasPhone) {
            let startX = 0;
            let startY = 0;
            let isVertical = false;

            content.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isVertical = false;
                content.style.transition = 'none';
            }, { passive: true });

            content.addEventListener('touchmove', (e) => {
                if(isVertical) return;

                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const diffX = currentX - startX;
                const diffY = currentY - startY;

                // MATEMÁTICA: Si baja más que lo que se mueve al lado, es scroll vertical
                if (Math.abs(diffY) > Math.abs(diffX)) {
                    isVertical = true;
                    return;
                }
                
                // Si es lateral
                if (Math.abs(diffX) > 5) {
                    let move = diffX > 250 ? 250 : (diffX < -250 ? -250 : diffX);
                    content.style.transform = `translateX(${move}px)`;

                    if (wrapper.children[0] && wrapper.children[1]) {
                        if (diffX > 0) { // Derecha (Verde/Llamar)
                            wrapper.children[0].style.zIndex = 1; wrapper.children[1].style.zIndex = 0;
                            wrapper.children[0].style.opacity = Math.min(diffX / 100, 1);
                        } else { // Izquierda (Azul/SMS)
                            wrapper.children[0].style.zIndex = 0; wrapper.children[1].style.zIndex = 1;
                            wrapper.children[1].style.opacity = Math.min(Math.abs(diffX) / 100, 1);
                        }
                    }
                }
            }, { passive: false });

            // FUNCIÓN DE LIMPIEZA SEGURA
            const finalizarSwipe = () => {
                content.style.transition = 'transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                content.style.transform = `translateX(0)`;
                setTimeout(() => {
                    if (wrapper.children[0]) wrapper.children[0].style.opacity = '0';
                    if (wrapper.children[1]) wrapper.children[1].style.opacity = '0';
                }, 200);
            };

            content.addEventListener('touchend', (e) => {
                const fueVertical = isVertical;
                isVertical = false;
                
                // Si fue scroll, limpiamos posición y salimos (YA NO SE TRABA)
                if(fueVertical) { finalizarSwipe(); return; }
                
                const diff = e.changedTouches[0].clientX - startX;
                
                if (diff > 120) makeCall(c.phone);
                else if (diff < -120) window.location.href = `sms:${c.phone}`;
                
                finalizarSwipe();
            });

            // SEGURIDAD EXTRA: Si el sistema cancela el toque (llamada entrante, etc)
            content.addEventListener('touchcancel', () => { isVertical = false; finalizarSwipe(); });
        }
        wrapper.appendChild(content);
        virtualBox.appendChild(wrapper);
    }
}

function renderClients(resetPagination = true) {
    if (resetPagination) clientLimit = 20;

    const search = document.getElementById('clientSearch').value.toLowerCase();
    const container = document.getElementById('clientsListContainer');
    document.getElementById('btnClearSearch').style.display = search.length > 0 ? 'block' : 'none';

    const scrollTarget = container.parentElement;
    scrollTarget.onscroll = function() {
        if (scrollTarget.scrollTop + scrollTarget.clientHeight >= scrollTarget.scrollHeight - 50) {
            clientLimit += 20;
            renderClients(false);
        }
    };

    container.innerHTML = '';

    const now = new Date();
    const startedClients = new Set();

    DB.appointments.forEach(a => {
        const appTimeDate = new Date(a.date + 'T' + a.time);
        if (appTimeDate <= now) {
            startedClients.add(a.name);
        }
    });

    const list = Object.keys(DB.clients)
        .filter(name => startedClients.has(name))
        .map(k => ({
            name: k,
            ...DB.clients[k]
        }))
        .filter(c => c.name.toLowerCase().includes(search))
        .sort((a, b) => b.visits - a.visits);

    if (list.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#555;">No hay perfiles activos.</p>';
        return;
    }

    const displayed = list.slice(0, clientLimit);

    displayed.forEach(c => {
        const item = document.createElement('div');
        item.className = 'client-item';
        let tagHtml = getTagBadge(c.tag);

        item.innerHTML = ` 
            <div class="client-info" onclick="openClientProfile('${c.name}')"> 
                <div class="client-avatar">${c.name.charAt(0).toUpperCase()}</div> 
                <div style="overflow:hidden;"> 
                    <div style="font-weight:800;font-size:0.9rem;color:#fff;">${c.name}${tagHtml}</div> 
                    <div style="font-size:0.7rem;color:var(--text-muted);">${c.visits}Visitas</div> 
                </div> 
            </div> 
            `;
        container.appendChild(item);
    });
}

function openQuickClientModal() {
    document.getElementById('quickName').value = "";
    document.getElementById('quickPhone').value = "";
    document.getElementById('quickTagInput').value = "";
    document.querySelectorAll('#quickTagsRow .tag-pill').forEach(t => t.classList.remove('active'));
    document.getElementById('modalQuickClient').classList.add('open');
}

function normalizeNum(num) {
    if (!num) return '';
    let n = num.replace(/\D/g, '');
    if (n.startsWith('53') && n.length > 8) n = n.substring(2);
    return n;
}

function saveQuickClient() {
    const name = document.getElementById('quickName').value.trim();
    const phone = document.getElementById('quickPhone').value.trim();
    const tag = document.getElementById('quickTagInput').value;

    if (!name) return showCustomAlert('warning', 'Falta Nombre', 'Escribe el nombre del cliente.');

    if (phone.length > 4) {
        const newNum = normalizeNum(phone);
        const duplicateKey = Object.keys(DB.clients).find(key => {
            const existingNum = normalizeNum(DB.clients[key].phone);
            return existingNum === newNum && key !== name;
        });

        if (duplicateKey) {
            return showCustomAlert('warning', 'Número Usado', `Este número ya pertenece a:<b>${duplicateKey}</b>`);
        }
    }

    let finalTag = tag;
    if (!finalTag) finalTag = checkAutoTag(phone);

    DB.clients[name] = {
        visits: DB.clients[name] ? DB.clients[name].visits : 0,
        lastDate: DB.clients[name] ? DB.clients[name].lastDate : "",
        phone: phone,
        tag: finalTag
    };

    saveData();
    document.getElementById('modalQuickClient').classList.remove('open');
    renderClients();
}
let currentProfileName = '';

function openClientProfile(name) {
    currentProfileName = name;
    const client = DB.clients[name];
    document.getElementById('profileName').innerText = name;
    document.getElementById('profileAvatar').innerText = name.charAt(0).toUpperCase();
    document.getElementById('profileVisits').innerText = `${client.visits}Visitas Totales`;
    const historyList = document.getElementById('profileHistoryList');
    historyList.innerHTML = '';
    const history = DB.appointments.filter(a => a.name === name).sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
    if (history.length === 0) historyList.innerHTML = '<p style="text-align:center;color:gray;">Sin historial.</p>';
    history.forEach(h => {
        const div = document.createElement('div');
        div.style.padding = '12px 10px';
        div.style.borderBottom = '1px solid rgba(255, 255, 255, 0.05)';
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        div.innerHTML = `<div><div style="color:#fff;font-size:0.9rem;">${h.date}</div><div style="font-size:0.8rem;color:var(--text-muted);">${formatTime(h.time)}</div></div><div style="font-weight:bold;color:var(--primary);">$${h.price}</div>`;
        historyList.appendChild(div);
    });
    resetStudio();
    switchTab('history');
    document.getElementById('modalClientProfile').classList.add('open');
}

function switchTab(tabId) {
    document.querySelectorAll('.p-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    const btns = document.querySelectorAll('.p-tab');
    if (tabId === 'history') btns[0].classList.add('active');
    else btns[1].classList.add('active');
    document.getElementById('tab-' + tabId).classList.add('active');
}

function editClientContact(name) {
    const client = DB.clients[name];
    if (!client) return;
    document.getElementById('editClientOldName').value = name;
    document.getElementById('editClientName').value = name;
    document.getElementById('editClientPhone').value = client.phone || '';
    const currentTag = client.tag || '';
    document.getElementById('editClientTagInput').value = currentTag;
    document.querySelectorAll('#editTagsRow .tag-pill').forEach(t => {
        if (t.classList.contains('tag-' + currentTag)) t.classList.add('active');
        else t.classList.remove('active');
    });
    document.getElementById('modalEditClient').classList.add('open');
}

function saveClientEdit() {
    const oldName = document.getElementById('editClientOldName').value;
    const newName = document.getElementById('editClientName').value.trim();
    const newPhone = document.getElementById('editClientPhone').value.trim();
    const newTag = document.getElementById('editClientTagInput').value;
    if (!newName) return;
    if (newName !== oldName) {
        if (DB.clients[newName]) return;
        DB.clients[newName] = DB.clients[oldName];
        delete DB.clients[oldName];
        DB.appointments.forEach(a => {
            if (a.name === oldName) a.name = newName;
        });
    }
    DB.clients[newName].phone = newPhone;
    if (newTag) DB.clients[newName].tag = newTag;
    else DB.clients[newName].tag = checkAutoTag(newPhone);
    saveData();
    document.getElementById('modalEditClient').classList.remove('open');
    renderClients();
    renderAgenda();
    showCustomAlert('success', 'Actualizado', 'Datos guardados.');
}

function deleteClient(n) {
    showCustomAlert('warning', 'Papelera ', `Se movera a ${n}a la papelera .`, () => {
        const clientData = DB.clients[n];
        if (clientData) {
            moveToTrash('client', clientData, n, 'Lista Clientes');
            delete DB.clients[n];
            saveData();
            renderClients();
            showCustomAlert('success', 'Eliminado', 'Cliente en papelera .');
        }
    }, null);
}

function clearClientSearch() {
    document.getElementById('clientSearch').value = '';
    renderClients();
}

function goToToday() {
    showingAll = false;
    document.getElementById('btnToggleAll').classList.remove('btn-active-toggle');

    const list = document.getElementById('agendaList');
    if (list && list.parentElement) list.parentElement.onscroll = null;

    const f = getLocalISOString();
    const now = new Date();
    document.getElementById('todayDate').innerText = now.toLocaleDateString();

    document.getElementById('dateSelector').value = f;

    const [y, m, d] = f.split('-');
    const displayEl = document.getElementById('agendaDateDisplay');
    if (displayEl) displayEl.value = `${d}/${m}/${y}`;

    document.getElementById('quickFab').style.display = 'flex';
    renderAgenda();
}

function toggleAllPending() {
    if (showingAll) goToToday();
    else showAllPending();
}
let agendaLimit = 50;

function showAllPending(resetPagination = true) {
    if (resetPagination) agendaLimit = 50;

    showingAll = true;
    document.getElementById('btnToggleAll').classList.add('btn-active-toggle');

    document.getElementById('dateSelector').value = '';
    const displayEl = document.getElementById('agendaDateDisplay');
    if (displayEl) displayEl.value = "--- TODOS ---";

    document.getElementById('headerLabel').innerText = "Todos los turnos";
    document.getElementById('currencySign').style.display = 'none';
    document.getElementById('quickFab').style.display = 'none';

    const list = document.getElementById('agendaList');
    list.innerHTML = '';

    const now = new Date();
    const pending = DB.appointments.filter(a => new Date(a.date + 'T' + a.time) >= now).sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

    document.getElementById('dailyTotal').innerText = pending.length + " Turnos";

    if (pending.length === 0) {
        list.innerHTML = `<div style="text-align:center;padding:30px;opacity:0.85;"><i class="fas fa-check-circle fa-3x" style="color:var(--text-muted);"></i><p style="color:var(--text-muted);margin-top:10px;">Todo al dia</p></div>`;
        return;
    }

    const scrollParent = list.parentElement;
    scrollParent.onscroll = function() {
        if (showingAll && (scrollParent.scrollTop + scrollParent.clientHeight >= scrollParent.scrollHeight - 50)) {
            agendaLimit += 20;
            showAllPending(false);
        }
    };

    const displayed = pending.slice(0, agendaLimit);
    displayed.forEach(app => renderApptItem(app, list));
}

function renderAgenda() {
    if (document.getElementById('dateSelector').value) {
        showingAll = false;
        document.getElementById('btnToggleAll').classList.remove('btn-active-toggle');
        if (document.getElementById('view-agenda').classList.contains('active')) {
            document.getElementById('quickFab').style.display = 'flex';
        }
    }
    const date = document.getElementById('dateSelector').value;
    if (!date) return;
    document.getElementById('headerLabel').innerText = "Ganancia Hoy";
    document.getElementById('currencySign').style.display = 'inline';
    const list = document.getElementById('agendaList');
    list.innerHTML = '';
    const daily = DB.appointments.filter(a => a.date === date).sort((a, b) => a.time.localeCompare(b.time));
    const now = new Date();
    const isToday = (date === getLocalISOString());
    const dailyExtras = DB.extras.filter(e => e.date === date);
    let totalMoney = 0;
    daily.forEach(a => {
        const appDate = new Date(a.date + 'T' + a.time);
        if (!isToday || (isToday && now >= appDate)) {
            totalMoney += parseInt(a.price || 0);
        }
    });
    dailyExtras.forEach(e => totalMoney += parseInt(e.price || 0));
    if (DB.settings.privacyMode) {
        document.getElementById('dailyTotal').innerText = "****";
        document.getElementById('btnPrivacy').className = "fas fa-eye-slash privacy-btn";
    } else {
        document.getElementById('dailyTotal').innerText = totalMoney;
        document.getElementById('btnPrivacy').className = "fas fa-eye privacy-btn";
    }
    if (isToday && !DB.settings.privacyMode) checkRecordBreaker(totalMoney);
    const visibleApps = daily.filter(app => {
        if (!isToday) return true;
        const appTime = new Date(date + 'T' + app.time);
        const limitTime = new Date(appTime.getTime() + 60 * 60000);
        if (now > limitTime) return false;
        return true;
    });
    if (visibleApps.length === 0) list.innerHTML = `<div style="text-align:center;padding:30px;opacity:0.85;"><i class="fas fa-calendar-times fa-3x" style="color:var(--text-muted);"></i><p style="color:var(--text-muted);margin-top:10px;">Sin turnos pendientes</p></div>`;
    visibleApps.forEach(app => renderApptItem(app, list));
    const goalContainer = document.getElementById('monthlyGoalContainer');
    if (DB.settings.showGoal) {
        goalContainer.classList.add('show');
        let monthTotal = 0;
        let monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const allTransactions = [...DB.appointments, ...DB.extras];
        allTransactions.forEach(t => {
            const tDate = new Date(t.date + 'T00:00:00');
            if (tDate >= monthStart && tDate.getMonth() === now.getMonth()) {
                if (t.type === 'manual' || new Date(t.date + 'T' + t.time) <= now) {
                    monthTotal += parseInt(t.price || 0);
                }
            }
        });
        const goalAmount = DB.settings.monthlyGoal || 80000;
        let percent = Math.floor((monthTotal / goalAmount) * 100);
        if (percent > 100) percent = 100;
        if (DB.settings.privacyMode) {
            document.getElementById('goalText').innerText = "$**** / $****";
        } else {
            document.getElementById('goalText').innerText = `$${monthTotal}/ $${goalAmount}`;
        }
        document.getElementById('percentText').innerText = percent + "%";
        document.getElementById('goalBar').style.width = percent + "%";
    } else {
        goalContainer.classList.remove('show');
    }
}

function toggleActions(id) {
    const el = document.getElementById('actions-' + id);
    if (el) el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
}

function renderApptItem(app, list) {
    const item = document.createElement('div');
    item.className = 'appt-item';
    
    // Aseguramos que el elemento reciba toques incluso si está bloqueado visualmente
    item.style.pointerEvents = "auto"; 

    const now = new Date();
    const appTimeDate = new Date(app.date + 'T' + app.time);
    if (app.date === getLocalISOString() && now >= appTimeDate) {
        item.classList.add('appt-started');
    }

    let touchStartX = 0;
    let touchStartY = 0;
    let isVerticalScroll = false;

    item.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        isVerticalScroll = false;
        item.style.transition = 'none';
    }, {passive: true});

    item.addEventListener('touchmove', e => {
        if(isVerticalScroll) return; // Si ya detectamos scroll, no movemos lateral

        const currentX = e.changedTouches[0].screenX;
        const currentY = e.changedTouches[0].screenY;
        
        const diffX = currentX - touchStartX;
        const diffY = currentY - touchStartY;

        // MATEMÁTICA: Si se mueve más en Y que en X, es scroll vertical -> BLOQUEAR SWIPE
        if (Math.abs(diffY) > Math.abs(diffX)) {
            isVerticalScroll = true;
            return;
        }

        // Solo movemos si el desplazamiento es horizontal y significativo
        if (Math.abs(diffX) > 10) item.style.transform = `translateX(${diffX}px)`;
    }, {passive: false});

    item.addEventListener('touchend', e => {
        if(isVerticalScroll) {
            isVerticalScroll = false;
            return;
        }

        const touchEndX = e.changedTouches[0].screenX;
        item.style.transition = 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; // Animación más suave
        const diff = touchEndX - touchStartX;

        if (diff > 100) {
            // DESLIZAR DERECHA (Abrir Perfil)
            item.style.transform = `translateX(100px)`;
            setTimeout(() => {
                openClientProfile(app.name);
                
                // CONEXIÓN DIRECTA CON EL TUTORIAL
                if(typeof tutorialActive !== 'undefined' && tutorialActive) {
                    const currentStep = TUTORIAL_STEPS[currentStepIndex];
                    if(currentStep && currentStep.title === "DESLIZA AHORA") {
                        advanceTutorial();
                    }
                }
                
                setTimeout(() => switchTab('studio'), 100);
                item.style.transform = `translateX(0)`;
            }, 200);
        } else if (diff < -100) {
            // DESLIZAR IZQUIERDA (Borrar)
            item.style.transform = `translateX(-100%)`;
            setTimeout(() => {
                deleteAppointment(app.id);
            }, 300);
        } else {
            item.style.transform = `translateX(0)`;
        }
    });

    const hasPhone = app.phone && app.phone.length > 0;

    let menuHtml = '';
    if (hasPhone) {
        menuHtml = `
                <div id="actions-${app.id}" style="display:none;gap:16px;margin-right:8px;">
                    <button onclick="event.stopPropagation();toggleActions(${app.id});makeCall('${app.phone}')" class="action-btn btn-call"><i class="fas fa-phone"></i></button>
                    <a href="sms:${app.phone}" onclick="event.stopPropagation();toggleActions(${app.id})" class="action-btn btn-msg" style="display:flex;align-items:center;justify-content:center;"><i class="fas fa-comment"></i></a>
                    <button onclick="event.stopPropagation();toggleActions(${app.id});sendWhatsApp('${app.phone}')" class="action-btn btn-wa"><i class="fab fa-whatsapp"></i></button>
                </div>
                <button class="action-btn" style="background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2);" onclick="event.stopPropagation();toggleActions(${app.id})">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                `;
    }

    let timeDisplay = formatTime(app.time);
    if (showingAll) {
        const [y, m, d] = app.date.split('-');
        timeDisplay = `${d}/${m}- ${timeDisplay}`;
    }

    let priceDisplay = DB.settings.privacyMode ? '$****' : `$${app.price}`;
    let tagHtml = '';
    if (DB.clients[app.name]) {
        tagHtml = getTagBadge(DB.clients[app.name].tag);
    }

    item.innerHTML = ` 
            <div class="client-info" onclick="editAppointment(${app.id})"> 
                <div class="client-avatar">${app.name.charAt(0).toUpperCase()}</div> 
                <div style="overflow:hidden;"> 
                    <div style="font-weight:800;font-size:0.9rem;color:#fff;">${app.name}${tagHtml}</div> 
                    <div style="font-size:0.7rem;color:var(--text-muted);">${timeDisplay}. ${priceDisplay}</div> 
                </div> 
            </div> 
            <div class="client-actions" style="position:relative;z-index:10;"> 
                ${menuHtml}
            </div>`;

    list.appendChild(item);
}


function previewTheme(name) {
    tempTheme = name;
    applyTheme(name);
    DB.settings.theme = name;
    saveData();
    toggleThemePanel();
}

function applyTheme(name) {
    document.body.setAttribute('data-theme', name);
}

function applyBg(url) {
    document.getElementById('appBackground').style.backgroundImage = `url(${url})`;
}

function applyModalSettings() {}

function hideKeyboardOnScroll() {
    if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) {
        document.activeElement.blur();
    }
}

function formatTime(t) {
    if (!t) return '';
    const [h, m] = t.split(':');
    return `${h%12||12}:${m}${h>=12?'PM':'AM'}`;
}



let quickClientLimit = 50;

function openQuickMode() {
    // CORRECCIÓN PRO: Eliminamos el avance automático para evitar doble salto en el tutorial.
    // El avance ahora lo controla el evento 'click' definido en TUTORIAL_STEPS.

    const todayISO = getLocalISOString();
    const [y, m, d] = todayISO.split('-');

    document.getElementById('quickPriceInput').value = '500';
    document.getElementById('quickPriceDisplay').innerText = '500';

    document.getElementById('quickDateValue').value = todayISO;
    document.getElementById('quickDateDisplay').innerText = `${d}/${m}`;
    document.getElementById('quickClientInput').value = '';
    document.getElementById('quickTimeInput').value = '';
    document.getElementById('btnQuickConfirm').style.display = 'none';

    document.getElementById('btnQuickClear').style.display = 'none';

    renderQuickTimeGrid(todayISO);

    document.getElementById('quickModeOverlay').style.display = 'flex';

    setTimeout(() => {
        renderQuickClientList(true);
    }, 50);
}



function closeQuickMode() {
    document.getElementById('quickModeOverlay').style.display = 'none';
}

function renderQuickTimeGrid(dateStr) {
    const grid = document.getElementById('quickTimeGrid');
    grid.innerHTML = '';

    const startHour = 9;
    const endHour = 18;
    const now = new Date();
    const isToday = (dateStr === getLocalISOString());
    const currentMins = now.getHours() * 60 + now.getMinutes();

    for (let h = startHour; h <= endHour; h++) {
        for (let m = 0; m < 60; m += 30) {
            if (h === endHour && m === 30) continue;
            const timeStr = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            const slotMins = h * 60 + m;

            const isTaken = DB.appointments.some(a => {
                if (a.date !== dateStr) return false;
                const aMin = getMinutes(a.time);
                return Math.abs(aMin - slotMins) < 30;
            });
            const isPast = isToday && slotMins < currentMins;
            const isBlocked = isTaken || isPast;

            const btn = document.createElement('div');
            btn.style.padding = '12px 0';
            btn.style.textAlign = 'center';
            btn.style.border = '1px solid rgba(255,255,255,0.1)';
            btn.style.borderRadius = '10px';
            btn.style.fontSize = '0.75rem';
            btn.style.fontWeight = 'bold';
            btn.innerText = formatTime(timeStr);

            if (isBlocked) {
                btn.style.textDecoration = 'line-through';
                btn.style.color = '#555';
                btn.style.background = 'rgba(255,255,255,0.02)';
                btn.style.pointerEvents = 'none';
            } else {
                btn.style.color = '#2ecc71';
                btn.style.background = 'rgba(46,204,113,0.15)';
                btn.style.borderColor = '#2ecc71';
                btn.style.cursor = 'pointer';

                btn.onclick = () => {
                    document.querySelectorAll('#quickTimeGrid div').forEach(d => {
                        if (d.style.textDecoration !== 'line-through') {
                            d.style.background = 'rgba(46,204,113,0.15)';
                            d.style.color = '#2ecc71';
                        }
                    });
                    btn.style.background = '#2ecc71';
                    btn.style.color = '#000';
                    document.getElementById('quickTimeInput').value = timeStr;
                    checkQuickReady();
                };
            }
            grid.appendChild(btn);
        }
    }
}
        let globalQuickKeys = [];
        const QUICK_ROW_HEIGHT = 55;

        function renderQuickClientList(forceReset = false) {
            const list = document.getElementById('quickClientList');
            const search = document.getElementById('quickClientInput').value.toLowerCase();
            
            globalQuickKeys = Object.keys(DB.clients).sort((a,b) => {
                const vA = DB.clients[a].visits || 0;
                const vB = DB.clients[b].visits || 0;
                if (vB !== vA) return vB - vA;
                return a.localeCompare(b,'es',{sensitivity:'base'});
            }).filter(name => {
                const c = DB.clients[name];
                return name.toLowerCase().includes(search) || (c.phone && c.phone.includes(search));
            });

            let virtualBox = document.getElementById('virtualQuickBox');
            if(!virtualBox || forceReset) {
                list.innerHTML = '';
                list.scrollTop = 0;
                
                virtualBox = document.createElement('div');
                virtualBox.id = 'virtualQuickBox';
                virtualBox.className = 'virtual-wrapper';
                list.appendChild(virtualBox);
                
                list.onscroll = () => {requestAnimationFrame(drawVirtualQuickClients);};
            }

            if(globalQuickKeys.length === 0) {
                virtualBox.innerHTML = '<div style="padding:24px;color:#555;text-align:center;">Sin resultados</div>';
                virtualBox.style.height = 'auto';
            } else {
                virtualBox.style.height = (globalQuickKeys.length * QUICK_ROW_HEIGHT) + "px";
                drawVirtualQuickClients();
            }
        }

        function drawVirtualQuickClients() {
            const list = document.getElementById('quickClientList');
            const virtualBox = document.getElementById('virtualQuickBox');
            if(!virtualBox) return;

            const scrollTop = list.scrollTop;
            const viewportHeight = list.clientHeight;
            
            const startIndex = Math.floor(scrollTop / QUICK_ROW_HEIGHT);
            const endIndex = Math.min(globalQuickKeys.length,Math.ceil((scrollTop + viewportHeight) / QUICK_ROW_HEIGHT));
            
            const start = Math.max(0,startIndex - 5);
            const end = Math.min(globalQuickKeys.length,endIndex + 5);

            const currentSelection = document.getElementById('quickClientInput').value;

            virtualBox.innerHTML = '';

            for(let i = start;i < end;i++) {
                const name = globalQuickKeys[i];
                const clientData = DB.clients[name];
                const topPos = i * QUICK_ROW_HEIGHT;

                const item = document.createElement('div');
                item.className = 'virtual-item';
                item.style.transform = `translateY(${topPos}px)`;
                item.style.height = (QUICK_ROW_HEIGHT - 4) + 'px';
                
                const isSelected = (name === currentSelection);
                const bg = isSelected ? 'var(--primary)' :'rgba(0,0,0,0.6)';
                const col = isSelected ? '#000' :'#ddd';
                const subCol = isSelected ? '#000' :'#888';
                
                const phoneDisplay = clientData.phone ? `<span style="font-size:0.8rem;color:${subCol};margin-left:10px;">${clientData.phone}</span>` :'';

                item.innerHTML = `<div style="font-weight:bold;">${name}</div>${phoneDisplay}`;
                
                item.style.padding = '0 15px';
                item.style.display = 'flex';
                item.style.alignItems = 'center';
                item.style.justifyContent = 'space-between';
                item.style.borderRadius = '8px';
                item.style.border = '1px solid rgba(255,255,255,0.05)';
                item.style.background = bg;
                item.style.color = col;
                item.style.cursor = 'pointer';

                item.onclick = () => {
                    document.getElementById('quickClientInput').value = name;
                    document.getElementById('quickClientPhone').value = clientData.phone || '';
                    checkQuickReady();
                    requestAnimationFrame(drawVirtualQuickClients);
                };

                virtualBox.appendChild(item);
            }
        }

        function handleQuickClientSearch() {
            const val = document.getElementById('quickClientInput').value;
            if(val.length > 0) {
                document.getElementById('btnQuickClear').style.display = 'block';
            } else {
                document.getElementById('btnQuickClear').style.display = 'none';
            }
            renderQuickClientList(true);
            checkQuickReady();
        }

        function clearQuickInput() {
            document.getElementById('quickClientInput').value = '';
            document.getElementById('quickClientPhone').value = '';
            handleQuickClientSearch();
        }

        let isQuickImport = false;
        function importContactForQuick() {
            isQuickImport = true;
            if(typeof Android !== 'undefined') Android.abrirContactos();
        }

        function checkQuickReady() {
            const d = document.getElementById('quickDateValue').value;
            const t = document.getElementById('quickTimeInput').value;
            const c = document.getElementById('quickClientInput').value;
            const btn = document.getElementById('btnQuickConfirm');
            if(d && t && c.trim().length > 0) btn.style.display = 'block';
            else btn.style.display = 'none';
        }

        function saveQuickModeAppointment() {
            const name = document.getElementById('quickClientInput').value.trim();
            const phone = document.getElementById('quickClientPhone').value.trim();
            const date = document.getElementById('quickDateValue').value;
            const time = document.getElementById('quickTimeInput').value;
            const price = document.getElementById('quickPriceInput').value || "500";
            
            checkTimeAndProceed(name,phone,date,time,price,"");
            
            closeQuickMode();

            navTo('agenda');
        }

        let tempPrice = "";
        function openNumKeyboard() {
            tempPrice = "";
            document.getElementById('customNumKeyboard').style.display = 'grid';
        }
        function closeNumKeyboard() {
            document.getElementById('customNumKeyboard').style.display = 'none';
            if(tempPrice === "") tempPrice = "500";
            document.getElementById('quickPriceInput').value = tempPrice;
            document.getElementById('quickPriceDisplay').innerText = tempPrice;
        }
        function pressNum(val) {
            if(val === 'del') tempPrice = tempPrice.slice(0,-1);
            else if(tempPrice.length < 6) tempPrice += val;
            
            document.getElementById('quickPriceDisplay').innerText = tempPrice || "0";
            document.getElementById('quickPriceInput').value = tempPrice;
        }
        
        document.addEventListener('click',function(e) {
            const kbd = document.getElementById('customNumKeyboard');
            const container = document.getElementById('priceContainer');
            if(kbd.style.display === 'grid' && !container.contains(e.target)) {
                closeNumKeyboard();
            }
        });

        function setQuickTomorrow() {
            const currentVal = document.getElementById('quickDateValue').value;
            const now = new Date();
            
            const yToday = now.getFullYear();
            const mToday = String(now.getMonth() + 1).padStart(2,'0');
            const dToday = String(now.getDate()).padStart(2,'0');
            const todayISO = `${yToday}-${mToday}-${dToday}`;
            
            now.setDate(now.getDate() + 1);
            const yTmrw = now.getFullYear();
            const mTmrw = String(now.getMonth() + 1).padStart(2,'0');
            const dTmrw = String(now.getDate()).padStart(2,'0');
            const tomorrowISO = `${yTmrw}-${mTmrw}-${dTmrw}`;
            
            let targetISO = tomorrowISO;
            let displayDate = `${dTmrw}/${mTmrw}`;

            if(currentVal === tomorrowISO) {
                targetISO = todayISO;
                displayDate = `${dToday}/${mToday}`;
            }

            document.getElementById('quickDateValue').value = targetISO;
            document.getElementById('quickDateDisplay').innerText = displayDate;
            
            renderQuickTimeGrid(targetISO);
            checkQuickReady();
            if(navigator.vibrate) navigator.vibrate(20);
        }

        function handleBackPress() {
            // 0. ESCUDO DE SEGURIDAD TOTAL (Bloquea Botón Atrás en Pantallas Críticas)
            const lockSub = document.getElementById('subscriptionLockOverlay');
            const lockSys = document.getElementById('globalSystemLock');
            const lockSec = document.getElementById('secureLockOverlay');
            
            // Si alguno de estos bloqueos está activo, el botón atrás no hace NADA.
            if ((lockSub && lockSub.style.display === 'flex') || 
                (lockSys && lockSys.style.display === 'flex') || 
                (lockSec && lockSec.style.display === 'flex')) {
                return; 
            }

            // 1. PRIORIDAD MÁXIMA: PANTALLAS ESPECIALES (No son modales estándar)
            
            // A. VISOR DE HISTORIAS (Gestión de cierre por pasos)
            const storyModal = document.getElementById('storyManagerModal');
            const storySheet = document.getElementById('storyStatsSheet');
            if (storyModal && storyModal.style.display === 'flex') {
                // Si el panel de comentarios está arriba, bájalo primero
                if (storySheet.classList.contains('expanded')) {
                    toggleStatsSheet();
                } else {
                    // Si el panel está abajo, cierra el visor completo
                    cerrarStoryManager();
                }
                return;
            }

            const quickMode = document.getElementById('quickModeOverlay');
            if (quickMode && quickMode.style.display === 'flex') { closeQuickMode(); return; }

            const fullscreenViewer = document.getElementById('fullscreenViewer');
            if (fullscreenViewer && fullscreenViewer.style.display === 'flex') { closeFullscreenViewer(); return; }

            const resultView = document.getElementById('view-result-placeholder');
            if (resultView && resultView.style.display === 'flex') { resultView.style.display = 'none'; return; }

            const customAlert = document.getElementById('customAlert');
            if (customAlert && customAlert.style.display === 'flex') {
                // Si es una alerta normal, la cerramos. Si es bloqueo, NO.
                // Asumimos que las alertas normales se pueden cerrar con este botón
                customAlert.style.display = 'none'; 
                return; 
            }

            // 2. SISTEMA INTELIGENTE DE MODALES (STACK)
            // Buscamos TODOS los modales abiertos en una lista
            const modalesAbiertos = Array.from(document.querySelectorAll('.modal.open'));

            if (modalesAbiertos.length > 0) {
                // Seleccionamos el ÚLTIMO de la lista (el que está visualmente encima)
                const modalTop = modalesAbiertos[modalesAbiertos.length - 1];

                // SEGURIDAD: Bloqueos de Sistema y ACTUALIZACIÓN OBLIGATORIA
                if (modalTop.id === 'secureLockOverlay' || modalTop.id === 'globalSystemLock') return;

                // Si es actualización y la X está oculta, BLOQUEAR botón atrás
                if (modalTop.id === 'modalUpdate') {
                    const btnClose = document.getElementById('btnCloseUpdate');
                    if (btnClose && btnClose.style.display === 'none') {
                        if(navigator.vibrate) navigator.vibrate(500); // Vibrar error
                        return; // NO cerrar
                    }
                }

                // Cerramos SOLAMENTE ese modal específico
                modalTop.classList.remove('open');
                
                // Limpieza específica si cerramos el modal de agregar turno
                if(modalTop.id === 'modalAdd') {
                    document.getElementById('timeSlotsContainer').style.display = 'none';
                }
                return;
            }

            // 3. NAVEGACIÓN (Volver al Home/Agenda si estamos en otra vista)
            const agendaView = document.getElementById('view-agenda');
            if (!agendaView.classList.contains('active')) {
                navTo('agenda');
                return;
            }

            // 4. SALIDA (Si no hay nada más abierto)
            showCustomAlert(
                'warning',
                '¿SALIR DEL SISTEMA?', 
                '<div style="font-size:0.9rem;color:#999;margin-bottom:10px;">Se mantendrá la sesión iniciada.</div>',
                function() {
                    if(typeof Android !== 'undefined' && Android.exitApp) {
                        Android.exitApp();
                    }
                },
                null
            );
        }

        var _alturaOriginal = window.innerHeight;

        function activarSaltoTeclado() {
            const inputs = document.querySelectorAll('#modalAdd input');
            const modal = document.getElementById('modalAdd');
            const card = document.querySelector('#modalAdd .modal-card');

            const bajarModal = () => {
                modal.style.alignItems = 'flex-end';
                modal.style.paddingTop = '0';
                card.style.minHeight = '';
                card.style.borderRadius = '30px 30px 0 0';
            };

            inputs.forEach(input => {
                if(input.type === 'time' || input.type === 'date') return;

                input.onfocus = function() {
                    modal.style.alignItems = 'flex-start';
                    modal.style.paddingTop = '0px';
                    card.style.minHeight = '100%';
                    card.style.borderRadius = '0';
                    setTimeout(() => {card.scrollTop = card.scrollHeight;},50);
                };

                input.onblur = function() {
                    setTimeout(bajarModal,100);
                };
            });

            window.onresize = function() {
                if (Math.abs(window.innerHeight - _alturaOriginal) < 100) {
                    bajarModal();
                    if(document.activeElement && document.activeElement.tagName === 'INPUT') {
                        document.activeElement.blur();
                    }
                }
            };
        }
        
        function recibirFotoQR(base64) {
            tempQRData = base64;
            
            showCustomPrompt((name) => {
                if(name && tempQRData) {
                    DB.qrs.push({name:name,data:tempQRData});
                    saveData();
                    renderQRGrid();
                    tempQRData = null;
                    showToast("QR Guardado", "📷", "ÉXITO");
                }
            });
        }

        function shareGalleryImage(base64Data) {
            if(typeof Android !== 'undefined' && Android.compartirImagenBase64) {
                Android.compartirImagenBase64(base64Data);
            }
        }

        function saveGalleryImageFromList(base64Data) {
            var cleanBase64 = base64Data;
            if (base64Data.includes(",")) {
                cleanBase64 = base64Data.split(',')[1];
            }

            if(typeof Android !== 'undefined' && Android.guardarFotoGaleria) {
                Android.guardarFotoGaleria(cleanBase64);
                if(typeof showToast === 'function') {
                  
                }
            }
            else {
                const a = document.createElement('a');
                a.href = base64Data;
                a.download = 'barber-estetica-'+Date.now()+'.jpg';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }

        function triggerCameraDirect(num) {
            if(typeof Android !== 'undefined' && Android.tomarFotoEstetica) {
                Android.tomarFotoEstetica(num);
            }
            else {
                var input = document.getElementById('cameraInput' + num);
                if(input) input.click();
            }
        }

        function triggerQuickPhoto() {
            if(typeof Android !== 'undefined' && Android.tomarFotoRapida) {
                Android.tomarFotoRapida();
            } else {
                const inp = document.getElementById('cameraInputQuick');
                if(inp) inp.click();
            }
        }

        function handleQuickPhotoInput(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {processQuickPhoto(e.target.result);};
                reader.readAsDataURL(input.files[0]);
            }
        }

        function processQuickPhoto(base64Raw) {
            const img = new Image();
            img.src = base64Raw;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Reducimos ancho a 640px (antes 1080)
                const w = 640;
                const scale = w / img.width;
                const h = img.height * scale;
                
                canvas.width = w;canvas.height = h;
                ctx.drawImage(img,0,0,w,h);
                
                const b = DB.settings.brand;
                if(b && b.enabled) {
                    ctx.save();
                    ctx.globalAlpha = 0.5;
                    ctx.fillStyle = b.color || '#fff';
                    ctx.textAlign = 'center';
                    // Texto más pequeño proporcionalmente
                    ctx.font = "bold 24px Montserrat";
                    ctx.fillText(b.text.toUpperCase(),w/2,40);
                    ctx.restore();
                }
                
                // Compresión 0.6 (60%)
                const finalData = canvas.toDataURL('image/jpeg',0.6);

                // OCULTAR BOTON PRIVACIDAD (Tambien en foto rapida)
                const btnPriv = document.getElementById('btnPrivacyResult');
                if(btnPriv) btnPriv.style.display = 'none';
                
                if(currentProfileName && DB.clients[currentProfileName]) {
                    if(!DB.clients[currentProfileName].savedPhotos) DB.clients[currentProfileName].savedPhotos = [];
                    DB.clients[currentProfileName].savedPhotos.unshift({id:Date.now(),date:Date.now(),data:finalData});
                    
                    // Seguridad: Limite de 10 fotos por cliente
                    if(DB.clients[currentProfileName].savedPhotos.length > 10) {
                        DB.clients[currentProfileName].savedPhotos.pop();
                    }
                    saveData();
                }
                
                document.getElementById('finalImage').src = finalData;
                tipoImagenActual = 'estetica';

                document.getElementById('fabRow').classList.add('show-buttons');
                document.getElementById('view-result-placeholder').ontouchstart = null;
                document.getElementById('view-result-placeholder').ontouchend = null;

                document.getElementById('view-result-placeholder').style.display = 'flex';
            };
        }

        function showToast(msg, icon='✨', title='SISTEMA') {
            const container = document.getElementById('toast-container');
            if(!container) return;
            
            const toast = document.createElement('div');
            toast.className = 'toast-neon';
            toast.innerHTML = `
                <span class="t-emoji">${icon}</span>
                <div class="t-content">
                    <div class="t-title">${title}</div>
                    <div class="t-msg">${msg}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.add('show');
                // Vibración eliminada
            });
            
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 350);
            }, 3000);
        }

        function vibratePhone(ms) {
            if (navigator.vibrate) {
                navigator.vibrate(ms);
            }
        }

        function renderWeeklyChart() {
            const container = document.getElementById('weeklyChart');
            if(!container) return;
            
            container.innerHTML = '';
            
            const now = new Date();
            const currentDay = now.getDay() === 0 ? 6 :now.getDay() - 1;
            let weeklyData = [0,0,0,0,0,0,0];
            const labels = ['L','M','M','J','V','S','D'];
            
            const all = [...DB.appointments,...DB.extras];
            
            all.forEach(item => {
                const itemDate = new Date(item.date + 'T00:00:00');
                const diffDays = Math.floor((now - itemDate) / (24*60*60*1000));
                
                if(diffDays >= 0 && diffDays < 7) {
                    let dayIndex = itemDate.getDay() === 0 ? 6 :itemDate.getDay() - 1;
                    weeklyData[dayIndex] += parseInt(item.price || 0);
                }
            });
            
            let maxVal = Math.max(...weeklyData);
            if(maxVal === 0) maxVal = 1;

            weeklyData.forEach((total,index) => {
                const heightPercent = (total / maxVal) * 100;
                const isToday = (index === currentDay);
                
                const col = document.createElement('div');
                col.className = 'chart-col';
                col.innerHTML = `
                    <div class="chart-bar ${isToday ? 'today' :''}" style="height:${heightPercent}%;"></div>
                    <div class="chart-label" style="${isToday ? 'color:#fff' :''}">${labels[index]}</div>
                `;
                container.appendChild(col);
            });
        }

        function borrarFinanza(id,type) {
            showCustomAlert('warning','Eliminar','¿Mover a papelera?',() => {
                if (type === 'manual') {
                    const idx = DB.extras.findIndex(e => e.id == id);
                    if (idx !== -1) {
                        moveToTrash('manual',DB.extras[idx],DB.extras[idx].reason,'Finanzas');
                        DB.extras.splice(idx,1);
                        
                        // Borrar de Nube
                        if(MY_DEVICE_ID && typeof supabase !== 'undefined') {
                            supabase.from('ingresos_extra').delete().eq('id', id).then(() => console.log("Extra borrado nube"));
                        }
                    }
                }else {
                    const idx = DB.appointments.findIndex(a => a.id == id);
                    if (idx !== -1) {
                        const app = DB.appointments[idx];
                        
                        // Borrar de Nube (ELIMINACIÓN REAL)
                        if(MY_DEVICE_ID && typeof supabase !== 'undefined') {
                             supabase.from('turnos').delete().eq('id', id).then(() => console.log("Turno eliminado totalmente"));
                        }

                        if(DB.clients[app.name]) {
                            DB.clients[app.name].visits--;
                            if(DB.clients[app.name].visits < 0) DB.clients[app.name].visits = 0;
                        }
                        moveToTrash('appointment',app,app.name + " (" + app.date + ")",'Agenda');
                        DB.appointments.splice(idx,1);
                    }
                }
                
                saveData();
                renderFinance(currentFinanceMode,null,false);
                renderAgenda();
            });
        }


        function editarFinanza(id,type) {
            if (type === 'manual') {
                const item = DB.extras.find(e => e.id == id);
                if (!item) return;
                
                document.getElementById('manualReason').value = item.reason;
                document.getElementById('manualAmount').value = item.price;
                document.getElementById('modalManualEntry').classList.add('open');
                
                const btn = document.querySelector('#modalManualEntry .btn');
                const oldOnclick = btn.getAttribute('onclick');
                
                btn.innerText = "Actualizar";
                btn.onclick = function() {
                    item.reason = document.getElementById('manualReason').value;
                    item.price = document.getElementById('manualAmount').value;
                    saveData();
                    
                    document.getElementById('modalManualEntry').classList.remove('open');
                    
                    renderFinance(currentFinanceMode,null,false);
                    renderAgenda();
                    
                    btn.innerText = "Guardar";
                    btn.setAttribute('onclick',oldOnclick);
                    btn.onclick = saveManualEntry;
                };
            } else {
                editAppointment(id);
            }
        }
        
        function toggleTimePicker(state) {}

        function toggleSmartGrid(forceClose) {
            const grid = document.getElementById('timeSlotsContainer');
            const selectedDate = document.getElementById('inputDate').value;

            if (forceClose || grid.style.display === 'grid') {
                grid.style.display = 'none';
                return;
            }

            grid.innerHTML = '';
            grid.style.display = 'grid';

            const startTime = 9;
            const endTime = 18;
            
            const now = new Date();
            const isToday = (selectedDate === getLocalISOString());
            const currentTotalMinutes = (now.getHours() * 60) + now.getMinutes();

            for (let hour = startTime;hour <= endTime;hour++) {
                for (let min = 0;min < 60;min += 30) {
                    if (hour === endTime && min === 30) continue;
                    
                    const timeStr = `${String(hour).padStart(2,'0')}:${String(min).padStart(2,'0')}`;
                    const slotMinutes = (hour * 60) + min;
                    const slotEndMinutes = slotMinutes + 30;

                    const isTaken = DB.appointments.some(a => {
                        if (a.date !== selectedDate) return false;
                        const appMinutes = getMinutes(a.time);
                        return appMinutes >= slotMinutes && appMinutes < slotEndMinutes;
                    });
                    
                    const isPast = isToday && (slotMinutes <= currentTotalMinutes);
                    const blockSlot = isTaken || isPast;
                    
                    const slot = document.createElement('div');
                    slot.className = 'time-slot' + (blockSlot ? ' taken' :'');
                    slot.innerText = formatTime(timeStr);
                    
                    if (!blockSlot) {
                        slot.onclick = () => {
                            document.getElementById('inputTime').value = timeStr;
                            grid.style.display = 'none';
                        };
                    }
                    grid.appendChild(slot);
                }
            }
        }

        let calState = {viewDate:new Date(),selectedDate:new Date()};
        let calendarSource = 'new';
        const monthNames = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

        function openDateSmart(source) {
            calendarSource = source || 'new';
            
            let targetId = 'inputDate';
            if (calendarSource === 'agenda') targetId = 'dateSelector';
            if (calendarSource === 'quick') targetId = 'quickDateValue';

            let rawVal = document.getElementById(targetId).value;
            
            if(!rawVal && (calendarSource === 'agenda' || calendarSource === 'quick')) rawVal = getLocalISOString();

            if (rawVal) {
                const [y,m,d] = rawVal.split('-').map(Number);
                calState.selectedDate = new Date(y,m - 1,d);
                calState.viewDate = new Date(y,m - 1,1);
            } else {
                const now = new Date();
                calState.selectedDate = new Date(now.getFullYear(),now.getMonth(),now.getDate());
                calState.viewDate = new Date(now.getFullYear(),now.getMonth(),1);
            }
            
            const btnDone = document.querySelector('#modalDateSmart .drum-done');
            if(btnDone) btnDone.style.display = (calendarSource === 'quick') ? 'none' :'block';

            renderCalDays();
            document.getElementById('calViewDays').classList.add('active');
            document.getElementById('calViewDrum').classList.remove('active');
            document.getElementById('modalDateSmart').classList.add('open');
        }

        function closeDateSmart() {document.getElementById('modalDateSmart').classList.remove('open');}

        function renderCalDays() {
            const y = calState.viewDate.getFullYear();
            const m = calState.viewDate.getMonth();
            document.getElementById('calDisplayMonth').innerText = monthNames[m];
            document.getElementById('calDisplayYear').innerText = y;

            const container = document.getElementById('calDaysContainer');
            container.innerHTML = '';

            const firstDay = new Date(y,m,1).getDay();
            const daysInMonth = new Date(y,m + 1,0).getDate();

            for(let i=0;i<firstDay;i++) {
                const empty = document.createElement('div');
                empty.className = 'cal-day empty';
                container.appendChild(empty);
            }

            for(let d=1;d<=daysInMonth;d++) {
                const el = document.createElement('div');
                el.className = 'cal-day';
                el.innerText = d;
                
                if(d === calState.selectedDate.getDate() && m === calState.selectedDate.getMonth() && y === calState.selectedDate.getFullYear()) {
                    el.classList.add('selected');
                }
                const today = new Date();
                if(d === today.getDate() && m === today.getMonth() && y === today.getFullYear()) {
                    el.classList.add('today');
                }

                el.onclick = () => {
                    calState.selectedDate = new Date(y,m,d);
                    renderCalDays();
                    if(navigator.vibrate) navigator.vibrate(5);

                    if(calendarSource === 'quick') {
                        setTimeout(confirmDateSmart,150);
                    }
                };
                container.appendChild(el);
            }
        }

        function changeMonth(delta) {
            calState.viewDate.setMonth(calState.viewDate.getMonth() + delta);
            renderCalDays();
        }

        function toggleCalView() {
            const viewDays = document.getElementById('calViewDays');
            const viewDrum = document.getElementById('calViewDrum');
            
            if(viewDays.classList.contains('active')) {
                viewDays.classList.remove('active');
                viewDrum.classList.add('active');
                initCalDrum();
            } else {
                applyDrumToCal();
                viewDays.classList.add('active');
                viewDrum.classList.remove('active');
            }
        }

        function confirmDateSmart() {
            if(document.getElementById('calViewDrum').classList.contains('active')) applyDrumToCal();

            const d = calState.selectedDate;
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2,'0');
            const day = String(d.getDate()).padStart(2,'0');

            const isoDate = `${y}-${m}-${day}`;
            const displayDate = `${day}/${m}/${y}`;
            const shortDate = `${day}/${m}`;

            if (calendarSource === 'agenda') {
                document.getElementById('dateSelector').value = isoDate;
                document.getElementById('agendaDateDisplay').value = displayDate;
                renderAgenda();
            }
            else if (calendarSource === 'quick') {
                document.getElementById('quickDateValue').value = isoDate;
                document.getElementById('quickDateDisplay').innerText = shortDate;
                renderQuickTimeGrid(isoDate);
                checkQuickReady();
            }
            else {
                document.getElementById('inputDate').value = isoDate;
                document.getElementById('inputDateDisplay').value = displayDate;
                const grid = document.getElementById('timeSlotsContainer');
                grid.style.display = 'none';
                toggleSmartGrid();
            }
            
            closeDateSmart();
        }

        function initCalDrum() {
            const colM = document.getElementById('drumCalMonth');
            const colY = document.getElementById('drumCalYear');
            colM.innerHTML = '<div style="height:75px;"></div>';
            colY.innerHTML = '<div style="height:75px;"></div>';

            monthNames.forEach((name,i) => {
                const el = document.createElement('div');
                el.className = 'drum-item';el.innerText = name;
                colM.appendChild(el);
            });

            const currentY = new Date().getFullYear();
            for(let i=currentY-10;i<=currentY+10;i++) {
                const el = document.createElement('div');
                el.className = 'drum-item';el.innerText = i;
                colY.appendChild(el);
            }
            colM.innerHTML += '<div style="height:75px;"></div>';
            colY.innerHTML += '<div style="height:75px;"></div>';

            const handleScroll = (col) => {
                const index = Math.round(col.scrollTop / 50);
                const items = col.querySelectorAll('.drum-item');
                items.forEach(it => it.classList.remove('active'));
                if(items[index]) items[index].classList.add('active');
            };
            colM.onscroll = () => {handleScroll(colM);if(navigator.vibrate) navigator.vibrate(5);};
            colY.onscroll = () => {handleScroll(colY);if(navigator.vibrate) navigator.vibrate(5);};

            setTimeout(() => {
                colM.scrollTop = calState.viewDate.getMonth() * 50;
                const yIndex = calState.viewDate.getFullYear() - (currentY - 10);
                colY.scrollTop = yIndex * 50;
            },50);
        }

        function applyDrumToCal() {
            const getIndex = (id) => Math.round(document.getElementById(id).scrollTop / 50);
            const mIndex = getIndex('drumCalMonth');
            const currentY = new Date().getFullYear();
            const yIndex = getIndex('drumCalYear');
            const year = (currentY - 10) + yIndex;

            if(mIndex >= 0 && mIndex < 12) {
                calState.viewDate = new Date(year,mIndex,1);
                renderCalDays();
            }
        }

        const ITEM_HEIGHT = 50;
        
        const hoursRaw = Array.from({length:12},(_,i) => i + 1);
        const minsRaw = Array.from({length:60},(_,i) => i < 10 ? '0'+i :i);
        
        const drumData = {
            h:[...hoursRaw,...hoursRaw,...hoursRaw],
            m:[...minsRaw,...minsRaw,...minsRaw],
            ap:['AM','PM']
        };

        let lastVib = {h:-1,m:-1,ap:-1};

        function initDrumColumn(id,type) {
            const col = document.getElementById(id);
            col.innerHTML = '';
            
            const data = drumData[type];
            data.forEach((val) => {
                const el = document.createElement('div');
                el.className = 'drum-item';
                el.innerText = val;
                col.appendChild(el);
            });

            col.onscroll = function() {
                let scrollTop = col.scrollTop;
                
                if (type !== 'ap') {
                    const singleSetHeight = (data.length / 3) * ITEM_HEIGHT;
                    
                    if (scrollTop < singleSetHeight / 2) {
                        col.scrollTop = scrollTop + singleSetHeight;
                        return;
                    }
                    else if (scrollTop > singleSetHeight * 2.5) {
                        col.scrollTop = scrollTop - singleSetHeight;
                        return;
                    }
                }

                const centerIndex = Math.round(col.scrollTop / ITEM_HEIGHT);
                
                const items = col.querySelectorAll('.drum-item');
                items.forEach(i => i.classList.remove('active'));
                if(items[centerIndex]) items[centerIndex].classList.add('active');

                if (lastVib[type] !== centerIndex) {
                    if (navigator.vibrate) navigator.vibrate(5);
                    lastVib[type] = centerIndex;
                }
            };
        }

        let timeDrumSource = 'new';

        function openTimeDrum(source) {
            timeDrumSource = source || 'new';

            if(!document.getElementById('drumHours').hasChildNodes()) {
                initDrumColumn('drumHours','h');
                initDrumColumn('drumMinutes','m');
                initDrumColumn('drumAmPm','ap');
            }

            const now = new Date();
            let hh = now.getHours();
            let isPm = hh >= 12;
            let h12 = hh % 12;
            if(h12 === 0) h12 = 12;

            document.getElementById('modalTimeDrum').classList.add('open');

            setTimeout(() => {
                const hIndex = 12 + (h12 - 1);
                const mIndex = 60 + 0;
                const apIndex = isPm ? 1 :0;

                document.getElementById('drumHours').scrollTop = hIndex * ITEM_HEIGHT;
                document.getElementById('drumMinutes').scrollTop = mIndex * ITEM_HEIGHT;
                document.getElementById('drumAmPm').scrollTop = apIndex * ITEM_HEIGHT;
            },50);
        }

        function openTimeDrumFromQuick() {
            openTimeDrum('quick');
        }

        function closeTimeDrum() {
            document.getElementById('modalTimeDrum').classList.remove('open');
        }

        function confirmTimeDrum() {
            const getVal = (id) => {
                const col = document.getElementById(id);
                const index = Math.round(col.scrollTop / ITEM_HEIGHT);
                const items = col.querySelectorAll('.drum-item');
                return items[index] ? items[index].innerText :null;
            };

            let h = parseInt(getVal('drumHours'));
            let m = getVal('drumMinutes');
            let ap = getVal('drumAmPm');

            let h24 = h;
            if (ap === 'PM' && h !== 12) h24 += 12;
            if (ap === 'AM' && h === 12) h24 = 0;

            const finalStr = `${String(h24).padStart(2,'0')}:${m}`;
            
            if (timeDrumSource === 'quick') {
                document.getElementById('quickTimeInput').value = finalStr;
                
                document.querySelectorAll('#quickTimeGrid div').forEach(d => {
                    if(d.style.textDecoration !== 'line-through') {
                        d.style.background = 'rgba(46,204,113,0.15)';
                        d.style.color = '#2ecc71';
                        d.style.fontWeight = 'normal';
                    }
                });
                
                const btnManual = document.getElementById('btnManualTime');
                if(btnManual) {
                    btnManual.innerHTML = `<i class="fas fa-check"></i> ${formatTime(finalStr)}`;
                    btnManual.style.color = "#fff";
                    btnManual.style.background = "var(--primary)";
                }
                
                checkQuickReady();
            } else {
                document.getElementById('inputTime').value = finalStr;
            }
            
            closeTimeDrum();
        }
        
        function pedirSincronizacion() {
            const btnIcon = document.querySelector('#view-contactos .fa-sync-alt');
            if(btnIcon) btnIcon.classList.add('fa-spin');
            
            if(typeof Android !== 'undefined' && Android.sincronizarAgenda) {
                Android.sincronizarAgenda();
            } else {
                if(btnIcon) btnIcon.classList.remove('fa-spin');
            }
        }

        function recibirAgendaMasivaBase64(base64Data) {
            try {
                const jsonString = decodeURIComponent(escape(window.atob(base64Data)));
                const nativeContacts = JSON.parse(jsonString);
                
                const nativeSet = new Set();
                nativeContacts.forEach(c => nativeSet.add(c.name));

                let addedCount = 0;
                let deletedCount = 0;

                nativeContacts.forEach(c => {
                    if(!DB.clients[c.name]) {
                        DB.clients[c.name] = {
                            visits:0,
                            phone:c.phone,
                            tag:checkAutoTag(c.phone),
                            lastDate:""
                        };
                        addedCount++;
                    }
                });
                Object.keys(DB.clients).forEach(appClientName => {
                    const client = DB.clients[appClientName];
                    if (client.phone && client.phone.length > 0 && !nativeSet.has(appClientName)) {
                        moveToTrash('client',client,appClientName,'Sincronización Automática');
                        delete DB.clients[appClientName];
                        deletedCount++;
}
});

                if(addedCount > 0 || deletedCount > 0) {
                    saveData();
                    if(document.getElementById('view-contactos').classList.contains('active')) {
                         renderContactsList();
}
                    showToast("Agenda Sincronizada", "👥", "CONTACTOS");
}

}catch(e) {
                console.error("Error importando:",e);
}finally {
                const btnIcon = document.querySelector('#view-contactos .fa-sync-alt');
                if(btnIcon) btnIcon.classList.remove('fa-spin');
}
}
        
        function importContactForClientList() {
            isImportingForClientList = true;
            if(typeof Android !== 'undefined') Android.abrirContactos();
}
        function openCustomAdd() {
            document.getElementById('newContactName').value = '';
            document.getElementById('newContactPhone').value = '';
            document.getElementById('syncNewContact').checked = true;
            
            if(typeof Android !== 'undefined' && Android.obtenerCuentas) {
                 const accs = Android.obtenerCuentas();
                 const sel = document.getElementById('accountSelectorNew');
                 sel.innerHTML = '';
                 const list = accs.split(',');
                 list.forEach(a => {
                     const opt = document.createElement('option');
                     opt.value = a;
                     opt.innerText = a;
                     sel.appendChild(opt);
});
}
            document.getElementById('modalAddContact').classList.add('open');
}

        function submitNewContact() {
            const name = document.getElementById('newContactName').value.trim();
            const phone = document.getElementById('newContactPhone').value.trim();
            const sync = document.getElementById('syncNewContact').checked;
            const account = document.getElementById('accountSelectorNew').value;

            if(!name) return;

            if (phone.length > 4) {
                const newNum = normalizeNum(phone);
                const duplicateKey = Object.keys(DB.clients).find(key => {
                    const existingNum = normalizeNum(DB.clients[key].phone);
                    return existingNum === newNum && key !== name;
});
                
                if(duplicateKey) {
                    return;
}
}
            
            const tag = checkAutoTag(phone);
            
            DB.clients[name] = {
                visits:DB.clients[name] ? DB.clients[name].visits :0,
                phone:phone,
                tag:tag,
                lastDate:DB.clients[name] ? DB.clients[name].lastDate :"" 
};
            saveData();
            
            renderContactsList();
            renderClients();

            if(sync && typeof Android !== 'undefined' && Android.agregarContactoNativo) {
                Android.agregarContactoNativo(name,phone,account);
}
            
            closeModal();
}

        function openCustomEdit(name) {
            const c = DB.clients[name];
            if(!c) return;
            
            document.getElementById('editContactOriginalName').value = name;
            document.getElementById('editContactName').value = name;
            document.getElementById('editContactPhone').value = c.phone || '';
            document.getElementById('syncEditContact').checked = true;
            
            document.getElementById('modalCustomEditContact').classList.add('open');
}

        function submitEditContact() {
            const oldName = document.getElementById('editContactOriginalName').value;
            const newName = document.getElementById('editContactName').value.trim();
            const newPhone = document.getElementById('editContactPhone').value.trim();
            const sync = document.getElementById('syncEditContact').checked;

            if(!newName) return;
            if(!DB.clients[oldName]) return;

            if(newName !== oldName) {
                if(DB.clients[newName]) return;
                
                DB.clients[newName] = JSON.parse(JSON.stringify(DB.clients[oldName]));
                
                delete DB.clients[oldName];
                
                DB.appointments.forEach(a => {if(a.name === oldName) a.name = newName;});
}
            
            if(DB.clients[newName]) {
                DB.clients[newName].phone = newPhone;
}

            saveData();
            
            if(sync && typeof Android !== 'undefined' && Android.actualizarContactoNativo) {
                Android.actualizarContactoNativo(oldName,newName,newPhone);
}

            closeModal();
            document.getElementById('contactsListContainer').innerHTML = '';
            renderContactsList();
            renderClients();
            renderAgenda();
}

async function abrirBandejaSolicitudes() {
    const list = document.getElementById('inboxList');
    document.getElementById('modalInbox').classList.add('open');
    
    // UI del encabezado con selección múltiple
    list.innerHTML = `
        <div class="inbox-header-actions">
            <span id="selCountText" style="color:#aaa;font-size:0.8rem;">Mantén presionado para seleccionar</span>
            <button class="btn-gallery-del" onclick="accionBorrarMasivo()" style="width:auto;padding:5px 15px;">
                <i class="fas fa-trash"></i> <span id="btnDelText">Borrar Todos</span>
            </button>
        </div>
        <div id="inboxItems" style="text-align:center;padding:10px;"><i class="fas fa-spinner fa-spin"></i></div>
    `;

    // 1. Limpieza de ID
    const myCleanID = String(MY_DEVICE_ID).trim();

    // 2. Consulta BLINDADA (Acepta 'pendiente', 'Pendiente', 'PENDIENTE')
    const {data:turnos, error} = await supabase
        .from('turnos')
        .select('*')
        .eq('barbero_id', myCleanID)
        .in('estado', ['pendiente', 'Pendiente', 'PENDIENTE']) 
        .order('id', {ascending:false}); // ID más alto primero (el más nuevo)

    const itemsContainer = document.getElementById('inboxItems');
    itemsContainer.innerHTML = '';

    if(error) {
        itemsContainer.innerHTML = `<div style="text-align:center;color:red;">Error Red: ${error.message}</div>`;
        return;
    }

    if(turnos && turnos.length > 0) {
        
        // --- FILTRO INTELIGENTE ---
        // Solo mostramos el primer turno que encontremos de cada cliente (que será el más nuevo por el sort)
        const unicosPorCliente = {};
        turnos.forEach(t => {
            if(!unicosPorCliente[t.cliente]) {
                unicosPorCliente[t.cliente] = t;
            }
        });
        const listaFiltrada = Object.values(unicosPorCliente);
        // --------------------------

        solicitudesCache = listaFiltrada;
        seleccionados.clear(); 
        modoSeleccion = false;
        
        actualizarContadorRequests(listaFiltrada.length);

        listaFiltrada.forEach((req) => {
            // Formato de fecha visual
            let fechaVisual = req.fecha;
            if(req.fecha && req.fecha.includes('-')) {
                const p = req.fecha.split('-');
                fechaVisual = `${p[2]}/${p[1]}`;
            }
            
            // CONVERTIR A 12 HORAS (AM/PM)
            let horaVisual = formatTime(req.hora);

            const card = document.createElement('div');
            card.className = 'inbox-card'; 
            card.id = `req-${req.id}`;
            card.style.cssText = 'background:rgba(255,255,255,0.05); padding:15px; border-radius:16px; margin-bottom:12px; border:1px solid rgba(255,255,255,0.08); position:relative;';
            
            // Lógica de mantener presionado
            let timer;
            const start = () => timer = setTimeout(() => { toggleSeleccion(req.id); vibratePhone(50); }, 600);
            const end = () => clearTimeout(timer);
            
            card.addEventListener('touchstart', start); 
            card.addEventListener('touchend', end); 
            card.addEventListener('touchmove', end);
            
            card.onclick = () => { if(modoSeleccion) toggleSeleccion(req.id); };

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <div style="font-weight:800; color:#fff; font-size:1rem;">${req.cliente}</div>
                    <div style="color:#f1c40f; font-weight:700; font-size:0.9rem;">${horaVisual}</div>
                </div>
                
                <div style="font-size:0.75rem; color:#888; margin-bottom:12px; display:flex; gap:10px; align-items:center;">
                   <span><i class="fas fa-calendar-alt"></i> ${fechaVisual}</span>
                   <span style="color:#555;">|</span>
                   <span>${req.servicio || 'General'}</span>
                   <span style="color:#555;">|</span>
                   <span style="color:var(--primary); font-weight:600;">$${req.precio || ''}</span>
                </div>

                <div class="individual-actions" style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px;">
                    
                    <div style="display:flex; gap:12px;">
                        <a href="tel:${req.telefono}" onclick="event.stopPropagation()" style="width:34px; height:34px; border-radius:50%; background:rgba(46,204,113,0.1); color:#2ecc71; display:flex; align-items:center; justify-content:center; text-decoration:none; border:1px solid rgba(46,204,113,0.3); transition:0.2s;">
                            <i class="fas fa-phone-alt" style="font-size:0.8rem;"></i>
                        </a>
                        
                        <a href="sms:${req.telefono}" onclick="event.stopPropagation()" style="width:34px; height:34px; border-radius:50%; background:rgba(52,152,219,0.1); color:#3498db; display:flex; align-items:center; justify-content:center; text-decoration:none; border:1px solid rgba(52,152,219,0.3); transition:0.2s;">
                            <i class="fas fa-comment" style="font-size:0.8rem;"></i>
                        </a>
                        
                        <button onclick="event.stopPropagation();sendWhatsApp('${req.telefono}')" style="width:34px; height:34px; border-radius:50%; background:rgba(37,211,102,0.1); color:#25d366; display:flex; align-items:center; justify-content:center; border:1px solid rgba(37,211,102,0.3); cursor:pointer; transition:0.2s;">
                            <i class="fab fa-whatsapp" style="font-size:0.9rem;"></i>
                        </button>
                    </div>

                    <div style="display:flex; gap:10px;">
                        <button onclick="event.stopPropagation();gestionarSolicitud('${req.id}',false)" style="width:38px; height:38px; border-radius:12px; border:none; background:rgba(231,76,60,0.15); color:#e74c3c; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-times"></i>
                        </button>
                        
                        <button onclick="event.stopPropagation();gestionarSolicitud('${req.id}',true,'${req.cliente}','${req.telefono}','${req.hora}','${req.fecha}','${req.precio}','${req.servicio}')" style="width:38px; height:38px; border-radius:12px; border:none; background:#2ecc71; color:#000; cursor:pointer; box-shadow:0 0 10px rgba(46,204,113,0.3); display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
            `;
            itemsContainer.appendChild(card);
        });
    } else {
        itemsContainer.innerHTML = '<div style="color:#555;margin-top:20px;">Bandeja limpia 🧹</div>';
        document.getElementById('fabRequests').style.display = 'none';
    }
}



async function gestionarSolicitud(id,aceptada,nombre,tel,hora,fecha,precio,servicio) {
    const nuevoEstado = aceptada ? 'aceptado' :'rechazado';
    const {error}= await supabase.from('turnos').update({estado:nuevoEstado}).eq('id',id);

    if (error) {
        showToast("Error de conexión", "❌", "ERROR");
        return;
    }

    if (aceptada) {
        // --- LIMPIEZA SILENCIOSA ---
        // Eliminamos las solicitudes viejas (duplicadas) de este cliente para que no notifique rechazo
        supabase.from('turnos')
            .delete()
            .eq('barbero_id', MY_DEVICE_ID)
            .eq('cliente', nombre)
            .eq('estado', 'pendiente')
            .neq('id', id)
            .then(() => console.log("Limpieza silenciosa ejecutada"));
        // ---------------------------

        // Guardado Directo en Local
        const nombreFinal = (servicio && servicio !== "General") ? `${nombre} (${servicio})` : nombre;
        
        DB.appointments.push({
            id: parseInt(id), // Usamos el ID de la nube para consistencia
            name: nombreFinal,
            phone: tel,
            date: fecha,
            time: hora,
            price: precio || "500"
        });

        // Guardar o Actualizar Cliente
        if (!DB.clients[nombreFinal]) {
            DB.clients[nombreFinal] = { visits: 1, phone: tel, lastDate: fecha, tag: checkAutoTag(tel) };
        } else {
            DB.clients[nombreFinal].visits++;
            DB.clients[nombreFinal].lastDate = fecha;
            if(tel) DB.clients[nombreFinal].phone = tel;
        }

        saveData();
        renderAgenda();
        renderClients();
        programarAlarmas();

        showToast("Turno Confirmado", "✅", "AGENDA ACTUALIZADA");
        abrirBandejaSolicitudes(); // Recargamos la lista para quitar el aceptado

    } else {
        showToast("Solicitud Rechazada", "🗑️", "ELIMINADO");
        abrirBandejaSolicitudes();
    }
}

        function openMyProfileModal() {
        const currentName = DB.settings.brand.text || "Tu Negocio";
        document.getElementById('displayBrandName').innerText = currentName;
        
        const savedPhone = localStorage.getItem('barber_phone_real') || "--";
        document.getElementById('displayBrandPhone').innerText = savedPhone;
        
        const displayEl = document.getElementById('displayMyID');
        if(displayEl) displayEl.innerText = MY_DEVICE_ID;
        
        const badgeMain = document.getElementById('badgeSolicitudes');
        const badgeProfile = document.querySelector('#modalMyProfile #badgeSolicitudes');
        if(badgeMain && badgeProfile && badgeMain.innerText !== "0") {
            badgeProfile.style.display = 'inline-block';
            badgeProfile.innerText = badgeMain.innerText;
}

        if(supabase) {
            supabase.from('barberos').select('foto_url').eq('id',MY_DEVICE_ID).single()
            .then(({data}) => {
                // FIX: Si el Admin borró la foto (es null), limpiar caché y UI
                if (data && data.foto_url) {
                    localStorage.setItem('bm_cached_profile_pic', data.foto_url);
                    mostrarFotoEnUI(data.foto_url);
                } else {
                    localStorage.removeItem('bm_cached_profile_pic');
                    mostrarFotoEnUI(null);
                }
            });
}

        cargarEstadisticasPerfil();

        // ACTUALIZAR GRID VISUALMENTE
        if(DB.settings.schedule) {
            actualizarGridPerfil(DB.settings.schedule);
        }

        // INICIAR BOTÓN HISTORIA
        checkMyStoryStatus();

        document.getElementById('modalMyProfile').classList.add('open');
}

    let currentAuthMode = 'create';

    function setAuthMode(mode) {
        currentAuthMode = mode;
        // 1. Resetear pestañas y bordes rojos
        ['create', 'login', 'phone', 'pass'].forEach(m => {
            const tab = document.getElementById('tabAuth' + m.charAt(0).toUpperCase() + m.slice(1));
            if(tab) { tab.style.background = 'transparent'; tab.style.color = '#fff'; }
        });
        document.querySelectorAll('#authFormContainer input').forEach(i => i.style.borderColor = '');

        // 2. Elementos UI
        const btn = document.getElementById('btnAuthAction');
        const grpName = document.getElementById('groupNameField');
        const grpExtra = document.getElementById('groupExtraSettings');
        const grpOldPass = document.getElementById('groupOldPass'); 
        const activeTab = document.getElementById('tabAuth' + mode.charAt(0).toUpperCase() + mode.slice(1));
        
        const inpPhone = document.getElementById('editProfilePhone');
        const inpPass = document.getElementById('editProfilePassword');
        const inpOldPass = document.getElementById('inputOldPass'); 
        const lblPhone = document.getElementById('lblPhone');
        const lblPass = document.getElementById('lblPass');

        // 3. Estilo Activo
        if(activeTab) {
            let color = 'var(--primary)';
            if(mode === 'login') color = '#3498db';
            if(mode === 'phone') color = '#9b59b6'; 
            if(mode === 'pass') color = '#f1c40f';
            activeTab.style.background = color;
            activeTab.style.color = (mode === 'login') ? '#fff' : '#000';
        }

        // 4. Estado Base (Desbloqueado)
        grpName.style.display = 'none';
        grpExtra.style.display = 'none';
        grpOldPass.style.display = 'none'; // Oculto por defecto
        
        inpPhone.readOnly = false; inpPhone.style.opacity = '1'; inpPhone.style.background = 'rgba(0,0,0,0.4)';
        inpPass.readOnly = false; inpPass.style.opacity = '1'; inpPass.style.background = 'rgba(0,0,0,0.4)';
        inpPass.type = 'text'; 

        if (mode === 'create') {
            grpName.style.display = 'block';
            grpExtra.style.display = 'block';
            lblPhone.innerText = "Número de Teléfono (ID)";
            lblPass.innerText = "Contraseña";
            
            // BLOQUEO DE SEGURIDAD SI YA EXISTE SESIÓN
            const sessionPhone = localStorage.getItem('barber_phone_real');
            if(MY_DEVICE_ID && sessionPhone) {
                inpPhone.value = sessionPhone; // Asegurar que se vea el número
                inpPhone.readOnly = true; 
                inpPhone.style.opacity = '0.5';
                inpPhone.style.background = 'rgba(255,255,255,0.05)';
                
                inpPass.value = ''; 
                inpPass.placeholder = "🔒 Protegido"; 
                inpPass.readOnly = true;
                inpPass.style.opacity = '0.5';
                inpPass.style.background = 'rgba(255,255,255,0.05)';
            }

            btn.innerHTML = '<i class="fas fa-save"></i> GUARDAR DATOS';
            btn.style.background = 'var(--primary)'; btn.style.color = '#000';
            btn.onclick = saveProfileData;
        } 
        else if (mode === 'login') {
            lblPhone.innerText = "Tu Teléfono Registrado";
            lblPass.innerText = "Tu Contraseña";
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> RESTAURAR CUENTA';
            btn.style.background = '#3498db'; btn.style.color = '#fff';
            btn.onclick = recuperarPorPassword;
        }
        else if (mode === 'phone') {
            lblPhone.innerText = "NUEVO Número de Teléfono";
            lblPass.innerText = "Contraseña ACTUAL (Seguridad)";
            inpPhone.value = ''; 
            inpPass.value = '';
            inpPass.placeholder = "Confirma que eres tú...";
            
            btn.innerHTML = '<i class="fas fa-sim-card"></i> CAMBIAR NÚMERO';
            btn.style.background = '#9b59b6'; btn.style.color = '#fff';
            btn.onclick = cambiarNumeroTelefono;
        }
        else if (mode === 'pass') {
            inpPhone.readOnly = true; inpPhone.style.opacity = '0.5';
            inpPhone.value = localStorage.getItem('barber_phone_real') || '';
            
            grpOldPass.style.display = 'block'; // Mostrar campo vieja clave
            inpOldPass.value = '';
            
            lblPhone.innerText = "Usuario (Fijo)";
            lblPass.innerText = "NUEVA Contraseña";
            inpPass.value = '';
            inpPass.placeholder = "Escribe la nueva...";
            
            btn.innerHTML = '<i class="fas fa-key"></i> ACTUALIZAR CLAVE';
            btn.style.background = '#f1c40f'; btn.style.color = '#000';
            btn.onclick = saveProfileData;
        }
    }

    function openEditDataModal() {
        let nombreMostrar = DB.settings.brand.text || "";
        if (nombreMostrar === "BARBERIA CON ESTILO" || nombreMostrar === "Usuario Desconocido") nombreMostrar = "";
        
        document.getElementById('editProfileName').value = nombreMostrar;
        document.getElementById('editProfilePhone').value = localStorage.getItem('barber_phone_real') || "";
        document.getElementById('editProfileProvincia').value = DB.settings.brand.provincia || "";
        document.getElementById('editProfileZona').value = DB.settings.brand.zona || "";
        document.getElementById('editProfilePassword').value = localStorage.getItem('barber_password') || "";
        
        // Resetear visual
        document.getElementById('inputLat').value = ""; document.getElementById('inputLng').value = "";
        document.getElementById('mapPickerContainer').style.display = 'none';
        document.getElementById('btnGeoText').innerText = "DETECTAR UBICACIÓN Y MAPA";
        
        setAuthMode('create'); 
        document.getElementById('modalEditData').classList.add('open');
    }

    let passwordRetryCount = 0;

                let passwordEditRetry = 0; // Contador local para cambios internos

    async function saveProfileData() {
        // 1. OBTENER ELEMENTOS
        const inpName = document.getElementById('editProfileName');
        const inpPhone = document.getElementById('editProfilePhone');
        const inpPass = document.getElementById('editProfilePassword');
        const inpOldPass = document.getElementById('inputOldPass'); 
        
        [inpName, inpPhone, inpPass, inpOldPass].forEach(i => i.style.borderColor = '');

        const valName = inpName.value.trim();
        const valPhone = normalizarTelefono(inpPhone.value);
        const valPass = inpPass.value.trim();
        const valOldPass = inpOldPass.value.trim();
        
        const savedPass = localStorage.getItem('barber_password');
        let errorFound = false;

        // 2. VALIDACIÓN VISUAL (ROJO) Y SEGURIDAD
        if (currentAuthMode === 'create') {
            if (!valName) { inpName.style.borderColor = 'red'; errorFound = true; }
            if (!inpPhone.readOnly && !valPhone) { inpPhone.style.borderColor = 'red'; errorFound = true; }
            
            // VALIDACIÓN DE PRECIOS OBLIGATORIA
            const cachedServ = localStorage.getItem('bm_cached_services');
            if (!cachedServ || JSON.parse(cachedServ).length === 0) {
                showToast("Configura tu Lista de Precios primero", "📋", "REQUERIDO");
                if(navigator.vibrate) navigator.vibrate(500);
                // Ayudamos al usuario abriendo la ventana correspondiente
                setTimeout(abrirGestorServicios, 1500);
                return;
            }

            if (!inpPass.readOnly) {
                if (!valPass || valPass.length < 8 || !/[A-Z]/.test(valPass) || !/[!@#$%^&*.,\-_]/.test(valPass)) {
                    inpPass.style.borderColor = 'red';
                    showToast("Mínimo 8 caracteres, 1 Mayúscula y 1 Símbolo", "🔒", "CLAVE DÉBIL");
                    if(navigator.vibrate) navigator.vibrate(200);
                    return;
                }
            }
        } 
        else if (currentAuthMode === 'pass') {
            if (!valPass || valPass.length < 8 || !/[A-Z]/.test(valPass) || !/[!@#$%^&*.,\-_]/.test(valPass)) {
                inpPass.style.borderColor = 'red'; 
                showToast("Mínimo 8 caracteres, 1 Mayúscula y 1 Símbolo", "🔒", "CLAVE DÉBIL");
                if(navigator.vibrate) navigator.vibrate(200);
                return;
            }
            if (!valOldPass) { inpOldPass.style.borderColor = 'red'; errorFound = true; }
        }

        if (errorFound) {
            showToast("Faltan datos marcados en rojo", "⚠️", "ERROR");
            if(navigator.vibrate) navigator.vibrate(200);
            return;
        }

        // 3. SEGURIDAD: VERIFICAR CONTRASEÑA ACTUAL
        if (currentAuthMode === 'pass') {
            if (valOldPass !== savedPass) {
                passwordEditRetry++;
                inpOldPass.style.borderColor = 'red';
                showToast("La contraseña actual no coincide", "⛔", "DENEGADO");
                
                if(passwordEditRetry >= 3) {
                    const msgSoporte = `
                        <div style="font-size:0.9rem;color:#bbb;margin-bottom:20px;line-height:1.5;">
                            Demasiados intentos fallidos de contraseña.<br>Contacta soporte para verificar tu identidad.
                        </div>
                        <div style="display:flex;gap:12px;justify-content:center;">
                            <a href="tel:+5351881471" class="btn" style="flex:1;background:rgba(52,152,219,0.2);border:1px solid #3498db;color:#3498db;display:flex;align-items:center;justify-content:center;text-decoration:none;">
                                <i class="fas fa-phone"></i>&nbsp; Llamar
                            </a>
                            <button onclick="window.open('https://wa.me/5351881471?text=Ayuda%20cambio%20clave%20bloqueado','_blank')" class="btn" style="flex:1;background:#25D366;color:#fff;">
                                <i class="fab fa-whatsapp"></i>&nbsp; WhatsApp
                            </button>
                        </div>
                    `;
                    showCustomAlert('warning', '⛔ Acción Bloqueada', msgSoporte, null, null);
                    // Ocultar botón cancelar
                    const cancelBtn = document.querySelector('#alertButtons .btn-outline');
                    if(cancelBtn) cancelBtn.style.display = 'none';
                }

                if(navigator.vibrate) navigator.vibrate(500);
                return;
            }
            // Si acierta, reseteamos el contador
            passwordEditRetry = 0;
        }

        // 4. PROCESAMIENTO
        const btn = document.getElementById('btnAuthAction');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GUARDANDO...';
        btn.disabled = true;

        if (currentAuthMode === 'create' && !localStorage.getItem('barber_phone_real')) {
            const { data: existe } = await supabase.from('barberos').select('id').eq('telefono', valPhone).maybeSingle();
            if (existe) {
                btn.innerHTML = originalText; btn.disabled = false;
                inpPhone.style.borderColor = 'red';
                showToast("Ese número ya tiene cuenta.", "⛔", "OCUPADO");
                return;
            }
        }

        if (valName) DB.settings.brand.text = valName;
        if (currentAuthMode === 'create') {
            if (!inpPhone.readOnly) localStorage.setItem('barber_phone_real', valPhone);
            if (!inpPass.readOnly) localStorage.setItem('barber_password', valPass);
        }
        if (currentAuthMode === 'pass') localStorage.setItem('barber_password', valPass);

        saveData();
        applyBrandSettings();

        const finalPass = localStorage.getItem('barber_password');
        const finalPhone = localStorage.getItem('barber_phone_real');
        const prov = DB.settings.brand.provincia || "";
        const zona = DB.settings.brand.zona || "";
        const desc = zona ? `${zona}, ${prov}` : prov;
        
        let estoyVerificado = DB.settings.verified === true;
        let estoyOnline = localStorage.getItem('barber_online_status') === 'true';

        if (currentAuthMode === 'create') {
            // FIX: Si ya existe cuenta verificada, MANTENER ESTADO (No reiniciar)
            if(localStorage.getItem('barber_phone_real') && DB.settings.verified === true) {
                estoyVerificado = true; 
                // estoyOnline se mantiene con el valor que tenía
            } else {
                // Solo si es registro nuevo o reseteo
                estoyVerificado = null; 
                estoyOnline = false;
            }
        }

        await enviarDatosAlServidor(
            DB.settings.brand.text, 
            finalPhone, 
            finalPass, 
            desc, 
            prov, 
            DB.settings.brand.lat, 
            DB.settings.brand.lng,
            estoyOnline,
            estoyVerificado 
        );

        btn.innerHTML = originalText;
        btn.disabled = false;
        inpPass.value = '';
        inpOldPass.value = '';
        document.getElementById('modalEditData').classList.remove('open');

        if (currentAuthMode === 'create') {
        } else if (currentAuthMode === 'pass') {
            showToast("Contraseña cambiada correctamente", "🔑", "SEGURIDAD");
        } else {
            showToast("Nombre actualizado correctamente", "📝", "PERFIL");
        }
    }


    async function cambiarNumeroTelefono() {
        const inpNewPhone = document.getElementById('editProfilePhone');
        const inpCurrentPass = document.getElementById('editProfilePassword');
        
        inpNewPhone.style.borderColor = ''; 
        inpCurrentPass.style.borderColor = '';

        const newPhone = normalizarTelefono(inpNewPhone.value);
        const pass = inpCurrentPass.value.trim();
        const savedPass = localStorage.getItem('barber_password');

        // 1. VALIDACIONES
        if (!newPhone) { inpNewPhone.style.borderColor = 'red'; showToast("Escribe el nuevo número", "✏️", "ERROR"); return; }
        if (!pass) { inpCurrentPass.style.borderColor = 'red'; showToast("Confirma tu contraseña actual", "🔒", "SEGURIDAD"); return; }
        
        if (pass !== savedPass) {
            passwordEditRetry++; // Usamos el mismo contador de seguridad
            inpCurrentPass.style.borderColor = 'red';
            showToast("Contraseña incorrecta", "❌", "ERROR");
            
            if(passwordEditRetry >= 3) {
                const msgSoporte = `
                    <div style="font-size:0.9rem;color:#bbb;margin-bottom:20px;line-height:1.5;">
                        No podemos verificar que eres tú.<br>Contacta al soporte para cambiar tu número.
                    </div>
                    <div style="display:flex;gap:12px;justify-content:center;">
                        <a href="tel:+5351881471" class="btn" style="flex:1;background:rgba(52,152,219,0.2);border:1px solid #3498db;color:#3498db;display:flex;align-items:center;justify-content:center;text-decoration:none;">
                            <i class="fas fa-phone"></i>&nbsp; Llamar
                        </a>
                        <button onclick="window.open('https://wa.me/5351881471?text=Ayuda%20cambio%20numero%20bloqueado','_blank')" class="btn" style="flex:1;background:#25D366;color:#fff;">
                            <i class="fab fa-whatsapp"></i>&nbsp; WhatsApp
                        </button>
                    </div>
                `;
                showCustomAlert('warning', '⛔ Seguridad Activada', msgSoporte, null, null);
                const cancelBtn = document.querySelector('#alertButtons .btn-outline');
                if(cancelBtn) cancelBtn.style.display = 'none';
            }

            if(navigator.vibrate) navigator.vibrate(500);
            return;
        }
        
        // Reseteo si acierta
        passwordEditRetry = 0;

        const btn = document.getElementById('btnAuthAction');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> VERIFICANDO...';
        btn.disabled = true;

        // 2. VERIFICAR SI EXISTE EN NUBE
        const { data: existe } = await supabase.from('barberos').select('id').eq('telefono', newPhone).maybeSingle();
        
        if (existe) {
            btn.innerHTML = '<i class="fas fa-sim-card"></i> CAMBIAR NÚMERO';
            btn.disabled = false;
            inpNewPhone.style.borderColor = 'red';
            showToast("Ese número ya está en uso", "⛔", "OCUPADO");
            return;
        }

        // 3. ACTUALIZAR TODO
        localStorage.setItem('barber_phone_real', newPhone);
        
        await supabase.from('barberos').update({ telefono: newPhone }).eq('id', MY_DEVICE_ID);
        
        document.getElementById('displayBrandPhone').innerText = newPhone;
        
        btn.innerHTML = '<i class="fas fa-check"></i> ÉXITO';
        btn.style.background = '#2ecc71';
        showToast("Número actualizado correctamente", "✅", "LISTO");
        
        setTimeout(() => {
            document.getElementById('modalEditData').classList.remove('open');
            location.reload();
        }, 1500);
    }


    
    let mapPicker = null;
    let markerPicker = null;

    function detectarUbicacionBarbero() {
        if(typeof Android !== 'undefined' && Android.pedirPermisoUbicacion) Android.pedirPermisoUbicacion();

        const btn = document.getElementById('btnGeoText');
        btn.innerText = "DETECTANDO SATÉLITES...";
        
        if(!navigator.geolocation) {
            btn.innerText = "ACTUALIZAR UBICACIÓN NEGOCIO";
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                
                inicializarMapaPicker(lat, lng);
                
                obtenerNombreProvincia(lat, lng);

                document.getElementById('btnConfirmMap').style.display = 'block';
                btn.innerText = "UBICACIÓN ENCONTRADA";
            },
            (err) => {
                btn.innerText = "REINTENTAR GPS";
                inicializarMapaPicker(23.1136, -82.3666); 
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    function inicializarMapaPicker(lat, lng) {
        const container = document.getElementById('mapPickerContainer');
        container.style.display = 'block'; 
        container.classList.add('active');
        
        document.getElementById('btnConfirmMap').style.display = 'none';

        if (mapPicker) { mapPicker.remove(); mapPicker = null; }

        mapPicker = L.map('mapPickerContainer', { zoomControl: false, attributionControl: false }).setView([lat, lng], 16);

        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20, 
            subdomains: ['mt0','mt1','mt2','mt3'],
            detectRetina: true, // ACTIVAR HD (RETINA)
            updateWhenZooming: false
        }).addTo(mapPicker);

        const gpsIcon = L.divIcon({
            className: 'gps-dot',
            html: '<div style="width:12px;height:12px;background:#3498db;border-radius:50%;border:2px solid #fff;box-shadow:0 0 10px #3498db;"></div>',
            iconSize: [12, 12]
        });
        L.marker([lat, lng], {icon: gpsIcon}).addTo(mapPicker).bindPopup("Tú (GPS)");

        let shopLat = DB.settings.brand.lat || lat;
        let shopLng = DB.settings.brand.lng || lng;

        const shopIcon = L.divIcon({
            className: 'shop-pin',
            html: '<div style="width:30px;height:30px;background:#00D4AA;border-radius:50%;border:3px solid #fff;box-shadow:0 0 15px rgba(0,212,170,0.5);display:flex;align-items:center;justify-content:center;color:#000;font-size:14px;"><i class="fas fa-cut"></i></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        markerPicker = L.marker([shopLat, shopLng], {icon: shopIcon, draggable: true}).addTo(mapPicker);

        const MyShopControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function() {
                const btn = L.DomUtil.create('button', 'leaflet-bar leaflet-control');
                btn.innerHTML = '<i class="fas fa-store"></i>';
                btn.style.cssText = 'background:#1a1a1a; color:#00D4AA; border:1px solid #00D4AA; width:40px; height:40px; border-radius:10px; cursor:pointer; font-size:18px; box-shadow:0 0 10px rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;';
                btn.onclick = function(e) {
                    L.DomEvent.stopPropagation(e);
                    if(DB.settings.brand.lat) {
                        mapPicker.setView([DB.settings.brand.lat, DB.settings.brand.lng], 17);
                        markerPicker.setLatLng([DB.settings.brand.lat, DB.settings.brand.lng]);
                    } else {
                    }
                };
                return btn;
            }
        });
        mapPicker.addControl(new MyShopControl());

        const showSaveBtn = () => {
            document.getElementById('btnConfirmMap').style.display = 'block';
            if(navigator.vibrate) navigator.vibrate(20);
        };

        markerPicker.on('dragend', showSaveBtn);
        mapPicker.on('click', function(e) {
            markerPicker.setLatLng(e.latlng);
            showSaveBtn();
        });

        setTimeout(() => { mapPicker.invalidateSize(); }, 100);
    }

    async function confirmarPuntoMapa() {
        if(!markerPicker) return;
        
        const c = markerPicker.getLatLng();
        const btn = document.getElementById('btnConfirmMap');

        // 1. Guardar SIEMPRE en memoria local primero
        let prov = document.getElementById('editProfileProvincia').value;
        let zona = document.getElementById('editProfileZona').value;
        if(prov === "Detectando..." || prov === "") prov = "Ubicación Mapa";
        if(zona === "Detectando...") zona = "";

        DB.settings.brand.lat = c.lat;
        DB.settings.brand.lng = c.lng;
        DB.settings.brand.provincia = prov;
        DB.settings.brand.zona = zona;
        saveData();

        // 2. Si es cuenta nueva, NO subir aún (esperar al botón Guardar Datos)
        if (!localStorage.getItem('barber_phone_real')) {
            document.getElementById('btnGeoText').innerText = "📍 PUNTO FIJADO (Pendiente Guardar)";
            btn.style.display = 'none';
            if(navigator.vibrate) navigator.vibrate(50);
            return; 
        }
        
        // 3. Si ya tiene cuenta, subir a la nube al instante
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> GUARDANDO...';
        btn.disabled = true;

        try {
            // let prov ya fue declarado arriba, lo usamos directo
            let zona = document.getElementById('editProfileZona').value;
            
            if(prov === "Detectando..." || prov === "") prov = "Ubicación Mapa";
            if(zona === "Detectando...") zona = "";

            const desc = zona ? `${zona}, ${prov}` : prov;

            if(MY_DEVICE_ID) {
                const { error } = await supabase.from('barberos').update({
                    lat: c.lat,
                    lng: c.lng,
                    provincia: prov,
                    descripcion: desc
                }).eq('id', MY_DEVICE_ID);
                
                if(error) throw error;
            }

            DB.settings.brand.lat = c.lat;
            DB.settings.brand.lng = c.lng;
            DB.settings.brand.provincia = prov;
            DB.settings.brand.zona = zona;
            saveData();

            if(navigator.vibrate) navigator.vibrate([50, 50]);
            
            btn.style.display = 'none';
            document.getElementById('btnGeoText').innerText = "📍 UBICACIÓN SINCRONIZADA";
            
            if(document.getElementById('lastSyncText')) {
                document.getElementById('lastSyncText').innerHTML = "<span style='color:#2ecc71'>✅ Visible en: " + desc + "</span>";
            }

        } catch(e) {
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-map-pin"></i> USAR ESTA UBICACIÓN';
        }
    }

    async function buscarLugarManual() {
        const query = document.getElementById('manualMapSearch').value.trim();
        if(!query) return;

        const btn = document.querySelector('button[onclick="buscarLugarManual()"]');
        const iconoOriginal = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
            const resp = await fetch(url); 
            const data = await resp.json();

            if(data && data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lng = parseFloat(data[0].lon);

                if(!mapPicker) {
                    inicializarMapaPicker(lat, lng);
                } else {
                    mapPicker.setView([lat, lng], 16);
                    markerPicker.setLatLng([lat, lng]);
                }
                
                obtenerNombreProvincia(lat, lng);

                document.getElementById('btnConfirmMap').style.display = 'block';
                if(navigator.vibrate) navigator.vibrate(50);
            } else {
            }
        } catch(e) {
            console.warn(e);
        }
        btn.innerHTML = iconoOriginal;
    }

    async function obtenerNombreProvincia(lat, lng) {
        const inputProv = document.getElementById('editProfileProvincia');
        const inputZona = document.getElementById('editProfileZona');
        
        inputProv.value = "Detectando...";
        inputZona.value = "Detectando...";

        try {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=14`;
            const resp = await fetch(url);
            
            if(!resp.ok) throw new Error("Error API");
            
            const data = await resp.json();
            
            if(data && data.address) {
                const a = data.address;
                const prov = a.state || a.province || a.region || "";
                const zona = a.suburb || a.neighbourhood || a.city_district || a.village || a.town || "";

                inputProv.value = prov || "Ubicación Manual";
                inputZona.value = zona;
            } else {
                throw new Error("Sin datos");
            }
        } catch(e) {
            console.warn("Geo error:", e);
            inputProv.value = "";
            inputZona.value = "";
            inputProv.placeholder = "Escribe tu provincia...";
            inputZona.placeholder = "Escribe tu zona...";
        }
    }

    function syncProfileInputs() {}

        function normalizarTelefono(input) {
            if (!input) return "";
            let limpio = input.replace(/\D/g,'');
            if (limpio.startsWith('53') && limpio.length > 8) {
                limpio = limpio.substring(2);
}
            return limpio;
}


        async function enviarDatosAlServidor(nombre, telefono, clave, desc, prov, lat, lng, isOnline = false, isVerified = null) {
            const btn = document.getElementById('btnPublish');
            
            // 1. INTELIGENCIA DE ESTADO
            let estadoVerificadoFinal = isVerified;
            let estadoOnlineFinal = isOnline;

            // Si es cuenta nueva o reset (isVerified es null)
            if (isVerified === null) {
                const { data: configSistema } = await supabase
                    .from('sistema')
                    .select('verificacion_estricta')
                    .eq('id', 'config')
                    .maybeSingle();
                
                const seguridadActiva = configSistema ? (configSistema.verificacion_estricta !== false) : true;
                DB.settings.strictMode = seguridadActiva;
                
                estadoVerificadoFinal = !seguridadActiva; // Si no hay seguridad, estás verificado

                // MAGIA: Si te auto-verificas, te ponemos ONLINE automáticamente
                if (estadoVerificadoFinal) {
                    estadoOnlineFinal = true;
                }
            }
            
            // 2. PREPARAR DATOS

            // FIX: Si es cuenta nueva (sin horario), crear estándar (Lun-Sab 9am-6pm)
            if (!DB.settings.schedule || Object.keys(DB.settings.schedule).length === 0) {
                const hDef = {active: true, start: "09:00", end: "18:00"};
                DB.settings.schedule = {
                    lun: hDef, mar: hDef, mie: hDef, 
                    jue: hDef, vie: hDef, sab: hDef,
                    dom: {active: false, start: "09:00", end: "18:00"}
                };
                saveData(); // Guardar en memoria del teléfono
            }

            // --- CÁLCULO TRIAL 30 DÍAS (SOLO NUEVOS) ---
            let fechaTrial = null;
            if (isVerified === null) { // Solo si es registro nuevo
                const f = new Date();
                f.setDate(f.getDate() + 30);
                fechaTrial = f.toISOString();
            }

            // --- INSPECTOR TÉCNICO V1 (ACTUALIZACIÓN) ---
            let modeloReal = "Web/Desconocido";
            let versionReal = "1.0";
            
            if(typeof Android !== 'undefined' && Android.obtenerDatosTecnicos) {
                try {
                    const techData = JSON.parse(Android.obtenerDatosTecnicos());
                    modeloReal = techData.modelo || modeloReal;
                    versionReal = techData.version || versionReal;
                } catch(e) {}
            }

            const perfilData = {
                id: MY_DEVICE_ID,
                nombre: nombre,
                telefono: telefono,
                clave: clave,
                descripcion: desc,
                provincia: prov,
                disponible: estadoOnlineFinal, 
                verificado: estadoVerificadoFinal,
                horario: DB.settings.schedule,
                modelo_dispositivo: modeloReal,
                version_app: versionReal,
                ultima_conexion: new Date().toISOString()
            };
            
            // Inyectar fecha solo si es nuevo para no sobrescribir pagos previos
            if(fechaTrial) perfilData.vencimiento_suscripcion = fechaTrial;

            if (lat && lng) {
                perfilData.lat = lat;
                perfilData.lng = lng;
            }

            // 3. ENVIAR A SUPABASE
            const { data, error } = await supabase.from('barberos').upsert(perfilData).select();

            if (error) {
                if(btn) {
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ERROR RED';
                    btn.style.background = "#e74c3c";
                    setTimeout(() => { 
                        btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> PUBLICAR PERFIL';
                        btn.style.background = "var(--primary)";
                    }, 3000);
                }
            } else {
                if (data && data[0] && data[0].bloqueado) {
                     activarCandadoSeguridad("Cuenta bloqueada por Admin");
                     return;
                }

                if(btn) {
                    btn.innerHTML = '<i class="fas fa-check"></i> GUARDADO';
                    btn.style.background = "#2ecc71";
                    btn.style.color = "#000";
                }
                
                // Guardar en memoria local
                DB.settings.verified = estadoVerificadoFinal;
                
                // CRUCIAL: Si el servidor nos puso ONLINE automáticamente, guardamos eso en memoria YA
                if(estadoOnlineFinal) {
                    localStorage.setItem('barber_online_status', 'true');
                }
                
                saveData();
                
                // 4. ACTUALIZAR INTERFAZ (Interruptor y Textos)
                actualizarBotonEstado(estadoOnlineFinal);

                // Mensaje de estado y Feedback Visual
                if (isVerified === null) {
                    if (!estadoVerificadoFinal) {
                        // CASO: Seguridad Cerrada (Mensaje Doble)
                        showToast("Cuenta creada correctamente. Esperando aprobación del Admin.", "⏳", "REGISTRO");
                    } else {
                        // CASO: Seguridad Abierta
                        if(navigator.vibrate) navigator.vibrate([100,50,100,50,200]); 
                        showToast("Cuenta creada correctamente.", "✅", "REGISTRO");
                        
                        // Forzar visualmente el switch
                        const sw = document.getElementById('toggleOnlineSwitch');
                        if(sw) sw.checked = true;

                        // CORRECCIÓN DEFINITIVA: Fuerza bruta al servidor
                        // Enviamos una orden extra para asegurar que la base de datos guarde el estado ONLINE
                        supabase.from('barberos').update({ disponible: true }).eq('id', MY_DEVICE_ID).then(() => {
                            console.log("✅ Servidor forzado a ONLINE correctamente");
                        });
                    }
                }
                
                iniciarRadarPerfil();

                if(btn) {
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> PUBLICAR PERFIL';
                        btn.style.background = "var(--primary)";
                        btn.style.color = "#000";
                    }, 3000);
                }
            }
        }
        
        function copiarIDBloqueado() {
            const idTexto = document.getElementById('lockIDDisplay').innerText;
            if(idTexto && idTexto !== '...') {
                // Intento 1: API Moderna
                navigator.clipboard.writeText(idTexto).then(() => {
                    showToast("ID copiado al portapapeles", "📋", "SOPORTE");
                }).catch(err => {
                    // Intento 2: Fallback compatible
                    try {
                        const textArea = document.createElement("textarea");
                        textArea.value = idTexto;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand("copy");
                        document.body.removeChild(textArea);
                        showToast("ID copiado al portapapeles", "📋", "SOPORTE");
                    } catch (e) {
                        console.error("Fallo copia", e);
                    }
                });
            }
        }

        async function alternarDisponibilidad() {
            const btnStatus = document.getElementById('btnStatusToggle');
            const statusText = document.getElementById('lastSyncText');
            
            const esOnline = btnStatus.innerHTML.includes('fa-moon');
            
            const nuevoEstado = !esOnline;

            btnStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CAMBIANDO...';

            const {error}= await supabase
                .from('barberos')
                .update({disponible:nuevoEstado})
                .eq('id',MY_DEVICE_ID);

            if(!error) {
                if(nuevoEstado) {
                    actualizarBotonEstado(true);
                    if(statusText) statusText.innerHTML = "<span style='color:#2ecc71'>✅ En Línea y Visible</span>";
}else {
                    actualizarBotonEstado(false);
                    if(statusText) statusText.innerHTML = "<span style='color:#f1c40f'>💤 Modo No Disponible</span>";
}
}else {
                actualizarBotonEstado(esOnline);
}
}

       function actualizarBotonEstado(estoyOnline, silent = false) {
            actualizarPuntoEstado(estoyOnline);

            const switchPro = document.getElementById('toggleOnlineSwitch');
            if(switchPro) {
                switchPro.checked = estoyOnline;
                const statusBadge = document.getElementById('profileStatusBadge');
                const toggleTitle = document.getElementById('toggleStatusTitle');
                const toggleSubtitle = document.getElementById('toggleStatusSubtitle');
                const iconStatus = document.getElementById('iconOnlineStatus');
                
                if(estoyOnline) {
                    if(statusBadge) {statusBadge.classList.remove('offline');statusBadge.classList.add('online');}
                    if(document.getElementById('statusTextBadge')) document.getElementById('statusTextBadge').innerText = 'Conectado';
                    if(toggleTitle) toggleTitle.innerText = 'Online - Recibiendo Clientes';
                    if(toggleSubtitle) toggleSubtitle.innerText = 'Disponible para citas';
                    if(iconStatus) iconStatus.style.color = '#2ecc71';
                    if(!silent) showToast("Estás Visible", "🟢", "ONLINE");
}else {
                    if(statusBadge) {statusBadge.classList.remove('online');statusBadge.classList.add('offline');}
                    if(document.getElementById('statusTextBadge')) document.getElementById('statusTextBadge').innerText = 'Desconectado';
                    if(toggleTitle) toggleTitle.innerText = 'Offline - No visible';
                    if(toggleSubtitle) toggleSubtitle.innerText = 'Tap para conectarte';
                    if(iconStatus) iconStatus.style.color = '#e74c3c';
                    if(!silent) showToast("Estás Oculto", "🔴", "OFFLINE");
}
}

            const btn = document.getElementById('btnStatusToggle');
            if(btn) {
                if(estoyOnline) {
                    btn.innerHTML = '<i class="fas fa-moon"></i> PONER NO DISPONIBLE';
                    btn.style.color = "#f1c40f";
                    btn.style.borderColor = "#f1c40f";
}else {
                    btn.innerHTML = '<i class="fas fa-bolt"></i> PONERME EN LÍNEA';
                    btn.style.color = "#2ecc71";
                    btn.style.borderColor = "#2ecc71";
}
}
            
            localStorage.setItem('barber_online_status',estoyOnline);
}

        function borrarPerfilServidor() {
            showCustomAlert(
                'warning',
                '¿Eliminar Cuenta?',
                'Desaparecerás <b>totalmente</b> del servidor y los clientes no podrán encontrarte.',
                async function() {
                    const {error}= await supabase.from('barberos').delete().eq('id',MY_DEVICE_ID);

                    if(!error) {
                        document.getElementById('lastSyncText').innerHTML = "<span style='color:#aaa'>🗑️ Perfil eliminado.</span>";
                        document.getElementById('btnPublish').innerHTML = '<i class="fas fa-save"></i> PUBLICAR PERFIL';
                        actualizarBotonEstado(false);
}else {
}
},
                null 
            );
}

        function copiarIDPortapapeles() {
            if(!MY_DEVICE_ID) return;
            navigator.clipboard.writeText(MY_DEVICE_ID).then(() => {
                if(navigator.vibrate) navigator.vibrate(50);
                showToast("ID Copiado", "📋", "SOPORTE");
}).catch(err => console.error("Error copia",err));
}
async function subirFotoPerfil(input) {
    if (!input.files || !input.files[0]) return;

    if (!localStorage.getItem('barber_phone_real')) {
        showToast("Crea una cuenta primero", "👤", "REQUERIDO");
        input.value = ''; 
        return;
    }
    
    const fileOriginal = input.files[0];
    const btnIcon = document.querySelector('label[for="uploadProfilePic"] i');
    btnIcon.className = "fas fa-spinner fa-spin";

    // 1. MODO OFFLINE: Guardar y mostrar inmediatamente
    const reader = new FileReader();
    reader.onload = async function(e) {
        const base64Data = e.target.result;
        
        localStorage.setItem('bm_cached_profile_pic', base64Data);
        mostrarFotoEnUI(base64Data);
        
        btnIcon.className = "fas fa-camera";
        showToast("Foto Actualizada", "📸", "PERFIL");

        // 2. MODO ONLINE: Subir a la nube en segundo plano
        if (navigator.onLine && typeof supabase !== 'undefined') {
            try {
                const archivoLigero = await comprimirImagenCliente(fileOriginal);
                // PRO: Nombre fijo para sobrescribir y no llenar el servidor
                const fileName = `${MY_DEVICE_ID}_profile.jpg`;
                const filePath = `avatars/${fileName}`;

                // upsert: true fuerza el reemplazo de la vieja
                const { error } = await supabase.storage.from('perfiles').upload(filePath, archivoLigero, { upsert: true });
                if (!error) {
                    const { data } = supabase.storage.from('perfiles').getPublicUrl(filePath);
                    // Agregamos ?t=tiempo para obligar a la app a refrescar la imagen
                    const urlFresca = data.publicUrl + '?t=' + Date.now();
                    
                    await supabase.from('barberos').update({ foto_url: urlFresca }).eq('id', MY_DEVICE_ID);
                    console.log("☁️ Foto sobrescrita y sincronizada");
                }
            } catch (err) { console.warn("Subida pendiente"); }
        }
    };
    reader.readAsDataURL(fileOriginal);
}

function mostrarFotoEnUI(url) {
    const img = document.getElementById('profileImagePreview');
    const def = document.getElementById('profileAvatarDefault');
    
    const headerImg = document.getElementById('headerProfileImg');
    const headerIcon = document.getElementById('headerProfileIcon');

    if(url) {
        if(img) {img.src = url;img.style.display = 'block';}
        if(def) def.style.display = 'none';

        if(headerImg) {
            headerImg.src = url;
            headerImg.style.display = 'block';
}
        if(headerIcon) headerIcon.style.display = 'none';
}else {
        if(headerImg) headerImg.style.display = 'none';
        if(headerIcon) headerIcon.style.display = 'flex';
}
}
function initProfileModal() {
    // 1. CARGAR FOTO DE PERFIL INSTANTÁNEA (OFFLINE)
    const fotoGuardada = localStorage.getItem('bm_cached_profile_pic');
    if(fotoGuardada) {
        mostrarFotoEnUI(fotoGuardada);
    }

    const toggle = document.getElementById('toggleOnlineSwitch');
    if(toggle) {
        // LEER MEMORIA LOCAL
        const isOnline = localStorage.getItem('barber_online_status') === 'true';
        toggle.checked = isOnline;
        
        // Solo actualizamos lo visual (Silent Mode) para no chocar con el servidor
        actualizarBotonEstado(isOnline, true); 
    }

    // --- RESTAURAR ESTADO DE VOZ IA ---
    updateVoiceFabVisibility();
}

document.addEventListener('DOMContentLoaded',initProfileModal);

function actualizarPuntoEstado(online) {
    const dot = document.getElementById('statusDot');
    if(dot) {
        if(online) {
            dot.className = 'status-dot online';
        } else {
            dot.className = 'status-dot offline';
        }
    }
}

async function abrirGestorServicios() {
    document.getElementById('modalServices').classList.add('open');
    cargarMisServicios();
}

async function cargarMisServicios() {
    const list = document.getElementById('myServicesList');
    
    // 1. CARGAR DE MEMORIA (Rápido)
    const cachedServices = localStorage.getItem('bm_cached_services');
    let serviciosLocales = [];
    
    if(cachedServices) {
        serviciosLocales = JSON.parse(cachedServices);
        renderServicesList(serviciosLocales); // Pintar ya
    } else {
        list.innerHTML = '<div style="text-align:center;padding:24px;color:#666;"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>';
    }

    // 2. ACTUALIZAR DE INTERNET (Lento pero seguro)
    const {data,error}= await supabase
        .from('servicios')
        .select('*')
        .eq('barbero_id',MY_DEVICE_ID)
        .order('precio',{ascending:true});

    if (!error && data) {
        localStorage.setItem('bm_cached_services', JSON.stringify(data));
        renderServicesList(data); // Repintar con datos nuevos
    } else if (!cachedServices) {
        list.innerHTML = '<div style="text-align:center;padding:24px;color:#555;">No tienes servicios publicados.<br>Agrega uno arriba 👆</div>';
    }
}

function renderServicesList(data) {
    const list = document.getElementById('myServicesList');
    if(!data || data.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:24px;color:#555;">No tienes servicios publicados.<br>Agrega uno arriba 👆</div>';
        return;
    }
    list.innerHTML = '';
    data.forEach(s => {
        const item = document.createElement('div');
        item.style.cssText = "background:rgba(255,255,255,0.03);padding:14px;margin-bottom:8px;border-radius:16px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.05);";
        item.innerHTML = `
            <div>
                <div style="font-weight:bold;color:#fff;">${s.nombre}</div>
                <div style="color:#3498db;font-weight:800;">$${s.precio}</div>
            </div>
            <button onclick="borrarServicio('${s.id}')" style="background:rgba(231,76,60,0.2);color:#e74c3c;border:none;width:35px;height:35px;border-radius:8px;cursor:pointer;">
                <i class="fas fa-trash"></i>
            </button>
        `;
        list.appendChild(item);
    });
}

async function crearServicio() {
    const nameInput = document.getElementById('newServiceName');
    const priceInput = document.getElementById('newServicePrice');
    const nombre = nameInput.value.trim();
    const precio = priceInput.value;
    const btn = document.querySelector('#modalServices .btn');

    if(!nombre || !precio) return;
    if(!MY_DEVICE_ID) return;

    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    const precioFinal = parseFloat(precio);

    console.log("Enviando:",{barbero_id:MY_DEVICE_ID,nombre:nombre,precio:precioFinal});

    const {data,error}= await supabase
        .from('servicios')
        .insert([{
            barbero_id:MY_DEVICE_ID,
            nombre:nombre,
            precio:precioFinal
        }])
        .select();

    btn.innerHTML = originalText;
    btn.disabled = false;

    if(error) {
        console.error(error);
    } else {
        nameInput.value = '';
        priceInput.value = '';
        cargarMisServicios();
        nameInput.focus();
    }
}

function borrarServicio(id) {
    (async function() {
        const {error}= await supabase
            .from('servicios')
            .delete()
            .eq('id',id);

        if(!error) {
            cargarMisServicios();
        }
    })();
}

// --- LÓGICA DE HISTORIAS 24H (PRO V2) ---
let myActiveStoryUrl = null;
let storyCreatedAt = null; // Para guardar la fecha de creación
let storyTouchStartY = 0;
let storyTimerInterval = null;

// 1. INICIAR: Chequear historia (Con Caché)
async function checkMyStoryStatus() {
    if(!MY_DEVICE_ID) return;
    
    const btnContainer = document.getElementById('storyBtnContainer');
    const btnAdd = document.getElementById('btnStoryAdd');
    const thumb = document.getElementById('myActiveStoryThumb');
    
    // A. CARGA RÁPIDA DE MEMORIA
    const cachedStory = JSON.parse(localStorage.getItem('bm_cached_story'));
    if(cachedStory) {
        const now = new Date().getTime();
        const diff = now - new Date(cachedStory.created_at).getTime();
        
        // Si la historia guardada tiene menos de 24h, la mostramos YA
        if(diff < 24 * 60 * 60 * 1000) {
            myActiveStoryUrl = cachedStory.url;
            storyCreatedAt = cachedStory.created_at;
            btnAdd.style.display = 'none';
            thumb.src = myActiveStoryUrl;
            thumb.style.display = 'block';
            btnContainer.setAttribute('onclick', 'abrirStoryManager()');
        }
    }

    // B. VERIFICACIÓN SILENCIOSA EN LA NUBE
    const fileName = `story_${MY_DEVICE_ID}.jpg`;
    const { data } = await supabase.storage.from('stories').list('', { search: fileName });

    if (data && data.length > 0) {
        const { data: publicData } = supabase.storage.from('stories').getPublicUrl(fileName);
        
        // CORRECCION CACHE: Agregamos ?t=tiempo para forzar descarga nueva
        const serverUrl = publicData.publicUrl + '?t=' + new Date().getTime();
        const serverDate = data[0].created_at || data[0].updated_at;
        
        // Guardamos en memoria para la próxima
        localStorage.setItem('bm_cached_story', JSON.stringify({ url: serverUrl, created_at: serverDate }));

        myActiveStoryUrl = serverUrl;
        storyCreatedAt = serverDate;
        
        btnAdd.style.display = 'none';
        thumb.src = myActiveStoryUrl;
        thumb.style.display = 'block';
        btnContainer.setAttribute('onclick', 'abrirStoryManager()');
    } else {
        // Si no hay en nube, limpiamos memoria
        localStorage.removeItem('bm_cached_story');
        myActiveStoryUrl = null;
        storyCreatedAt = null;
        thumb.style.display = 'none';
        btnAdd.style.display = 'flex';
        btnContainer.setAttribute('onclick', 'triggerStoryUpload()');
    }
}

// 2. SUBIR
function triggerStoryUpload() { 
    // FIX: Bloqueo de historia para usuarios sin cuenta
    if (!localStorage.getItem('barber_phone_real')) {
        showToast("Crea una cuenta primero", "👤", "REQUERIDO");
        return;
    }
    document.getElementById('inputStoryUpload').click(); 
}

async function handleStoryFile(input) {
    if (!input.files || !input.files[0]) return;
    showToast("Subiendo...", "⏳", "HISTORIA");
    try {
        const compressedBlob = await comprimirHistoria(input.files[0]);
        const fileName = `story_${MY_DEVICE_ID}.jpg`;
        
        // Subir
        const { error } = await supabase.storage.from('stories').upload(fileName, compressedBlob, { upsert: true, contentType: 'image/jpeg' });
        if (error) throw error;
        
        // Limpiar likes viejos
        await supabase.from('interacciones_stories').delete().eq('barber_id', MY_DEVICE_ID);
        
        // GUARDAR EN CACHÉ MANUALMENTE PARA VERLA YA
        const { data: publicData } = supabase.storage.from('stories').getPublicUrl(fileName);
        
        // CORRECCION CACHE: Agregamos ?t=tiempo para que se vea la nueva inmediatamente
        const newUrl = publicData.publicUrl + '?t=' + Date.now();
        const newDate = new Date().toISOString();
        
        localStorage.setItem('bm_cached_story', JSON.stringify({ url: newUrl, created_at: newDate }));
        
                // NUEVO: Avisar a los clientes que hay historia nueva
        // Actualizamos el nombre con el mismo valor para forzar el evento en tiempo real
        const miNombreActual = DB.settings.brand.text;
        await supabase.from('barberos').update({ nombre: miNombreActual }).eq('id', MY_DEVICE_ID);

        showToast("Publicada", "🔥", "ÉXITO");
        
        // Refrescar visualmente de inmediato
        setTimeout(checkMyStoryStatus, 500);


    } catch (err) {
        console.error(err); showToast("Error al subir", "❌", "ERROR");
    } finally { input.value = ''; }
}

// 3. GESTIÓN Y VISOR
async function abrirStoryManager() {
    if(!myActiveStoryUrl) return;
    
    const modal = document.getElementById('storyManagerModal');
    const img = document.getElementById('storyManagerImg');
    const sheet = document.getElementById('storyStatsSheet');
    
    img.src = myActiveStoryUrl;
    sheet.classList.remove('expanded'); // Empezar cerrado
    modal.style.display = 'flex';
    
    // INICIAR CONTADOR CUENTA ATRÁS
    iniciarContadorHistoria();

    // GESTOS TÁCTILES (SWIPE MEJORADO)
    const zone = document.getElementById('storyManagerTouchZone');
    
    zone.ontouchstart = (e) => { storyTouchStartY = e.touches[0].clientY; };
    
    zone.ontouchend = (e) => {
        const diff = storyTouchStartY - e.changedTouches[0].clientY;
        const sheetOpen = sheet.classList.contains('expanded');

        // Si el panel está abierto y toco la foto (click corto, no swipe), CERRAR PANEL
        if (sheetOpen && Math.abs(diff) < 10) {
            toggleStatsSheet(false);
            return;
        }

        // Swipe Arriba (>30px es más sensible) -> Abrir Panel
        if (diff > 30) { toggleStatsSheet(true); } 
        // Swipe Abajo (<-30px) -> Cerrar Todo
        else if (diff < -30) { cerrarStoryManager(); }
    };

    // GESTOS EN EL PANEL (Para cerrarlo bajando)
    sheet.ontouchstart = (e) => { 
        if(document.getElementById('storyStatsList').scrollTop <= 0) storyTouchStartY = e.touches[0].clientY; 
    };
    sheet.ontouchend = (e) => {
        const diff = storyTouchStartY - e.changedTouches[0].clientY;
        if (diff < -30 && document.getElementById('storyStatsList').scrollTop <= 0) { 
            toggleStatsSheet(false); // Cerrar Panel
        }
    };

    renderStoryStats();
}

function iniciarContadorHistoria() {
    if(!storyCreatedAt) return;
    const label = document.getElementById('storyTimeLeft');
    
    if(storyTimerInterval) clearInterval(storyTimerInterval);
    
    const updateTimer = () => {
        const created = new Date(storyCreatedAt).getTime();
        const expires = created + (24 * 60 * 60 * 1000); // +24 horas
        const now = new Date().getTime();
        const left = expires - now;

        if (left <= 0) {
            label.innerText = "Expirada";
            clearInterval(storyTimerInterval);
        } else {
            const h = Math.floor(left / (1000 * 60 * 60));
            const m = Math.floor((left % (1000 * 60 * 60)) / (1000 * 60));
            label.innerText = `Quedan ${h}h ${m}m`;
        }
    };
    
    updateTimer();
    storyTimerInterval = setInterval(updateTimer, 60000); // Actualizar cada minuto
}

// HORA 12H (AM/PM)
function formatTime12h(isoDate) {
    if(!isoDate) return '';
    const d = new Date(isoDate);
    let h = d.getHours();
    const m = String(d.getMinutes()).padStart(2, '0');
    const ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12;
    if (h === 0) h = 12;
    return `${h}:${m} ${ampm}`;
}

async function renderStoryStats() {
    const list = document.getElementById('storyStatsList');
    const countLabel = document.getElementById('storyViewsCount');
    list.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">Cargando...</div>';

    const { data } = await supabase.from('interacciones_stories')
        .select('*').eq('barber_id', MY_DEVICE_ID).order('created_at', { ascending: false });

    list.innerHTML = '';
    
    if(!data || data.length === 0) {
        countLabel.innerText = "0 Vistas";
        list.innerHTML = '<div style="text-align:center;padding:40px;color:#555;">Nadie la ha visto aún.</div>';
        return;
    }

    const grouped = {};
    let uniqueCount = 0;

    data.forEach(item => {
        const uid = item.cliente_id || 'anon';
        const timeStr = formatTime12h(item.created_at); // Hora formateada 12h

        if (!grouped[uid]) {
            grouped[uid] = { 
                name: item.cliente_nombre || 'Anónimo', 
                hasLike: false, 
                comment: null,
                time: timeStr // Guardamos la hora del evento más reciente
            };
            uniqueCount++;
        }
        if (item.tipo === 'like') grouped[uid].hasLike = true;
        if (item.tipo === 'comentario') grouped[uid].comment = item.contenido;
    });

    countLabel.innerText = `${uniqueCount} Personas`;

    Object.values(grouped).forEach(user => {
        const heartHtml = user.hasLike ? '<i class="fas fa-heart stat-heart"></i>' : '';
        const commentHtml = user.comment ? `<span style="color:#fff;">"${user.comment}"</span>` : '<span style="color:#666;font-style:italic;">Visto</span>';
        
        // Renderizado con Hora a la derecha del nombre
        list.innerHTML += `
            <div class="stat-item">
                <div class="stat-avatar">${user.name.charAt(0)}</div>
                <div class="stat-info">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div class="stat-name">${user.name}</div>
                        <div style="font-size:0.65rem;color:#666;font-weight:400;">${user.time}</div>
                    </div>
                    <div class="stat-action">${commentHtml}</div>
                </div>
                <div class="stat-icon-container">${heartHtml}</div>
            </div>
        `;
    });
}

function toggleStatsSheet(forceState) {
    const sheet = document.getElementById('storyStatsSheet');
    const arrow = document.getElementById('sheetArrow');
    
    if (typeof forceState === 'boolean') {
        if(forceState) sheet.classList.add('expanded');
        else sheet.classList.remove('expanded');
    } else {
        sheet.classList.toggle('expanded');
    }

    if(sheet.classList.contains('expanded')) arrow.style.transform = 'rotate(180deg)';
    else arrow.style.transform = 'rotate(0deg)';
}

function cerrarStoryManager() {
    if(storyTimerInterval) clearInterval(storyTimerInterval);
    const sheet = document.getElementById('storyStatsSheet');
    if(sheet.classList.contains('expanded')) {
        toggleStatsSheet(false);
    } else {
        document.getElementById('storyManagerModal').style.display = 'none';
    }
}

// BORRADO CORRECTO
function borrarMiHistoria() {
    showCustomAlert(
        'warning',
        '¿Borrar Historia?',
        'Desaparecerá inmediatamente.',
        async function() {
            showToast("Borrando...", "🗑️", "SISTEMA");
            cerrarStoryManager();
            
            const btnContainer = document.getElementById('storyBtnContainer');
            const btnAdd = document.getElementById('btnStoryAdd');
            const thumb = document.getElementById('myActiveStoryThumb');
            
            myActiveStoryUrl = null;
            thumb.style.display = 'none';
            btnAdd.style.display = 'flex';
            btnContainer.setAttribute('onclick', 'triggerStoryUpload()');

            const fileName = `story_${MY_DEVICE_ID}.jpg`;
            
            // 1. Borrar archivo físico
            await supabase.storage.from('stories').remove([fileName]);
            
            // 2. Borrar likes y comentarios
            await supabase.from('interacciones_stories').delete().eq('barber_id', MY_DEVICE_ID);
            
            // 3. NUEVO: "Despertar" a la App Clientes para que quite el aro
            // Hacemos un update invisible (actualizamos el nombre a lo que ya tiene) para disparar el radar
            const miNombreActual = DB.settings.brand.text;
            await supabase.from('barberos').update({ nombre: miNombreActual }).eq('id', MY_DEVICE_ID);
            
            showToast("Eliminada", "✅", "LISTO");
        },
        null
    );
}

// Click fuera (en el área oscura del header del panel) para cerrar panel
document.getElementById('storyStatsSheet').addEventListener('click', function(e) {
    // Si toco el encabezado (handle o header) y ya está abierto -> Cerrar (Toggle)
    if(e.target.classList.contains('sheet-header') || e.target.classList.contains('sheet-handle')) {
        toggleStatsSheet();
    }
});

function comprimirHistoria(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const maxH = 1280;
                let w = img.width; let h = img.height;
                if (h > maxH) { const s = maxH/h; w*=s; h=maxH; }
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                canvas.toBlob(resolve, 'image/jpeg', 0.6);
            };
        };
    });
}



// AUTO-INIT: Ejecutar chequeo al abrir modal perfil
// (Esto se conecta buscando la función openMyProfileModal existente)

function comprimirImagenCliente(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                // PRO: Aumentado a 500px para nitidez
                const maxWidth = 500;
                const scaleSize = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scaleSize;

                const ctx = canvas.getContext('2d');
                // Activar suavizado para que no se vea pixelada
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img,0,0,canvas.width,canvas.height);

                // Calidad al 60% (aprox 25-40kb)
                canvas.toBlob((blob) => {
                    resolve(blob);
                },'image/jpeg',0.6);
            }
        }
    });
}

function activarCandadoSeguridad(motivo) {
    localStorage.setItem('bm_lock_status','LOCKED');
    
    const lockScreen = document.getElementById('secureLockOverlay');
    document.getElementById('lockIDDisplay').innerText = MY_DEVICE_ID;
    lockScreen.style.display = 'flex';
    
    document.body.style.overflow = 'hidden';
    console.warn("🔒 SISTEMA BLOQUEADO:" + motivo);
}

function desbloquearSistema() {
    localStorage.removeItem('bm_lock_status');
    document.getElementById('secureLockOverlay').style.display = 'none';
    document.body.style.overflow = 'auto';
}

async function verificarIdentidad() {
    if (!supabase || !MY_DEVICE_ID) return;

    try {
        if(localStorage.getItem('bm_lock_status') === 'LOCKED') {
            activarCandadoSeguridad("Bloqueo persistente detectado");
        }

        const {data,error}= await supabase
            .from('barberos')
            // AHORA SÍ PEDIMOS TELEFONO Y CLAVE PARA PODER BLOQUEAR EL FORMULARIO
            .select('id,nombre,bloqueado,foto_url,disponible,horario,verificado,telefono,clave') 
            .eq('id',MY_DEVICE_ID)
            .maybeSingle();

        if (error) throw error;

        if (!data) {
            // SI EL SERVIDOR NO ME CONOCE -> AUTO-REGISTRO SILENCIOSO
            console.warn("⚠️ ID Nuevo detectado. Creando registro en servidor...");

            // --- INSPECTOR TÉCNICO V1 ---
            let modeloReal = "Web/Desconocido";
            let versionReal = "1.0";
            
            if(typeof Android !== 'undefined' && Android.obtenerDatosTecnicos) {
                try {
                    const techData = JSON.parse(Android.obtenerDatosTecnicos());
                    modeloReal = techData.modelo || modeloReal;
                    versionReal = techData.version || versionReal;
                } catch(e) {}
            }

            // 1. Crear el registro "fantasma" CON DATOS TÉCNICOS
            const { error: insertError } = await supabase.from('barberos').insert([{
                id: MY_DEVICE_ID,
                nombre: "Usuario Nuevo", 
                disponible: false,
                verificado: false,
                modelo_dispositivo: modeloReal,
                version_app: versionReal,
                ultima_conexion: new Date().toISOString()
            }]);

            if(!insertError) console.log("✅ ID registrado automáticamente en la nube");

            // 2. Limpiar credenciales locales (Por si quedaron residuos de otra cuenta)
            localStorage.removeItem('barber_phone_real');
            localStorage.removeItem('barber_password');
            localStorage.removeItem('barber_online_status');

            // 3. Resetear visualmente a "De Fábrica"
            DB.settings.brand.text = "";
            DB.settings.verified = false;
            
            // 4. Apagar Switch y limpiar UI
            actualizarBotonEstado(false, true); // Silencioso
            mostrarFotoEnUI(null);
            
            saveData();
            applyBrandSettings();

        } else {
            if (data.bloqueado) {
                activarCandadoSeguridad("Acceso denegado por servidor");
            } else {
                desbloquearSistema();
                mostrarFotoEnUI(data.foto_url);
                actualizarBotonEstado(data.disponible, true); // SILENCIOSO AL INICIAR

                // 1. RECUPERAR CREDENCIALES AL LOCALSTORAGE (CRUCIAL PARA BLOQUEO)
                if(data.telefono) localStorage.setItem('barber_phone_real', data.telefono);
                if(data.clave) localStorage.setItem('barber_password', data.clave);

                // RECUPERAR HORARIO Y PINTARLO (FIX)
                if(data.horario) {
                    DB.settings.schedule = data.horario;
                    // Forzamos el pintado inmediato de los botones verdes
                    actualizarGridPerfil(DB.settings.schedule);
                }
                
                // GUARDAR ESTADO DE VERIFICACIÓN
                DB.settings.verified = data.verificado || false;

                if (data.nombre && data.nombre.trim() !== "") {
                    DB.settings.brand.text = data.nombre;
                    saveData();
                    applyBrandSettings();
                }

                // --- ACTUALIZACIÓN SILENCIOSA DE HARDWARE (EXISTENTES) ---
                if(typeof Android !== 'undefined' && Android.obtenerDatosTecnicos) {
                    try {
                        const tData = JSON.parse(Android.obtenerDatosTecnicos());
                        // Enviamos el modelo y versión al servidor sin molestar al usuario
                        supabase.from('barberos').update({
                            modelo_dispositivo: tData.modelo,
                            version_app: tData.version,
                            ultima_conexion: new Date().toISOString()
                        }).eq('id', MY_DEVICE_ID).then(() => console.log("📱 Hardware registrado"));
                    } catch(e) {}
                }
                
                // RECUPERAR DATOS (Agenda y Finanzas)
                await descargarAgendaNube();
            }
        }
        
        // ARREGLO FINAL: Enviar el ID REAL al servicio Java
        if(typeof Android !== 'undefined' && Android.iniciarServicioNotificaciones) {
            console.log("Enviando ID real al servicio: " + MY_DEVICE_ID);
            Android.iniciarServicioNotificaciones(MY_DEVICE_ID);
        }
        
        iniciarRadarPerfil();

    } catch (e) {
        console.warn("Modo Offline o Error Servidor:",e);
    }
}

let radarMaestroInterval = null;

async function iniciarRadarMaestro() {
    if (!supabase || !MY_DEVICE_ID) return;

    // Limpieza agresiva previa para evitar duplicados
    if (window.canalMaestro) await supabase.removeChannel(window.canalMaestro);
    
    const channel = supabase.channel('radar-maestro-v7'); 
    window.canalMaestro = channel;

    channel
        .on('postgres_changes',{event:'INSERT',schema:'public',table:'mensajes'},payload => {
            const msg = payload.new;
            const myID = String(MY_DEVICE_ID).trim();
            const targetID = String(msg.destinatario_id).trim();

            if (targetID === myID || targetID === 'GLOBAL') {
                if(typeof Android !== 'undefined' && Android.mostrarNotificacionTurnos) {
                    Android.mostrarNotificacionTurnos("📩 Mensaje Del Admin",msg.texto);
                } else {
                    if(navigator.vibrate) navigator.vibrate([200,100,200]);
                }
            }
        })
        .on('postgres_changes',{event:'*',schema:'public',table:'app_versiones'},() => {
            console.log("📢 Nueva versión detectada");
            verificarActualizaciones();
        })
        .on('postgres_changes',{event:'INSERT',schema:'public',table:'turnos'},payload => {
            const sol = payload.new;
            if (String(sol.barbero_id) === String(MY_DEVICE_ID) && sol.estado === 'pendiente') {
                if(typeof Android !== 'undefined' && Android.mostrarNotificacionTurnos) {
                    Android.mostrarNotificacionTurnos("🔔 Nueva Solicitud","Cliente: " + sol.cliente);
                }
                actualizarConteoReal();
            }
        })
        .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'turnos' }, payload => {
            const idBorrado = payload.old.id;
            const existe = DB.appointments.some(a => a.id == idBorrado);
            if(existe) {
                DB.appointments = DB.appointments.filter(a => a.id != idBorrado);
                saveData();
                renderAgenda();
                if(navigator.vibrate) navigator.vibrate(5);
                console.log("🗑️ Turno eliminado remotamente");
            }
        })
        .on('postgres_changes',{event:'*',schema:'public',table:'sistema'},() => {
            console.log("⚙️ Cambio en sistema detectado");
            verificarEstadoGlobal();
        })
        .subscribe((status) => {
            console.log("Estado Radar Maestro:", status);
            if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
                console.warn("⚠️ Radar desconectado. Reiniciando en 5s...");
                setTimeout(iniciarRadarMaestro, 5000);
            }
        });
    
    verificarEstadoGlobal();
    
    // Intervalo de seguridad (Heartbeat) - Reemplaza los timeouts sueltos
    if(radarMaestroInterval) clearInterval(radarMaestroInterval);
    radarMaestroInterval = setInterval(() => {
        buscarSolicitudesPerdidas();
        // Si el canal no está unido (joined), forzar reinicio
        if (channel.state !== 'joined') {
            console.log("♻️ Heartbeat: Reiniciando Radar Maestro...");
            iniciarRadarMaestro();
        }
    }, 15000); // Revisar cada 15 segundos
}


async function buscarSolicitudesPerdidas() {
    if (!supabase || !MY_DEVICE_ID) return;
    
    const { data } = await supabase
        .from('turnos')
        .select('id')
        .eq('barbero_id', MY_DEVICE_ID)
        .eq('estado', 'pendiente');

    if (data && data.length > 0) {
        actualizarContadorRequests(data.length);
        if(document.getElementById('modalInbox').classList.contains('open')) {
            abrirBandejaSolicitudes();
        }
    }
}

async function loginConGoogle() {
    const {error}= await supabase.auth.signInWithOAuth({
        provider:'google',options:{redirectTo:window.location.href}
    });
    if (error) console.error(error.message);
}

let seleccionados = new Set();
let modoSeleccion = false;
let solicitudesCache = [];

async function actualizarConteoReal() {
    const {count,error}= await supabase
        .from('turnos')
        .select('*',{count:'exact',head:true})
        .eq('barbero_id',MY_DEVICE_ID)
        .eq('estado','pendiente');
    
    if(!error) actualizarContadorRequests(count);
}

function toggleSeleccion(id) {
    const card = document.getElementById(`req-${id}`);
    const actionDivs = card.querySelectorAll('.individual-actions');

    if(seleccionados.has(id)) {
        seleccionados.delete(id);
        card.classList.remove('selected');
        actionDivs.forEach(div => div.style.display = 'flex');
        if(seleccionados.size === 0) modoSeleccion = false;
    } else {
        seleccionados.add(id);
        card.classList.add('selected');
        actionDivs.forEach(div => div.style.display = 'none');
        modoSeleccion = true;
    }
    
    actualizarTextoSeleccion();
}

function actualizarTextoSeleccion() {
    const count = seleccionados.size;
    const txt = document.getElementById('selCountText');
    const btnTxt = document.getElementById('btnDelText');
    
    if(txt && btnTxt) {
        if(count > 0) {
            txt.innerText = `${count}Seleccionados`;
            txt.style.color = "#2ecc71";
            btnTxt.innerText = `Borrar (${count})`;
        } else {
            txt.innerText = "Mantén presionado para seleccionar";
            txt.style.color = "#aaa";
            btnTxt.innerText = "Borrar Todos";
        }
    }
}

function accionBorrarMasivo() {
    // CASO 1: Hay items seleccionados manualmente -> Borramos solo esos
    if(seleccionados.size > 0) {
        let ids = Array.from(seleccionados);
        (async () => {
            const {error} = await supabase.from('turnos').update({estado:'rechazado'}).in('id',ids);
            if(!error) {
                abrirBandejaSolicitudes();
                showToast("Selección eliminada", "🗑️", "LISTO");
            }
        })();
        return;
    }

    // CASO 2: No hay selección -> ES "BORRAR TODOS" (Visibles y Ocultos)
    if(!solicitudesCache || solicitudesCache.length === 0) return;

    showCustomAlert('warning', '¿Vaciar Bandeja?', 'Se rechazarán TODAS las solicitudes pendientes (incluyendo las antiguas).', async () => {
        const {error} = await supabase
            .from('turnos')
            .update({estado:'rechazado'})
            .eq('barbero_id', MY_DEVICE_ID)
            .eq('estado', 'pendiente'); // ESTO BORRA TODO LO PENDIENTE DE LA NUBE

        if(!error) {
            abrirBandejaSolicitudes();
            actualizarContadorRequests(0);
            showToast("Bandeja totalmente limpia", "✨", "LIMPIEZA");
        }
    }, null);
}

function actualizarContadorRequests(num) {
    const fab = document.getElementById('fabRequests');
    const badge = document.getElementById('reqCounterBadge');
    if(num > 0) {
        fab.style.display = 'flex';badge.innerText = num;
        fab.style.animation = 'none';setTimeout(() => fab.style.animation = 'bounceIn 0.5s',10);
    } else {fab.style.display = 'none';}
}

// Variables Globales Dinámicas (CON MEMORIA ANTI-PARPADEO)
let PRECIO_ACTUAL_SISTEMA = localStorage.getItem('sys_cache_precio') || "250";
let TARJETA_ACTUAL_SISTEMA = localStorage.getItem('sys_cache_tarjeta') || "9204 0699 9752 4327";
let TELEFONO_ADMIN_ACTUAL = localStorage.getItem('sys_cache_admin') || "5351881471";
let TELEFONO_CONFIRM_ACTUAL = localStorage.getItem('sys_cache_confirm') || "5351881471";

// Ejecución Inmediata: Pintar lo que recordamos ANTES de conectar a internet
(function pintarDatosCacheados() {
    // 1. CHEQUEO DE BLOQUEO GLOBAL OFFLINE (Seguridad Persistente)
    if (localStorage.getItem('sys_global_lock') === 'true') {
        const lockScreen = document.getElementById('globalSystemLock');
        const msgEl = document.getElementById('globalLockMessage');
        const savedMsg = localStorage.getItem('sys_global_msg') || "Acceso restringido.";
        
        if(msgEl) msgEl.innerHTML = savedMsg;
        if(lockScreen) lockScreen.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    setTimeout(() => {
        const uiP = document.getElementById('uiPrecioSuscripcion');
        const uiC = document.getElementById('cardNumberDisplay');
        const uiT = document.getElementById('confirmNumberDisplay');
        if(uiP) uiP.innerText = PRECIO_ACTUAL_SISTEMA + " CUP / Mes";
        if(uiC) uiC.innerText = TARJETA_ACTUAL_SISTEMA;
        if(uiT) uiT.innerText = TELEFONO_CONFIRM_ACTUAL;
    }, 50); // 50ms para asegurar que el HTML existe
})();

async function verificarEstadoGlobal(esManual = false) {
    const btn = document.querySelector('#globalSystemLock button');
    const originalText = '<i class="fas fa-sync-alt"></i> RECARGAR SISTEMA';

    if(esManual && btn) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> VERIFICANDO...';
        btn.disabled = true;
    }

    // Descargamos TODA la configuración (Precio, Tarjeta, Teléfonos)
    const {data,error}= await supabase.from('sistema').select('*').eq('id','config').maybeSingle();
    
    const lockScreen = document.getElementById('globalSystemLock');
    const msgEl = document.getElementById('globalLockMessage');

    if (error) {
        if(esManual && btn) {
            btn.style.background = "#e74c3c";
            btn.innerHTML = '<i class="fas fa-wifi"></i> SIN CONEXIÓN';
            vibratePhone(500);
            setTimeout(() => {
                btn.style.background = "#3498db";
                btn.innerHTML = originalText;
                btn.disabled = false;
            },2000);
        }
        return;
    }

    if (data) {
        // 1. ACTUALIZAR VARIABLES DINÁMICAS Y GUARDAR EN MEMORIA
        if (data.precio_mensual) {
            PRECIO_ACTUAL_SISTEMA = data.precio_mensual;
            localStorage.setItem('sys_cache_precio', PRECIO_ACTUAL_SISTEMA); // Guardar
            const uiPrecio = document.getElementById('uiPrecioSuscripcion');
            if(uiPrecio) uiPrecio.innerText = `${PRECIO_ACTUAL_SISTEMA} CUP / Mes`;
        }
        
        if (data.tarjeta_pago) {
            TARJETA_ACTUAL_SISTEMA = data.tarjeta_pago;
            localStorage.setItem('sys_cache_tarjeta', TARJETA_ACTUAL_SISTEMA); // Guardar
            const uiCard = document.getElementById('cardNumberDisplay');
            if(uiCard) uiCard.innerText = TARJETA_ACTUAL_SISTEMA;
        }

        if (data.telefono_confirmacion) {
            TELEFONO_CONFIRM_ACTUAL = data.telefono_confirmacion;
            localStorage.setItem('sys_cache_confirm', TELEFONO_CONFIRM_ACTUAL); // Guardar
            const uiConf = document.getElementById('confirmNumberDisplay');
            if(uiConf) uiConf.innerText = TELEFONO_CONFIRM_ACTUAL;
        }

        if (data.telefono_admin) {
            TELEFONO_ADMIN_ACTUAL = data.telefono_admin;
            localStorage.setItem('sys_cache_admin', TELEFONO_ADMIN_ACTUAL); // Guardar
        }

        // 2. SEGURIDAD ESTRICTA
        DB.settings.strictMode = (data.verificacion_estricta !== false);
        saveData();

        // 3. BLOQUEO GLOBAL (Persistente Offline)
        if (data.bloqueo_global) {
            let textoOriginal = data.mensaje_bloqueo || "Acceso restringido.";
            
            // MARCA DE FUEGO: Guardar estado para que funcione sin internet
            localStorage.setItem('sys_global_lock', 'true');
            localStorage.setItem('sys_global_msg', textoOriginal);

            const textoConLinks = textoOriginal.replace(
                /((http|https):\/\/[^\s]+)/gi,
                '<a href="$1" target="_blank" rel="noopener noreferrer" style="color:#3498db;text-decoration:underline;font-weight:bold;">$1</a>'
            );

            if(msgEl) msgEl.innerHTML = textoConLinks;
            if(lockScreen) lockScreen.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            if(esManual && btn) {
                btn.innerHTML = '<i class="fas fa-lock"></i> AÚN BLOQUEADO';
                setTimeout(() => {btn.innerHTML = originalText;btn.disabled = false;},2000);
            }
        } else {
            // LIBERAR: Borrar la marca de fuego
            localStorage.removeItem('sys_global_lock');
            localStorage.removeItem('sys_global_msg');

            if(lockScreen) lockScreen.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
}
async function iniciarRadarPerfil() {
    if (!supabase || !MY_DEVICE_ID) return;

    if (window.canalPerfil) await supabase.removeChannel(window.canalPerfil);

    const channel = supabase.channel('radar-perfil-v8'); 
    window.canalPerfil = channel;

    console.log("📡 Radar Perfil activado para:", MY_DEVICE_ID);

    channel
        .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'barberos',
            filter: `id=eq.${MY_DEVICE_ID}`
        }, (payload) => {
            const data = payload.new;

            if (data.bloqueado) {
                activarCandadoSeguridad("Bloqueo en tiempo real por Admin");
                if (navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
            } else if (!data.bloqueado && localStorage.getItem('bm_lock_status') === 'LOCKED') {
                desbloquearSistema();
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }

            if (data.nombre) {
                DB.settings.brand.text = data.nombre;
                saveData();
                applyBrandSettings();
                const inputName = document.getElementById('editProfileName');
                if (inputName) inputName.value = data.nombre;
            }

            if (data.telefono) {
                localStorage.setItem('barber_phone_real', data.telefono);
                const displayPhone = document.getElementById('displayBrandPhone');
                if (displayPhone) displayPhone.innerText = data.telefono;
                const inputPhone = document.getElementById('editProfilePhone');
                if (inputPhone) inputPhone.value = data.telefono;
            }

            if (data.clave) {
                const passActual = localStorage.getItem('barber_password');
                if (passActual !== data.clave) {
                    localStorage.setItem('barber_password', data.clave);
                    const inputPass = document.getElementById('editProfilePassword');
                    if (inputPass) inputPass.value = data.clave;
                    if (!window.isSelfUpdate) {
                        showToast("Contraseña actualizada por Admin", "🔑", "SEGURIDAD");
                    }
                }
            }

            if (data.foto_url !== undefined) {
                if (data.foto_url) {
                    localStorage.setItem('bm_cached_profile_pic', data.foto_url);
                    mostrarFotoEnUI(data.foto_url);
                } else {
                    localStorage.removeItem('bm_cached_profile_pic');
                    mostrarFotoEnUI(null);
                }
            }

            if (data.verificado === true && DB.settings.verified === false) {
                DB.settings.verified = true;
                saveData();
                showToast("¡Tu cuenta ha sido aprobada!", "🎉", "ESTÁS DENTRO");
                fireConfetti();
                if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 500]);
                document.getElementById('toggleOnlineSwitch').checked = true;
                alternarDisponibilidadPro(true);
                if (document.getElementById('statusTextBadge')) document.getElementById('statusTextBadge').innerText = "✅ APROBADO Y ONLINE";
            }

            if (data.verificado === false && DB.settings.verified === true) {
                DB.settings.verified = false;
                saveData();
                alternarDisponibilidadPro(false);
                showToast("Verificación revocada.", "👮‍♂️", "ALERTA");
            }
        })
        // DETECCIÓN INTELIGENTE DE NUEVA SESIÓN
        .on('postgres_changes', {
            event: 'DELETE',
            schema: 'public',
            table: 'barberos',
            filter: `id=eq.${MY_DEVICE_ID}`
        }, async () => {
            console.warn("⚠️ PERFIL DESVINCULADO LOCALMENTE");
            
            // 1. ANTES DE BORRAR: Preguntamos quién tiene mi número ahora
            const miTelefono = localStorage.getItem('barber_phone_real');
            let tituloSalida = "CUENTA ELIMINADA";
            let mensajeSalida = "Tu perfil ha sido eliminado por el Administrador.";
            
            if (miTelefono) {
                // Consulta rápida a Supabase
                const { data } = await supabase
                    .from('barberos')
                    .select('modelo_dispositivo')
                    .eq('telefono', miTelefono)
                    .maybeSingle();
                
                // Si encontramos datos, es que NO fui borrado, sino movido
                if (data && data.modelo_dispositivo) {
                    tituloSalida = "SESIÓN CERRADA";
                    mensajeSalida = `Tu cuenta se abrió en otro dispositivo:<br><b style="color:#f1c40f;font-size:1.1rem;">${data.modelo_dispositivo}</b>`;
                }
            }

            // 2. BORRADO LOCAL (Reseteo de Fábrica)
            DB.appointments = [];
            DB.clients = {};
            DB.extras = [];
            DB.trash = [];
            DB.qrs = [];
            DB.settings = {
                goal: 80000,
                theme: 'matrix',
                showGoal: true,
                brand: { text: "Barbería", color: "#ffffff", font: "font-modern", enabled: true }
            };
            localStorage.removeItem('barber_phone_real');
            localStorage.removeItem('barber_password');
            localStorage.removeItem('barber_online_status');
            saveData();
            applyBrandSettings();

            // 3. AVISO BLOQUEANTE (Para que el usuario lea qué pasó)
            if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]);
            
            showCustomAlert('warning', tituloSalida, mensajeSalida, () => {
                location.reload();
            }, null);
            
            // Si no toca nada, recarga forzosa en 8 segundos
            setTimeout(() => { location.reload(); }, 8000);
        })
        .subscribe((status) => {
            if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
                console.warn("⚠️ Radar Perfil caído. Reiniciando en 5s...");
                setTimeout(iniciarRadarPerfil, 5000);
            }
        });
}

let recoveryRetryCount = 0;

function agregarAColaPendientes(turno) {
    if (!DB.cola_pendientes) DB.cola_pendientes = [];
    
    const yaEsta = DB.cola_pendientes.some(t => t.fecha === turno.fecha && t.hora === turno.hora);
    if(!yaEsta) {
        DB.cola_pendientes.push(turno);
        saveData(); 
        console.log("Turno agregado a la cola de pendientes");
    }
}

async function intentarSincronizar() {
    if (!DB.cola_pendientes || DB.cola_pendientes.length === 0) return;
    if (!navigator.onLine || typeof supabase === 'undefined') return;

    console.log(`🔄 Sincronizando ${DB.cola_pendientes.length} turnos...`);

    const fallidos = [];

    for (const turno of DB.cola_pendientes) {
        const { error } = await supabase.from('turnos').insert([turno]);
        
        if (error) {
            console.error("Error sync:", error);
            fallidos.push(turno); 
        }
    }

    DB.cola_pendientes = fallidos;
    saveData();
}

async function descargarAgendaNube() {
    if (typeof supabase === 'undefined' || !MY_DEVICE_ID) return;
    
    // 1. DESCARGAR TURNOS
    const { data: turnos } = await supabase
        .from('turnos')
        .select('*')
        .eq('barbero_id', MY_DEVICE_ID)
        .or('estado.eq.aceptado,estado.eq.confirmado');

    if (turnos && turnos.length > 0) {
        turnos.forEach(t => {
            // ANTI-DUPLICADOS PRO: Buscar por ID o por HORA (Fusión)
            const idxID = DB.appointments.findIndex(a => a.id === t.id);
            const idxHora = DB.appointments.findIndex(a => a.date === t.fecha && a.time === t.hora);

            if (idxID !== -1) {
                // Ya tenemos el ID oficial, no hacer nada
            } 
            else if (idxHora !== -1) {
                // Encontramos turno manual a la misma hora: FUSIONAR
                DB.appointments[idxHora].id = t.id; // Actualizar ID local al de la nube
                DB.appointments[idxHora].name = t.cliente; 
                if(t.telefono) DB.appointments[idxHora].phone = t.telefono;
                console.log("Fusionado turno manual con servidor:", t.id);
            } 
            else {
                // No existe ni por ID ni por Hora: Agregar Nuevo
                DB.appointments.push({
                    id: t.id,
                    name: t.cliente,
                    phone: t.telefono,
                    date: t.fecha,
                    time: t.hora,
                    price: t.precio || "0"
                });
                
                if (!DB.clients[t.cliente]) {
                    DB.clients[t.cliente] = { visits:1, phone:t.telefono, lastDate:t.fecha, tag: checkAutoTag(t.telefono) };
                }
            }
        });
    }

    // 2. DESCARGAR FINANZAS (EXTRAS)
    const { data: extras } = await supabase
        .from('ingresos_extra')
        .select('*')
        .eq('barbero_id', MY_DEVICE_ID);

    if (extras && extras.length > 0) {
        extras.forEach(e => {
            const existe = DB.extras.some(x => x.id === e.id);
            if (!existe) {
                DB.extras.push({
                    id: e.id,
                    type: 'manual',
                    reason: e.razon,
                    price: e.precio,
                    date: e.fecha,
                    time: e.hora
                });
            }
        });
    }

    saveData();
    renderAgenda();
    renderClients();
    
    if(document.getElementById('modalFinance').classList.contains('open')) {
        renderFinance(currentFinanceMode, null, false);
    }
    
    // Actualizar notificaciones con los nuevos IDs fusionados
    programarAlarmas();
}

function reactivarConexiones() {
    console.log("♻️ Reactivando sistemas en tiempo real...");
    intentarSincronizar();
    verificarActualizaciones();
    verificarIdentidad(); 
    verificarSuscripcion(); 
    verificarEstadoGlobal();
    
    // Reiniciar ambos radares con fuerza para despertar la conexión
    iniciarRadarMaestro();
    iniciarRadarPerfil();
}

window.addEventListener('online', reactivarConexiones);

document.addEventListener("visibilitychange", () => {
    if (!document.hidden && navigator.onLine) {
        // Al volver a ver la app (salir de pausa), forzamos la reconexión
        reactivarConexiones();
    }
});

// FIX: Bucle de seguridad para insistir en actualizaciones (Cada 60s)
setInterval(() => {
    if(navigator.onLine) verificarActualizaciones();
}, 60000);

setTimeout(intentarSincronizar, 3000);

async function recuperarPorPassword() {
    const phone = document.getElementById('editProfilePhone').value.trim();
    const pass = document.getElementById('editProfilePassword').value.trim();

    if (!phone || !pass) {
        showToast("Faltan datos", "✏️", "ERROR");
        return;
    }

    const btn = document.getElementById('btnAuthAction');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> VINCULANDO...';
    btn.disabled = true;

    let idFisico = localStorage.getItem('backup_original_id') || localStorage.getItem('bm_secure_id_v1');
    
    if(!idFisico) {
        idFisico = 'barber_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
        localStorage.setItem('backup_original_id', idFisico);
    }

    try {
        // 1. CAPTURAR MODELO DEL CELULAR
        let modeloReal = "Android Nuevo";
        let versionReal = "1.0";
        if(typeof Android !== 'undefined' && Android.obtenerDatosTecnicos) {
            try {
                const techData = JSON.parse(Android.obtenerDatosTecnicos());
                modeloReal = techData.modelo || modeloReal;
                versionReal = techData.version || versionReal;
            } catch(e) {}
        }

        // 2. EJECUTAR MIGRACIÓN EN SERVIDOR
        const { data, error } = await supabase.rpc('vincular_dispositivo_fisico_barbero', {
            p_telefono: normalizarTelefono(phone),
            p_clave: pass,
            p_nuevo_id_fisico: idFisico
        });

        if (error) throw error;

        if (data.success) {
            const perfil = data.data;
            if(navigator.vibrate) navigator.vibrate([100,50,100]);
            
            MY_DEVICE_ID = perfil.id;
            localStorage.setItem('bm_secure_id_v1', perfil.id);
            localStorage.setItem('barber_phone_real', perfil.telefono);
            localStorage.setItem('barber_password', perfil.clave);
            
            if(perfil.nombre) DB.settings.brand.text = perfil.nombre;
            if(perfil.horario) DB.settings.schedule = perfil.horario;
            DB.settings.verified = perfil.verificado;
            
            // 3. ¡CRUCIAL! REGISTRAR EL MODELO EN LA NUBE YA MISMO
            // Así el teléfono viejo sabrá quién lo sacó
            await supabase.from('barberos').update({
                modelo_dispositivo: modeloReal,
                version_app: versionReal,
                ultima_conexion: new Date().toISOString()
            }).eq('id', MY_DEVICE_ID);

            await descargarDatosNube();
            saveData();

            showToast("Cuenta Restaurada", "☁️", "EXITO");
            setTimeout(() => location.reload(), 2000);

        } else {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
            showToast(data.msg || "Datos incorrectos", "❌", "ERROR");
            if(navigator.vibrate) navigator.vibrate(500);
        }

    } catch (e) {
        console.error(e);
        btn.innerHTML = originalHTML;
        btn.disabled = false;
        showToast("Error de conexión", "⚠️", "ERROR");
    }
}

if(localStorage.getItem('bm_lock_status') === 'LOCKED') {
    activarCandadoSeguridad("Inicio Offline Bloqueado");
}

setTimeout(() => {
    verificarIdentidad();
    iniciarRadarMaestro();
}, 1000);


// --- MOTOR DE TUTORIAL GUIADO ---

let currentStepIndex = -1;
let backupAppointments = [];
let tutorialActive = false;
let isTutorialLocked = false;

const TUTORIAL_STEPS = [
    // FASE 1: SIMULACIÓN
    {
        title: "BIENVENIDO",
        desc: "Vamos a enseñarte a manejar tu negocio como un PRO. Mira tu agenda simulada.",
        target: null,
        action: 'info',
        onStart: () => {
            backupAppointments = [...DB.appointments];
            
            // 1. Inyectamos clientes para que existan al deslizar
            DB.clients["Cliente Rojo"] = {visits: 1, phone: "55555555", tag: "vip"};
            DB.clients["Juan Pérez"] = {visits: 5, phone: "55555555", tag: "good"};
            DB.clients["María Style"] = {visits: 10, phone: "55555555", tag: "alert"};

            // 2. Calculamos horas dinámicas basadas en TU hora actual para que no se borren
            const now = new Date();
            const h1 = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
            
            const d2 = new Date(now.getTime() + 60*60000); // +1 hora
            const h2 = String(d2.getHours()).padStart(2,'0') + ":" + String(d2.getMinutes()).padStart(2,'0');

            const d3 = new Date(now.getTime() + 120*60000); // +2 horas
            const h3 = String(d3.getHours()).padStart(2,'0') + ":" + String(d3.getMinutes()).padStart(2,'0');

            DB.appointments = [
                {id: 9991, name: "Cliente Rojo", phone: "55555555", date: getLocalISOString(), time: h1, price: "500"},
                {id: 9992, name: "Juan Pérez", phone: "55555555", date: getLocalISOString(), time: h2, price: "800"},
                {id: 9993, name: "María Style", phone: "55555555", date: getLocalISOString(), time: h3, price: "1200"}
            ];
            renderAgenda();
        }
    },
   {
        title: "NOTIFICACIONES",
        desc: "30 minutos antes de cada turno, recibirás una notificación automática.",
        target: "#reqCounterBadge", // Referencia visual arriba
        action: 'info'
    },
    {
        title: "CAJA CERRADA",
        desc: "El dinero NO cuenta en caja hasta que llegue la hora exacta del turno.",
        target: ".card-transparent", // Caja
        action: 'info'
    },
    {
        title: "TURNO EN CURSO",
        desc: "Cuando empieza el turno se pone ROJO. Si usas los botones, puedes llamar o chatear.",
        target: ".appt-item:first-child",
        action: 'info',
        onStart: () => {
             // Forzar estilo rojo en el primero
             const items = document.querySelectorAll('.appt-item');
             if(items[0]) items[0].classList.add('appt-started');
        }
    },
    {
        title: "DESLIZA AHORA",
        desc: "Desliza este turno a la DERECHA ➡️ para abrir el Perfil del Cliente.",
        target: ".appt-item:first-child",
        action: 'swipe-right',
        lockTarget: true
    },
    {
        title: "ESTUDIO FOTOGRÁFICO",
        desc: "Esta sección es para crear tus fotos de ANTES y DESPUÉS para marketing.",
        target: ".p-tab:nth-child(2)", 
        action: 'info',
        onStart: () => switchTab('studio') // Forzamos la vista de fotos
    },
    {
        title: "SUBIR TRABAJOS",
        desc: "Aquí eliges las fotos de la galería o cámara y pulsas 'Generar Estética' para crear el collage.",
        target: "#tab-studio .photo-grid",
        action: 'info'
    },
    {
        title: "HISTORIAL",
        desc: "En este botón puedes ver todas las veces que el cliente te ha visitado y cuánto ha gastado.",
        target: ".p-tab:nth-child(1)", // Botón Historial
        action: 'info'
    },
    {
        title: "FOTO RÁPIDA",
        desc: "Usa este botón para tirar una foto flash sin marca de agua, directo al expediente del cliente.",
        target: ".p-tab:nth-child(3)", // Botón Rápida
        action: 'info',
        onEnd: () => closeModal() 
    },
    // FASE 2: FLUJO DE ACCIONES
    {
        title: "QR DE COBRO",
        desc: "Toca el título 'Agenda' para mostrar tus QR de pago rápido.",
        target: "#agendaTitle",
        action: 'info'
    },
    {
        title: "HISTORIAL Y PERIODOS",
        desc: "Aquí alternas entre vista Global, Mensual y Semanal para controlar tus ganancias.",
        target: ".finance-tabs", // Marca toda la fila de botones
        action: 'info',
        onStart: () => openFinanceModal() // Abrimos la ventana al empezar
    },
    {
        title: "INGRESOS EXTRA",
        desc: "Usa el botón (+) para sumar propinas o ventas de productos manualmente.",
        target: "button[onclick='openManualEntryModal()']", // Marca el botón + exacto
        action: 'info',
        onEnd: () => closeModal() // Cerramos al terminar esta sección
    },
    {
        title: "META MENSUAL",
        desc: "Tu progreso mensual. Puedes editar el monto objetivo en Ajustes.",
        target: "#monthlyGoalContainer",
        action: 'info'
    },
    {
        title: "CONTROLES",
        desc: "Filtra tus turnos o viaja al futuro (Mañana) con un toque.",
        target: "#btnToggleAll",
        action: 'info'
    },
    {
        title: "COMUNICACIÓN",
        desc: "Botones directos: Llamada, SMS y WhatsApp sin guardar contacto.",
        target: ".appt-item:first-child .client-actions",
        action: 'info'
    },
    {
        title: "LÓGICA DE CAJA",
        desc: "¡Atención! Solo cuando el turno se pone ROJO (Hora actual), el dinero entra al total.",
        target: "#dailyTotal",
        action: 'info'
    },
           {
        title: "TURNO RÁPIDO",
        desc: "Usa la PLUMA para agendar a la velocidad de la luz.",
        target: "#quickFab",
        action: 'custom', 
        lockTarget: false, 
        onStart: () => {
             const btn = document.querySelector('#quickFab');
             const hand = document.getElementById('tutHand');
             const overlay = document.getElementById('gameOverlay');
             const spotlight = document.getElementById('tutSpotlight');
             const tooltip = document.getElementById('tutTooltip');

             spotlight.style.display = 'none';
             overlay.style.pointerEvents = 'none'; 

             btn.classList.add('fab-super-lock');
             
             const rect = btn.getBoundingClientRect();
             
             // Mano Dorada
             hand.style.display = 'block';
             hand.className = 'fas fa-hand-point-up tut-hand heavy-tap'; 
             hand.style.top = (rect.top + 65) + 'px'; 
             hand.style.left = (rect.left + 15) + 'px';
             
             // FIX: Mostrar manualmente el cartel (Tooltip)
             tooltip.style.opacity = '1';
             tooltip.style.top = (rect.top - 250) + 'px'; // Lo subimos para que no tape el botón
             tooltip.style.left = '50%';
             tooltip.style.transform = 'translateX(-50%)';

             const next = (e) => { 
                 btn.classList.remove('fab-super-lock');
                 overlay.style.pointerEvents = 'auto'; 
                 btn.removeEventListener('click', next);
                 setTimeout(advanceTutorial, 500); 
             };
             btn.addEventListener('click', next, {once:true});
        }
    },


    {
        title: "1. SELECCIONAR",
        desc: "Toca el primer contacto de la lista para seleccionarlo.",
        target: "#virtualQuickBox .virtual-item:first-child",
        pos: 'top',
        action: 'info'
    },
    {
        title: "2. PARA MAÑANA",
        desc: "Toca este botón para agendar el turno para el Siguiente Día.",
        target: "div[onclick='setQuickTomorrow()']",
        action: 'info'
    },
    {
        title: "3. HORA MANUAL",
        desc: "Toca aquí por si quieres escoger una hora manual específica.",
        target: "#btnManualTime",
        action: 'info'
    },
    {
        title: "4. PRECIO",
        desc: "Toca aquí si quieres cambiar el precio del servicio.",
        target: "#priceContainer",
        action: 'info'
    },
    {
        title: "5. CONFIRMAR",
        desc: "Aquí aparecerá el botón para CONFIRMAR el turno.",
        target: "#btnQuickConfirm",
        action: 'info',
        onStart: () => document.getElementById('btnQuickConfirm').style.display = 'block'
    },
        {
        title: "¡AGENDADO!",
        desc: "El turno se agenda aquí correctamente. Ahora vamos a la sección de Clientes.",
        target: ".appt-item:first-child",
        action: 'info',
        onStart: () => closeQuickMode()
    },
    {
        title: "SECCIÓN CLIENTES",
        desc: "Aquí gestionas tu base de datos. Toca el botón para entrar.",
        target: ".nav-btn:nth-child(2)",
        action: 'click',
        lockTarget: true
    },
    {
        title: "PERFIL & HISTORIAL",
        desc: "Toca cualquier cliente para ver su historial, igual que vimos antes.",
        target: ".client-item:first-child",
        action: 'info'
    },
    {
        title: "GALERÍA DE TRABAJOS",
        desc: "Este botón abre tu portafolio de fotos (Antes y Después).",
        target: ".btn-search-action",
        action: 'info'
    },
    {
        title: "AUTO-LIMPIEZA",
        desc: "Las fotos aquí se borran solas a los 30 días o se reemplazan si el cliente vuelve.",
        target: "#galleryList",
        action: 'info',
        onStart: () => openGalleryModal()
    },
    {
        title: "IR A AJUSTES",
        desc: "Toca el botón de la barra inferior para entrar a la configuración.",
        target: ".nav-btn:nth-child(5)",
        action: 'click', // Detecta el click real
        lockTarget: true, // Bloquea todo menos el botón
        onStart: () => { closeModal(); } // NO navega solo, espera tu toque
    },
    {
        title: "MIS SERVICIOS",
        desc: "Define tu lista de precios y cortes aquí. Toca para editar.",
        target: "div[onclick='abrirGestorServicios()']",
        action: 'info',
        onStart: () => {
            // Forzamos scroll arriba para que se vea el primer botón
            const body = document.querySelector('#view-ajustes .content-body');
            if(body) body.scrollTop = 0;
        }
    },
    {
        title: "PAPELERA",
        desc: "Recupera elementos borrados (Turnos, Clientes) en las últimas 24h.",
        target: "div[onclick='openTrashModal()']",
        action: 'info'
    },
    {
        title: "MARCA & EDITOR",
        desc: "Escribe aquí el nombre de tu negocio para el recibo.",
        target: "#brandTextInput", // Apunta al input exacto (más centrado)
        action: 'info'
    },
        {
        title: "META MENSUAL",
        desc: "Escribe tu objetivo de dinero mensual aquí.",
        target: "#inputGoalAmount",
        action: 'info',
        onStart: () => {
            // Forzamos que la pantalla baje y centre este elemento
            const el = document.getElementById('inputGoalAmount');
            if(el) el.scrollIntoView({behavior: "auto", block: "center"});
        }
    },
    {
        title: "APARIENCIA",
        desc: "Toca este botón para cambiar los temas visuales (Matrix, Oro...).",
        target: "button[onclick='toggleThemePanel()']",
        action: 'info',
        onStart: () => {
            // Forzamos centrado nuevamente para asegurar que se ve bien
            const el = document.querySelector("button[onclick='toggleThemePanel()']");
            if(el) el.scrollIntoView({behavior: "auto", block: "center"});
        }
    },

    {
        title: "DATOS LOCALES",
        desc: "¡Vital! Usa este botón para guardar copia de tus datos.",
        target: "button[onclick='descargarBackup()']",
        action: 'info'
    },
        {
        title: "EL PERFIL",
        desc: "Y por último, lo más importante. Toca tu FOTO para gestionar tu Perfil Online.",
        target: ".profile-header-wrapper",
        action: 'custom',
        lockTarget: true,
        onStart: () => {
            navTo('agenda');
            setTimeout(() => {
                const tt = document.getElementById('tutTooltip');
                const hand = document.getElementById('tutHand');
                const spotlight = document.getElementById('tutSpotlight');
                
                if(tt) {
                    tt.classList.add('tut-special-entry');
                    tt.innerHTML = '<h4 style="color:#f1c40f;font-size:1.8rem;text-shadow:0 0 10px #f1c40f;">✨ EL GRAN FINAL</h4><p style="font-size:1.1rem;">Toca tu <b>FOTO</b> arriba para activarte.</p>';
                }
                
                const target = document.querySelector('.profile-header-wrapper');
                const rect = target.getBoundingClientRect();
                
                hand.style.display = 'block';
                hand.className = 'fas fa-location-arrow tut-hand tut-arrow-anim'; 
                hand.style.fontSize = '2.5rem'; 
                
                hand.style.top = (rect.top + 25) + 'px'; 
                hand.style.left = (rect.left + 25) + 'px';
                
                spotlight.style.cssText = `
                    width: ${rect.width}px; height: ${rect.height}px;
                    top: ${rect.top}px; left: ${rect.left}px;
                    display: block; opacity: 0; position: absolute;
                    pointer-events: auto; z-index: 26000; cursor: pointer; border-radius: 50%;
                `;
                
                lockScreenForElement(target, 'custom');
                
                spotlight.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    openMyProfileModal();
                    
                    tt.classList.remove('tut-special-entry');
                    hand.style.display = 'none';
                    hand.className = 'fas fa-hand-pointer tut-hand'; 
                    hand.style.fontSize = ''; 
                    
                    tt.innerHTML = '<h4 id="tutTitle"></h4><p id="tutDesc"></p><div id="tutHint" class="tap-hint"><i class="fas fa-fingerprint"></i> Toca para continuar</div>';
                    
                    setTimeout(advanceTutorial, 600);
                };
            }, 150);
        }
    },
    {
        title: "TU FOTO PÚBLICA",
        desc: "Aquí escoges la foto que verán tus clientes en su App.",
        target: ".profile-avatar-container",
        action: 'info',
        onStart: () => {
             const card = document.querySelector('#modalMyProfile .modal-card');
             if(card) card.scrollTop = 0;
        }
    },
    {
        title: "TU ID ÚNICO",
        desc: "Este es tu identificador exclusivo en el sistema.",
        target: ".profile-id-row",
        action: 'info'
    },
    {
        title: "VISIBILIDAD",
        desc: "Este botón controla si apareces disponible o no para el mundo.",
        target: ".profile-status-toggle-card",
        action: 'info'
    },
    {
        title: "HORARIO LABORAL",
        desc: "Aquí escoges qué días y horas trabajas. Tus clientes solo podrán reservar en estos huecos.",
        target: "#availabilityGrid", 
        action: 'info',
        onStart: () => {
            document.getElementById('availabilityGrid').scrollIntoView({behavior: "smooth", block: "center"});
        }
    },
    {
        title: "EDITAR DATOS",
        desc: "Toca este botón para entrar al Panel de Control de tu cuenta.",
        target: "button[onclick='openEditDataModal()']", 
        action: 'click', 
        lockTarget: true,
        onStart: () => {
             const card = document.querySelector('#modalMyProfile .modal-card');
             if(card) card.scrollTop = 0;
        }
    },
    {
        title: "GESTIÓN DE CUENTA",
        desc: "Usa estas pestañas para CREAR tu cuenta, INICIAR SESIÓN o CAMBIAR DE NÚMERO.",
        target: "#authTabsRow", 
        action: 'info',
        onStart: () => {
             const card = document.querySelector('#modalEditData .modal-card');
             if(card) card.scrollTop = 0;
        }
    },
    {
        title: "TUS DATOS",
        desc: "Aquí escribes el Nombre de tu Negocio y tu Teléfono. ¡No olvides guardar!",
        target: "#editProfileName", 
        action: 'info'
    },
    {
        title: "LISTA DE PRECIOS",
        desc: "Entra aquí para definir cuánto cobras por cada servicio (Corte, Barba, etc).",
        target: "#groupExtraSettings div[onclick='abrirGestorServicios()']",
        action: 'info'
    },
    {
        title: "UBICACIÓN GPS",
        desc: "Pulsa para detectar dónde estás. Así aparecerás en el mapa de los clientes.",
        target: ".btn-geo-auto",
        action: 'info',
        onStart: () => {
            const el = document.querySelector('.btn-geo-auto');
            if(el) el.scrollIntoView({behavior: "smooth", block: "center"});
        }
    },

    {
        title: "¡TUTORIAL COMPLETADO!",
        desc: "✨ Bienvenido a la Familia PRO. ¡Ya estás listo para el éxito! ✨",
        target: null,
        action: 'info',
        onStart: () => {
            // Limpieza Final Automática
            closeModal(); 
            document.getElementById('modalMyProfile').classList.remove('open');
            document.getElementById('modalEditData').classList.remove('open');
            navTo('agenda'); 
            
            // Borra los turnos de prueba
            DB.appointments = DB.appointments.filter(a => ![9991, 9992, 9993].includes(a.id));
            delete DB.clients["Cliente Rojo"];
            delete DB.clients["Juan Pérez"];
            delete DB.clients["María Style"];
            
            saveData();
            renderAgenda();
            fireConfetti(); 
        }
    }
];


function iniciarTutorialMaestro() {
    tutorialActive = true;
    currentStepIndex = -1;
    document.getElementById('gameOverlay').style.display = 'block';
    
    // Preparar UI
    navTo('agenda');
    
    advanceTutorial();
}
function advanceTutorial(e) {
    if(e && e.stopPropagation) e.stopPropagation();

    if(isTutorialLocked) return;
    isTutorialLocked = true;
    setTimeout(() => { isTutorialLocked = false; }, 1500);

    // 1. Limpieza total
    unlockScreen(); 

    const prevStep = TUTORIAL_STEPS[currentStepIndex];
    if(prevStep && prevStep.onEnd) prevStep.onEnd();

    currentStepIndex++;

    if(currentStepIndex >= TUTORIAL_STEPS.length) {
        finishTutorial();
        return;
    }

    const step = TUTORIAL_STEPS[currentStepIndex];
    
    // 2. Elementos UI
    const spotlight = document.getElementById('tutSpotlight');
    const tooltip = document.getElementById('tutTooltip');
    const hint = document.getElementById('tutHint');
    const overlay = document.getElementById('gameOverlay');
    const hand = document.getElementById('tutHand');

    // 3. Textos y Reseteo
    document.getElementById('tutTitle').innerText = step.title;
    document.getElementById('tutDesc').innerText = step.desc;
    hand.className = 'fas fa-hand-pointer tut-hand';
    hand.style.display = 'none';
    overlay.style.display = 'block'; 
    spotlight.style.display = 'none'; 
    tooltip.style.opacity = '0';

    if(step.onStart) step.onStart();
    if (step.action === 'custom') return; 

    // 4. LÓGICA DE INTERACCIÓN
    if (step.lockTarget) {
        // En modo bloqueo, el fondo negro deja pasar los clicks hacia la app (que estará congelada excepto el target)
        overlay.style.pointerEvents = 'none'; 
    } else {
        // En modo normal, el fondo negro captura el click para avanzar
        overlay.style.pointerEvents = 'auto';
        overlay.onclick = () => advanceTutorial();
    }

    // 5. Pistas Visuales
    if (step.lockTarget) {
        if(step.action && step.action.includes('swipe')) {
            hint.innerHTML = '<i class="fas fa-arrows-alt-h"></i> Desliza el turno ahora';
        } else {
            hint.innerHTML = '<i class="fas fa-lock"></i> Toca el elemento marcado';
        }
    } else {
        hint.innerHTML = '<i class="fas fa-fingerprint"></i> Toca para continuar';
    }

    // 6. Posicionamiento y Activación
    if(step.target) {
        const el = document.querySelector(step.target);
        if(el) {
            el.scrollIntoView({behavior: "smooth", block: "center"});
            
            setTimeout(() => {
                // AQUÍ aplicamos el congelado selectivo
                if(step.lockTarget) {
                    lockScreenForElement(el, step.action);
                    
                    // 1. Si toca el foco de luz
                    spotlight.onclick = (ev) => {
                        ev.stopPropagation();
                        el.click(); // Fuerza la acción nativa
                        // No esperamos setTimeout aquí, el listener de abajo se encargará o lo forzamos
                    };

                    // 2. Si toca el botón real (Doble seguridad)
                    const avanceAutomatico = () => {
                        // Quitamos el listener para que no se repita
                        el.removeEventListener('click', avanceAutomatico);
                        // Avanzamos rápido
                        setTimeout(() => advanceTutorial(), 300);
                    };
                    el.addEventListener('click', avanceAutomatico, {once:true});
                }

                const rect = el.getBoundingClientRect();
                spotlight.style.cssText = `
                    width: ${rect.width + 10}px; height: ${rect.height + 10}px;
                    top: ${rect.top - 5}px; left: ${rect.left - 5}px;
                    display: block; opacity: 1; border-radius: 15px; position: absolute;
                    z-index: 25001; cursor: pointer;
                    /* Si es swipe (deslizar), el spotlight se vuelve intangible para no estorbar el dedo */
                    pointer-events: ${step.action && step.action.includes('swipe') ? 'none' : 'auto'};
                `;
                tooltip.style.opacity = '1';
                
                if (step.pos === 'top') {
                    tooltip.style.top = (rect.top - 200) + 'px';
                } else {
                    tooltip.style.top = (rect.top > window.innerHeight / 2) ? (rect.top - 280) + 'px' : (rect.bottom + 20) + 'px';
                }
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translateX(-50%)';

                // LOGICA INTELIGENTE BOTON OMITIR
                const btnSkip = document.getElementById('btnSkipTut');
                if(btnSkip) {
                    // Si el elemento objetivo está en el 20% superior de la pantalla, bajamos el botón
                    if(rect.top < (window.innerHeight * 0.20)) btnSkip.classList.add('moved');
                    else btnSkip.classList.remove('moved');
                }

                if(step.action === 'swipe-right') {
                    hand.style.display = 'block';
                    hand.style.top = (rect.top + rect.height/2 - 20) + 'px';
                    hand.style.left = (rect.left + 20) + 'px';
                    hand.classList.add('swipe-right');
                }
            }, 800);
        } else { setTimeout(advanceTutorial, 100); }
    } else {
        tooltip.style.opacity = '1';
        tooltip.style.top = '50%';
        tooltip.style.left = '50%';
        tooltip.style.transform = 'translate(-50%, -50%)';
    }
}



function skipTutorial() {
    // Usamos tu alerta bonita (warning) en vez de la fea del sistema
    showCustomAlert(
        'warning',
        '¿Saltar Tutorial?',
        'Se borrarán los datos de prueba y volverás a la Agenda.',
        function() {
            // 1. Ocultamos el botón OMITIR a la fuerza
            const btn = document.getElementById('btnSkipTut');
            if(btn) btn.style.display = 'none';

            // 2. Finalizamos
            finishTutorial();

            // 3. Cartel bonito de confirmación
            showCustomAlert('success', 'Tutorial Omitido', 'Has vuelto al modo normal.');
        },
        null
    );
}

function lockScreenForElement(element, actionType) {
    // 1. Congelamos la app completa para que nada responda
    const app = document.querySelector('.app-container');
    if(app) app.style.pointerEvents = 'none';
    
    // 2. Descongelamos SOLO el elemento (el turno) para poder tocarlo/deslizarlo
    element.style.pointerEvents = 'auto';
    element.classList.add('element-highlight-lock');
}


function unlockScreen() {
    // 1. Reactivamos la app
    const app = document.querySelector('.app-container');
    if(app) app.style.pointerEvents = '';
    
    // 2. Limpiamos los elementos
    document.querySelectorAll('.element-highlight-lock').forEach(el => {
        el.style.pointerEvents = '';
        el.classList.remove('element-highlight-lock');
    });
    
    // 3. Quitamos el escudo viejo por si acaso
    document.getElementById('hardLockLayer').style.display = 'none';
}

function finishTutorial() {
    const btn = document.getElementById('btnSkipTut');
    if(btn) btn.style.display = 'none';

    tutorialActive = false;
    document.getElementById('gameOverlay').style.display = 'none';
    unlockScreen();
    
    const hand = document.getElementById('tutHand');
    const tt = document.getElementById('tutTooltip');
    if(hand) { hand.style.color = ''; hand.style.fontSize = ''; }
    if(tt) { tt.classList.remove('tut-special-entry'); tt.style.bottom = ''; }
    
    // 1. Restaurar si hay backup, SINO filtrar manualmente (Más seguro ante recargas)
    if(Array.isArray(backupAppointments) && backupAppointments.length > 0) {
        DB.appointments = [...backupAppointments];
    } else {
        // Si se perdió la memoria, limpiamos los IDs falsos de la DB real
        DB.appointments = DB.appointments.filter(a => ![9991, 9992, 9993].includes(a.id));
    }
    
    // 2. Borrado explícito de clientes falsos
    if(DB.clients) {
        delete DB.clients["Cliente Rojo"];
        delete DB.clients["Juan Pérez"];
        delete DB.clients["María Style"];
    }
    
    // 3. Forzar actualización visual inmediata de clientes
    renderClients();
    
    localStorage.setItem('tutorial_v12_completed', 'true');
    saveData();
    renderAgenda();
    navTo('agenda');
}

// --- VER MIS RESEÑAS (LADO BARBERO) ---
async function verMisResenasPro() {
    const modal = document.getElementById('modalReviewsPro');
    const list = document.getElementById('lista-resenas-pro');
    modal.classList.add('open');
    
    // 1. CARGAR CACHÉ
    const cachedReviews = localStorage.getItem('bm_cached_reviews');
    if(cachedReviews) {
        renderReviewsList(JSON.parse(cachedReviews));
    } else {
        list.innerHTML = '<div style="text-align:center; padding:40px; color:#666;"><i class="fas fa-circle-notch fa-spin"></i> Cargando opiniones...</div>';
    }

    if(!MY_DEVICE_ID) return;

    // 2. ACTUALIZAR DE INTERNET
    const { data, error } = await supabase
        .from('resenas')
        .select('*')
        .eq('barbero_id', MY_DEVICE_ID)
        .order('fecha', { ascending: false });

    if(!error && data) {
        localStorage.setItem('bm_cached_reviews', JSON.stringify(data));
        renderReviewsList(data);
    } else if (!cachedReviews) {
        list.innerHTML = '<div style="text-align:center; padding:40px; color:#555;">Todavía no tienes reseñas.<br>¡Haz un buen trabajo hoy!</div>';
    }
}

function renderReviewsList(data) {
    const list = document.getElementById('lista-resenas-pro');
    if(!data || data.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:40px; color:#555;">Todavía no tienes reseñas.<br>¡Haz un buen trabajo hoy!</div>';
        return;
    }
    list.innerHTML = '';
    data.forEach(r => {
        const estrellas = '⭐'.repeat(r.calificacion);
        const fechaObj = new Date(r.fecha);
        const fechaStr = `${fechaObj.getDate()}/${fechaObj.getMonth()+1}`;
        
        list.innerHTML += `
        <div style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:15px; padding:15px; margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <div style="font-weight:800; color:#fff;">${r.cliente_nombre || 'Cliente'}</div>
                <div style="font-size:0.75rem; color:#666;">${fechaStr}</div>
            </div>
            <div style="color:var(--gold); font-size:0.8rem; margin-bottom:8px;">${estrellas}</div>
            <div style="color:#ccc; font-size:0.9rem; line-height:1.4; font-style:italic;">"${r.comentario || ''}"</div>
        </div>`;
    });
}
function cerrarSesionBarbero() {
    showCustomAlert('warning', '¿Cerrar Sesión?', 'Se desconectará tu cuenta de este dispositivo.', () => {
        // 1. Borrar credenciales
        localStorage.removeItem('barber_phone_real');
        localStorage.removeItem('barber_password');
        localStorage.removeItem('barber_online_status');
        
        // 2. RESTAURAR EL ID DE FÁBRICA
        const originalID = localStorage.getItem('backup_original_id');
        if (originalID) {
            localStorage.setItem('bm_secure_id_v1', originalID);
            MY_DEVICE_ID = originalID;
        } else {
            // Si no había backup, generamos uno nuevo limpio
            const newID = 'barber_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
            localStorage.setItem('bm_secure_id_v1', newID);
            localStorage.setItem('backup_original_id', newID);
            MY_DEVICE_ID = newID;
        }
        
        // 3. Limpiar datos locales visuales
        DB.appointments = [];
        DB.clients = {};
        DB.settings.brand.text = "Barbería";
        DB.settings.verified = false;
        saveData();
        
        showToast("Sesión Cerrada", "👋", "ADIÓS");
        setTimeout(() => location.reload(), 1000);
    }, null);
}
        // --- FUNCIÓN MAESTRA: RESTAURAR TODO DESDE LA NUBE ---
        async function descargarDatosNube() {
            if(!MY_DEVICE_ID) return;
            
            // Avisar visualmente en el botón de carga
            const btn = document.getElementById('btnAuthAction');
            if(btn) btn.innerHTML = '<i class="fas fa-cloud-download-alt fa-spin"></i> RECUPERANDO HISTORIAL...';

            // 1. Descargar TURNOS
            const { data: turnos } = await supabase.from('turnos').select('*').eq('barbero_id', MY_DEVICE_ID);
            
            // 2. Descargar EXTRAS (Propinas)
            const { data: extras } = await supabase.from('ingresos_extra').select('*').eq('barbero_id', MY_DEVICE_ID);

            // A. Procesar Turnos
            if(turnos && turnos.length > 0) {
                DB.appointments = turnos.map(t => ({
                    id: t.id,
                    name: t.cliente,
                    phone: t.telefono,
                    date: t.fecha,
                    time: t.hora,
                    price: t.precio
                }));
            }

            // B. Procesar Extras
            if(extras && extras.length > 0) {
                DB.extras = extras.map(e => ({
                    id: e.id,
                    type: 'manual',
                    reason: e.razon,
                    price: e.precio,
                    date: e.fecha,
                    time: e.hora
                }));
            }

            // C. Reconstruir Clientes (Historial completo)
            if(turnos && turnos.length > 0) {
                DB.clients = {}; 
                // Ordenamos por fecha
                turnos.sort((a,b) => new Date(a.fecha) - new Date(b.fecha));

                turnos.forEach(t => {
                    const name = t.cliente;
                    if(!DB.clients[name]) {
                        DB.clients[name] = { visits: 0, phone: t.telefono || "", lastDate: "", tag: "" };
                    }
                    DB.clients[name].visits++;
                    DB.clients[name].lastDate = t.fecha;
                    if(t.telefono) DB.clients[name].phone = t.telefono;
                    // Intento recuperar tag automático si es posible
                    if(!DB.clients[name].tag) DB.clients[name].tag = checkAutoTag(t.telefono);
                });
            }

            saveData();
            console.log("✅ Restauración completa (Agenda + Finanzas + Clientes).");
        }

                async function verificarActualizaciones() {
            if(typeof supabase === 'undefined') return;
            console.log("🔍 Buscando actualizaciones...");

            // Usamos maybeSingle para que no de error si está vacío (borrado)
            const { data, error } = await supabase
                .from('app_versiones')
                .select('*')
                .eq('app_id', 'manager') 
                .order('id', { ascending: false })
                .limit(1)
                .maybeSingle(); 

            const modal = document.getElementById('modalUpdate');

            // 1. SI HAY ACTUALIZACIÓN NUEVA -> ABRIR
            if (data && !error && parseFloat(data.ver_num) > APP_CURRENT_VERSION) {
                
                document.getElementById('updVerTxt').innerText = "v" + data.ver_num;
                document.getElementById('updNotes').innerText = data.notas || "Mejoras generales.";
                
                const btnUpdate = document.getElementById('btnDoUpdate');
                const btnClose = document.getElementById('btnCloseUpdate');

                btnUpdate.onclick = () => {
                    if (typeof Android !== 'undefined' && Android.abrirEnlace) {
                        Android.abrirEnlace(data.link);
                    } else {
                        window.open(data.link, '_system');
                    }
                };

                if (data.obligatorio) {
                    btnClose.style.display = 'none';
                    modal.onclick = null;
                } else {
                    btnClose.style.display = 'block';
                    modal.onclick = (e) => { if(e.target === modal) modal.classList.remove('open'); };
                }

                // Solo vibrar y abrir si no estaba ya abierto
                if (!modal.classList.contains('open')) {
                    if(navigator.vibrate) navigator.vibrate([100,50,100]);
                    modal.classList.add('open');
                }
            } 
            // 2. SI NO HAY DATOS (BORRADO) -> CERRAR
            else {
                if (modal.classList.contains('open')) {
                    modal.classList.remove('open');
                    console.log("Actualización cancelada o eliminada.");
                }
            }
        }

        function toggleLiteMode() {
            const isLite = localStorage.getItem('bm_lite_mode') === 'true';
            const nuevoEstado = !isLite;
            
            let titulo = nuevoEstado ? "⚡ ¿ACTIVAR MODO RÁPIDO?" : "✨ ¿MODO VISUAL?";
            let msg = nuevoEstado 
                ? "Se eliminarán las transparencias y animaciones para que la App vuele. Se requiere reinicio." 
                : "Se activarán los efectos de cristal y animaciones. (Puede ser lento). Se requiere reinicio.";

            showCustomAlert('warning', titulo, msg, () => {
                localStorage.setItem('bm_lite_mode', nuevoEstado);
                window.location.reload();
            }, null);
        }
                // --- LÓGICA DEL CATÁLOGO (SERVIDOR NUEVO) ---
        
        let myCatalogData = [];

        async function abrirCatalogoModal() {
            // Seguridad: Si no tiene cuenta
            if (!localStorage.getItem('barber_phone_real')) {
                showToast("Crea una cuenta primero", "👤", "REQUERIDO");
                return;
            }
            
            document.getElementById('modalCatalog').classList.add('open');
            cargarCatalogo();
        }

        async function cargarCatalogo() {
            const grid = document.getElementById('catalogGrid');
            
            // 1. CACHÉ INMEDIATA (Modo Ahorro Datos)
            const cachedCat = localStorage.getItem('bm_cached_catalog');
            if(cachedCat) {
                myCatalogData = JSON.parse(cachedCat);
                renderCatalogoGrid(); // Muestra fotos al instante
            } else {
                grid.innerHTML = '<div style="grid-column:span 2;text-align:center;padding:40px;color:#666;"><i class="fas fa-circle-notch fa-spin"></i> Cargando fotos...</div>';
            }

            try {
                if (!supabaseCatalogo) throw new Error("Credenciales CAT_URL/CAT_KEY incorrectas.");

                // 2. Actualizar en segundo plano (Internet)
                const { data, error } = await supabaseCatalogo
                    .storage
                    .from('catalogo') 
                    .list(MY_DEVICE_ID, {
                        limit: 10, offset: 0, sortBy: { column: 'created_at', order: 'desc' }
                    });

                if (error) throw error;

                // 3. Guardar nueva lista en memoria y refrescar
                myCatalogData = data || [];
                localStorage.setItem('bm_cached_catalog', JSON.stringify(myCatalogData));
                renderCatalogoGrid();

            } catch (e) {
                console.error("Error Catalogo:", e);
                if(myCatalogData.length === 0) {
                    grid.innerHTML = `<div style="grid-column:span 2;text-align:center;color:#e74c3c;padding:20px;">Error de conexión</div>`;
                }
            }
        }

        function renderCatalogoGrid() {
            const grid = document.getElementById('catalogGrid');
            grid.innerHTML = '';

            // 1. Mostrar fotos existentes
            myCatalogData.forEach(file => {
                // Construir URL Pública (Servidor Nuevo)
                const publicUrl = `${CAT_URL}/storage/v1/object/public/catalogo/${MY_DEVICE_ID}/${file.name}`;
                
                const div = document.createElement('div');
                div.className = 'catalog-item';
                div.onclick = () => gestionarFotoCatalogo(file.name);
                
                div.innerHTML = `
                    <img src="${publicUrl}" class="catalog-img" loading="lazy">
                    <div style="position:absolute;bottom:0;right:0;background:rgba(0,0,0,0.6);color:#fff;padding:2px 8px;font-size:0.6rem;border-top-left-radius:8px;">
                        <i class="fas fa-pen"></i>
                    </div>
                `;
                grid.appendChild(div);
            });

            // 2. Botón "Agregar" (Solo si hay menos de 10)
            if (myCatalogData.length < 10) {
                const btnAdd = document.createElement('div');
                btnAdd.className = 'catalog-add';
                btnAdd.onclick = () => document.getElementById('inputCatalogUpload').click();
                btnAdd.innerHTML = `
                    <i class="fas fa-plus fa-2x" style="margin-bottom:10px;"></i>
                    <div style="font-size:0.7rem;font-weight:700;">AGREGAR</div>
                    <div style="font-size:0.6rem;">${myCatalogData.length}/10</div>
                `;
                grid.appendChild(btnAdd);
            } else {
                const label = document.createElement('div');
                label.style.gridColumn = "span 2";
                label.style.textAlign = "center";
                label.style.color = "#f1c40f";
                label.style.fontSize = "0.8rem";
                label.style.padding = "10px";
                label.innerHTML = "<i class='fas fa-crown'></i> Límite de 10 fotos alcanzado";
                grid.appendChild(label);
            }
        }

        async function handleCatalogUpload(input) {
            if (!input.files || !input.files[0]) return;
            
            // Doble chequeo de límite
            if (myCatalogData.length >= 10) {
                showToast("Límite alcanzado (10)", "⛔", "CATÁLOGO");
                return;
            }

            const file = input.files[0];
            const btnContainer = document.getElementById('catalogGrid');
            // Efecto de carga visual simple
            btnContainer.style.opacity = '0.5';
            showToast("Comprimiendo y Subiendo...", "☁️", "CATÁLOGO");

            try {
                // 1. Compresión (aprox 250kb)
                const compressedBlob = await comprimirParaCatalogo(file);
                
                // 2. Nombre único
                const fileName = `foto_${Date.now()}.jpg`;
                const filePath = `${MY_DEVICE_ID}/${fileName}`;

                // 3. Subir al NUEVO servidor
                const { error } = await supabaseCatalogo
                    .storage
                    .from('catalogo')
                    .upload(filePath, compressedBlob, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) throw error;

                showToast("Foto Agregada", "✅", "ÉXITO");
                cargarCatalogo(); // Recargar grilla

            } catch (err) {
                console.error("Upload error:", err);
                showToast("Error al subir", "❌", "ERROR");
                btnContainer.style.opacity = '1';
            } finally {
                input.value = ''; // Limpiar input
            }
        }

        function gestionarFotoCatalogo(fileName) {
            showCustomAlert(
                'warning',
                'Gestionar Foto',
                '¿Qué quieres hacer con esta imagen?',
                async () => { // Confirmar = BORRAR
                    showToast("Borrando...", "🗑️", "PROCESANDO");
                    const { error } = await supabaseCatalogo
                        .storage
                        .from('catalogo')
                        .remove([`${MY_DEVICE_ID}/${fileName}`]);
                    
                    if(!error) {
                        showToast("Eliminada", "🗑️", "LISTO");
                        cargarCatalogo();
                    }
                }, 
                () => { // Cancelar = NADA (Se podría usar para cambiar, pero usaremos un botón extra si quieres)
                    // Por ahora el Alert solo tiene 2 botones. 
                    // Vamos a modificar esto ligeramente abajo para que sea BORRAR o CANCELAR.
                }
            );
            
            // TRUCO: Cambiamos los textos de los botones del Alert en caliente
            setTimeout(() => {
                const btns = document.querySelectorAll('#alertButtons .btn');
                if(btns[1]) { 
                    btns[1].innerText = "BORRAR FOTO"; 
                    btns[1].style.background = "#e74c3c"; // Rojo
                }
                const btnCancel = document.querySelector('#alertButtons .btn-outline');
                if(btnCancel) btnCancel.innerText = "CANCELAR";
            }, 50);
        }

        function comprimirParaCatalogo(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // Max 1080px para asegurar calidad decente
                        const maxW = 1080;
                        let w = img.width;
                        let h = img.height;
                        
                        if (w > maxW) {
                            h *= maxW / w;
                            w = maxW;
                        }

                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        
                        // Calidad 0.7 suele dar ~150-300kb para 1080p
                        canvas.toBlob(resolve, 'image/jpeg', 0.7);
                    };
                };
            });
        }

 <script>
/* ================================
   BARBER MANAGER PRO - OFFLINE CORE
   ================================ */

const STORAGE_KEY = 'barber_manager_pro_data';

/* ---------- MOTOR DE DATOS LOCAL ---------- */
function loadData() {
    try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
            clientes: [],
            turnos: [],
            finanzas: [],
            galeria: [],
            perfil: {},
            ajustes: {}
        };
    } catch (e) {
        return {};
    }
}

function saveData(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

/* ---------- SESIÓN LOCAL (sin auth) ---------- */
function verificarIdentidad() {
    return true; // Siempre permitido (offline)
}

function descargarAgendaNube() {
    return loadData().turnos || [];
}

/* ---------- BLOQUEOS ELIMINADOS ---------- */
function verificarSuscripcion() { return true; }
function verificarEstadoGlobal() { return true; }

/* ---------- MODALES ---------- */
function openModal(id) {
    const modal = document.getElementById(id);
    if (modal) modal.classList.add('open');
}

function closeModal(id) {
    const modal = document.getElementById(id);
    if (modal) modal.classList.remove('open');
}

document.querySelectorAll('.modal-close-x').forEach(btn => {
    btn.addEventListener('click', () => {
        btn.closest('.modal')?.classList.remove('open');
    });
});

/* ---------- PREVENIR LLAMADAS DE RED ---------- */
window.fetch = function () {
    console.warn('Fetch bloqueado: App en modo OFFLINE');
    return Promise.reject('OFFLINE MODE');
};

/* ---------- ESTADO OFFLINE ---------- */
document.addEventListener('DOMContentLoaded', () => {
    console.log('Barber Manager Pro OFFLINE listo');
});

/* ---------- API GLOBAL (para futuras funciones) ---------- */
window.BMP = {
    loadData,
    saveData
};
</script>
</body>
</html>